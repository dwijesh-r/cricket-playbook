<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Film Room - The Lab</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* ==================== THEME SYSTEM ==================== */
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --bg-elevated: #3a3a3c;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --text-tertiary: #636366;
            --accent: #0a84ff;
            --accent-green: #30d158;
            --accent-yellow: #ffd60a;
            --accent-orange: #ff9f0a;
            --accent-red: #ff453a;
            --accent-purple: #bf5af2;
            --accent-pink: #ff375f;
            --accent-teal: #64d2ff;
            --border: rgba(255, 255, 255, 0.1);
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.08);
            --shadow: rgba(0, 0, 0, 0.4);
        }

        [data-theme="light"] {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e5e5ea;
            --bg-elevated: #d1d1d6;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-tertiary: #8e8e93;
            --accent: #007aff;
            --accent-green: #28cd41;
            --accent-yellow: #ffcc00;
            --accent-orange: #ff9500;
            --accent-red: #ff3b30;
            --accent-purple: #af52de;
            --accent-pink: #ff2d55;
            --accent-teal: #5ac8fa;
            --border: rgba(0, 0, 0, 0.08);
            --glass: rgba(0, 0, 0, 0.03);
            --glass-border: rgba(0, 0, 0, 0.06);
            --shadow: rgba(0, 0, 0, 0.15);
        }

        /* ==================== TOOLTIP SYSTEM (TKT-109) ==================== */
        .has-tooltip {
            position: relative;
            cursor: help;
        }
        .has-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 4px 12px var(--shadow);
        }
        .has-tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            font-size: 10px;
            color: var(--text-tertiary);
            cursor: help;
            margin-left: 4px;
            vertical-align: middle;
        }
        .help-icon:hover { color: var(--accent); }

        /* Mobile-safe tooltip adjustments */
        @media (max-width: 768px) {
            .has-tooltip::after {
                white-space: normal;
                max-width: 200px;
                left: 0;
                transform: none;
                font-size: 11px;
            }
        }
        @media (max-width: 480px) {
            .has-tooltip::after {
                max-width: 160px;
                padding: 6px 10px;
                font-size: 10px;
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ==================== BACKGROUND ==================== */
        .bg-gradient {
            position: fixed; inset: 0; z-index: -4;
            background: linear-gradient(135deg, #000000 0%, #0a0a12 25%, #0d1020 50%, #0a0a15 75%, #000000 100%);
        }
        [data-theme="light"] .bg-gradient {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #f1f3f5 100%);
        }
        .bg-gradient::before {
            content: ''; position: absolute; top: -20%; right: -10%; width: 60%; height: 60%;
            background: radial-gradient(ellipse, rgba(10, 132, 255, 0.18) 0%, transparent 70%);
            filter: blur(80px);
        }
        .bg-grid {
            position: fixed; inset: 0; z-index: -2;
            background-image: linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 60px 60px;
        }
        [data-theme="light"] .bg-grid {
            background-image: linear-gradient(rgba(0, 0, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
        }

        /* ==================== NAVIGATION ==================== */
        .nav {
            position: fixed; top: 0; left: 0; right: 0; height: 56px;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px; z-index: 100;
        }
        [data-theme="light"] .nav { background: rgba(245, 245, 247, 0.85); }
        .nav-brand { display: flex; align-items: center; gap: 12px; }
        .nav-logo {
            width: 32px; height: 32px; border-radius: 8px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-purple) 100%);
            display: flex; align-items: center; justify-content: center; font-size: 16px;
        }
        .nav-title { font-size: 15px; font-weight: 600; letter-spacing: -0.3px; }
        .nav-title span { color: var(--accent); }
        .nav-tabs {
            display: flex; gap: 4px;
            background: var(--bg-secondary); border-radius: 10px; padding: 4px;
        }
        .nav-tab {
            padding: 6px 14px; border-radius: 8px; font-size: 13px; font-weight: 500;
            color: var(--text-secondary); text-decoration: none; transition: all 0.2s ease;
            white-space: nowrap;
        }
        .nav-tab:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .nav-tab.active {
            color: var(--text-primary); background: var(--bg-tertiary);
            box-shadow: 0 1px 3px var(--shadow);
        }
        .nav-actions { display: flex; align-items: center; gap: 12px; }
        .nav-time { font-size: 12px; color: var(--text-tertiary); font-variant-numeric: tabular-nums; }

        /* Theme Toggle */
        .theme-toggle {
            width: 36px; height: 36px; border-radius: 10px;
            background: var(--bg-secondary); border: 1px solid var(--border);
            color: var(--text-primary); cursor: pointer; font-size: 16px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
        }
        .theme-toggle:hover { background: var(--bg-tertiary); }

        /* Mobile hamburger menu */
        .mobile-menu-btn {
            display: none;
            width: 38px; height: 38px; border-radius: 10px;
            background: var(--bg-secondary); border: 1px solid var(--border);
            color: var(--text-primary); cursor: pointer;
            flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; padding: 8px;
        }
        .mobile-menu-btn span {
            display: block; width: 18px; height: 2px;
            background: currentColor; border-radius: 1px; transition: all 0.3s ease;
        }
        .mobile-menu-btn.active span:nth-child(1) { transform: rotate(45deg) translate(4px, 4px); }
        .mobile-menu-btn.active span:nth-child(2) { opacity: 0; }
        .mobile-menu-btn.active span:nth-child(3) { transform: rotate(-45deg) translate(4px, -4px); }

        /* Mobile Navigation Dropdown */
        .mobile-nav-menu {
            display: none; position: fixed; top: 56px; left: 0; right: 0;
            background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            flex-direction: column; padding: 8px 16px;
            z-index: 99; transform: translateY(-10px); opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        .mobile-nav-menu.active { transform: translateY(0); opacity: 1; pointer-events: auto; }
        [data-theme="light"] .mobile-nav-menu { background: rgba(245, 245, 247, 0.95); }
        .mobile-nav-menu .nav-tab {
            padding: 12px 16px; border-radius: 8px; font-size: 15px;
            display: block; width: 100%;
        }
        .mobile-nav-menu .nav-tab.active {
            background: var(--bg-tertiary); color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .nav-tabs { display: none; }
            .mobile-menu-btn { display: flex; }
            .mobile-nav-menu { display: flex; }
        }

        /* ==================== MAIN LAYOUT ==================== */
        .main {
            padding-top: 72px;
            min-height: 100vh;
        }

        .page-header {
            padding: 32px 24px 16px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .page-title {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
        }
        .page-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            max-width: 700px;
            line-height: 1.6;
        }

        /* ==================== RESEARCH DESK LAYOUT ==================== */
        .desk-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 0;
            max-width: 1400px;
            margin: 16px auto 0;
            padding: 0 24px;
            min-height: calc(100vh - 200px);
        }

        /* ==================== SCHEMA BROWSER (LEFT SIDEBAR) ==================== */
        .schema-sidebar {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px 0 0 12px;
            overflow-y: auto;
            max-height: calc(100vh - 180px);
            position: sticky;
            top: 72px;
        }
        .schema-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .schema-header h3 {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }
        .schema-search {
            width: 100%;
            padding: 8px 12px;
            margin: 12px 16px;
            width: calc(100% - 32px);
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;  /* min 16px prevents iOS auto-zoom on focus */
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s ease;
            touch-action: manipulation;
        }
        .schema-search:focus { border-color: var(--accent); }
        .schema-search::placeholder { color: var(--text-tertiary); }

        .schema-group {
            padding: 8px 0;
        }
        .schema-group-label {
            padding: 6px 16px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-tertiary);
        }
        .schema-item {
            padding: 6px 16px 6px 24px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .schema-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .schema-item .icon {
            font-size: 10px;
            opacity: 0.6;
        }
        .schema-item-dim .icon { color: var(--accent-teal); }
        .schema-item-fact .icon { color: var(--accent-orange); }
        .schema-item-ref .icon { color: var(--accent-green); }
        .schema-item-cluster .icon { color: var(--accent-purple); }
        .schema-item-view .icon { color: var(--accent-yellow); }
        .schema-item .row-count {
            margin-left: auto;
            font-size: 10px;
            color: var(--text-tertiary);
        }

        /* ---- Interactive Schema Browser (TKT-175) ---- */
        .schema-item .chevron {
            font-size: 8px;
            transition: transform 0.2s ease;
            color: var(--text-tertiary);
            flex-shrink: 0;
        }
        .schema-item.expanded .chevron {
            transform: rotate(90deg);
        }
        .schema-item .table-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .schema-item .query-btn {
            display: none;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            background: var(--accent);
            color: #fff;
            border: none;
            cursor: pointer;
            flex-shrink: 0;
            line-height: 1.4;
            transition: opacity 0.15s ease;
        }
        .schema-item:hover .query-btn {
            display: inline-block;
        }
        .schema-columns {
            display: none;
            padding: 2px 0 6px 0;
            background: rgba(0,0,0,0.1);
            border-bottom: 1px solid var(--border);
        }
        [data-theme="light"] .schema-columns {
            background: rgba(0,0,0,0.02);
        }
        .schema-columns.visible {
            display: block;
        }
        .schema-col-item {
            padding: 3px 16px 3px 40px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.12s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .schema-col-item:hover {
            background: rgba(10, 132, 255, 0.08);
            color: var(--text-primary);
        }
        .schema-col-item .col-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .schema-col-item .col-type {
            font-size: 9px;
            font-weight: 600;
            padding: 1px 5px;
            border-radius: 3px;
            flex-shrink: 0;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .schema-col-item .col-type.type-varchar { background: rgba(10, 132, 255, 0.12); color: var(--accent); }
        .schema-col-item .col-type.type-bigint { background: rgba(255, 159, 10, 0.12); color: var(--accent-orange); }
        .schema-col-item .col-type.type-hugeint { background: rgba(255, 159, 10, 0.12); color: var(--accent-orange); }
        .schema-col-item .col-type.type-integer { background: rgba(255, 159, 10, 0.12); color: var(--accent-orange); }
        .schema-col-item .col-type.type-double { background: rgba(48, 209, 88, 0.12); color: var(--accent-green); }
        .schema-col-item .col-type.type-boolean { background: rgba(191, 90, 242, 0.12); color: var(--accent-purple); }
        .schema-col-item .col-type.type-default { background: rgba(142, 142, 147, 0.12); color: var(--text-tertiary); }
        .schema-col-item .col-desc {
            display: none;
        }
        .schema-col-item:hover .col-desc {
            display: none; /* Use tooltip instead */
        }

        /* ---- Example Card Enhancements (TKT-176) ---- */
        .example-card-category.phase { background: rgba(100, 210, 255, 0.15); color: var(--accent-teal); }
        .example-card-category.ipl2026 { background: rgba(255, 55, 95, 0.15); color: var(--accent-pink); }
        .example-card-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 8px;
            font-family: inherit;
        }
        .example-card p {
            font-size: 11px;
            color: var(--text-tertiary);
            line-height: 1.4;
            font-family: 'JetBrains Mono', monospace;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .example-card .load-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--accent);
            color: #fff;
            transition: all 0.15s ease;
        }
        .example-card .load-btn:hover {
            background: #0977e6;
        }

        /* ==================== MAIN WORKSPACE ==================== */
        .workspace {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-left: none;
            border-radius: 0 12px 12px 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        /* ---- Natural Language Search Bar ---- */
        .nl-search-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }
        .nl-search-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 16px;
            transition: border-color 0.2s ease;
        }
        .nl-search-bar:focus-within { border-color: var(--accent); }
        .nl-search-icon { font-size: 16px; color: var(--text-tertiary); }
        .nl-search-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 16px;  /* min 16px prevents iOS auto-zoom on focus */
            font-family: inherit;
            outline: none;
            touch-action: manipulation;
        }
        .nl-search-input::placeholder { color: var(--text-tertiary); }
        .nl-search-hint {
            font-size: 11px;
            color: var(--text-tertiary);
            padding: 6px 0 0 28px;
        }
        .nl-search-hint kbd {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1px 5px;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* ---- SQL Editor Area ---- */
        .sql-editor-section {
            padding: 0;
            border-bottom: 1px solid var(--border);
        }
        .editor-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }
        [data-theme="light"] .editor-toolbar {
            background: rgba(0,0,0,0.02);
        }
        .editor-toolbar-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .editor-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
        }
        .editor-toolbar-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .editor-btn {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .editor-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }
        .editor-btn.run-btn {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        .editor-btn.run-btn:hover {
            background: #0977e6;
            border-color: #0977e6;
        }
        .sql-editor-wrapper {
            position: relative;
            min-height: 160px;
            max-height: 300px;
        }
        .sql-editor-placeholder {
            width: 100%;
            min-height: 160px;
            max-height: 300px;
            padding: 16px 20px;
            background: var(--bg-primary);
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            border: none;
            outline: none;
            resize: vertical;
            tab-size: 2;
        }
        [data-theme="light"] .sql-editor-placeholder {
            background: #f8f9fa;
        }

        /* ---- Results Panel ---- */
        .results-section {
            padding: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 200px;
        }
        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }
        [data-theme="light"] .results-header {
            background: rgba(0,0,0,0.02);
        }
        .results-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
        }
        .results-meta {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        .results-table-wrapper {
            overflow: auto;
            flex: 1;
            max-height: 400px;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .results-table th {
            position: sticky;
            top: 0;
            background: var(--bg-tertiary);
            padding: 8px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        .results-table th:hover { color: var(--accent); }
        .results-table th .sort-icon { margin-left: 4px; font-size: 10px; opacity: 0.4; }
        .results-table td {
            padding: 6px 12px;
            border-bottom: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-primary);
            white-space: nowrap;
        }
        .results-table tr:nth-child(even) {
            background: var(--glass);
        }
        .results-table tr:hover {
            background: rgba(10, 132, 255, 0.08);
        }
        .results-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 20px;
            color: var(--text-tertiary);
            text-align: center;
        }
        .results-empty-icon { font-size: 36px; margin-bottom: 12px; opacity: 0.4; }
        .results-empty-text { font-size: 14px; margin-bottom: 4px; }
        .results-empty-hint { font-size: 12px; color: var(--text-tertiary); }

        /* ---- Andy Flower Insights Card ---- */
        .insights-section {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
        }
        .insight-card {
            background: linear-gradient(135deg, rgba(10, 132, 255, 0.08) 0%, rgba(191, 90, 242, 0.06) 100%);
            border: 1px solid rgba(10, 132, 255, 0.15);
            border-radius: 12px;
            padding: 16px 20px;
        }
        .insight-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .insight-card-header .icon { font-size: 20px; }
        .insight-card-header h4 {
            font-size: 13px;
            font-weight: 700;
            color: var(--accent);
        }
        .insight-card-header .badge {
            margin-left: auto;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(10, 132, 255, 0.15);
            color: var(--accent);
            font-weight: 600;
        }
        .insight-card p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* ---- Example Queries Gallery ---- */
        .examples-section {
            padding: 20px;
            border-top: 1px solid var(--border);
        }
        .examples-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }
        .examples-header h3 {
            font-size: 14px;
            font-weight: 700;
        }
        .examples-filter {
            display: flex;
            gap: 4px;
        }
        .examples-filter-btn {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        .examples-filter-btn:hover,
        .examples-filter-btn.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 10px;
        }
        .example-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .example-card:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }
        .example-card-category {
            display: inline-block;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 6px;
        }
        .example-card-category.batting { background: rgba(10, 132, 255, 0.15); color: var(--accent); }
        .example-card-category.bowling { background: rgba(255, 69, 58, 0.15); color: var(--accent-red); }
        .example-card-category.team { background: rgba(48, 209, 88, 0.15); color: var(--accent-green); }
        .example-card-category.leaderboard { background: rgba(255, 214, 10, 0.15); color: var(--accent-yellow); }
        .example-card-category.matchup { background: rgba(191, 90, 242, 0.15); color: var(--accent-purple); }
        .example-card h4 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .example-card p {
            font-size: 11px;
            color: var(--text-tertiary);
            line-height: 1.4;
            font-family: 'JetBrains Mono', monospace;
        }

        /* ==================== LOADING OVERLAY ==================== */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            transition: opacity 0.5s ease;
        }
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
            display: none;
        }
        .loading-icon { font-size: 48px; }
        .loading-title {
            font-size: 20px;
            font-weight: 700;
        }
        .loading-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .loading-progress-container {
            width: 320px;
            max-width: 80vw;
        }
        .loading-progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }
        .loading-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-purple) 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .loading-progress-text {
            text-align: center;
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 8px;
        }
        .loading-steps {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 12px;
        }
        .loading-step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-tertiary);
        }
        .loading-step.active { color: var(--accent); }
        .loading-step.done { color: var(--accent-green); }
        .loading-step .check { font-size: 14px; }

        /* ==================== STATUS BAR ==================== */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 11px;
            color: var(--text-tertiary);
            z-index: 100;
        }
        .status-bar-left, .status-bar-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-green);
        }
        .status-dot.loading {
            background: var(--accent-yellow);
            animation: pulse 1.5s ease infinite;
        }
        .status-dot.error { background: var(--accent-red); }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ==================== FOOTER ==================== */
        .footer {
            padding: 40px 24px 52px;
            text-align: center;
            border-top: 1px solid var(--border);
        }
        .footer-text { font-size: 12px; color: var(--text-tertiary); }
        .footer a { color: var(--accent); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .desk-container {
                grid-template-columns: 1fr;
                padding: 0 12px;
            }
            .schema-sidebar {
                border-radius: 12px 12px 0 0;
                max-height: none;
                position: static;
            }
            .schema-sidebar.collapsed .schema-group { display: none; }
            .schema-sidebar.collapsed .schema-search { display: none; }
            .workspace {
                border-left: 1px solid var(--border);
                border-radius: 0 0 12px 12px;
            }
            .page-header { padding: 20px 12px 12px; }
            .page-title { font-size: 24px; }
            .examples-grid { grid-template-columns: 1fr; }
            .mobile-nav-menu .nav-tab { min-height: 44px; }
        }
        @media (max-width: 480px) {
            .page-title { font-size: 20px; }
            .page-subtitle { font-size: 13px; }
            .editor-toolbar { flex-wrap: wrap; gap: 6px; }
            .nl-search-bar { padding: 8px 12px; }
        }

        /* ==================== CODEMIRROR OVERRIDES (TKT-174) ==================== */
        .sql-editor-wrapper .cm-editor {
            min-height: 160px;
            max-height: 300px;
            overflow-y: auto;
        }
        .sql-editor-wrapper .cm-editor.cm-focused {
            outline: none;
        }
        .sql-editor-wrapper .cm-scroller {
            overflow: auto;
        }

        /* ---- Pagination Controls (TKT-174) ---- */
        .results-pagination {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 8px 20px;
            border-top: 1px solid var(--border);
            background: rgba(0,0,0,0.15);
            font-size: 12px;
            color: var(--text-secondary);
        }
        .results-pagination.visible { display: flex; }
        [data-theme="light"] .results-pagination { background: rgba(0,0,0,0.02); }
        .results-pagination-info {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-tertiary);
        }
        .results-pagination-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .pagination-btn {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            transition: all 0.15s ease;
        }
        .pagination-btn:hover:not(:disabled) {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }
        .pagination-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .pagination-btn.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        /* ---- Column Resize Handle (TKT-174) ---- */
        .results-table th { position: relative; }
        .col-resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: col-resize;
            background: transparent;
            z-index: 3;
        }
        .col-resize-handle:hover,
        .col-resize-handle.resizing { background: var(--accent); }

        /* ---- Sort Indicators (TKT-174) ---- */
        .results-table th.sorted-asc .sort-icon,
        .results-table th.sorted-desc .sort-icon { opacity: 1; color: var(--accent); }

        /* ---- Query History Dropdown (TKT-174) ---- */
        .query-history-wrapper { position: relative; }
        .query-history-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            right: 0;
            width: 420px;
            max-height: 320px;
            overflow-y: auto;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 8px 32px var(--shadow);
            z-index: 50;
            padding: 4px;
        }
        .query-history-dropdown.open { display: block; }
        .query-history-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s ease;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-bottom: 1px solid var(--border);
        }
        .query-history-item:last-child { border-bottom: none; }
        .query-history-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .query-history-empty {
            padding: 16px;
            text-align: center;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* ---- Editor Shortcuts Hint (TKT-174) ---- */
        .editor-shortcuts-hint {
            padding: 4px 20px 6px;
            font-size: 10px;
            color: var(--text-tertiary);
            background: rgba(0,0,0,0.1);
            border-top: 1px solid var(--border);
        }
        [data-theme="light"] .editor-shortcuts-hint { background: rgba(0,0,0,0.02); }
        .editor-shortcuts-hint kbd {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 0px 4px;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
        }

        @media (max-width: 768px) {
            .query-history-dropdown { width: 280px; }
        }

        /* ==================== ENHANCED MOBILE RESPONSIVE ==================== */

        /* Mobile schema toggle button */
        .schema-toggle-btn {
            display: none;
            position: fixed;
            bottom: 48px;
            left: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            z-index: 90;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px var(--shadow);
            transition: all 0.2s ease;
        }
        .schema-toggle-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        /* Schema sidebar overlay for mobile */
        .schema-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .schema-overlay.active { display: block; }

        /* Tablet breakpoint enhancements */
        @media (max-width: 768px) {
            /* Show mobile schema toggle */
            .schema-toggle-btn { display: flex; }

            /* Schema sidebar: fixed overlay on mobile */
            .schema-sidebar {
                position: fixed;
                left: -300px;
                top: 0;
                bottom: 0;
                z-index: 1000;
                width: 280px;
                max-height: 100vh;
                border-radius: 0 12px 12px 0;
                transition: left 0.3s ease;
                background: var(--bg-secondary);
                border-right: 1px solid var(--border);
            }
            .schema-sidebar.open {
                left: 0;
            }

            /* Main content: full width */
            .workspace {
                border-left: 1px solid var(--border);
                border-radius: 12px;
            }

            /* Status bar: smaller text */
            .status-bar { font-size: 11px; padding: 0 12px; }
            .status-bar-left, .status-bar-right { gap: 8px; }

            /* Examples: single column */
            .examples-grid { grid-template-columns: 1fr !important; }
            .examples-filter { flex-wrap: wrap; }

            /* Editor adjustments */
            .nl-search-section { padding: 12px; }
            .insights-section { padding: 12px; }
            .examples-section { padding: 12px; }

            /* Results pagination */
            .results-pagination { flex-wrap: wrap; gap: 8px; padding: 8px 12px; }
            .results-pagination-controls { flex-wrap: wrap; justify-content: center; }
        }

        /* Phone breakpoint enhancements */
        @media (max-width: 480px) {
            /* Editor toolbar: wrap buttons */
            .editor-toolbar { flex-wrap: wrap; gap: 4px; padding: 6px 12px; }
            .editor-toolbar-left, .editor-toolbar-right { gap: 4px; }
            .editor-btn { font-size: 11px; padding: 5px 8px; }

            /* Results table: smaller font */
            .results-table { font-size: 11px; }
            .results-table th { font-size: 10px; padding: 6px 8px; }
            .results-table td { font-size: 11px; padding: 5px 8px; }

            /* Pagination: wrap and center */
            .results-pagination { justify-content: center; }
            .results-pagination-controls { flex-wrap: wrap; justify-content: center; gap: 4px; }
            .pagination-btn { padding: 4px 8px; font-size: 10px; }

            /* NL search bar: compact */
            .nl-search-bar { padding: 8px 10px; gap: 6px; }
            .nl-search-input { font-size: 16px; }  /* keep 16px ‚Äî below triggers iOS auto-zoom */
            .nl-search-hint { padding: 4px 0 0 0; font-size: 10px; }

            /* Insight card: compact */
            .insight-card { padding: 12px 14px; }

            /* Schema toggle position */
            .schema-toggle-btn { bottom: 44px; left: 12px; width: 42px; height: 42px; font-size: 18px; }

            /* Editor shortcuts hint */
            .editor-shortcuts-hint { display: none; }
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    <div class="bg-grid"></div>

    <!-- Mobile Schema Browser Toggle -->
    <button type="button" class="schema-toggle-btn" id="schema-toggle-btn" onclick="toggleSchemaSidebar()" title="Toggle Schema Browser">&#9776;</button>
    <div class="schema-overlay" id="schema-overlay" onclick="toggleSchemaSidebar()"></div>

    <!-- Loading Overlay (TKT-173 will wire up actual logic) -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-icon">üé¨</div>
        <div class="loading-title">Setting Up The Film Room</div>
        <div class="loading-subtitle">Cuing up the game tape...</div>
        <div class="loading-progress-container">
            <div class="loading-progress-bar">
                <div class="loading-progress-fill" id="loading-progress" style="width: 0%"></div>
            </div>
            <div class="loading-progress-text" id="loading-progress-text">Coach is grabbing the remote...</div>
        </div>
        <div class="loading-steps">
            <div class="loading-step active" id="step-engine">
                <span class="check">...</span> Firing up the analytics engine
            </div>
            <div class="loading-step" id="step-tables">
                <span class="check">...</span> Loading 15 scouting reports
            </div>
            <div class="loading-step" id="step-views">
                <span class="check">...</span> Building 52 play diagrams
            </div>
            <div class="loading-step" id="step-ready">
                <span class="check">...</span> Film Room ready ‚Äî play ball
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-brand">
            <div class="nav-logo">üèè</div>
            <div class="nav-title">Cricket <span>Playbook</span></div>
        </div>
        <div class="nav-tabs">
            <a href="index.html" class="nav-tab">Home</a>
            <a href="teams.html" class="nav-tab">Teams</a>
            <a href="artifacts.html" class="nav-tab">Artifacts</a>
            <a href="analysis.html" class="nav-tab">Analysis</a>
            <a href="research.html" class="nav-tab">Research</a>
            <a href="research-desk.html" class="nav-tab active">The Film Room</a>
            <a href="about.html" class="nav-tab">About</a>
        </div>
        <div class="nav-actions">
            <span class="nav-time" id="navTime">--:--:--</span>
            <button type="button" class="mobile-menu-btn" onclick="toggleMobileMenu()" title="Menu">
                <span></span><span></span><span></span>
            </button>
            <button type="button" class="theme-toggle" onclick="toggleTheme()">üåô</button>
        </div>
    </nav>

    <!-- Mobile Navigation Menu -->
    <div class="mobile-nav-menu" id="mobile-nav-menu">
        <a href="index.html" class="nav-tab">üè† Home</a>
        <a href="teams.html" class="nav-tab">üèè Teams</a>
        <a href="artifacts.html" class="nav-tab">üîç Artifacts</a>
        <a href="analysis.html" class="nav-tab">üî¨ Analysis</a>
        <a href="research.html" class="nav-tab">üìö Research</a>
        <a href="research-desk.html" class="nav-tab active">üé¨ The Film Room</a>
        <a href="about.html" class="nav-tab">üåπ About</a>
    </div>

    <main class="main">
        <header class="page-header">
            <div class="typewriter-container">
                <h1 class="page-title">üé¨ The Film Room</h1>
            </div>
            <p class="page-tagline" style="font-size: 17px; font-weight: 600; color: var(--accent); margin-bottom: 8px; font-style: italic;">
                "Where coaches break down the game, one query at a time"
            </p>
            <p class="page-subtitle">
                Every delivery. Every match. Every season. Pull up the tape on any player, team, or matchup
                across IPL history. The playbook is open ‚Äî run your own plays.
            </p>
        </header>

        <div class="desk-container">
            <!-- Schema Browser (Left Sidebar) ‚Äî TKT-175: Interactive -->
            <aside class="schema-sidebar" id="schema-browser">
                <div class="schema-header">
                    <h3>Schema Browser</h3>
                    <span class="has-tooltip" data-tooltip="Click to expand columns. Click a column to insert into editor.">
                        <span class="help-icon">?</span>
                    </span>
                </div>
                <input type="text" class="schema-search" placeholder="Search tables, views & columns..." id="schema-search" autocomplete="off">
                <!-- Schema groups will be rendered dynamically by TKT-175 JS -->
                <div id="schema-groups-container"></div>
            </aside>

            <!-- Main Workspace -->
            <div class="workspace">
                <!-- Natural Language Search (TKT-177) -->
                <div class="nl-search-section" id="nl-search-bar">
                    <div class="nl-search-bar">
                        <span class="nl-search-icon">&#128269;</span>
                        <input type="text" class="nl-search-input" placeholder="'Kohli stats', 'Bumrah year wise', 'Kohli at Chinnaswamy', 'top 10 batsmen', 'CSK squad'..." id="nl-search-input" autocomplete="off" enterkeyhint="search">
                        <button type="button" class="nl-search-btn" id="nl-search-btn" title="Search" style="
                            padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 600;
                            cursor: pointer; border: 1px solid var(--accent); background: var(--accent);
                            color: #fff; transition: all 0.2s ease; white-space: nowrap;
                        " onclick="handleNLSearch()">&#9654; Ask</button>
                    </div>
                    <div class="nl-search-hint">
                        <kbd>Enter</kbd> to search &middot; Try: <em>[name] stats</em> &middot; <em>[name] year wise</em> &middot; <em>[name] at [venue]</em> &middot; <em>[name] vs [name/team]</em> &middot; <em>top N [batsmen/bowlers]</em>
                    </div>
                </div>

                <!-- SQL Editor ‚Äî TKT-174 will wire up CodeMirror -->
                <div class="sql-editor-section" id="sql-editor">
                    <div class="editor-toolbar">
                        <div class="editor-toolbar-left">
                            <span class="editor-label">SQL Editor</span>
                        </div>
                        <div class="editor-toolbar-right">
                            <!-- Query History (TKT-174) -->
                            <div class="query-history-wrapper">
                                <button type="button" class="editor-btn" id="history-button" title="Query history">
                                    &#128338; History
                                </button>
                                <div class="query-history-dropdown" id="query-history-dropdown">
                                    <div class="query-history-empty">No query history yet</div>
                                </div>
                            </div>
                            <button type="button" class="editor-btn run-btn" id="run-button" title="Run query (Ctrl+Enter)">
                                &#9654; Run
                            </button>
                            <button type="button" class="editor-btn" id="copy-button" title="Copy SQL to clipboard">
                                üìã Copy
                            </button>
                            <button type="button" class="editor-btn" id="export-button" title="Export results as CSV">
                                üíæ Export
                            </button>
                        </div>
                    </div>
                    <div class="sql-editor-wrapper" id="sql-editor-wrapper">
                        <textarea class="sql-editor-placeholder" id="sql-editor-textarea"
                            placeholder="-- Write your SQL query here...&#10;-- Example: SELECT * FROM analytics_ipl_batting_career LIMIT 10;&#10;&#10;"
                            spellcheck="false">SELECT
  player_name,
  runs,
  balls_faced,
  strike_rate,
  average
FROM analytics_ipl_batting_career
ORDER BY runs DESC
LIMIT 20;</textarea>
                    </div>
                    <!-- Keyboard shortcuts hint (TKT-174) -->
                    <div class="editor-shortcuts-hint">
                        <kbd>Ctrl+Enter</kbd> Run &middot;
                        <kbd>Ctrl+L</kbd> Clear &middot;
                        <kbd>Ctrl+/</kbd> Comment &middot;
                        <kbd>Ctrl+Space</kbd> Autocomplete
                    </div>
                </div>

                <!-- Results Panel ‚Äî TKT-174 will wire up interactivity -->
                <div class="results-section" id="results-panel">
                    <div class="results-header">
                        <span class="results-label">Results</span>
                        <span class="results-meta" id="results-meta">Run a query to see results</span>
                    </div>
                    <div class="results-table-wrapper" id="results-table-wrapper">
                        <div class="results-empty">
                            <div class="results-empty-icon">üìä</div>
                            <div class="results-empty-text">No results yet</div>
                            <div class="results-empty-hint">Write a SQL query above and click Run, or choose an example query below</div>
                        </div>
                    </div>
                    <!-- Pagination (TKT-174) -->
                    <div class="results-pagination" id="results-pagination">
                        <span class="results-pagination-info" id="pagination-info">Showing 0 rows</span>
                        <div class="results-pagination-controls" id="pagination-controls"></div>
                    </div>
                </div>

                <!-- The First Take (formerly Andy Flower Insights) ‚Äî TKT-177 will wire up -->
                <div class="insights-section" id="andy-flower-insights">
                    <div class="insight-card">
                        <div class="insight-card-header">
                            <span class="icon">üèè</span>
                            <h4>The First Take</h4>
                            <span class="badge">Cricket Context</span>
                        </div>
                        <p class="insight-subtitle" style="font-size: 13px; font-style: italic; color: var(--text-secondary); margin-bottom: 8px;">
                            "Stephen A. wished he had this data before going on air"
                        </p>
                        <p>
                            Run a query to receive cricket context from Andy Flower, our domain expert.
                            He'll provide tactical interpretation of your results, highlight key trends,
                            and suggest related queries to deepen your analysis.
                        </p>
                    </div>
                </div>

                <!-- Example Queries Gallery (TKT-176: 17 curated queries) -->
                <div class="examples-section" id="example-queries">
                    <div class="examples-header">
                        <h3>Example Queries</h3>
                        <div class="examples-filter">
                            <button type="button" class="examples-filter-btn active" data-filter="all">All</button>
                            <button type="button" class="examples-filter-btn" data-filter="leaderboard">Leaderboard</button>
                            <button type="button" class="examples-filter-btn" data-filter="batting">Batting</button>
                            <button type="button" class="examples-filter-btn" data-filter="bowling">Bowling</button>
                            <button type="button" class="examples-filter-btn" data-filter="team">Team</button>
                            <button type="button" class="examples-filter-btn" data-filter="matchup">Matchup</button>
                            <button type="button" class="examples-filter-btn" data-filter="phase">Phase</button>
                            <button type="button" class="examples-filter-btn" data-filter="ipl2026">IPL 2026</button>
                        </div>
                    </div>
                    <div class="examples-grid" id="examples-grid">
                        <!-- Cards rendered by TKT-176 JS -->
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p class="footer-text">
                Cricket Playbook ‚Äî The Film Room | EPIC-012 | Powered by DuckDB-WASM | <a href="https://github.com/dwijesh-r/cricket-playbook" target="_blank">View on GitHub</a>
            </p>
        </footer>
    </main>

    <!-- Status Bar ‚Äî TKT-173 will wire up live stats -->
    <div class="status-bar" id="db-status-bar">
        <div class="status-bar-left">
            <div class="status-indicator">
                <span class="status-dot loading" id="status-dot"></span>
                <span id="status-text">Setting up...</span>
            </div>
        </div>
        <div class="status-bar-right">
            <span>15 scouting reports</span>
            <span>&middot;</span>
            <span>52 play diagrams</span>
            <span>&middot;</span>
            <span>Every IPL delivery</span>
        </div>
    </div>

    <!-- Global form submission blocker: prevent any accidental page reloads on mobile -->
    <script>
        document.addEventListener('submit', function(e) { e.preventDefault(); return false; }, true);
    </script>

    <!-- Safety timeout: if module fails to load, show error instead of infinite spinner -->
    <script>
        window._filmRoomReady = false;
        setTimeout(function() {
            if (!window._filmRoomReady) {
                var overlay = document.getElementById('loading-overlay');
                var progressText = document.getElementById('loading-progress-text');
                if (overlay && !overlay.classList.contains('hidden')) {
                    if (progressText) progressText.textContent = 'Loading timed out ‚Äî a CDN dependency may be unreachable. Check browser console (F12) for details.';
                    var btn = document.createElement('button');
                    btn.textContent = 'Dismiss & Browse Page';
                    btn.style.cssText = 'margin-top:16px;padding:10px 24px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:13px;font-weight:600;';
                    btn.onclick = function() { overlay.classList.add('hidden'); };
                    overlay.querySelector('.loading-steps').insertAdjacentElement('afterend', btn);
                }
            }
        }, 25000);
    </script>

    <!-- Main Application Module (TKT-173 DuckDB + TKT-174 CodeMirror & Enhancements) -->
    <script type="module">
        /* ==================== THEME ==================== */
        window.toggleTheme = function() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            document.querySelector('.theme-toggle').textContent = newTheme === 'dark' ? '\u{1F319}' : '\u{2600}\u{FE0F}';
        };

        /* ==================== MOBILE MENU ==================== */
        window.toggleMobileMenu = function() {
            const menu = document.getElementById('mobile-nav-menu');
            const btn = document.querySelector('.mobile-menu-btn');
            menu.classList.toggle('active');
            btn.classList.toggle('active');
        };

        /* ==================== INIT ==================== */
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.querySelector('.theme-toggle').textContent = savedTheme === 'dark' ? '\u{1F319}' : '\u{2600}\u{FE0F}';

        // Timer - User's local timezone
        function updateTime() {
            document.getElementById('navTime').textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
        }
        updateTime();
        setInterval(updateTime, 1000);

        /* ==================== UTILITY: escapeHtml (must be defined before usage) ==================== */
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        /* ==================== CODEMIRROR REMOVED ‚Äî TEXTAREA FALLBACK (TKT-174) ==================== */
        /* CodeMirror 6 removed: 8 CDN ESM imports caused page-blocking hangs on GitHub Pages.
           The textarea works reliably. CodeMirror can be re-added later via a bundled build. */

        /* ---- Textarea keyboard shortcut: Ctrl+Enter to run ---- */
        document.getElementById('sql-editor-textarea').addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                if (window.executeQuery) window.executeQuery();
            }
        });

        // Helper: get SQL from textarea
        function getEditorSQL() {
            return document.getElementById('sql-editor-textarea').value;
        }

        // Helper: set SQL in textarea
        function setEditorSQL(sqlText) {
            document.getElementById('sql-editor-textarea').value = sqlText;
        }

        function clearEditor() {
            setEditorSQL('');
            document.getElementById('sql-editor-textarea').focus();
        }

        /* ==================== QUERY HISTORY (TKT-174) ==================== */
        const HISTORY_KEY = 'cricket_playbook_query_history';
        const MAX_HISTORY = 10;

        function getQueryHistory() {
            try {
                return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            } catch { return []; }
        }

        function saveQueryHistory(sqlText) {
            const trimmed = sqlText.trim();
            if (!trimmed) return;
            let history = getQueryHistory();
            // Remove duplicate if exists
            history = history.filter(h => h.sql !== trimmed);
            // Add to front
            history.unshift({ sql: trimmed, timestamp: Date.now() });
            // Cap at MAX_HISTORY
            if (history.length > MAX_HISTORY) history = history.slice(0, MAX_HISTORY);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }

        function renderQueryHistoryDropdown() {
            const dropdown = document.getElementById('query-history-dropdown');
            const history = getQueryHistory();
            if (history.length === 0) {
                dropdown.innerHTML = '<div class="query-history-empty">No query history yet</div>';
                return;
            }
            let html = '';
            for (const entry of history) {
                const timeStr = new Date(entry.timestamp).toLocaleString('en-US', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                const preview = entry.sql.replace(/\n/g, ' ').substring(0, 80);
                html += `<div class="query-history-item" data-sql="${entry.sql.replace(/"/g, '&quot;')}" title="${entry.sql.replace(/"/g, '&quot;')}">
                    ${escapeHtml(preview)}${entry.sql.length > 80 ? '...' : ''}
                    <div style="font-size:10px;color:var(--text-tertiary);margin-top:2px;">${timeStr}</div>
                </div>`;
            }
            dropdown.innerHTML = html;

            // Wire click handlers
            dropdown.querySelectorAll('.query-history-item').forEach(item => {
                item.addEventListener('click', function() {
                    setEditorSQL(this.getAttribute('data-sql'));
                    dropdown.classList.remove('open');
                    document.getElementById('sql-editor-textarea').focus();
                    document.getElementById('sql-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
            });
        }

        // History button toggle
        document.getElementById('history-button').addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('query-history-dropdown');
            renderQueryHistoryDropdown();
            dropdown.classList.toggle('open');
        });

        // Close dropdown on outside click
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('query-history-dropdown');
            if (!e.target.closest('.query-history-wrapper')) {
                dropdown.classList.remove('open');
            }
        });

        /* ==================== RESULTS PANEL ENHANCEMENTS (TKT-174) ==================== */
        const PAGE_SIZE = 50;
        let currentPage = 0;
        let sortColumn = null;
        let sortDirection = 'asc'; // 'asc' or 'desc'
        let currentResultColumns = [];
        let currentResultRows = [];
        let currentElapsed = '0';

        function renderResultsPage() {
            const resultsWrapper = document.getElementById('results-table-wrapper');
            const paginationEl = document.getElementById('results-pagination');
            const paginationInfo = document.getElementById('pagination-info');
            const paginationControls = document.getElementById('pagination-controls');
            const resultsMeta = document.getElementById('results-meta');

            const columns = currentResultColumns;
            let rows = [...currentResultRows];
            const totalRows = rows.length;

            if (totalRows === 0) {
                paginationEl.classList.remove('visible');
                resultsWrapper.innerHTML = `
                    <div class="results-empty">
                        <div class="results-empty-icon">\u{1F4CB}</div>
                        <div class="results-empty-text">Query returned 0 rows</div>
                        <div class="results-empty-hint">Executed in ${currentElapsed}s</div>
                    </div>`;
                resultsMeta.textContent = `0 rows \u00B7 ${currentElapsed}s`;
                return;
            }

            // Sort if applicable
            if (sortColumn !== null && columns[sortColumn] !== undefined) {
                const colName = columns[sortColumn];
                rows.sort((a, b) => {
                    let va = a[colName], vb = b[colName];
                    if (va === null || va === undefined) va = '';
                    if (vb === null || vb === undefined) vb = '';
                    if (typeof va === 'number' && typeof vb === 'number') {
                        return sortDirection === 'asc' ? va - vb : vb - va;
                    }
                    const sa = String(va), sb = String(vb);
                    // Try numeric comparison
                    const na = parseFloat(sa), nb = parseFloat(sb);
                    if (!isNaN(na) && !isNaN(nb)) {
                        return sortDirection === 'asc' ? na - nb : nb - na;
                    }
                    return sortDirection === 'asc' ? sa.localeCompare(sb) : sb.localeCompare(sa);
                });
            }

            // Pagination
            const totalPages = Math.ceil(totalRows / PAGE_SIZE);
            if (currentPage >= totalPages) currentPage = totalPages - 1;
            if (currentPage < 0) currentPage = 0;
            const startIdx = currentPage * PAGE_SIZE;
            const endIdx = Math.min(startIdx + PAGE_SIZE, totalRows);
            const pageRows = rows.slice(startIdx, endIdx);

            // Update meta
            resultsMeta.textContent = `Showing ${(startIdx + 1).toLocaleString()}-${endIdx.toLocaleString()} of ${totalRows.toLocaleString()} rows \u00B7 ${currentElapsed}s`;

            // Build table
            let html = '<table class="results-table"><thead><tr>';
            html += '<th style="width:40px;text-align:right;min-width:40px;">#</th>';
            for (let ci = 0; ci < columns.length; ci++) {
                const sortClass = sortColumn === ci ? (sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc') : '';
                const sortIcon = sortColumn === ci ? (sortDirection === 'asc' ? '\u25B2' : '\u25BC') : '\u25B2';
                html += `<th class="${sortClass}" data-col-idx="${ci}" style="position:relative;">`;
                html += `${escapeHtml(columns[ci])}<span class="sort-icon">${sortIcon}</span>`;
                html += `<div class="col-resize-handle" data-col-idx="${ci}"></div>`;
                html += `</th>`;
            }
            html += '</tr></thead><tbody>';

            for (let i = 0; i < pageRows.length; i++) {
                html += '<tr>';
                html += `<td style="text-align:right;color:var(--text-tertiary);font-size:10px;">${startIdx + i + 1}</td>`;
                for (const col of columns) {
                    const val = pageRows[i][col];
                    const display = val === null || val === undefined
                        ? '<span style="color:var(--text-tertiary);font-style:italic">NULL</span>'
                        : escapeHtml(String(val));
                    html += `<td>${display}</td>`;
                }
                html += '</tr>';
            }
            html += '</tbody></table>';
            resultsWrapper.innerHTML = html;

            // Pagination controls
            if (totalPages > 1) {
                paginationEl.classList.add('visible');
                paginationInfo.textContent = `Showing ${(startIdx + 1).toLocaleString()}\u2013${endIdx.toLocaleString()} of ${totalRows.toLocaleString()} rows \u00B7 ${currentElapsed}s`;

                let ctrlHtml = '';
                ctrlHtml += `<button type="button" class="pagination-btn" id="pg-prev" ${currentPage === 0 ? 'disabled' : ''}>\u25C0 Prev</button>`;

                // Show page numbers (max 7 visible)
                const maxVisible = 7;
                let startPage = Math.max(0, currentPage - Math.floor(maxVisible / 2));
                let endPage = Math.min(totalPages, startPage + maxVisible);
                if (endPage - startPage < maxVisible) startPage = Math.max(0, endPage - maxVisible);

                if (startPage > 0) {
                    ctrlHtml += `<button type="button" class="pagination-btn" data-page="0">1</button>`;
                    if (startPage > 1) ctrlHtml += `<span style="color:var(--text-tertiary);padding:0 4px;">...</span>`;
                }

                for (let p = startPage; p < endPage; p++) {
                    ctrlHtml += `<button class="pagination-btn${p === currentPage ? ' active' : ''}" data-page="${p}">${p + 1}</button>`;
                }

                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) ctrlHtml += `<span style="color:var(--text-tertiary);padding:0 4px;">...</span>`;
                    ctrlHtml += `<button type="button" class="pagination-btn" data-page="${totalPages - 1}">${totalPages}</button>`;
                }

                ctrlHtml += `<button type="button" class="pagination-btn" id="pg-next" ${currentPage >= totalPages - 1 ? 'disabled' : ''}>Next \u25B6</button>`;
                paginationControls.innerHTML = ctrlHtml;

                // Wire pagination events
                document.getElementById('pg-prev')?.addEventListener('click', () => { currentPage--; renderResultsPage(); });
                document.getElementById('pg-next')?.addEventListener('click', () => { currentPage++; renderResultsPage(); });
                paginationControls.querySelectorAll('[data-page]').forEach(btn => {
                    btn.addEventListener('click', function() {
                        currentPage = parseInt(this.getAttribute('data-page'));
                        renderResultsPage();
                    });
                });
            } else {
                paginationEl.classList.remove('visible');
                // Show simple info for small result sets
            }

            // Wire sort click on column headers
            resultsWrapper.querySelectorAll('.results-table th[data-col-idx]').forEach(th => {
                th.addEventListener('click', function(e) {
                    if (e.target.classList.contains('col-resize-handle')) return; // Don't sort on resize
                    const idx = parseInt(this.getAttribute('data-col-idx'));
                    if (sortColumn === idx) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = idx;
                        sortDirection = 'asc';
                    }
                    currentPage = 0;
                    renderResultsPage();
                });
            });

            // Wire column resize
            wireColumnResize();
        }

        // ---- Column Resize (TKT-174) ----
        function wireColumnResize() {
            const handles = document.querySelectorAll('.col-resize-handle');
            handles.forEach(handle => {
                handle.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const th = this.parentElement;
                    const startX = e.pageX;
                    const startWidth = th.offsetWidth;
                    this.classList.add('resizing');

                    function onMouseMove(e2) {
                        const diff = e2.pageX - startX;
                        th.style.width = Math.max(40, startWidth + diff) + 'px';
                        th.style.minWidth = Math.max(40, startWidth + diff) + 'px';
                    }

                    function onMouseUp() {
                        handle.classList.remove('resizing');
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    }

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            });
        }

        /* ==================== DuckDB-WASM INITIALIZATION (TKT-173) ==================== */
        /* NOTE: DuckDB import is deferred to avoid top-level await blocking module evaluation.
           The import happens inside loadAndInitDuckDB() which is called at the bottom of this module. */
        let duckdb = null;

        // Global state
        let db = null;
        let conn = null;
        let lastQueryResults = null;
        let totalRowsLoaded = 0;

        // UI references
        const progressBar = document.getElementById('loading-progress');
        const progressText = document.getElementById('loading-progress-text');
        const overlay = document.getElementById('loading-overlay');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');

        // Table manifest - all 15 Parquet files
        const TABLE_FILES = [
            'dim_bowler_classification',
            'dim_franchise_alias',
            'dim_match',
            'dim_player',
            'dim_player_name_history',
            'dim_team',
            'dim_tournament',
            'dim_venue',
            'fact_ball',
            'fact_player_match_performance',
            'fact_powerplay',
            'ipl_2026_contracts',
            'ipl_2026_squads',
            'player_clusters_batters',
            'player_clusters_bowlers'
        ];

        function setLoadingStep(stepId, state) {
            const el = document.getElementById(stepId);
            if (!el) return;
            el.classList.remove('active', 'done');
            if (state === 'active') {
                el.classList.add('active');
                el.querySelector('.check').textContent = '...';
            } else if (state === 'done') {
                el.classList.add('done');
                el.querySelector('.check').textContent = '\u2713';
            }
        }

        function setProgress(pct, text) {
            progressBar.style.width = pct + '%';
            if (text) progressText.textContent = text;
        }

        function setStatus(state, text) {
            statusDot.classList.remove('loading', 'error');
            if (state === 'loading') statusDot.classList.add('loading');
            if (state === 'error') statusDot.classList.add('error');
            statusText.textContent = text;
        }

        // Detect mobile: small screen OR touch-only device
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || (window.innerWidth <= 768 && 'ontouchstart' in window);

        async function initDuckDB() {
            try {
                // Mobile Chrome/Safari have limited WASM memory (~300-500MB).
                // DuckDB + 15 Parquet tables can exceed that, crashing the tab.
                if (isMobile) {
                    setProgress(5, 'Mobile detected ‚Äî loading lightweight mode...');
                    console.log('Mobile device detected ‚Äî skipping DuckDB to prevent browser crash');
                    overlay.classList.add('hidden');
                    setStatus('connected', 'Mobile Mode');

                    const mobileHint = document.getElementById('results-table-wrapper');
                    if (mobileHint) {
                        mobileHint.innerHTML = `
                            <div class="results-empty" style="padding: 32px 20px;">
                                <div class="results-empty-icon" style="font-size: 48px;">üì±</div>
                                <div class="results-empty-text" style="font-size: 15px; margin: 12px 0;">The Film Room works best on desktop</div>
                                <div class="results-empty-hint" style="line-height: 1.7; max-width: 400px; margin: 0 auto;">
                                    The full scouting database (15 tables, 52 views, 2M+ rows) requires more memory than mobile browsers can handle.<br><br>
                                    <strong>On desktop:</strong> Full interactive SQL with live queries<br>
                                    <strong>On mobile:</strong> Browse the example queries and schema below, then run them on desktop
                                </div>
                            </div>`;
                    }
                    return;
                }

                setLoadingStep('step-engine', 'active');
                setProgress(5, 'Warming up the analytics engine...');

                const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
                const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

                const worker_url = URL.createObjectURL(
                    new Blob([`importScripts("${bundle.mainWorker}");`], { type: 'text/javascript' })
                );

                const worker = new Worker(worker_url);
                const logger = new duckdb.ConsoleLogger();
                db = new duckdb.AsyncDuckDB(logger, worker);

                // SharedArrayBuffer requires COOP/COEP headers (not available on GitHub Pages)
                // Fall back to single-threaded mode gracefully
                const hasSAB = typeof SharedArrayBuffer !== 'undefined';
                try {
                    await db.instantiate(bundle.mainModule, hasSAB ? bundle.pthreadWorker : null);
                } catch (instantiateErr) {
                    console.warn('Multi-threaded init failed, falling back to single-threaded:', instantiateErr.message);
                    await db.instantiate(bundle.mainModule);
                }
                URL.revokeObjectURL(worker_url);

                conn = await db.connect();

                setLoadingStep('step-engine', 'done');
                setProgress(20, 'Engine ready ‚Äî loading the scouting data...');

                setLoadingStep('step-tables', 'active');
                const basePath = 'data/sql_lab/tables/';

                for (let i = 0; i < TABLE_FILES.length; i++) {
                    const tableName = TABLE_FILES[i];
                    const filePath = basePath + tableName + '.parquet';
                    const pct = 20 + Math.round(((i + 1) / TABLE_FILES.length) * 50);
                    setProgress(pct, `Scouting ${tableName.replace(/_/g, ' ')}... ${i + 1}/${TABLE_FILES.length}`);

                    try {
                        const response = await fetch(filePath);
                        if (!response.ok) throw new Error(`HTTP ${response.status} for ${filePath}`);
                        const buffer = new Uint8Array(await response.arrayBuffer());
                        await db.registerFileBuffer(tableName + '.parquet', buffer);
                        await conn.query(`CREATE TABLE ${tableName} AS SELECT * FROM read_parquet('${tableName}.parquet')`);
                        const countResult = await conn.query(`SELECT count(*) AS cnt FROM ${tableName}`);
                        const rows = Number(countResult.toArray()[0].cnt);
                        totalRowsLoaded += rows;
                    } catch (tableErr) {
                        console.error(`Failed to load table ${tableName}:`, tableErr);
                    }
                }

                setLoadingStep('step-tables', 'done');
                setProgress(70, `All scouting reports loaded ‚Äî ${formatRowCount(totalRowsLoaded)} data points`);

                setLoadingStep('step-views', 'active');
                setProgress(72, 'Drawing up the play diagrams...');

                let viewsCreated = 0;
                let viewsFailed = 0;

                try {
                    const viewsResponse = await fetch('data/sql_lab/views.sql');
                    if (!viewsResponse.ok) throw new Error(`HTTP ${viewsResponse.status} for views.sql`);
                    const viewsSql = await viewsResponse.text();
                    const viewStatements = viewsSql.split(/(?=CREATE OR REPLACE VIEW)/i).filter(s => s.trim().length > 0 && s.trim().startsWith('CREATE'));

                    for (let i = 0; i < viewStatements.length; i++) {
                        const stmt = viewStatements[i].trim();
                        if (!stmt) continue;
                        const cleanStmt = stmt.replace(/;\s*$/, '');
                        try {
                            await conn.query(cleanStmt);
                            viewsCreated++;
                        } catch (viewErr) {
                            viewsFailed++;
                            console.warn(`View creation failed: ${viewErr.message.substring(0, 120)}`);
                        }
                        if (i % 5 === 0) {
                            const pct = 72 + Math.round(((i + 1) / viewStatements.length) * 23);
                            setProgress(pct, `Building playbook page ${i + 1} of ${viewStatements.length}...`);
                        }
                    }
                } catch (viewsErr) {
                    console.error('Failed to load views.sql:', viewsErr);
                }

                setLoadingStep('step-views', 'done');
                setProgress(95, `${viewsCreated} play diagrams ready`);

                setLoadingStep('step-ready', 'active');
                setProgress(100, `Game time! ${formatRowCount(totalRowsLoaded)} data points loaded`);

                await new Promise(resolve => setTimeout(resolve, 600));

                setLoadingStep('step-ready', 'done');
                overlay.classList.add('hidden');

                setStatus('connected', 'Film Room Active');
                updateStatusBarStats(viewsCreated);
                document.getElementById('run-button').disabled = false;

                console.log(`The Film Room ready: ${TABLE_FILES.length} tables, ${viewsCreated} views, ${formatRowCount(totalRowsLoaded)} rows`);
                if (viewsFailed > 0) console.warn(`${viewsFailed} views failed to create`);

            } catch (err) {
                console.error('DuckDB initialization failed:', err);
                setStatus('error', 'Technical Timeout');
                progressText.textContent = 'The engine stalled: ' + err.message;
                statusDot.classList.remove('loading');
                statusDot.classList.add('error');

                const overlayEl = document.getElementById('loading-overlay');
                const dismissBtn = document.createElement('button');
                dismissBtn.textContent = 'Dismiss & Continue';
                dismissBtn.style.cssText = 'margin-top:16px;padding:8px 20px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:13px;font-weight:600;';
                dismissBtn.onclick = () => overlayEl.classList.add('hidden');
                overlayEl.appendChild(dismissBtn);
            }
        }

        function formatRowCount(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(0) + 'K';
            return String(n);
        }

        function updateStatusBarStats(viewCount) {
            const rightBar = document.querySelector('.status-bar-right');
            rightBar.innerHTML = `
                <span>${TABLE_FILES.length} scouting reports</span>
                <span>&middot;</span>
                <span>${viewCount} play diagrams</span>
                <span>&middot;</span>
                <span>${formatRowCount(totalRowsLoaded)} data points</span>
            `;
        }

        /* ==================== SQL QUERY EXECUTION (TKT-173, enhanced TKT-174) ==================== */
        async function executeQuery() {
            if (!conn) {
                showError('Database not connected. Please wait for initialization to complete.');
                return;
            }

            const sqlText = getEditorSQL().trim();
            if (!sqlText) {
                showError('Please enter a SQL query.');
                return;
            }

            const runBtn = document.getElementById('run-button');
            const resultsMeta = document.getElementById('results-meta');

            runBtn.disabled = true;
            runBtn.innerHTML = '&#9654; Running...';
            resultsMeta.textContent = 'Executing query...';

            const startTime = performance.now();

            try {
                const result = await conn.query(sqlText);
                const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);

                const rows = result.toArray().map(row => {
                    const obj = {};
                    for (const field of result.schema.fields) {
                        let val = row[field.name];
                        if (typeof val === 'bigint') val = Number(val);
                        obj[field.name] = val;
                    }
                    return obj;
                });

                const columns = result.schema.fields.map(f => f.name);

                // Store for export
                lastQueryResults = { columns, rows };

                // Save to query history (TKT-174)
                saveQueryHistory(sqlText);

                // Render with pagination (TKT-174)
                currentResultColumns = columns;
                currentResultRows = rows;
                currentElapsed = elapsed;
                currentPage = 0;
                sortColumn = null;
                sortDirection = 'asc';
                renderResultsPage();

            } catch (err) {
                const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
                showError(err.message, elapsed);
                document.getElementById('results-pagination').classList.remove('visible');
            } finally {
                runBtn.disabled = false;
                runBtn.innerHTML = '&#9654; Run';
            }
        }

        // Make executeQuery available globally so CodeMirror keymap can call it
        window.executeQuery = executeQuery;

        function showError(message, elapsed) {
            const resultsMeta = document.getElementById('results-meta');
            const resultsWrapper = document.getElementById('results-table-wrapper');

            resultsMeta.textContent = elapsed ? `Error \u00B7 ${elapsed}s` : 'Error';
            resultsWrapper.innerHTML = `
                <div class="results-empty" style="color: var(--accent-red);">
                    <div class="results-empty-icon">\u26A0\uFE0F</div>
                    <div class="results-empty-text" style="color: var(--accent-red); font-weight: 600;">Query Error</div>
                    <div class="results-empty-hint" style="color: var(--text-secondary); max-width: 600px; word-break: break-word; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.6; text-align: left; background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-top: 8px;">${escapeHtml(message)}</div>
                </div>`;
        }

        /* ==================== COPY BUTTON (TKT-173, updated for CodeMirror TKT-174) ==================== */
        function copySQL() {
            const sqlText = getEditorSQL();
            if (!sqlText.trim()) return;

            navigator.clipboard.writeText(sqlText).then(() => {
                const btn = document.getElementById('copy-button');
                const original = btn.innerHTML;
                btn.innerHTML = '\u2705 Copied!';
                btn.style.borderColor = 'var(--accent-green)';
                setTimeout(() => { btn.innerHTML = original; btn.style.borderColor = ''; }, 1500);
            }).catch(() => {
                // Fallback
                const ta = document.createElement('textarea');
                ta.value = sqlText;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                const btn = document.getElementById('copy-button');
                const original = btn.innerHTML;
                btn.innerHTML = '\u2705 Copied!';
                setTimeout(() => { btn.innerHTML = original; }, 1500);
            });
        }

        /* ==================== EXPORT BUTTON (TKT-173) ==================== */
        function exportCSV() {
            if (!lastQueryResults || !lastQueryResults.rows.length) {
                const btn = document.getElementById('export-button');
                const original = btn.innerHTML;
                btn.innerHTML = '\u274C No data';
                setTimeout(() => { btn.innerHTML = original; }, 1500);
                return;
            }

            const { columns, rows } = lastQueryResults;
            const csvRows = [];
            csvRows.push(columns.map(c => `"${c.replace(/"/g, '""')}"`).join(','));
            for (const row of rows) {
                const values = columns.map(col => {
                    const val = row[col];
                    if (val === null || val === undefined) return '';
                    return `"${String(val).replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            }

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `research_desk_export_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            const btn = document.getElementById('export-button');
            const original = btn.innerHTML;
            btn.innerHTML = '\u2705 Exported!';
            btn.style.borderColor = 'var(--accent-green)';
            setTimeout(() => { btn.innerHTML = original; btn.style.borderColor = ''; }, 1500);
        }

        /* ==================== WIRE BUTTONS ==================== */
        document.getElementById('run-button').addEventListener('click', executeQuery);
        document.getElementById('copy-button').addEventListener('click', copySQL);
        document.getElementById('export-button').addEventListener('click', exportCSV);

        /* ==================== TKT-175: INTERACTIVE SCHEMA BROWSER ==================== */
        let tableMetadata = null;

        // Load metadata and build interactive schema browser
        async function buildInteractiveSchema() {
            try {
                const resp = await fetch('data/sql_lab/table_metadata.json');
                if (!resp.ok) throw new Error('Failed to load metadata');
                tableMetadata = await resp.json();
            } catch(e) {
                console.warn('TKT-175: Could not load table_metadata.json:', e);
                return;
            }

            const container = document.getElementById('schema-groups-container');
            if (!container) return;

            // Group tables by type
            const groups = [
                { label: 'Dimension Tables', type: 'dimension', cssClass: 'dim', icon: '&#9679;' },
                { label: 'Fact Tables', type: 'fact', cssClass: 'fact', icon: '&#9679;' },
                { label: 'Reference Tables', type: 'reference', cssClass: 'ref', icon: '&#9679;' },
                { label: 'Analytics Tables', type: 'analytics', cssClass: 'cluster', icon: '&#9679;' },
            ];

            let html = '';

            // Render table groups
            for (const group of groups) {
                const tables = Object.entries(tableMetadata.tables || {}).filter(([, info]) => info.type === group.type);
                if (tables.length === 0) continue;

                html += `<div class="schema-group" data-group-type="${group.type}">`;
                html += `<div class="schema-group-label">${group.label} (${tables.length})</div>`;

                for (const [name, info] of tables) {
                    const rowDisplay = formatSchemaRowCount(info.rows);
                    html += buildSchemaItem(name, info, group.cssClass, rowDisplay, 'table');
                }
                html += `</div>`;
            }

            // Render views group
            const views = Object.entries(tableMetadata.views || {});
            if (views.length > 0) {
                html += `<div class="schema-group" data-group-type="views">`;
                html += `<div class="schema-group-label">Analytics Views (${views.length})</div>`;
                for (const [name, info] of views) {
                    html += buildSchemaItem(name, info, 'view', '', 'view');
                }
                html += `</div>`;
            }

            container.innerHTML = html;
            wireSchemaInteractions();
        }

        function formatSchemaRowCount(n) {
            if (n === undefined || n === null) return '';
            if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(0) + 'K';
            return String(n);
        }

        function getColTypeClass(type) {
            const t = (type || '').toUpperCase();
            if (t === 'VARCHAR') return 'type-varchar';
            if (t === 'BIGINT') return 'type-bigint';
            if (t === 'HUGEINT') return 'type-hugeint';
            if (t === 'INTEGER') return 'type-integer';
            if (t === 'DOUBLE') return 'type-double';
            if (t === 'BOOLEAN') return 'type-boolean';
            return 'type-default';
        }

        function buildSchemaItem(name, info, cssClass, rowDisplay, itemType) {
            const columns = info.columns || [];
            const dataAttr = itemType === 'view' ? `data-view="${name}"` : `data-table="${name}"`;
            let html = '';
            html += `<div class="schema-item schema-item-${cssClass}" ${dataAttr}>`;
            html += `<span class="chevron">&#9654;</span>`;
            html += `<span class="icon">&#9679;</span>`;
            html += `<span class="table-name">${name}</span>`;
            html += `<button type="button" class="query-btn" title="SELECT * FROM ${name} LIMIT 100">SQL</button>`;
            if (rowDisplay) html += `<span class="row-count">${rowDisplay}</span>`;
            html += `</div>`;

            // Column sub-list
            html += `<div class="schema-columns" data-parent="${name}">`;
            for (const col of columns) {
                const typeClass = getColTypeClass(col.type);
                const tooltip = col.description ? ` title="${escapeHtml(col.description)}"` : '';
                html += `<div class="schema-col-item" data-col="${col.name}" data-parent-table="${name}"${tooltip}>`;
                html += `<span class="col-name">${col.name}</span>`;
                html += `<span class="col-type ${typeClass}">${col.type}</span>`;
                html += `</div>`;
            }
            html += `</div>`;
            return html;
        }

        function wireSchemaInteractions() {
            // Click schema item to expand/collapse columns
            document.querySelectorAll('#schema-groups-container .schema-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    // If clicking the SQL button, load query instead
                    if (e.target.classList.contains('query-btn')) {
                        e.stopPropagation();
                        const tableName = this.getAttribute('data-table') || this.getAttribute('data-view');
                        if (!tableName) return;
                        setEditorSQL(`SELECT * FROM ${tableName} LIMIT 100;`);
                        document.getElementById('sql-editor-textarea').focus();
                        document.getElementById('sql-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });
                        return;
                    }

                    const tableName = this.getAttribute('data-table') || this.getAttribute('data-view');
                    if (!tableName) return;

                    const columnsEl = document.querySelector(`.schema-columns[data-parent="${tableName}"]`);
                    if (!columnsEl) return;

                    const isExpanded = this.classList.contains('expanded');
                    if (isExpanded) {
                        this.classList.remove('expanded');
                        columnsEl.classList.remove('visible');
                    } else {
                        this.classList.add('expanded');
                        columnsEl.classList.add('visible');
                    }
                });
            });

            // Click column to insert into textarea at cursor
            document.querySelectorAll('#schema-groups-container .schema-col-item').forEach(colItem => {
                colItem.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const colName = this.getAttribute('data-col');
                    if (!colName) return;

                    const ta = document.getElementById('sql-editor-textarea');
                    const pos = ta.selectionStart || ta.value.length;
                    ta.value = ta.value.slice(0, pos) + colName + ta.value.slice(pos);
                    ta.focus();
                    ta.selectionStart = ta.selectionEnd = pos + colName.length;
                });
            });
        }

        // Schema search: filter by table name AND column names
        document.getElementById('schema-search').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase().trim();

            document.querySelectorAll('#schema-groups-container .schema-item').forEach(item => {
                const tableName = (item.getAttribute('data-table') || item.getAttribute('data-view') || '').toLowerCase();
                const columnsEl = document.querySelector(`.schema-columns[data-parent="${tableName}"]`);

                if (!query) {
                    item.style.display = '';
                    // Remove search-triggered expansions
                    if (item.hasAttribute('data-search-expanded')) {
                        item.classList.remove('expanded');
                        item.removeAttribute('data-search-expanded');
                        if (columnsEl) columnsEl.classList.remove('visible');
                    }
                    if (columnsEl) {
                        columnsEl.style.display = '';
                        columnsEl.querySelectorAll('.schema-col-item').forEach(c => c.style.display = '');
                    }
                    return;
                }

                // Check table name match
                let tableMatch = tableName.includes(query);

                // Check column name matches
                let anyColMatch = false;
                if (columnsEl) {
                    columnsEl.querySelectorAll('.schema-col-item').forEach(colItem => {
                        const colName = (colItem.getAttribute('data-col') || '').toLowerCase();
                        if (colName.includes(query)) {
                            anyColMatch = true;
                            colItem.style.display = '';
                        } else {
                            colItem.style.display = tableMatch ? '' : 'none';
                        }
                    });
                }

                if (tableMatch || anyColMatch) {
                    item.style.display = '';
                    // Auto-expand if column match found
                    if (anyColMatch && !tableMatch && columnsEl) {
                        if (!item.classList.contains('expanded')) {
                            item.setAttribute('data-search-expanded', 'true');
                        }
                        item.classList.add('expanded');
                        columnsEl.classList.add('visible');
                    }
                } else {
                    item.style.display = 'none';
                    if (columnsEl) columnsEl.style.display = 'none';
                }
            });

            // Show/hide group labels if all their items are hidden
            document.querySelectorAll('#schema-groups-container .schema-group').forEach(group => {
                const visibleItems = group.querySelectorAll('.schema-item[style=""], .schema-item:not([style])');
                const hasVisible = Array.from(group.querySelectorAll('.schema-item')).some(i => i.style.display !== 'none');
                group.style.display = hasVisible ? '' : 'none';
            });
        });

        /* ==================== SCHEMA SIDEBAR COLLAPSE (mobile) ==================== */
        document.querySelector('.schema-header').addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                document.querySelector('.schema-sidebar').classList.toggle('collapsed');
            }
        });

        // Build the schema browser
        buildInteractiveSchema();

        /* ==================== TKT-176: EXAMPLE QUERIES GALLERY ==================== */
        const EXAMPLE_QUERIES = [
            // Leaderboard
            {
                category: 'leaderboard',
                title: 'Top 20 IPL Run Scorers',
                description: 'All-time highest run scorers in IPL history with strike rates and averages.',
                sql: `SELECT player_name, innings, runs, balls_faced,\n  highest_score, fifties, hundreds,\n  ROUND(strike_rate, 1) AS strike_rate,\n  ROUND(batting_average, 1) AS avg\nFROM analytics_top_run_scorers\nLIMIT 20;`
            },
            {
                category: 'leaderboard',
                title: 'Top 20 IPL Wicket Takers',
                description: 'All-time leading wicket takers in IPL with economy and bowling averages.',
                sql: `SELECT player_name, matches_bowled, wickets,\n  ROUND(overs_bowled, 1) AS overs,\n  best_wickets || '/' || best_runs AS best,\n  ROUND(economy_rate, 2) AS economy,\n  ROUND(bowling_average, 1) AS avg\nFROM analytics_top_wicket_takers\nLIMIT 20;`
            },
            {
                category: 'leaderboard',
                title: 'Highest Strike Rates (min 500 balls)',
                description: 'Batters with the best strike rates in IPL, minimum 500 balls faced.',
                sql: `SELECT player_name, innings, runs, balls_faced,\n  ROUND(strike_rate, 2) AS strike_rate,\n  ROUND(batting_average, 1) AS avg,\n  ROUND(boundary_pct, 1) AS boundary_pct\nFROM analytics_ipl_batting_career\nWHERE balls_faced >= 500\nORDER BY strike_rate DESC\nLIMIT 20;`
            },
            // Batting
            {
                category: 'batting',
                title: 'Best Powerplay Batters',
                description: 'Top performers in the powerplay phase by strike rate, minimum 200 balls.',
                sql: `SELECT player_name, innings, runs, balls_faced,\n  ROUND(strike_rate, 2) AS strike_rate,\n  ROUND(batting_average, 1) AS avg,\n  ROUND(boundary_pct, 1) AS boundary_pct\nFROM analytics_ipl_batter_phase\nWHERE match_phase = 'powerplay'\n  AND balls_faced >= 200\nORDER BY strike_rate DESC\nLIMIT 20;`
            },
            {
                category: 'batting',
                title: 'Death Over Batting Specialists',
                description: 'Batters with the best death overs strike rate, minimum 200 balls faced.',
                sql: `SELECT player_name, innings, runs, balls_faced,\n  ROUND(strike_rate, 2) AS strike_rate,\n  fours, sixes,\n  ROUND(boundary_pct, 1) AS boundary_pct\nFROM analytics_ipl_batter_phase\nWHERE match_phase = 'death'\n  AND balls_faced >= 200\nORDER BY strike_rate DESC\nLIMIT 20;`
            },
            {
                category: 'batting',
                title: 'Most Sixes in IPL History',
                description: 'Players who have hit the most sixes across all IPL seasons.',
                sql: `SELECT player_name, innings, runs,\n  sixes, fours,\n  ROUND(strike_rate, 2) AS strike_rate,\n  ROUND(boundary_pct, 1) AS boundary_pct\nFROM analytics_ipl_batting_career\nWHERE balls_faced >= 100\nORDER BY sixes DESC\nLIMIT 20;`
            },
            // Bowling
            {
                category: 'bowling',
                title: 'Best Death Bowlers',
                description: 'Bowlers with the best economy rate in death overs, minimum 200 balls.',
                sql: `SELECT player_name, matches, balls_bowled,\n  ROUND(overs, 1) AS overs,\n  runs_conceded, wickets,\n  ROUND(economy_rate, 2) AS economy,\n  ROUND(dot_ball_pct, 1) AS dot_pct\nFROM analytics_ipl_bowler_phase\nWHERE match_phase = 'death'\n  AND balls_bowled >= 200\nORDER BY economy_rate ASC\nLIMIT 20;`
            },
            {
                category: 'bowling',
                title: 'Spin vs Pace Economy by Phase',
                description: 'Compare spin and pace bowling economy across powerplay, middle, and death phases.',
                sql: `SELECT\n  bc.bowling_style,\n  bp.match_phase,\n  COUNT(DISTINCT bp.player_id) AS bowlers,\n  SUM(bp.balls_bowled) AS total_balls,\n  ROUND(SUM(bp.runs_conceded) * 6.0 / SUM(bp.balls_bowled), 2) AS economy,\n  ROUND(SUM(bp.dot_balls) * 100.0 / SUM(bp.balls_bowled), 1) AS dot_pct\nFROM analytics_ipl_bowler_phase bp\nJOIN dim_bowler_classification bc ON bp.player_id = bc.player_id\nWHERE bp.balls_bowled >= 60\nGROUP BY bc.bowling_style, bp.match_phase\nORDER BY bc.bowling_style, bp.match_phase;`
            },
            {
                category: 'bowling',
                title: 'Most Dot Balls in IPL Career',
                description: 'Bowlers who have bowled the most dot balls in IPL history.',
                sql: `SELECT player_name, matches_bowled,\n  ROUND(overs_bowled, 1) AS overs,\n  wickets, dot_balls,\n  ROUND(dot_ball_pct, 1) AS dot_pct,\n  ROUND(economy_rate, 2) AS economy\nFROM analytics_ipl_bowling_career\nWHERE balls_bowled >= 300\nORDER BY dot_balls DESC\nLIMIT 20;`
            },
            // Team
            {
                category: 'team',
                title: 'IPL 2026 Squad Spend by Team',
                description: 'Total and average squad spend per team for IPL 2026 mega auction.',
                sql: `SELECT team_name,\n  COUNT(*) AS squad_size,\n  ROUND(SUM(price_cr), 2) AS total_spend_cr,\n  ROUND(AVG(price_cr), 2) AS avg_price_cr,\n  ROUND(MAX(price_cr), 2) AS top_buy_cr\nFROM ipl_2026_contracts\nGROUP BY team_name\nORDER BY total_spend_cr DESC;`
            },
            {
                category: 'team',
                title: 'Team Win Rates by Venue (IPL)',
                description: 'How each IPL team performs at different venues, sorted by win percentage.',
                sql: `SELECT dt.team_name, v.venue_name,\n  COUNT(*) AS matches,\n  SUM(CASE WHEN m.winner_id = dt.team_id THEN 1 ELSE 0 END) AS wins,\n  ROUND(SUM(CASE WHEN m.winner_id = dt.team_id THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) AS win_pct\nFROM dim_match m\nJOIN dim_venue v ON m.venue_id = v.venue_id\nJOIN dim_tournament t ON m.tournament_id = t.tournament_id\nJOIN dim_team dt ON dt.team_id IN (m.team1_id, m.team2_id)\nWHERE t.tournament_name LIKE '%Indian Premier League%'\nGROUP BY dt.team_name, v.venue_name\nHAVING COUNT(*) >= 5\nORDER BY win_pct DESC\nLIMIT 25;`
            },
            {
                category: 'team',
                title: 'Strongest Batting Lineups (IPL 2026)',
                description: 'IPL 2026 squads ranked by combined historical IPL batting performance.',
                sql: `SELECT team_name,\n  COUNT(*) AS batters,\n  SUM(ipl_runs) AS total_ipl_runs,\n  ROUND(AVG(ipl_sr), 1) AS avg_strike_rate,\n  ROUND(AVG(ipl_avg), 1) AS avg_batting_avg\nFROM analytics_ipl_squad_batting\nWHERE ipl_innings >= 5\nGROUP BY team_name\nORDER BY total_ipl_runs DESC;`
            },
            // Matchup
            {
                category: 'matchup',
                title: 'Virat Kohli vs Left-Arm Pace',
                description: 'How Virat Kohli has performed against left-arm pace bowling in IPL.',
                sql: `SELECT batter_name, bowler_type,\n  balls, runs, dismissals,\n  ROUND(strike_rate, 2) AS strike_rate,\n  ROUND(average, 1) AS average,\n  ROUND(boundary_pct, 1) AS boundary_pct\nFROM analytics_ipl_batter_vs_bowler_type\nWHERE batter_name LIKE '%Kohli%'\nORDER BY bowler_type;`
            },
            {
                category: 'matchup',
                title: 'Jasprit Bumrah vs Top Batters',
                description: 'Bumrah head-to-head record against batters with 10+ balls faced.',
                sql: `SELECT batter_name, balls, runs, dismissals,\n  ROUND(strike_rate, 2) AS strike_rate,\n  ROUND(dot_ball_pct, 1) AS dot_pct\nFROM analytics_ipl_batter_vs_bowler\nWHERE bowler_name LIKE '%Bumrah%'\n  AND balls >= 10\nORDER BY balls DESC\nLIMIT 20;`
            },
            // Phase Analysis
            {
                category: 'phase',
                title: 'Powerplay Run Rate by Team (Recent Seasons)',
                description: 'Average powerplay run rate per team in recent IPL seasons.',
                sql: `SELECT dt_bat.team_name AS batting_team,\n  COUNT(DISTINCT fb.match_id) AS matches,\n  SUM(fb.total_runs) AS pp_runs,\n  SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) AS pp_balls,\n  ROUND(SUM(fb.total_runs) * 6.0 / SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 2) AS run_rate\nFROM fact_ball fb\nJOIN dim_match m ON fb.match_id = m.match_id\nJOIN dim_tournament t ON m.tournament_id = t.tournament_id\nJOIN dim_team dt_bat ON fb.batting_team_id = dt_bat.team_id\nWHERE t.tournament_name LIKE '%Indian Premier League%'\n  AND m.season IN ('2024', '2024/25', '2025')\n  AND fb.match_phase = 'powerplay'\nGROUP BY dt_bat.team_name\nHAVING SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) >= 100\nORDER BY run_rate DESC;`
            },
            // IPL 2026
            {
                category: 'ipl2026',
                title: 'IPL 2026 Overseas Players',
                description: 'All overseas players in IPL 2026 squads with their roles and nationalities.',
                sql: `SELECT team_name, player_name, nationality,\n  role, age, batting_hand,\n  bowling_type\nFROM ipl_2026_squads\nWHERE nationality != 'India'\nORDER BY team_name, player_name;`
            },
            {
                category: 'ipl2026',
                title: 'Most Expensive IPL 2026 Buys',
                description: 'The biggest price tags from the IPL 2026 mega auction and retentions.',
                sql: `SELECT c.player_name, c.team_name,\n  c.price_cr, c.acquisition_type,\n  s.nationality, s.role, s.age\nFROM ipl_2026_contracts c\nJOIN ipl_2026_squads s\n  ON c.player_name = s.player_name\n  AND c.team_name = s.team_name\nORDER BY c.price_cr DESC\nLIMIT 25;`
            },
        ];

        function renderExampleQueries(filter) {
            const grid = document.getElementById('examples-grid');
            const filtered = filter === 'all' ? EXAMPLE_QUERIES : EXAMPLE_QUERIES.filter(q => q.category === filter);

            let html = '';
            for (const q of filtered) {
                const catClass = q.category === 'ipl2026' ? 'ipl2026' : q.category;
                const catLabel = q.category === 'ipl2026' ? 'IPL 2026' : q.category.charAt(0).toUpperCase() + q.category.slice(1);
                const sqlPreview = q.sql.replace(/\n/g, ' ').substring(0, 65);
                html += `<div class="example-card" data-category="${q.category}">`;
                html += `<span class="example-card-category ${catClass}">${catLabel}</span>`;
                html += `<h4>${escapeHtml(q.title)}</h4>`;
                html += `<div class="example-card-desc">${escapeHtml(q.description)}</div>`;
                html += `<p title="${escapeHtml(q.sql)}">${escapeHtml(sqlPreview)}...</p>`;
                html += `<button type="button" class="load-btn" data-sql="${q.sql.replace(/"/g, '&quot;')}">&#9654; Load Query</button>`;
                html += `</div>`;
            }
            grid.innerHTML = html;

            // Wire load buttons
            grid.querySelectorAll('.load-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const sqlText = this.getAttribute('data-sql');
                    setEditorSQL(sqlText);
                    document.getElementById('sql-editor-textarea').focus();
                    document.getElementById('sql-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
            });

            // Also make the whole card clickable (loads query)
            grid.querySelectorAll('.example-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (e.target.classList.contains('load-btn')) return; // Already handled
                    const btn = this.querySelector('.load-btn');
                    if (btn) {
                        const sqlText = btn.getAttribute('data-sql');
                        setEditorSQL(sqlText);
                        document.getElementById('sql-editor-textarea').focus();
                        document.getElementById('sql-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            });
        }

        // Render initial gallery
        renderExampleQueries('all');

        /* ==================== EXAMPLE FILTER (TKT-176) ==================== */
        document.querySelectorAll('.examples-filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.examples-filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const filterVal = this.getAttribute('data-filter') || 'all';
                renderExampleQueries(filterVal);
            });
        });

        /* ==================== NATURAL LANGUAGE QUERY ENGINE (TKT-177) ==================== */

        // ---- Team alias map for fuzzy matching ----
        const TEAM_ALIASES = {
            'csk':  'Chennai Super Kings',
            'chennai': 'Chennai Super Kings',
            'super kings': 'Chennai Super Kings',
            'mi':   'Mumbai Indians',
            'mumbai': 'Mumbai Indians',
            'rcb':  'Royal Challengers Bengaluru',
            'bangalore': 'Royal Challengers Bengaluru',
            'bengaluru': 'Royal Challengers Bengaluru',
            'royal challengers': 'Royal Challengers Bengaluru',
            'kkr':  'Kolkata Knight Riders',
            'kolkata': 'Kolkata Knight Riders',
            'knight riders': 'Kolkata Knight Riders',
            'dc':   'Delhi Capitals',
            'delhi': 'Delhi Capitals',
            'capitals': 'Delhi Capitals',
            'pbks': 'Punjab Kings',
            'punjab': 'Punjab Kings',
            'kxip': 'Punjab Kings',
            'rr':   'Rajasthan Royals',
            'rajasthan': 'Rajasthan Royals',
            'royals': 'Rajasthan Royals',
            'srh':  'Sunrisers Hyderabad',
            'hyderabad': 'Sunrisers Hyderabad',
            'sunrisers': 'Sunrisers Hyderabad',
            'gt':   'Gujarat Titans',
            'gujarat': 'Gujarat Titans',
            'titans': 'Gujarat Titans',
            'lsg':  'Lucknow Super Giants',
            'lucknow': 'Lucknow Super Giants',
            'super giants': 'Lucknow Super Giants',
        };

        // ---- Resolve a team token to canonical name or ILIKE pattern ----
        function resolveTeamName(token) {
            const lower = token.toLowerCase().trim();
            if (TEAM_ALIASES[lower]) return TEAM_ALIASES[lower];
            for (const [alias, full] of Object.entries(TEAM_ALIASES)) {
                if (alias.includes(lower) || lower.includes(alias)) return full;
            }
            return token;
        }

        // ---- Detect if a token looks like a team abbreviation or name ----
        function isTeamToken(token) {
            const lower = token.toLowerCase().trim();
            return TEAM_ALIASES.hasOwnProperty(lower) ||
                Object.values(TEAM_ALIASES).some(v => v.toLowerCase().includes(lower));
        }

        // ---- Phase keywords map ----
        const PHASE_MAP = {
            'powerplay': 'powerplay',
            'pp': 'powerplay',
            'power play': 'powerplay',
            'middle': 'middle',
            'middle overs': 'middle',
            'death': 'death',
            'death overs': 'death',
            'slog': 'death',
        };

        // ---- Helper: extract a limit number from the query ----
        function extractLimit(query) {
            const match = query.match(/\b(?:top|best|worst|first|last)\s+(\d+)\b/i);
            if (match) return parseInt(match[1]);
            const limitMatch = query.match(/\blimit\s+(\d+)\b/i);
            if (limitMatch) return parseInt(limitMatch[1]);
            return 20;
        }

        // ---- The main NL-to-SQL engine ----
        function naturalLanguageToSQL(query) {
            const q = query.trim();
            if (!q) return null;
            const lower = q.toLowerCase();
            const tokens = lower.split(/\s+/);
            const limit = extractLimit(lower);

            // ============ PATTERN 1: Player vs Player (batter vs bowler matchup) ============
            const vsPlayerMatch = lower.match(/^(.+?)\s+(?:vs\.?|versus|against|v)\s+(.+?)(?:\s+stats?)?$/i);
            if (vsPlayerMatch) {
                const left = vsPlayerMatch[1].trim();
                const right = vsPlayerMatch[2].trim();
                // Check if the right side is a team
                if (isTeamToken(right)) {
                    const teamName = resolveTeamName(right);
                    return {
                        sql: `SELECT * FROM analytics_ipl_batter_vs_team\nWHERE player_name ILIKE '%${left}%'\n  AND team_name ILIKE '%${teamName}%'\nORDER BY runs DESC;`,
                        type: 'player_vs_team',
                        entity: left,
                        context: teamName
                    };
                }
                // Check if right side is a bowling type
                if (/\b(spin|pace|fast|seam|left.?arm|right.?arm|off.?spin|leg.?spin|wrist.?spin)\b/.test(right)) {
                    return {
                        sql: `SELECT * FROM analytics_ipl_batter_vs_bowler_type\nWHERE batter_name ILIKE '%${left}%'\nORDER BY balls DESC;`,
                        type: 'player_vs_type',
                        entity: left,
                        context: right
                    };
                }
                // Otherwise it is batter vs bowler
                return {
                    sql: `SELECT * FROM analytics_ipl_batter_vs_bowler\nWHERE batter_name ILIKE '%${left}%'\n  AND bowler_name ILIKE '%${right}%'\nORDER BY balls DESC;`,
                    type: 'matchup',
                    entity: left,
                    context: right
                };
            }

            // ============ PATTERN 2: Player against spin/pace ============
            const vsTypeMatch = lower.match(/^(.+?)\s+(?:against|vs\.?|versus|v)\s+(spin|pace|fast|seam|left.?arm|right.?arm|off.?spin|leg.?spin|wrist.?spin)$/i);
            if (vsTypeMatch) {
                const player = vsTypeMatch[1].trim();
                return {
                    sql: `SELECT * FROM analytics_ipl_batter_vs_bowler_type\nWHERE batter_name ILIKE '%${player}%'\nORDER BY balls DESC;`,
                    type: 'player_vs_type',
                    entity: player,
                    context: vsTypeMatch[2].trim()
                };
            }

            // ============ PATTERN 3: Most expensive players / auction / contracts ============
            if (/\b(most expensive|highest paid|costliest|auction|contracts?|price|retained|rtm)\b/.test(lower)) {
                if (/\b(cheap|lowest|bargain|affordable)\b/.test(lower)) {
                    return {
                        sql: `SELECT player_name, team_name, price_cr, acquisition_type, year_joined\nFROM ipl_2026_contracts\nORDER BY price_cr ASC\nLIMIT ${limit};`,
                        type: 'contracts',
                        entity: 'cheapest players'
                    };
                }
                let teamFound = null;
                for (const [alias, full] of Object.entries(TEAM_ALIASES)) {
                    if (lower.includes(alias)) { teamFound = full; break; }
                }
                if (teamFound) {
                    return {
                        sql: `SELECT player_name, team_name, price_cr, acquisition_type, year_joined\nFROM ipl_2026_contracts\nWHERE team_name ILIKE '%${teamFound}%'\nORDER BY price_cr DESC;`,
                        type: 'contracts',
                        entity: teamFound
                    };
                }
                return {
                    sql: `SELECT player_name, team_name, price_cr, acquisition_type, year_joined\nFROM ipl_2026_contracts\nORDER BY price_cr DESC\nLIMIT ${limit};`,
                    type: 'contracts',
                    entity: 'most expensive'
                };
            }

            // ============ PATTERN 4: Overseas / foreign players ============
            if (/\b(overseas|foreign|international|non.?indian|imports?)\b/.test(lower)) {
                let teamFound = null;
                for (const [alias, full] of Object.entries(TEAM_ALIASES)) {
                    if (lower.includes(alias)) { teamFound = full; break; }
                }
                const teamClause = teamFound ? `\n  AND team_name ILIKE '%${teamFound}%'` : '';
                return {
                    sql: `SELECT player_name, team_name, nationality, role, age\nFROM ipl_2026_squads\nWHERE nationality != 'India'${teamClause}\nORDER BY team_name, player_name;`,
                    type: 'overseas',
                    entity: teamFound || 'all teams'
                };
            }

            // ============ PATTERN 5: Team squad ============
            if (/\b(squad|roster|team\s*list|players?)\b/.test(lower) || /\bwho\s+(is|are)\s+in\b/.test(lower)) {
                let teamFound = null;
                for (const [alias, full] of Object.entries(TEAM_ALIASES)) {
                    if (lower.includes(alias)) { teamFound = full; break; }
                }
                if (teamFound) {
                    return {
                        sql: `SELECT player_name, role, nationality, age, batting_hand, bowling_type\nFROM ipl_2026_squads\nWHERE team_name ILIKE '%${teamFound}%'\nORDER BY role, player_name;`,
                        type: 'squad',
                        entity: teamFound
                    };
                }
            }

            // ============ PATTERN 6: Team batting / bowling analysis ============
            if (/\b(batting|bowl(?:ing)?)\b/.test(lower)) {
                let teamFound = null;
                for (const [alias, full] of Object.entries(TEAM_ALIASES)) {
                    if (lower.includes(alias)) { teamFound = full; break; }
                }
                if (teamFound) {
                    const isBowling = /\bbowl(?:ing|ers?)?\b/.test(lower);
                    const view = isBowling ? 'analytics_ipl_squad_bowling' : 'analytics_ipl_squad_batting';
                    return {
                        sql: `SELECT * FROM ${view}\nWHERE team_name ILIKE '%${teamFound}%'\nORDER BY ${isBowling ? 'player_name' : 'ipl_runs DESC NULLS LAST'};`,
                        type: 'team_analysis',
                        entity: teamFound,
                        context: isBowling ? 'bowling' : 'batting'
                    };
                }
            }

            // ============ PATTERN 7: Phase-specific queries ============
            let detectedPhase = null;
            for (const [keyword, phase] of Object.entries(PHASE_MAP)) {
                if (lower.includes(keyword)) { detectedPhase = phase; break; }
            }
            if (detectedPhase) {
                const isBowling = /\bbowl(?:ing|ers?)?\b/.test(lower);
                const isBatting = /\bbat(?:ting|ters?|smen|sman)?\b/.test(lower) || /\b(run scorers?|hitters?|strikers?)\b/.test(lower);

                // Check for a specific player in the phase query
                const playerInPhase = lower.replace(/\b(powerplay|middle|death|slog|pp)\b/gi, '')
                    .replace(/\b(bat(?:ting|ters?|smen|sman)?|bowl(?:ing|ers?)?|best|top|worst|\d+|stats?|in|the|overs?|phase|hitters?|strikers?|run scorers?)\b/gi, '')
                    .trim();
                if (playerInPhase && playerInPhase.length >= 3) {
                    const view = isBowling ? 'analytics_ipl_bowler_phase' : 'analytics_ipl_batter_phase';
                    return {
                        sql: `SELECT * FROM ${view}\nWHERE player_name ILIKE '%${playerInPhase}%'\n  AND match_phase = '${detectedPhase}'\nORDER BY ${isBowling ? 'wickets DESC' : 'runs DESC'};`,
                        type: 'phase',
                        entity: playerInPhase,
                        context: detectedPhase
                    };
                }

                if (isBowling || (!isBatting && /\b(economy|wickets?|dot.?ball)\b/.test(lower))) {
                    return {
                        sql: `SELECT player_name, match_phase, matches, balls_bowled, overs, runs_conceded, wickets, economy_rate, dot_ball_pct\nFROM analytics_ipl_bowler_phase\nWHERE match_phase = '${detectedPhase}'\n  AND balls_bowled >= 120\nORDER BY ${/economy/.test(lower) ? 'economy_rate ASC' : 'wickets DESC'}\nLIMIT ${limit};`,
                        type: 'phase_leaderboard',
                        entity: detectedPhase + ' bowlers',
                        context: 'bowling'
                    };
                }
                return {
                    sql: `SELECT player_name, match_phase, innings, runs, balls_faced, strike_rate, batting_average, boundary_pct\nFROM analytics_ipl_batter_phase\nWHERE match_phase = '${detectedPhase}'\n  AND balls_faced >= 120\nORDER BY ${/average/.test(lower) ? 'batting_average DESC' : (/boundary/.test(lower) ? 'boundary_pct DESC' : 'strike_rate DESC')}\nLIMIT ${limit};`,
                    type: 'phase_leaderboard',
                    entity: detectedPhase + ' batters',
                    context: 'batting'
                };
            }

            // ============ PATTERN 8: Leaderboard queries ============
            if (/\b(top|best|highest|most|leading)\b/.test(lower) && /\b(bat(?:ters?|smen|sman)?|run.?scorers?|strike.?rate|sr|average|centuries|hundreds|fifties|50s|100s|sixes|fours|boundaries)\b/.test(lower)) {
                let orderBy = 'runs DESC';
                if (/strike.?rate|sr\b/.test(lower)) orderBy = 'strike_rate DESC';
                else if (/\baverage\b/.test(lower)) orderBy = 'batting_average DESC';
                else if (/\b(centuries|hundreds|100s)\b/.test(lower)) orderBy = 'hundreds DESC';
                else if (/\b(fifties|50s)\b/.test(lower)) orderBy = 'fifties DESC';
                else if (/\bsixes\b/.test(lower)) orderBy = 'sixes DESC';
                else if (/\bfours\b/.test(lower)) orderBy = 'fours DESC';
                else if (/\b(boundaries)\b/.test(lower)) orderBy = 'boundary_pct DESC';

                const minFilter = /strike.?rate|sr|average/.test(lower) ? '\n  AND balls_faced >= 500' : '';
                return {
                    sql: `SELECT player_name, primary_role, innings, runs, balls_faced, strike_rate, batting_average, boundary_pct, fifties, hundreds, sixes\nFROM analytics_ipl_batting_career\nWHERE innings >= 10${minFilter}\nORDER BY ${orderBy}\nLIMIT ${limit};`,
                    type: 'leaderboard',
                    entity: 'batters',
                    context: orderBy.split(' ')[0]
                };
            }

            if (/\b(top|best|highest|most|leading|lowest)\b/.test(lower) && /\b(bowl(?:ers?|ing)?|wicket.?takers?|wickets?|economy|econ|dot.?ball)\b/.test(lower)) {
                let orderBy = 'wickets DESC';
                if (/economy|econ\b/.test(lower)) orderBy = 'economy_rate ASC';
                else if (/dot.?ball/.test(lower)) orderBy = 'dot_ball_pct DESC';
                else if (/\baverage\b/.test(lower)) orderBy = 'bowling_average ASC';
                else if (/strike.?rate|sr\b/.test(lower)) orderBy = 'bowling_strike_rate ASC';

                const minFilter = /economy|econ|dot.?ball|average|strike.?rate|sr/.test(lower) ? '\n  AND balls_bowled >= 500' : '';
                return {
                    sql: `SELECT player_name, primary_role, matches_bowled, overs_bowled, wickets, economy_rate, bowling_average, bowling_strike_rate, dot_ball_pct, best_wickets, best_runs\nFROM analytics_ipl_bowling_career\nWHERE matches_bowled >= 10${minFilter}\nORDER BY ${orderBy}\nLIMIT ${limit};`,
                    type: 'leaderboard',
                    entity: 'bowlers',
                    context: orderBy.split(' ')[0]
                };
            }

            // ============ PATTERN 9: Season/Year-wise queries ============
            const seasonMatch = /\b(year\s*(?:wise|by\s*year)|season\s*(?:wise|by\s*season)|per\s*(?:season|year)|by\s*(?:season|year)|each\s*(?:season|year)|every\s*(?:season|year)|season\s*by\s*season|year\s*by\s*year|yearly|annually|all\s*seasons?|over\s*the\s*years?)\b/i;
            if (seasonMatch.test(lower)) {
                // Extract player name by stripping season keywords + noise
                let playerName = lower
                    .replace(seasonMatch, '')
                    .replace(/\b(stats?|career|record|performance|data|numbers?|info|details|batting|bowling|show|me|get|find|search|look\s*up|for|of|in|ipl|the|how|has|many|runs|scored|wickets|taken)\b/gi, '')
                    .replace(/\s+/g, ' ').trim();

                if (playerName.length >= 2 && !isTeamToken(playerName)) {
                    const isBowling = /\bbowl(?:ing|ers?)?\b/.test(lower) || /\bwickets?\b/.test(lower) || /\beconomy\b/.test(lower);

                    if (isBowling) {
                        return {
                            sql: `WITH ipl AS (\n  SELECT dm.match_id, dm.season\n  FROM dim_match dm\n  JOIN dim_tournament dt ON dm.tournament_id = dt.tournament_id\n  WHERE dt.tournament_name = 'Indian Premier League'\n)\nSELECT dp.current_name AS player_name, ipl.season,\n  count(DISTINCT fb.match_id) AS matches,\n  round(sum(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) / 6.0, 1) AS overs,\n  sum(fb.total_runs) AS runs_conceded,\n  sum(CASE WHEN fb.is_wicket AND fb.wicket_type NOT IN ('run out','retired hurt','retired out') THEN 1 ELSE 0 END) AS wickets,\n  round(sum(fb.total_runs) * 6.0 / nullif(sum(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS economy,\n  round(sum(fb.total_runs) * 1.0 / nullif(sum(CASE WHEN fb.is_wicket AND fb.wicket_type NOT IN ('run out','retired hurt','retired out') THEN 1 ELSE 0 END), 0), 2) AS average\nFROM fact_ball fb\nJOIN dim_player dp ON fb.bowler_id = dp.player_id\nJOIN ipl ON fb.match_id = ipl.match_id\nWHERE dp.current_name ILIKE '%${playerName}%'\nGROUP BY dp.current_name, ipl.season\nORDER BY ipl.season;`,
                            type: 'player_season',
                            entity: playerName,
                            context: 'bowling'
                        };
                    }

                    return {
                        sql: `WITH ipl AS (\n  SELECT dm.match_id, dm.season\n  FROM dim_match dm\n  JOIN dim_tournament dt ON dm.tournament_id = dt.tournament_id\n  WHERE dt.tournament_name = 'Indian Premier League'\n)\nSELECT dp.current_name AS player_name, ipl.season,\n  count(DISTINCT fb.match_id) AS innings,\n  sum(fb.batter_runs) AS runs,\n  sum(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) AS balls,\n  round(sum(fb.batter_runs) * 100.0 / nullif(sum(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS strike_rate,\n  round(sum(fb.batter_runs) * 1.0 / nullif(sum(CASE WHEN fb.is_wicket AND fb.player_out_id = fb.batter_id THEN 1 ELSE 0 END), 0), 2) AS average,\n  sum(CASE WHEN fb.batter_runs = 4 THEN 1 ELSE 0 END) AS fours,\n  sum(CASE WHEN fb.batter_runs = 6 THEN 1 ELSE 0 END) AS sixes\nFROM fact_ball fb\nJOIN dim_player dp ON fb.batter_id = dp.player_id\nJOIN ipl ON fb.match_id = ipl.match_id\nWHERE dp.current_name ILIKE '%${playerName}%'\nGROUP BY dp.current_name, ipl.season\nORDER BY ipl.season;`,
                        type: 'player_season',
                        entity: playerName,
                        context: 'batting'
                    };
                }
            }

            // ============ PATTERN 10: Venue-based queries ============
            const venueMatch = lower.match(/^(.+?)\s+(?:at|in|@)\s+(.+?)(?:\s+(?:stats?|record|performance|data))?$/i);
            if (venueMatch) {
                const subject = venueMatch[1].trim().replace(/\b(stats?|record|performance|data|show|me|get|find)\b/gi, '').trim();
                const venue = venueMatch[2].trim();

                if (subject.length >= 2 && venue.length >= 2 && !isTeamToken(subject)) {
                    const isBowling = /\bbowl(?:ing|ers?)?\b/.test(lower);
                    if (isBowling) {
                        return {
                            sql: `SELECT bowler_name, venue, matches, balls, runs_conceded, wickets, economy, average, dot_ball_pct\nFROM analytics_ipl_bowler_venue\nWHERE bowler_name ILIKE '%${subject}%'\n  AND venue ILIKE '%${venue}%'\nORDER BY matches DESC;`,
                            type: 'player_venue',
                            entity: subject,
                            context: venue
                        };
                    }
                    return {
                        sql: `SELECT batter_name, venue, innings, runs, balls, strike_rate, average, boundary_pct, sixes\nFROM analytics_ipl_batter_venue\nWHERE batter_name ILIKE '%${subject}%'\n  AND venue ILIKE '%${venue}%'\nORDER BY innings DESC;`,
                        type: 'player_venue',
                        entity: subject,
                        context: venue
                    };
                }
            }

            // ============ PATTERN 11: Direct "[name] stats" / "show me [name]" ============
            const playerLookupMatch = lower.match(/^(?:show\s+(?:me\s+)?|get\s+|find\s+|search\s+|look\s*up\s+)?(.+?)(?:\s+(?:stats?|career|record|numbers?|profile|performance|data|batting|bowling|info|details))?$/i);
            if (playerLookupMatch) {
                let playerName = playerLookupMatch[1].trim();
                playerName = playerName.replace(/^(?:stats?\s+(?:for|of)\s+|data\s+(?:for|of)\s+|career\s+(?:for|of)\s+|record\s+(?:for|of)\s+)/i, '').trim();
                playerName = playerName.replace(/\s+(?:stats?|career|record|numbers?|profile|performance|data|info|details)$/i, '').trim();
                // Strip leftover noise words that earlier patterns should have caught
                playerName = playerName.replace(/\b(year\s*wise|season\s*wise|per\s*(?:season|year)|by\s*(?:season|year)|each\s*(?:season|year)|every\s*(?:season|year)|yearly|annually|all\s*time|overall|ipl|in\s*ipl|total|how|many|has|scored|taken|what|is|are|the|his|her|runs?|wickets?)\b/gi, '').replace(/\s+/g, ' ').trim();

                if (playerName.length < 2) return null;

                // Check if this is actually a team query
                if (isTeamToken(playerName)) {
                    const teamName = resolveTeamName(playerName);
                    if (/\bbowl(?:ing|ers?)?\b/.test(lower)) {
                        return {
                            sql: `SELECT * FROM analytics_ipl_squad_bowling\nWHERE team_name ILIKE '%${teamName}%'\nORDER BY player_name;`,
                            type: 'team_analysis',
                            entity: teamName,
                            context: 'bowling'
                        };
                    }
                    if (/\bbat(?:ting|ters?)?\b/.test(lower)) {
                        return {
                            sql: `SELECT * FROM analytics_ipl_squad_batting\nWHERE team_name ILIKE '%${teamName}%'\nORDER BY ipl_runs DESC NULLS LAST;`,
                            type: 'team_analysis',
                            entity: teamName,
                            context: 'batting'
                        };
                    }
                    return {
                        sql: `SELECT player_name, role, nationality, age, batting_hand, bowling_type\nFROM ipl_2026_squads\nWHERE team_name ILIKE '%${teamName}%'\nORDER BY role, player_name;`,
                        type: 'squad',
                        entity: teamName
                    };
                }

                // Player lookup: check if bowling-specific
                if (/\bbowl(?:ing)?\b/.test(lower)) {
                    return {
                        sql: `SELECT player_name, primary_role, matches_bowled, overs_bowled, wickets, economy_rate, bowling_average, bowling_strike_rate, dot_ball_pct\nFROM analytics_ipl_bowling_career\nWHERE player_name ILIKE '%${playerName}%';`,
                        type: 'player_bowling',
                        entity: playerName
                    };
                }

                // Default: batting career lookup
                return {
                    sql: `SELECT player_name, primary_role, innings, runs, balls_faced, strike_rate, batting_average, boundary_pct, fifties, hundreds, sixes\nFROM analytics_ipl_batting_career\nWHERE player_name ILIKE '%${playerName}%';`,
                    type: 'player_lookup',
                    entity: playerName
                };
            }

            return null;
        }

        // Make it globally accessible
        window.naturalLanguageToSQL = naturalLanguageToSQL;

        /* ==================== "THE FIRST TAKE" INSIGHT GENERATOR (TKT-177) ==================== */
        let lastNLQueryType = null;
        let lastNLEntity = null;
        let lastNLContext = null;

        function generateFirstTakeInsight(columns, rows, queryType, entity, context) {
            if (!rows || rows.length === 0) {
                return `<p style="font-size:13px;color:var(--text-secondary);line-height:1.6;">
                    No results to analyse here. That is unusual \u2014 let us check if the query or spelling needs adjusting.
                    Try a broader search or check the schema browser for available views.
                </p>`;
            }

            const firstRow = rows[0];
            const totalRows = rows.length;

            function fmt(n) {
                if (n === null || n === undefined) return 'N/A';
                if (typeof n === 'number') return n % 1 === 0 ? n.toLocaleString() : n.toFixed(2);
                return String(n);
            }

            function colAvg(colName) {
                const vals = rows.map(r => r[colName]).filter(v => v !== null && v !== undefined && typeof v === 'number');
                if (vals.length === 0) return null;
                return vals.reduce((a, b) => a + b, 0) / vals.length;
            }

            function pctAboveAvg(val, avg) {
                if (!avg || avg === 0) return null;
                return (((val - avg) / avg) * 100).toFixed(1);
            }

            let insight = '';

            switch (queryType) {
                case 'leaderboard': {
                    const name = firstRow.player_name || firstRow.batter_name || 'The leader';
                    if (context === 'runs' || context === 'wickets') {
                        const statVal = firstRow[context] || firstRow.runs || firstRow.wickets;
                        const avg = colAvg(context) || colAvg('runs') || colAvg('wickets');
                        const pct = pctAboveAvg(statVal, avg);
                        insight = `Right, let us talk about this leaderboard. <strong>${escapeHtml(name)}</strong> sits at the top with <strong>${fmt(statVal)} ${context}</strong>.`;
                        if (pct && parseFloat(pct) > 0) {
                            insight += ` That is <strong>${pct}%</strong> above the group average in this sample.`;
                        }
                        insight += ` When you are scouting, this is your benchmark \u2014 everyone else is chasing this standard.`;
                        if (totalRows >= 3) {
                            const third = rows[2];
                            insight += ` Keep an eye on <strong>${escapeHtml(third.player_name || third.batter_name || 'the third name')}</strong> in third \u2014 that is often where the real value sits in squad building.`;
                        }
                    } else {
                        const keyStat = context || 'strike_rate';
                        const val = firstRow[keyStat];
                        insight = `Looking at this data, <strong>${escapeHtml(name)}</strong> leads with a ${keyStat.replace(/_/g, ' ')} of <strong>${fmt(val)}</strong>.`;
                        insight += ` This is a ${totalRows}-deep leaderboard \u2014 important to look beyond the headline number and consider sample size before drawing conclusions.`;
                    }
                    break;
                }
                case 'player_lookup':
                case 'player_bowling': {
                    const name = firstRow.player_name || firstRow.batter_name || entity;
                    if (firstRow.innings !== undefined) {
                        insight = `Here is the career dossier on <strong>${escapeHtml(name)}</strong>: <strong>${fmt(firstRow.innings)}</strong> innings`;
                        if (firstRow.runs !== undefined) insight += `, <strong>${fmt(firstRow.runs)}</strong> runs`;
                        if (firstRow.batting_average !== undefined) insight += ` at an average of <strong>${fmt(firstRow.batting_average)}</strong>`;
                        if (firstRow.strike_rate !== undefined) insight += ` and a strike rate of <strong>${fmt(firstRow.strike_rate)}</strong>`;
                        insight += '.';
                        if (firstRow.strike_rate && firstRow.strike_rate > 140) {
                            insight += ` That strike rate is in the impact zone \u2014 this is someone who shifts momentum.`;
                        } else if (firstRow.batting_average && firstRow.batting_average > 35) {
                            insight += ` Averaging above 35 in T20 cricket \u2014 that is rare consistency under pressure.`;
                        }
                    } else if (firstRow.wickets !== undefined) {
                        insight = `The bowling profile for <strong>${escapeHtml(name)}</strong>: <strong>${fmt(firstRow.wickets)}</strong> wickets`;
                        if (firstRow.economy_rate !== undefined) insight += ` at an economy of <strong>${fmt(firstRow.economy_rate)}</strong>`;
                        if (firstRow.bowling_average !== undefined) insight += `, average <strong>${fmt(firstRow.bowling_average)}</strong>`;
                        if (firstRow.bowling_strike_rate !== undefined) insight += `, strike rate <strong>${fmt(firstRow.bowling_strike_rate)}</strong>`;
                        insight += '.';
                        if (firstRow.economy_rate && firstRow.economy_rate < 7.5) {
                            insight += ` An economy under 7.5 in T20s is elite \u2014 this bowler controls scoring pressure.`;
                        }
                    } else {
                        insight = `Data loaded for <strong>${escapeHtml(name)}</strong>. ${totalRows} record${totalRows > 1 ? 's' : ''} found.`;
                    }
                    break;
                }
                case 'squad': {
                    const teamName = entity || 'This squad';
                    const overseas = rows.filter(r => r.nationality && r.nationality !== 'India').length;
                    const indian = totalRows - overseas;
                    insight = `<strong>${escapeHtml(teamName)}</strong> has <strong>${totalRows}</strong> players in the squad`;
                    insight += ` \u2014 <strong>${overseas}</strong> overseas slots used.`;
                    if (overseas > 0) {
                        const overseasNames = rows.filter(r => r.nationality && r.nationality !== 'India').slice(0, 4).map(r => r.player_name);
                        insight += ` Key overseas contingent: ${overseasNames.map(n => '<strong>' + escapeHtml(n) + '</strong>').join(', ')}.`;
                    }
                    insight += ` That is ${indian} Indian players forming the core \u2014 crucial for building the middle overs structure.`;
                    break;
                }
                case 'team_analysis': {
                    const teamName = entity || 'This team';
                    const side = context || 'batting';
                    insight = `<strong>${escapeHtml(teamName)}</strong> ${side} analysis across <strong>${totalRows}</strong> squad members.`;
                    if (side === 'batting' && firstRow.ipl_runs !== undefined) {
                        const topScorer = rows.reduce((a, b) => ((b.ipl_runs || 0) > (a.ipl_runs || 0) ? b : a), rows[0]);
                        insight += ` The anchor is <strong>${escapeHtml(topScorer.player_name)}</strong> with <strong>${fmt(topScorer.ipl_runs)}</strong> IPL runs.`;
                        const uncapped = rows.filter(r => !r.ipl_innings || r.ipl_innings === 0).length;
                        if (uncapped > 0) insight += ` ${uncapped} player${uncapped > 1 ? 's are' : ' is'} uncapped at IPL level \u2014 development opportunities there.`;
                    }
                    break;
                }
                case 'contracts': {
                    const topPlayer = firstRow.player_name || 'Top pick';
                    insight = `Looking at the money \u2014 <strong>${escapeHtml(topPlayer)}</strong> at <strong>${fmt(firstRow.price_cr)} Cr</strong>`;
                    if (firstRow.team_name) insight += ` for ${escapeHtml(firstRow.team_name)}`;
                    insight += '.';
                    if (totalRows >= 5) {
                        const totalSpend = rows.slice(0, Math.min(totalRows, limit)).reduce((s, r) => s + (r.price_cr || 0), 0);
                        insight += ` Top ${Math.min(totalRows, limit)} contracts total <strong>${fmt(totalSpend)} Cr</strong>.`;
                    }
                    insight += ` Always compare contract value against actual output \u2014 that is where you find market inefficiencies.`;
                    break;
                }
                case 'player_vs_team': {
                    const name = firstRow.player_name || entity;
                    insight = `<strong>${escapeHtml(name)}</strong> vs <strong>${escapeHtml(context || 'opposition')}</strong>: `;
                    if (firstRow.runs !== undefined) insight += `<strong>${fmt(firstRow.runs)}</strong> runs`;
                    if (firstRow.balls_faced !== undefined) insight += ` off <strong>${fmt(firstRow.balls_faced)}</strong> balls`;
                    if (firstRow.strike_rate !== undefined) insight += ` (SR: <strong>${fmt(firstRow.strike_rate)}</strong>)`;
                    insight += '. ';
                    insight += `Matchup data like this is gold in pre-tournament preparation \u2014 it tells you where to target or protect.`;
                    break;
                }
                case 'matchup': {
                    const batter = firstRow.batter_name || entity;
                    const bowler = firstRow.bowler_name || context;
                    insight = `Head-to-head: <strong>${escapeHtml(batter)}</strong> vs <strong>${escapeHtml(bowler)}</strong> \u2014 `;
                    if (firstRow.balls !== undefined) insight += `<strong>${fmt(firstRow.balls)}</strong> balls faced, `;
                    if (firstRow.runs !== undefined) insight += `<strong>${fmt(firstRow.runs)}</strong> runs, `;
                    if (firstRow.dismissals !== undefined) insight += `<strong>${fmt(firstRow.dismissals)}</strong> dismissals`;
                    if (firstRow.strike_rate !== undefined) insight += ` (SR: <strong>${fmt(firstRow.strike_rate)}</strong>)`;
                    insight += '. ';
                    if (firstRow.balls && firstRow.balls < 12) {
                        insight += `Small sample though \u2014 need at least 12 deliveries to read anything meaningful into this.`;
                    } else {
                        insight += `This is actionable intelligence for field placement and bowling changes.`;
                    }
                    break;
                }
                case 'player_vs_type': {
                    const name = firstRow.batter_name || entity;
                    insight = `<strong>${escapeHtml(name)}</strong> breakdown by bowler type:`;
                    for (const row of rows.slice(0, 4)) {
                        if (row.bowler_type) {
                            insight += ` vs ${escapeHtml(row.bowler_type)}: SR <strong>${fmt(row.strike_rate)}</strong> (${fmt(row.balls)} balls);`;
                        }
                    }
                    insight += ` This split is essential for planning bowling rotations \u2014 expose the weakness, protect against the strength.`;
                    break;
                }
                case 'phase_leaderboard':
                case 'phase': {
                    const phase = context || entity || 'this phase';
                    const name = firstRow.player_name || 'The leader';
                    insight = `Phase breakdown for <strong>${escapeHtml(String(phase))}</strong>: <strong>${escapeHtml(name)}</strong> leads.`;
                    if (firstRow.strike_rate !== undefined) insight += ` Strike rate: <strong>${fmt(firstRow.strike_rate)}</strong>.`;
                    if (firstRow.economy_rate !== undefined) insight += ` Economy: <strong>${fmt(firstRow.economy_rate)}</strong>.`;
                    if (firstRow.wickets !== undefined) insight += ` Wickets: <strong>${fmt(firstRow.wickets)}</strong>.`;
                    insight += ` Phase-specific data separates genuine match-winners from flat-track performers. Context is everything in T20 cricket.`;
                    break;
                }
                case 'overseas': {
                    insight = `<strong>${totalRows}</strong> overseas players across ${escapeHtml(entity || 'the squads')}.`;
                    const nationalities = {};
                    rows.forEach(r => { if (r.nationality) nationalities[r.nationality] = (nationalities[r.nationality] || 0) + 1; });
                    const topNations = Object.entries(nationalities).sort((a, b) => b[1] - a[1]).slice(0, 3);
                    if (topNations.length > 0) {
                        insight += ` Top nationalities: ${topNations.map(([n, c]) => `<strong>${escapeHtml(n)}</strong> (${c})`).join(', ')}.`;
                    }
                    insight += ` The overseas composition defines a squad's ceiling \u2014 you need the right balance of impact and reliability.`;
                    break;
                }
                case 'player_season': {
                    const name = firstRow.player_name || escapeHtml(entity);
                    const seasons = rows.map(r => r.season).filter(Boolean);
                    insight = `<strong>${escapeHtml(name)}</strong> across <strong>${seasons.length}</strong> IPL season${seasons.length > 1 ? 's' : ''} (${seasons[0]}\u2013${seasons[seasons.length - 1]}).`;
                    if (context === 'batting' && firstRow.runs !== undefined) {
                        const bestSeason = rows.reduce((best, r) => (r.runs || 0) > (best.runs || 0) ? r : best, rows[0]);
                        const totalRuns = rows.reduce((sum, r) => sum + (r.runs || 0), 0);
                        insight += ` Career total: <strong>${totalRuns.toLocaleString()}</strong> runs. Peak season: <strong>${bestSeason.season}</strong> with <strong>${(bestSeason.runs || 0).toLocaleString()}</strong> runs at SR ${fmt(bestSeason.strike_rate)}.`;
                    } else if (context === 'bowling' && firstRow.wickets !== undefined) {
                        const bestSeason = rows.reduce((best, r) => (r.wickets || 0) > (best.wickets || 0) ? r : best, rows[0]);
                        const totalWickets = rows.reduce((sum, r) => sum + (r.wickets || 0), 0);
                        insight += ` Career total: <strong>${totalWickets}</strong> wickets. Peak season: <strong>${bestSeason.season}</strong> with <strong>${bestSeason.wickets}</strong> wickets at econ ${fmt(bestSeason.economy)}.`;
                    }
                    insight += ` Year-by-year tape shows you the arc \u2014 who is peaking and who is fading.`;
                    break;
                }
                case 'player_venue': {
                    const name = firstRow.batter_name || firstRow.bowler_name || escapeHtml(entity);
                    const venue = firstRow.venue || escapeHtml(context);
                    if (firstRow.runs !== undefined) {
                        insight = `<strong>${escapeHtml(name)}</strong> at <strong>${escapeHtml(venue)}</strong>: <strong>${firstRow.runs}</strong> runs in <strong>${firstRow.innings}</strong> innings, SR ${fmt(firstRow.strike_rate)}, avg ${fmt(firstRow.average)}.`;
                        if (firstRow.sixes) insight += ` Hit <strong>${firstRow.sixes}</strong> sixes here.`;
                    } else if (firstRow.wickets !== undefined) {
                        insight = `<strong>${escapeHtml(name)}</strong> at <strong>${escapeHtml(venue)}</strong>: <strong>${firstRow.wickets}</strong> wickets in <strong>${firstRow.matches}</strong> matches, economy ${fmt(firstRow.economy)}.`;
                    }
                    insight += ` Ground conditions matter \u2014 the best scouts always check the venue tape first.`;
                    break;
                }
                default: {
                    insight = `${totalRows} row${totalRows > 1 ? 's' : ''} returned. `;
                    if (firstRow.player_name) {
                        insight += `First entry: <strong>${escapeHtml(firstRow.player_name)}</strong>. `;
                    }
                    insight += `Dig into the data \u2014 the details often tell a different story than the headlines.`;
                }
            }

            return `<p style="font-size:13px;color:var(--text-secondary);line-height:1.6;">${insight}</p>`;
        }

        // ---- Update the insight card after query execution ----
        function updateFirstTakeInsight(columns, rows) {
            const insightSection = document.getElementById('andy-flower-insights');
            if (!insightSection) return;

            const insightHTML = generateFirstTakeInsight(
                columns, rows,
                lastNLQueryType, lastNLEntity, lastNLContext
            );

            insightSection.innerHTML = `
                <div class="insight-card">
                    <div class="insight-card-header">
                        <span class="icon">\u{1F3CF}</span>
                        <h4>The First Take</h4>
                        <span class="badge">Cricket Context</span>
                    </div>
                    <p class="insight-subtitle" style="font-size: 13px; font-style: italic; color: var(--text-secondary); margin-bottom: 8px;">
                        "Stephen A. wished he had this data before going on air"
                    </p>
                    ${insightHTML}
                </div>`;
        }

        /* ==================== WIRE NL SEARCH BAR (TKT-177) ==================== */
        const nlInput = document.getElementById('nl-search-input');

        function handleNLSearch() {
            const query = nlInput.value.trim();
            if (!query) return;

            const result = naturalLanguageToSQL(query);
            if (result) {
                lastNLQueryType = result.type;
                lastNLEntity = result.entity || null;
                lastNLContext = result.context || null;

                setEditorSQL(result.sql);
                document.getElementById('sql-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Auto-execute after a brief delay to let user see the SQL
                setTimeout(() => {
                    executeQueryWithInsights();
                }, 300);
            } else {
                // No pattern matched - show helpful hint
                const insightSection = document.getElementById('andy-flower-insights');
                if (insightSection) {
                    insightSection.innerHTML = `
                        <div class="insight-card" style="border-color: rgba(255, 159, 10, 0.3); background: linear-gradient(135deg, rgba(255, 159, 10, 0.08) 0%, rgba(255, 69, 58, 0.06) 100%);">
                            <div class="insight-card-header">
                                <span class="icon">\u{1F3CF}</span>
                                <h4>The First Take</h4>
                                <span class="badge" style="background: rgba(255, 159, 10, 0.15); color: var(--accent-orange);">Try These</span>
                            </div>
                            <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.8; margin-bottom: 8px;">
                                I could not quite parse that one. Here are some things I understand:
                            </p>
                            <ul style="font-size: 12px; color: var(--text-secondary); line-height: 2; list-style: none; padding: 0; font-family: 'JetBrains Mono', monospace;">
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='Kohli stats';handleNLSearch();">\u{1F4A1} <strong>"Kohli stats"</strong> \u2014 Player career lookup</li>
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='Kohli year wise';handleNLSearch();">\u{1F4A1} <strong>"Kohli year wise"</strong> \u2014 Season-by-season breakdown</li>
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='Kohli at Chinnaswamy';handleNLSearch();">\u{1F4A1} <strong>"Kohli at Chinnaswamy"</strong> \u2014 Venue splits</li>
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='top 10 batsmen';handleNLSearch();">\u{1F4A1} <strong>"top 10 batsmen"</strong> \u2014 Batting leaderboard</li>
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='Kohli vs MI';handleNLSearch();">\u{1F4A1} <strong>"Kohli vs MI"</strong> \u2014 Player vs team</li>
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='best death bowlers';handleNLSearch();">\u{1F4A1} <strong>"best death bowlers"</strong> \u2014 Phase specialists</li>
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='CSK squad';handleNLSearch();">\u{1F4A1} <strong>"CSK squad"</strong> \u2014 Team roster</li>
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='most expensive players';handleNLSearch();">\u{1F4A1} <strong>"most expensive players"</strong> \u2014 IPL 2026 contracts</li>
                            </ul>
                        </div>`;
                }
            }
        }

        window.handleNLSearch = handleNLSearch;

        nlInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleNLSearch();
            }
        });

        // ---- Patch executeQuery to generate insights after results ----
        const _originalExecuteQuery = executeQuery;

        async function executeQueryWithInsights() {
            await _originalExecuteQuery();
            if (currentResultRows && currentResultRows.length > 0) {
                updateFirstTakeInsight(currentResultColumns, currentResultRows);
            }
        }

        window.executeQuery = executeQueryWithInsights;
        document.getElementById('run-button').removeEventListener('click', _originalExecuteQuery);
        document.getElementById('run-button').addEventListener('click', executeQueryWithInsights);

        // Update NL search bar placeholder
        nlInput.placeholder = "Ask: 'top batsmen', 'Kohli stats', 'CSK squad', 'best death bowlers', 'Kohli vs MI'...";

        /* ==================== START INITIALIZATION ==================== */
        /* Import DuckDB with a 15-second timeout so a hung CDN never blocks the page */
        function importWithTimeout(url, ms) {
            return Promise.race([
                import(url),
                new Promise((_, reject) => setTimeout(() => reject(new Error('CDN import timed out after ' + ms + 'ms')), ms))
            ]);
        }

        async function loadAndInitDuckDB() {
            try {
                duckdb = await importWithTimeout('https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.29.0/+esm', 15000);
                console.log('DuckDB-WASM loaded successfully');
                await initDuckDB();
            } catch (err) {
                console.error('DuckDB-WASM failed to load:', err);
                const overlayEl = document.getElementById('loading-overlay');
                const progressTextEl = document.getElementById('loading-progress-text');
                if (progressTextEl) progressTextEl.textContent = 'Analytics engine failed to load: ' + err.message;
                const btn = document.createElement('button');
                btn.textContent = 'Dismiss & Browse Page';
                btn.style.cssText = 'margin-top:16px;padding:10px 24px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:13px;font-weight:600;';
                btn.onclick = () => overlayEl.classList.add('hidden');
                overlayEl.querySelector('.loading-steps').insertAdjacentElement('afterend', btn);
            }
        }

        // Signal to safety timeout that module evaluation completed successfully
        window._filmRoomReady = true;

        // Kick off DuckDB load (non-blocking ‚Äî page is already rendered)
        loadAndInitDuckDB();
    </script>

    <!-- Navigation Guide Button -->
    <button type="button" class="nav-guide-btn" onclick="toggleNavGuide()" title="Quick Navigation Guide" style="
        position: fixed; bottom: 48px; right: 20px; width: 52px; height: 52px;
        border-radius: 50%; background: var(--bg-secondary); border: 1px solid var(--border);
        color: var(--text-secondary); font-size: 22px; cursor: pointer; z-index: 90;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 16px var(--shadow); transition: all 0.2s ease;
    ">‚ùì</button>

    <!-- Navigation Guide Modal -->
    <div class="nav-guide-overlay" id="nav-guide-overlay" onclick="closeNavGuide(event)" style="
        display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
        z-index: 150; align-items: center; justify-content: center;
    ">
        <div class="nav-guide-modal" onclick="event.stopPropagation()" style="
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 16px; padding: 28px 24px; max-width: 420px; width: 90%;
            max-height: 80vh; overflow-y: auto; position: relative;
        ">
            <button type="button" class="nav-guide-close" onclick="toggleNavGuide()" style="
                position: absolute; top: 12px; right: 12px; background: none; border: none;
                color: var(--text-tertiary); font-size: 18px; cursor: pointer; padding: 4px 8px;
            ">&#10005;</button>
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 18px; font-weight: 800;">üèè The Playbook Rundown</h3>
                <p style="font-size: 13px; color: var(--text-secondary);">Your pre-game briefing from the coaching staff</p>
            </div>
            <a href="index.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;">üè†</span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">Home ‚Äî "The Main Event"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">The Lab homepage. Your IPL 2026 analytics command center.</p>
                </div>
            </a>
            <a href="teams.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;">üèè</span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">Team Breakdowns ‚Äî "The Dugout"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">Andy Flower's domain. Predicted XIs, depth charts, full rosters.</p>
                </div>
            </a>
            <a href="artifacts.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;">üìä</span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">Artifacts ‚Äî "The Trophy Cabinet"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">All 10 franchise stat packs. Stephen Curry approved ‚Äî clean data.</p>
                </div>
            </a>
            <a href="analysis.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;">üî¨</span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">Analysis ‚Äî "Studying Film"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">Tom Brady's film room. Matchups, clusters, phase breakdowns.</p>
                </div>
            </a>
            <a href="research.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;">üìö</span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">Research ‚Äî "Pep's Tactical Notebook"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">Methodology docs. The science behind the grades.</p>
                </div>
            </a>
            <a href="research-desk.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; background: rgba(10,132,255,0.08); border: 1px solid rgba(10,132,255,0.15);">
                <span style="font-size: 24px;">üé¨</span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">The Film Room ‚Äî "Breaking Down Tape"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">üìç You Are Here. Pull up the tape on any player, team, or matchup. The full scouting database, coach-style.</p>
                </div>
            </a>
            <a href="about.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;">üåπ</span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">About ‚Äî "The Origin Story"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">The story, the vision, the Founder. How Cricket Playbook came to be.</p>
                </div>
            </a>
            <a href="../../mission_control/dashboard/index.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;">üì°</span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">The Boardroom ‚Äî "Front Office Moves"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">Florentino's war room. Tickets, sprints, agent roster.</p>
                </div>
            </a>
        </div>
    </div>

    <script>
        function toggleNavGuide() {
            const overlay = document.getElementById('nav-guide-overlay');
            const isVisible = overlay.style.display === 'flex';
            overlay.style.display = isVisible ? 'none' : 'flex';
        }
        function closeNavGuide(e) {
            if (e.target === e.currentTarget) toggleNavGuide();
        }

        /* Schema sidebar mobile toggle */
        function toggleSchemaSidebar() {
            const sidebar = document.getElementById('schema-browser');
            const overlay = document.getElementById('schema-overlay');
            const isOpen = sidebar.classList.contains('open');
            if (isOpen) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('active');
            }
        }
    </script>
</body>
</html>
