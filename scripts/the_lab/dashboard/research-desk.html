<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Film Room - The Lab</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* ==================== THEME SYSTEM ==================== */
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --bg-elevated: #3a3a3c;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --text-tertiary: #636366;
            --accent: #0a84ff;
            --accent-green: #30d158;
            --accent-yellow: #ffd60a;
            --accent-orange: #ff9f0a;
            --accent-red: #ff453a;
            --accent-purple: #bf5af2;
            --accent-pink: #ff375f;
            --accent-teal: #64d2ff;
            --border: rgba(255, 255, 255, 0.1);
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.08);
            --shadow: rgba(0, 0, 0, 0.4);
        }

        [data-theme="light"] {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e5e5ea;
            --bg-elevated: #d1d1d6;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-tertiary: #8e8e93;
            --accent: #007aff;
            --accent-green: #28cd41;
            --accent-yellow: #ffcc00;
            --accent-orange: #ff9500;
            --accent-red: #ff3b30;
            --accent-purple: #af52de;
            --accent-pink: #ff2d55;
            --accent-teal: #5ac8fa;
            --border: rgba(0, 0, 0, 0.08);
            --glass: rgba(0, 0, 0, 0.03);
            --glass-border: rgba(0, 0, 0, 0.06);
            --shadow: rgba(0, 0, 0, 0.15);
        }

        /* ==================== TOOLTIP SYSTEM (TKT-109) ==================== */
        .has-tooltip {
            position: relative;
            cursor: help;
        }
        .has-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 4px 12px var(--shadow);
        }
        .has-tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            font-size: 10px;
            color: var(--text-tertiary);
            cursor: help;
            margin-left: 4px;
            vertical-align: middle;
        }
        .help-icon:hover { color: var(--accent); }
        .has-tooltip-below::after {
            bottom: auto;
            top: calc(100% + 8px);
        }

        /* Mobile-safe tooltip adjustments */
        @media (max-width: 768px) {
            .has-tooltip::after {
                white-space: normal;
                max-width: 200px;
                left: 0;
                transform: none;
                font-size: 11px;
            }
        }
        @media (max-width: 480px) {
            .has-tooltip::after {
                max-width: 160px;
                padding: 6px 10px;
                font-size: 10px;
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { overflow-x: hidden; max-width: 100vw; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ==================== BACKGROUND ==================== */
        .bg-gradient {
            position: fixed; inset: 0; z-index: -4;
            background: linear-gradient(135deg, #000000 0%, #0a0a12 25%, #0d1020 50%, #0a0a15 75%, #000000 100%);
        }
        [data-theme="light"] .bg-gradient {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #f1f3f5 100%);
        }
        .bg-gradient::before {
            content: ''; position: absolute; top: -20%; right: -10%; width: 60%; height: 60%;
            background: radial-gradient(ellipse, rgba(10, 132, 255, 0.18) 0%, transparent 70%);
            filter: blur(80px);
        }
        .bg-grid {
            position: fixed; inset: 0; z-index: -2;
            background-image: linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 60px 60px;
        }
        [data-theme="light"] .bg-grid {
            background-image: linear-gradient(rgba(0, 0, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
        }

        /* ==================== NAVIGATION ==================== */
        .nav {
            position: fixed; top: 0; left: 0; right: 0; height: 56px;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px; z-index: 100;
        }
        [data-theme="light"] .nav { background: rgba(245, 245, 247, 0.85); }
        .nav-brand { display: flex; align-items: center; gap: 12px; }
        .nav-logo {
            width: 32px; height: 32px; border-radius: 8px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-purple) 100%);
            display: flex; align-items: center; justify-content: center; font-size: 16px;
        }
        .nav-title { font-size: 15px; font-weight: 600; letter-spacing: -0.3px; }
        .nav-title span { color: var(--accent); }
        .nav-tabs {
            display: flex; gap: 4px;
            background: var(--bg-secondary); border-radius: 10px; padding: 4px;
        }
        .nav-tab {
            padding: 6px 14px; border-radius: 8px; font-size: 13px; font-weight: 500;
            color: var(--text-secondary); text-decoration: none; transition: all 0.2s ease;
            white-space: nowrap;
        }
        .nav-tab:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .nav-tab.active {
            color: var(--text-primary); background: var(--bg-tertiary);
            box-shadow: 0 1px 3px var(--shadow);
        }
        .nav-actions { display: flex; align-items: center; gap: 12px; }
        .nav-time { font-size: 12px; color: var(--text-tertiary); font-variant-numeric: tabular-nums; }

        /* Theme Toggle */
        .theme-toggle {
            width: 36px; height: 36px; border-radius: 10px;
            background: var(--bg-secondary); border: 1px solid var(--border);
            color: var(--text-primary); cursor: pointer; font-size: 16px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
        }
        .theme-toggle:hover { background: var(--bg-tertiary); }

        /* Mobile hamburger menu */
        .mobile-menu-btn {
            display: none;
            width: 44px; height: 44px; border-radius: 10px;
            background: var(--bg-secondary); border: 1px solid var(--border);
            color: var(--text-primary); cursor: pointer;
            flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; padding: 8px;
        }
        .mobile-menu-btn span {
            display: block; width: 18px; height: 2px;
            background: currentColor; border-radius: 1px; transition: all 0.3s ease;
        }
        .mobile-menu-btn.active span:nth-child(1) { transform: rotate(45deg) translate(4px, 4px); }
        .mobile-menu-btn.active span:nth-child(2) { opacity: 0; }
        .mobile-menu-btn.active span:nth-child(3) { transform: rotate(-45deg) translate(4px, -4px); }

        /* Mobile Navigation Dropdown */
        .mobile-nav-menu {
            display: none; position: fixed; top: 56px; left: 0; right: 0;
            background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            flex-direction: column; padding: 8px 16px;
            z-index: 99; transform: translateY(-10px); opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        .mobile-nav-menu.active { transform: translateY(0); opacity: 1; pointer-events: auto; }
        [data-theme="light"] .mobile-nav-menu { background: rgba(245, 245, 247, 0.95); }
        .mobile-nav-menu .nav-tab {
            padding: 12px 16px; border-radius: 8px; font-size: 15px;
            display: block; width: 100%;
        }
        .mobile-nav-menu .nav-tab.active {
            background: var(--bg-tertiary); color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .nav-tabs { display: none; }
            .mobile-menu-btn { display: flex; }
            .mobile-nav-menu { display: flex; }
        }

        /* ==================== MAIN LAYOUT ==================== */
        .main {
            padding-top: 72px;
            min-height: 100vh;
        }

        .page-header {
            padding: 32px 24px 16px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .page-title {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .page-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            max-width: 700px;
            line-height: 1.7;
        }

        /* ==================== RESEARCH DESK LAYOUT ==================== */
        .desk-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 0;
            max-width: 1400px;
            margin: 20px auto 0;
            padding: 0 24px;
            min-height: calc(100vh - 200px);
        }

        /* ==================== SCHEMA BROWSER (LEFT SIDEBAR) ==================== */
        .schema-sidebar {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px 0 0 12px;
            overflow-y: auto;
            max-height: calc(100vh - 180px);
            position: sticky;
            top: 72px;
        }
        .schema-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 2;
        }
        .schema-header h3 {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }
        .schema-search {
            width: 100%;
            padding: 8px 12px;
            margin: 12px 16px;
            width: calc(100% - 32px);
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;  /* min 16px prevents iOS auto-zoom on focus */
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s ease;
            touch-action: manipulation;
        }
        .schema-search:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.1); }
        .schema-search::placeholder { color: var(--text-tertiary); }

        .schema-group {
            padding: 8px 0;
        }
        .schema-group-label {
            padding: 6px 16px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-tertiary);
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s ease;
        }
        .schema-group-label:hover { color: var(--text-secondary); }
        .schema-group-label .group-chevron {
            font-size: 8px;
            transition: transform 0.2s ease;
        }
        .schema-group.group-collapsed .schema-group-label .group-chevron {
            transform: rotate(-90deg);
        }
        .schema-group.group-collapsed .schema-item,
        .schema-group.group-collapsed .schema-columns {
            display: none;
        }
        .schema-item {
            padding: 6px 16px 6px 24px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .schema-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .schema-item .icon {
            font-size: 10px;
            opacity: 0.6;
        }
        .schema-item-dim .icon { color: var(--accent-teal); }
        .schema-item-fact .icon { color: var(--accent-orange); }
        .schema-item-ref .icon { color: var(--accent-green); }
        .schema-item-cluster .icon { color: var(--accent-purple); }
        .schema-item-view .icon { color: var(--accent-yellow); }
        .schema-item .row-count {
            margin-left: auto;
            font-size: 10px;
            color: var(--text-tertiary);
        }

        /* ---- Interactive Schema Browser (TKT-175) ---- */
        .schema-item .chevron {
            font-size: 8px;
            transition: transform 0.2s ease;
            color: var(--text-tertiary);
            flex-shrink: 0;
        }
        .schema-item.expanded .chevron {
            transform: rotate(90deg);
        }
        .schema-item .table-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .schema-item .query-btn {
            display: none;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            background: var(--accent);
            color: #fff;
            border: none;
            cursor: pointer;
            flex-shrink: 0;
            line-height: 1.4;
            transition: opacity 0.15s ease;
        }
        .schema-item:hover .query-btn {
            display: inline-block;
        }
        .schema-columns {
            display: none;
            padding: 2px 0 6px 0;
            background: rgba(0,0,0,0.1);
            border-bottom: 1px solid var(--border);
        }
        [data-theme="light"] .schema-columns {
            background: rgba(0,0,0,0.02);
        }
        .schema-columns.visible {
            display: block;
        }
        .schema-col-item {
            padding: 3px 16px 3px 40px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.12s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .schema-col-item:hover {
            background: rgba(10, 132, 255, 0.08);
            color: var(--text-primary);
        }
        .schema-col-item .col-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .schema-col-item .col-type {
            font-size: 9px;
            font-weight: 600;
            padding: 1px 5px;
            border-radius: 3px;
            flex-shrink: 0;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .schema-col-item .col-type.type-varchar { background: rgba(10, 132, 255, 0.12); color: var(--accent); }
        .schema-col-item .col-type.type-bigint { background: rgba(255, 159, 10, 0.12); color: var(--accent-orange); }
        .schema-col-item .col-type.type-hugeint { background: rgba(255, 159, 10, 0.12); color: var(--accent-orange); }
        .schema-col-item .col-type.type-integer { background: rgba(255, 159, 10, 0.12); color: var(--accent-orange); }
        .schema-col-item .col-type.type-double { background: rgba(48, 209, 88, 0.12); color: var(--accent-green); }
        .schema-col-item .col-type.type-boolean { background: rgba(191, 90, 242, 0.12); color: var(--accent-purple); }
        .schema-col-item .col-type.type-default { background: rgba(142, 142, 147, 0.12); color: var(--text-tertiary); }
        .schema-col-item .col-desc {
            display: none;
        }
        .schema-col-item:hover .col-desc {
            display: none; /* Use tooltip instead */
        }

        /* ---- Improved Schema Browser: Category Groups & Scope Toggle ---- */
        .schema-view-category {
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
        }
        .schema-view-category:last-child { border-bottom: none; }
        .schema-view-category-header {
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-tertiary);
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.2s ease;
        }
        .schema-view-category-header:hover { color: var(--text-secondary); }
        .schema-view-category-header .cat-icon {
            font-size: 13px;
            flex-shrink: 0;
            width: 18px;
            text-align: center;
        }
        .schema-view-category-header .cat-count {
            margin-left: auto;
            font-size: 9px;
            font-weight: 600;
            padding: 1px 6px;
            border-radius: 8px;
            background: var(--glass);
            color: var(--text-tertiary);
        }
        .schema-view-category-header .group-chevron {
            font-size: 8px;
            transition: transform 0.2s ease;
        }
        .schema-view-category.cat-collapsed .schema-view-category-header .group-chevron {
            transform: rotate(-90deg);
        }
        .schema-view-category.cat-collapsed .schema-view-items { display: none; }
        .schema-view-item-desc {
            display: block;
            padding: 0 16px 4px 42px;
            font-size: 10px;
            color: var(--text-tertiary);
            font-style: italic;
            line-height: 1.3;
        }

        /* Scope Toggle */
        .schema-scope-toggle {
            display: flex;
            margin: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 3px;
            gap: 2px;
        }
        .schema-scope-btn {
            flex: 1;
            padding: 5px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            transition: all 0.2s ease;
            font-family: inherit;
        }
        .schema-scope-btn:hover { color: var(--text-secondary); }
        .schema-scope-btn.active {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 1px 4px rgba(10, 132, 255, 0.3);
        }

        /* Quick Start Section */
        .schema-quick-start {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
        }
        .schema-quick-start-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--accent);
            padding: 4px 4px 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .schema-quick-query {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s ease, transform 0.15s ease;
            margin-bottom: 2px;
        }
        .schema-quick-query:hover {
            background: var(--bg-tertiary);
            transform: translateX(2px);
        }
        .schema-quick-query .qq-icon {
            font-size: 12px;
            flex-shrink: 0;
            margin-top: 1px;
        }
        .schema-quick-query .qq-text {
            flex: 1;
            min-width: 0;
        }
        .schema-quick-query .qq-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .schema-quick-query .qq-desc {
            font-size: 9px;
            color: var(--text-tertiary);
            line-height: 1.3;
            margin-top: 1px;
        }

        /* NL Search Chips */
        .nl-search-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px 0 0 0;
        }
        .nl-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--glass);
            color: var(--text-secondary);
            transition: all 0.2s ease;
            white-space: nowrap;
            font-family: inherit;
        }
        .nl-chip:hover {
            background: rgba(10, 132, 255, 0.12);
            border-color: var(--accent);
            color: var(--accent);
        }
        .nl-chip .chip-icon { font-size: 12px; }

        /* ---- Example Card Enhancements (TKT-176) ---- */
        .example-card-category.phase { background: rgba(100, 210, 255, 0.15); color: var(--accent-teal); }
        .example-card-category.ipl2026 { background: rgba(255, 55, 95, 0.15); color: var(--accent-pink); }
        .example-card-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 8px;
            font-family: inherit;
        }
        .example-card p {
            font-size: 11px;
            color: var(--text-tertiary);
            line-height: 1.4;
            font-family: 'JetBrains Mono', monospace;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .example-card .load-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--accent);
            color: #fff;
            transition: all 0.15s ease;
        }
        .example-card .load-btn:hover {
            background: #0977e6;
        }

        /* ==================== MAIN WORKSPACE ==================== */
        .workspace {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-left: none;
            border-radius: 0 12px 12px 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        /* ---- Natural Language Search Bar ---- */
        .nl-search-section {
            padding: 18px 20px;
            border-bottom: 1px solid var(--border);
        }
        .nl-search-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .nl-search-bar:focus-within { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.1); }
        .nl-search-icon { font-size: 16px; color: var(--text-tertiary); }
        .nl-search-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 16px;  /* min 16px prevents iOS auto-zoom on focus */
            font-family: inherit;
            outline: none;
            touch-action: manipulation;
        }
        .nl-search-input::placeholder { color: var(--text-tertiary); }
        .typeahead-item:hover, .typeahead-item.selected { background: rgba(100, 210, 80, 0.08); }
        .typeahead-item:last-child { border-bottom: none; }
        .nl-search-hint {
            font-size: 11px;
            color: var(--text-tertiary);
            padding: 6px 0 0 28px;
        }
        .nl-search-hint kbd {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1px 5px;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* ---- SQL Editor Area ---- */
        .sql-editor-section {
            padding: 0;
            border-bottom: 1px solid var(--border);
        }
        .editor-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }
        [data-theme="light"] .editor-toolbar {
            background: rgba(0,0,0,0.02);
        }
        .editor-toolbar-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .editor-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
        }
        .editor-toolbar-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .editor-btn {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .editor-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }
        .editor-btn.run-btn {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        .editor-btn.run-btn:hover {
            background: #0977e6;
            border-color: #0977e6;
        }
        .sql-editor-wrapper {
            position: relative;
            min-height: 160px;
            max-height: 300px;
        }
        .sql-editor-placeholder {
            width: 100%;
            min-height: 160px;
            max-height: 300px;
            padding: 16px 20px;
            background: var(--bg-primary);
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            border: none;
            outline: none;
            resize: vertical;
            tab-size: 2;
        }
        [data-theme="light"] .sql-editor-placeholder {
            background: #f8f9fa;
        }

        /* ---- Results Panel ---- */
        .results-section {
            padding: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 200px;
        }
        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }
        [data-theme="light"] .results-header {
            background: rgba(0,0,0,0.02);
        }
        .results-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
        }
        .results-meta {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        .results-table-wrapper {
            overflow: auto;
            flex: 1;
            max-height: 400px;
        }
        .results-table {
            min-width: 100%;
            width: max-content;
            border-collapse: collapse;
            font-size: 12px;
        }
        .results-table th {
            position: sticky;
            top: 0;
            background: var(--bg-tertiary);
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        .results-table th:hover { color: var(--accent); }
        .results-table th .sort-icon { margin-left: 4px; font-size: 10px; opacity: 0.4; }
        .results-table td {
            padding: 6px 12px;
            border-bottom: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-primary);
            white-space: normal;
            word-break: break-word;
            max-width: 320px;
        }
        .results-table tr:nth-child(even) {
            background: var(--glass);
        }
        .results-table tr:hover {
            background: rgba(10, 132, 255, 0.08);
        }
        .results-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 56px 24px;
            color: var(--text-tertiary);
            text-align: center;
        }
        .results-empty-icon { font-size: 40px; margin-bottom: 14px; opacity: 0.35; }
        .results-empty-text { font-size: 14px; margin-bottom: 6px; font-weight: 500; }
        .results-empty-hint { font-size: 12px; color: var(--text-tertiary); line-height: 1.5; }

        /* ---- Andy Flower Insights Card ---- */
        .insights-section {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
        }
        .insight-card {
            background: linear-gradient(135deg, rgba(10, 132, 255, 0.08) 0%, rgba(191, 90, 242, 0.06) 100%);
            border: 1px solid rgba(10, 132, 255, 0.15);
            border-radius: 12px;
            padding: 18px 22px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .insight-card:hover {
            border-color: rgba(10, 132, 255, 0.25);
            box-shadow: 0 2px 12px rgba(10, 132, 255, 0.08);
        }
        .insight-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .insight-card-header .icon { font-size: 20px; }
        .insight-card-header h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: -0.2px;
        }
        .insight-card-header .badge {
            margin-left: auto;
            font-size: 10px;
            padding: 3px 10px;
            border-radius: 6px;
            background: rgba(10, 132, 255, 0.15);
            color: var(--accent);
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .insight-card p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* ---- Example Queries Gallery ---- */
        .examples-section {
            padding: 20px;
            border-top: 1px solid var(--border);
        }
        .examples-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }
        .examples-header h3 {
            font-size: 14px;
            font-weight: 700;
        }
        .examples-filter {
            display: flex;
            gap: 4px;
        }
        .examples-filter-btn {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        .examples-filter-btn:hover,
        .examples-filter-btn.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 12px;
        }
        .example-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .example-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow);
        }
        .example-card-category {
            display: inline-block;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 6px;
        }
        .example-card-category.batting { background: rgba(10, 132, 255, 0.15); color: var(--accent); }
        .example-card-category.bowling { background: rgba(255, 69, 58, 0.15); color: var(--accent-red); }
        .example-card-category.team { background: rgba(48, 209, 88, 0.15); color: var(--accent-green); }
        .example-card-category.leaderboard { background: rgba(255, 214, 10, 0.15); color: var(--accent-yellow); }
        .example-card-category.matchup { background: rgba(191, 90, 242, 0.15); color: var(--accent-purple); }
        .example-card h4 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .example-card p {
            font-size: 11px;
            color: var(--text-tertiary);
            line-height: 1.4;
            font-family: 'JetBrains Mono', monospace;
        }

        /* ==================== LOADING OVERLAY ==================== */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            transition: opacity 0.5s ease;
        }
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
            display: none;
        }
        .loading-icon { font-size: 48px; }
        .loading-title {
            font-size: 20px;
            font-weight: 700;
        }
        .loading-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .loading-progress-container {
            width: 320px;
            max-width: 80vw;
        }
        .loading-progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }
        .loading-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-purple) 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .loading-progress-text {
            text-align: center;
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 8px;
        }
        .loading-steps {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 12px;
        }
        .loading-step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-tertiary);
        }
        .loading-step.active { color: var(--accent); }
        .loading-step.done { color: var(--accent-green); }
        .loading-step .check { font-size: 14px; }

        /* ==================== STATUS BAR ==================== */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 11px;
            color: var(--text-tertiary);
            z-index: 100;
        }
        .status-bar-left, .status-bar-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-green);
        }
        .status-dot.loading {
            background: var(--accent-yellow);
            animation: pulse 1.5s ease infinite;
        }
        .status-dot.error { background: var(--accent-red); }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ==================== FOOTER ==================== */
        .footer {
            padding: 48px 24px 56px;
            text-align: center;
            border-top: 1px solid var(--border);
        }
        .footer-text { font-size: 12px; color: var(--text-tertiary); letter-spacing: 0.2px; }
        .footer a { color: var(--accent); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .desk-container {
                grid-template-columns: 1fr;
                padding: 0 12px;
            }
            .schema-sidebar {
                border-radius: 12px 12px 0 0;
                max-height: none;
                position: static;
            }
            .schema-sidebar.collapsed .schema-group { display: none; }
            .schema-sidebar.collapsed .schema-view-category { display: none; }
            .schema-sidebar.collapsed .schema-search { display: none; }
            .schema-sidebar.collapsed .schema-quick-start { display: none; }
            .schema-sidebar.collapsed .schema-scope-toggle { display: none; }
            .workspace {
                border-left: 1px solid var(--border);
                border-radius: 0 0 12px 12px;
            }
            .page-header { padding: 20px 12px 12px; }
            .page-title { font-size: 24px; }
            .examples-grid { grid-template-columns: 1fr; }
            .mobile-nav-menu .nav-tab { min-height: 44px; }
        }
        @media (max-width: 480px) {
            .page-title { font-size: 20px; }
            .page-subtitle { font-size: 13px; }
            .editor-toolbar { flex-wrap: wrap; gap: 6px; }
            .nl-search-bar { padding: 8px 12px; }
        }

        /* ==================== QUERY EXPLANATION PANEL ==================== */
        .query-explanation-panel {
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(10, 132, 255, 0.04) 0%, rgba(191, 90, 242, 0.03) 100%);
            display: none;
        }
        .query-explanation-panel.visible { display: block; }
        .query-explanation-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
        }
        .query-explanation-header .qe-icon { font-size: 13px; }
        .query-explanation-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }
        .qe-tag {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            font-family: 'JetBrains Mono', monospace;
            white-space: nowrap;
        }
        .qe-tag.player { background: rgba(10, 132, 255, 0.12); color: var(--accent); }
        .qe-tag.team { background: rgba(48, 209, 88, 0.12); color: var(--accent-green); }
        .qe-tag.phase { background: rgba(100, 210, 255, 0.12); color: var(--accent-teal); }
        .qe-tag.venue { background: rgba(255, 159, 10, 0.12); color: var(--accent-orange); }
        .qe-tag.season { background: rgba(255, 214, 10, 0.12); color: var(--accent-yellow); }
        .qe-tag.bowler-type { background: rgba(191, 90, 242, 0.12); color: var(--accent-purple); }
        .qe-tag.role { background: rgba(255, 55, 95, 0.12); color: var(--accent-pink); }
        .qe-tag.modifier { background: rgba(142, 142, 147, 0.12); color: var(--text-secondary); }
        .qe-tag.intent { background: rgba(10, 132, 255, 0.08); color: var(--accent); border: 1px solid rgba(10, 132, 255, 0.2); }
        .qe-separator {
            color: var(--text-tertiary);
            font-size: 10px;
            margin: 0 1px;
        }
        .qe-route {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 4px;
            font-size: 10px;
            color: var(--text-tertiary);
            font-family: 'JetBrains Mono', monospace;
        }
        .qe-route .qe-arrow { color: var(--accent); }

        /* ==================== SIDE-BY-SIDE COMPARISON ==================== */
        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 16px 20px;
        }
        @media (max-width: 600px) {
            .comparison-container { grid-template-columns: 1fr; }
        }
        .comparison-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 16px;
            overflow: hidden;
        }
        .comparison-card.wins-card { border-top: 3px solid var(--accent-green); }
        .comparison-card.losses-card { border-top: 3px solid var(--accent-red); }
        .comparison-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        .comparison-card-header .cc-icon { font-size: 16px; }
        .comparison-card-header h4 {
            font-size: 13px;
            font-weight: 700;
        }
        .comparison-card-header .cc-count {
            margin-left: auto;
            font-size: 11px;
            color: var(--text-tertiary);
            font-family: 'JetBrains Mono', monospace;
        }
        .comparison-metrics {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .comparison-metric-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 0;
        }
        .comparison-metric-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-weight: 600;
        }
        .comparison-metric-value {
            font-size: 14px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        .comparison-delta-row {
            display: none;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            grid-column: 1 / -1;
        }
        .comparison-delta-row.visible { display: flex; }
        .comparison-deltas {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            padding: 12px 20px;
            border-top: 1px solid var(--border);
            background: var(--glass);
            border-radius: 0 0 10px 10px;
        }
        .delta-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        .delta-chip.positive { background: rgba(48, 209, 88, 0.12); color: var(--accent-green); }
        .delta-chip.negative { background: rgba(255, 69, 58, 0.12); color: var(--accent-red); }
        .delta-chip.neutral { background: rgba(142, 142, 147, 0.12); color: var(--text-secondary); }
        .delta-chip .delta-label {
            font-size: 10px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        /* ==================== DISAMBIGUATION CARD ==================== */
        .disambiguation-card {
            background: linear-gradient(135deg, rgba(255, 159, 10, 0.06) 0%, rgba(191, 90, 242, 0.04) 100%);
            border: 1px solid rgba(255, 159, 10, 0.2);
            border-radius: 10px;
            padding: 16px 20px;
            margin: 16px 20px;
        }
        .disambiguation-card h4 {
            font-size: 13px;
            font-weight: 700;
            color: var(--accent-orange);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .disambiguation-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .disambiguation-option {
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all 0.2s ease;
            font-family: inherit;
        }
        .disambiguation-option:hover {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        .fallback-suggestions {
            margin-top: 10px;
        }
        .fallback-suggestion-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s ease;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .fallback-suggestion-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .fallback-suggestion-item .fsi-icon {
            font-size: 12px;
            color: var(--accent);
        }
        .fallback-suggestion-item strong {
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }

        /* ---- Pagination Controls (TKT-174) ---- */
        .results-pagination {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 8px 20px;
            border-top: 1px solid var(--border);
            background: rgba(0,0,0,0.15);
            font-size: 12px;
            color: var(--text-secondary);
        }
        .results-pagination.visible { display: flex; }
        [data-theme="light"] .results-pagination { background: rgba(0,0,0,0.02); }
        .results-pagination-info {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-tertiary);
        }
        .results-pagination-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .pagination-btn {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            transition: all 0.15s ease;
        }
        .pagination-btn:hover:not(:disabled) {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }
        .pagination-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .pagination-btn.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        /* ---- Column Resize Handle (TKT-174) ---- */
        .results-table th { position: relative; }
        .col-resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: col-resize;
            background: transparent;
            z-index: 3;
        }
        .col-resize-handle:hover,
        .col-resize-handle.resizing { background: var(--accent); }

        /* ---- Sort Indicators (TKT-174) ---- */
        .results-table th.sorted-asc .sort-icon,
        .results-table th.sorted-desc .sort-icon { opacity: 1; color: var(--accent); }

        /* ---- Query History Dropdown (TKT-174) ---- */
        .query-history-wrapper { position: relative; }
        .query-history-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            right: 0;
            width: 420px;
            max-height: 320px;
            overflow-y: auto;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 8px 32px var(--shadow);
            z-index: 50;
            padding: 4px;
        }
        .query-history-dropdown.open { display: block; }
        .query-history-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s ease;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-bottom: 1px solid var(--border);
        }
        .query-history-item:last-child { border-bottom: none; }
        .query-history-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .query-history-empty {
            padding: 16px;
            text-align: center;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* ---- Editor Shortcuts Hint (TKT-174) ---- */
        .editor-shortcuts-hint {
            padding: 4px 20px 6px;
            font-size: 10px;
            color: var(--text-tertiary);
            background: rgba(0,0,0,0.1);
            border-top: 1px solid var(--border);
        }
        [data-theme="light"] .editor-shortcuts-hint { background: rgba(0,0,0,0.02); }
        .editor-shortcuts-hint kbd {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 0px 4px;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
        }

        @media (max-width: 768px) {
            .query-history-dropdown { width: 280px; }
        }

        /* ==================== ENHANCED MOBILE RESPONSIVE ==================== */

        /* Mobile schema toggle button */
        .schema-toggle-btn {
            display: none;
            position: fixed;
            bottom: 48px;
            left: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            z-index: 90;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px var(--shadow);
            transition: all 0.2s ease;
        }
        .schema-toggle-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        /* Schema sidebar overlay for mobile */
        .schema-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .schema-overlay.active { display: block; }

        /* Tablet breakpoint enhancements */
        @media (max-width: 768px) {
            /* Show mobile schema toggle */
            .schema-toggle-btn { display: flex; }

            /* Schema sidebar: fixed overlay on mobile */
            .schema-sidebar {
                position: fixed;
                left: -300px;
                top: 0;
                bottom: 0;
                z-index: 1000;
                width: 280px;
                max-height: 100vh;
                border-radius: 0 12px 12px 0;
                transition: left 0.3s ease;
                background: var(--bg-secondary);
                border-right: 1px solid var(--border);
            }
            .schema-sidebar.open {
                left: 0;
            }

            /* Main content: full width */
            .workspace {
                border-left: 1px solid var(--border);
                border-radius: 12px;
            }

            /* Status bar: smaller text */
            .status-bar { font-size: 11px; padding: 0 12px; }
            .status-bar-left, .status-bar-right { gap: 8px; }

            /* Examples: single column */
            .examples-grid { grid-template-columns: 1fr !important; }
            .examples-filter { flex-wrap: wrap; }

            /* Editor adjustments */
            .nl-search-section { padding: 12px; }
            .insights-section { padding: 12px; }
            .examples-section { padding: 12px; }

            /* Results pagination */
            .results-pagination { flex-wrap: wrap; gap: 8px; padding: 8px 12px; }
            .results-pagination-controls { flex-wrap: wrap; justify-content: center; }
        }

        /* Phone breakpoint enhancements */
        @media (max-width: 480px) {
            /* Editor toolbar: wrap buttons */
            .editor-toolbar { flex-wrap: wrap; gap: 4px; padding: 6px 12px; }
            .editor-toolbar-left, .editor-toolbar-right { gap: 4px; }
            .editor-btn { font-size: 11px; padding: 5px 8px; }

            /* Results table: smaller font */
            .results-table { font-size: 11px; }
            .results-table th { font-size: 10px; padding: 6px 8px; }
            .results-table td { font-size: 11px; padding: 5px 8px; }

            /* Pagination: wrap and center */
            .results-pagination { justify-content: center; }
            .results-pagination-controls { flex-wrap: wrap; justify-content: center; gap: 4px; }
            .pagination-btn { padding: 4px 8px; font-size: 10px; }

            /* NL search bar: compact */
            .nl-search-bar { padding: 8px 10px; gap: 6px; }
            .nl-search-input { font-size: 16px; }  /* keep 16px  below triggers iOS auto-zoom */
            .nl-search-hint { padding: 4px 0 0 0; font-size: 10px; }
            .nl-search-chips { gap: 4px; padding: 6px 0 0 0; }
            .nl-chip { font-size: 10px; padding: 3px 8px; }

            /* Insight card: compact */
            .insight-card { padding: 12px 14px; }

            /* Schema toggle position */
            .schema-toggle-btn { bottom: 44px; left: 12px; width: 42px; height: 42px; font-size: 18px; }

            /* Editor shortcuts hint */
            .editor-shortcuts-hint { display: none; }
        }

        /* Touch target minimum sizes (WCAG 44x44px) */
        .theme-toggle { min-width: 44px; min-height: 44px; }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    <div class="bg-grid"></div>

    <!-- Mobile Schema Browser Toggle -->
    <button type="button" class="schema-toggle-btn" id="schema-toggle-btn" onclick="toggleSchemaSidebar()" title="Toggle Schema Browser">&#9776;</button>
    <div class="schema-overlay" id="schema-overlay" onclick="toggleSchemaSidebar()"></div>

    <!-- Loading Overlay (TKT-173 will wire up actual logic) -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-icon"></div>
        <div class="loading-title">Setting Up The Film Room</div>
        <div class="loading-subtitle">Cuing up the game tape...</div>
        <div class="loading-progress-container">
            <div class="loading-progress-bar">
                <div class="loading-progress-fill" id="loading-progress" style="width: 0%"></div>
            </div>
            <div class="loading-progress-text" id="loading-progress-text">Coach is grabbing the remote...</div>
        </div>
        <div class="loading-steps">
            <div class="loading-step active" id="step-engine">
                <span class="check">...</span> Firing up the analytics engine
            </div>
            <div class="loading-step" id="step-tables">
                <span class="check">...</span> Loading 15 scouting reports
            </div>
            <div class="loading-step" id="step-views">
                <span class="check">...</span> Building 52 play diagrams
            </div>
            <div class="loading-step" id="step-ready">
                <span class="check">...</span> Film Room ready  play ball
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-brand">
            <div class="nav-logo"></div>
            <div class="nav-title">Cricket <span>Playbook</span></div>
        </div>
        <div class="nav-tabs">
            <a href="index.html" class="nav-tab">Home</a>
            <a href="teams.html" class="nav-tab">Teams</a>
            <a href="artifacts.html" class="nav-tab">Artifacts</a>
            <a href="analysis.html" class="nav-tab">Analysis</a>
            <a href="research.html" class="nav-tab">Research</a>
            <a href="research-desk.html" class="nav-tab active">The Film Room</a>
            <a href="about.html" class="nav-tab">About</a>
            <a href="../../mission_control/dashboard/index.html" class="nav-tab">The Boardroom</a>
        </div>
        <div class="nav-actions">
            <span class="nav-time" id="navTime">--:--:--</span>
            <button type="button" class="mobile-menu-btn" onclick="toggleMobileMenu()" title="Menu">
                <span></span><span></span><span></span>
            </button>
            <button type="button" class="theme-toggle" onclick="toggleTheme()"></button>
        </div>
    </nav>

    <!-- Mobile Navigation Menu -->
    <div class="mobile-nav-menu" id="mobile-nav-menu">
        <a href="index.html" class="nav-tab"> Home</a>
        <a href="teams.html" class="nav-tab"> Teams</a>
        <a href="artifacts.html" class="nav-tab"> Artifacts</a>
        <a href="analysis.html" class="nav-tab"> Analysis</a>
        <a href="research.html" class="nav-tab"> Research</a>
        <a href="research-desk.html" class="nav-tab active"> The Film Room</a>
        <a href="about.html" class="nav-tab"> About</a>
        <a href="../../mission_control/dashboard/index.html" class="nav-tab" style="background: linear-gradient(135deg, var(--accent) 0%, var(--accent-purple) 100%); color: white;"> The Boardroom</a>
    </div>

    <main class="main">
        <header class="page-header">
            <div class="typewriter-container">
                <h1 class="page-title"> The Film Room</h1>
            </div>
            <p class="page-tagline" style="font-size: 17px; font-weight: 600; color: var(--accent); margin-bottom: 8px; font-style: italic;">
                "Where coaches break down the game, one query at a time"
            </p>
            <p class="page-subtitle">
                Every delivery. Every match. Every season. Pull up the tape on any player, team, or matchup
                across IPL history. The playbook is open  run your own plays.
            </p>
        </header>

        <div class="desk-container">
            <!-- Schema Browser (Left Sidebar)  TKT-175: Interactive -->
            <aside class="schema-sidebar" id="schema-browser">
                <div class="schema-header">
                    <h3>Schema Browser</h3>
                    <span class="has-tooltip has-tooltip-below" data-tooltip="Click to expand columns. Click a column to insert into editor. Use scope toggle to switch between all-time and recent data.">
                        <span class="help-icon">?</span>
                    </span>
                </div>
                <input type="text" class="schema-search" placeholder="Filter views, tables & columns..." id="schema-search" autocomplete="off">
                <!-- Quick Start Queries -->
                <div class="schema-quick-start" id="schema-quick-start">
                    <div class="schema-quick-start-title">&#9889; Quick Start Queries</div>
                    <div class="schema-quick-query" onclick="setEditorSQL('SELECT player_name, runs, balls_faced,\n  ROUND(strike_rate, 2) AS strike_rate,\n  ROUND(batting_average, 1) AS avg\nFROM analytics_ipl_batting_career\nORDER BY runs DESC\nLIMIT 20;'); window.executeQuery();">
                        <span class="qq-icon">&#127942;</span>
                        <div class="qq-text">
                            <div class="qq-title">Top 20 Run Scorers</div>
                            <div class="qq-desc">All-time highest IPL run scorers</div>
                        </div>
                    </div>
                    <div class="schema-quick-query" onclick="setEditorSQL('SELECT player_name, matches_bowled, wickets,\n  ROUND(economy_rate, 2) AS economy,\n  ROUND(bowling_average, 1) AS avg\nFROM analytics_ipl_bowling_career\nORDER BY wickets DESC\nLIMIT 20;'); window.executeQuery();">
                        <span class="qq-icon">&#127936;</span>
                        <div class="qq-text">
                            <div class="qq-title">Top 20 Wicket Takers</div>
                            <div class="qq-desc">All-time leading IPL wicket takers</div>
                        </div>
                    </div>
                    <div class="schema-quick-query" onclick="setEditorSQL('SELECT player_name, match_phase, innings, runs, balls_faced,\n  ROUND(strike_rate, 2) AS sr,\n  ROUND(boundary_pct, 1) AS boundary_pct\nFROM analytics_ipl_batter_phase\nWHERE match_phase = \'death\' AND balls_faced >= 200\nORDER BY strike_rate DESC\nLIMIT 20;'); window.executeQuery();">
                        <span class="qq-icon">&#128293;</span>
                        <div class="qq-text">
                            <div class="qq-title">Death Over Hitters</div>
                            <div class="qq-desc">Best death-overs batters (min 200 balls)</div>
                        </div>
                    </div>
                    <div class="schema-quick-query" onclick="setEditorSQL('SELECT player_name, matches, balls_bowled,\n  ROUND(economy_rate, 2) AS economy,\n  ROUND(dot_ball_pct, 1) AS dot_pct, wickets\nFROM analytics_ipl_bowler_phase\nWHERE match_phase = \'death\' AND balls_bowled >= 200\nORDER BY economy_rate ASC\nLIMIT 20;'); window.executeQuery();">
                        <span class="qq-icon">&#127919;</span>
                        <div class="qq-text">
                            <div class="qq-title">Best Death Bowlers</div>
                            <div class="qq-desc">Lowest economy at death (min 200 balls)</div>
                        </div>
                    </div>
                    <div class="schema-quick-query" onclick="setEditorSQL('SELECT venue_name, MAX(matches) AS matches,\n  ROUND(AVG(run_rate), 2) AS run_rate,\n  ROUND(AVG(boundary_pct), 1) AS boundary_pct,\n  ROUND(AVG(dot_ball_pct), 1) AS dot_pct\nFROM analytics_ipl_venue_profile_alltime\nGROUP BY venue_name\nORDER BY matches DESC\nLIMIT 20;'); window.executeQuery();">
                        <span class="qq-icon">&#127967;</span>
                        <div class="qq-text">
                            <div class="qq-title">Venue Profiles</div>
                            <div class="qq-desc">Ground characteristics and scoring patterns</div>
                        </div>
                    </div>
                    <div class="schema-quick-query" onclick="setEditorSQL('SELECT team_name, player_name, role,\n  price_cr, acquisition_type, batting_hand\nFROM analytics_ipl_team_roster\nORDER BY team_name, role;'); window.executeQuery();">
                        <span class="qq-icon">&#128101;</span>
                        <div class="qq-text">
                            <div class="qq-title">IPL 2026 Squads</div>
                            <div class="qq-desc">Full team rosters with player roles</div>
                        </div>
                    </div>
                </div>
                <!-- Scope Toggle -->
                <div class="schema-scope-toggle" id="schema-scope-toggle">
                    <button type="button" class="schema-scope-btn active" data-scope="default" onclick="setSchemaScope('default')">Default</button>
                    <button type="button" class="schema-scope-btn" data-scope="alltime" onclick="setSchemaScope('alltime')">All-Time</button>
                    <button type="button" class="schema-scope-btn" data-scope="since2023" onclick="setSchemaScope('since2023')">Since 2023</button>
                </div>
                <!-- Schema groups will be rendered dynamically by TKT-175 JS -->
                <div id="schema-groups-container"></div>
            </aside>

            <!-- Main Workspace -->
            <div class="workspace">
                <!-- Natural Language Search (TKT-177) -->
                <div class="nl-search-section" id="nl-search-bar">
                    <div class="nl-search-bar" style="position:relative;">
                        <span class="nl-search-icon">&#128269;</span>
                        <input type="text" class="nl-search-input" placeholder="Ask in plain English: &quot;Kohli stats&quot;, &quot;best death bowlers&quot;, &quot;CSK squad&quot;..." id="nl-search-input" autocomplete="off" enterkeyhint="search">
                        <button type="button" class="nl-search-btn" id="nl-search-btn" title="Search" style="
                            padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 600;
                            cursor: pointer; border: 1px solid var(--accent); background: var(--accent);
                            color: #fff; transition: all 0.2s ease; white-space: nowrap;
                        " onclick="handleNLSearch()">&#9654; Ask</button>
                        <!-- Typeahead dropdown -->
                        <div id="nl-typeahead" class="nl-typeahead-dropdown" style="
                            display:none; position:absolute; top:100%; left:0; right:0; z-index:100;
                            background:var(--bg-card, #1a1a2e); border:1px solid var(--border-subtle, #333);
                            border-radius:0 0 10px 10px; max-height:260px; overflow-y:auto;
                            box-shadow:0 8px 24px rgba(0,0,0,0.4); margin-top:-1px;
                        "></div>
                    </div>
                    <div class="nl-search-hint">
                        <kbd>Enter</kbd> to search &middot; Type a player name, team, matchup, or stat question in plain English
                    </div>
                    <div class="nl-search-chips">
                        <span class="nl-chip" onclick="document.getElementById('nl-search-input').value='Kohli vs Bumrah by phase';handleNLSearch();">
                            <span class="chip-icon">&#9876;</span> Kohli vs Bumrah by phase
                        </span>
                        <span class="nl-chip" onclick="document.getElementById('nl-search-input').value='best death bowlers';handleNLSearch();">
                            <span class="chip-icon">&#127919;</span> Best death bowlers
                        </span>
                        <span class="nl-chip" onclick="document.getElementById('nl-search-input').value='CSK squad batting in powerplay';handleNLSearch();">
                            <span class="chip-icon">&#128101;</span> CSK squad powerplay
                        </span>
                        <span class="nl-chip" onclick="document.getElementById('nl-search-input').value='Kohli under pressure';handleNLSearch();">
                            <span class="chip-icon">&#128293;</span> Kohli under pressure
                        </span>
                        <span class="nl-chip" onclick="document.getElementById('nl-search-input').value='top run scorers at Wankhede';handleNLSearch();">
                            <span class="chip-icon">&#127942;</span> Top scorers at Wankhede
                        </span>
                        <span class="nl-chip" onclick="document.getElementById('nl-search-input').value='Bumrah bowling vs CSK in death';handleNLSearch();">
                            <span class="chip-icon">&#128200;</span> Bumrah vs CSK death
                        </span>
                        <span class="nl-chip" onclick="document.getElementById('nl-search-input').value='Kohli vs MI broken down by phases';handleNLSearch();">
                            <span class="chip-icon">&#128202;</span> Kohli vs MI by phase
                        </span>
                    </div>
                </div>

                <!-- SQL Editor  TKT-174 will wire up CodeMirror -->
                <div class="sql-editor-section" id="sql-editor">
                    <div class="editor-toolbar">
                        <div class="editor-toolbar-left">
                            <span class="editor-label">SQL Editor</span>
                        </div>
                        <div class="editor-toolbar-right">
                            <!-- Query History (TKT-174) -->
                            <div class="query-history-wrapper">
                                <button type="button" class="editor-btn" id="history-button" title="Query history">
                                    &#128338; History
                                </button>
                                <div class="query-history-dropdown" id="query-history-dropdown">
                                    <div class="query-history-empty">No query history yet</div>
                                </div>
                            </div>
                            <button type="button" class="editor-btn run-btn" id="run-button" title="Run query (Ctrl+Enter)">
                                &#9654; Run
                            </button>
                            <button type="button" class="editor-btn" id="copy-button" title="Copy SQL to clipboard">
                                 Copy
                            </button>
                            <button type="button" class="editor-btn" id="export-button" title="Export results as CSV">
                                 Export
                            </button>
                        </div>
                    </div>
                    <div class="sql-editor-wrapper" id="sql-editor-wrapper">
                        <textarea class="sql-editor-placeholder" id="sql-editor-textarea"
                            placeholder="-- Write your SQL query here...&#10;-- Example: SELECT * FROM analytics_ipl_batting_career LIMIT 10;&#10;&#10;"
                            spellcheck="false">SELECT
  player_name,
  runs,
  balls_faced,
  strike_rate,
  average
FROM analytics_ipl_batting_career
ORDER BY runs DESC
LIMIT 20;</textarea>
                    </div>
                    <!-- Keyboard shortcuts hint (TKT-174, cleaned by TKT-252) -->
                    <div class="editor-shortcuts-hint">
                        <kbd>Ctrl+Enter</kbd> Run
                    </div>
                </div>

                <!-- Results Panel  TKT-174 will wire up interactivity -->
                <div class="results-section" id="results-panel">
                    <div class="results-header">
                        <span class="results-label">Results</span>
                        <span class="results-meta" id="results-meta">Run a query to see results</span>
                    </div>
                    <!-- Query Explanation Panel -->
                    <div class="query-explanation-panel" id="query-explanation-panel"></div>
                    <!-- Disambiguation / Fallback Panel -->
                    <div id="disambiguation-panel"></div>
                    <div class="results-table-wrapper" id="results-table-wrapper">
                        <div class="results-empty">
                            <div class="results-empty-icon"></div>
                            <div class="results-empty-text">No results yet</div>
                            <div class="results-empty-hint">Write a SQL query above and click Run, or choose an example query below</div>
                        </div>
                    </div>
                    <!-- Pagination (TKT-174) -->
                    <div class="results-pagination" id="results-pagination">
                        <span class="results-pagination-info" id="pagination-info">Showing 0 rows</span>
                        <div class="results-pagination-controls" id="pagination-controls"></div>
                    </div>
                </div>

                <!-- The First Take (formerly Andy Flower Insights)  TKT-177 will wire up -->
                <div class="insights-section" id="andy-flower-insights">
                    <div class="insight-card">
                        <div class="insight-card-header">
                            <span class="icon"></span>
                            <h4>The First Take</h4>
                            <span class="badge">Cricket Context</span>
                        </div>
                        <p class="insight-subtitle" style="font-size: 13px; font-style: italic; color: var(--text-secondary); margin-bottom: 8px;">
                            "Stephen A. wished he had this data before going on air"
                        </p>
                        <p>
                            Run a query to receive cricket context from Andy Flower, our domain expert.
                            He'll provide tactical interpretation of your results, highlight key trends,
                            and suggest related queries to deepen your analysis.
                        </p>
                    </div>
                </div>

                <!-- Example Queries Gallery (TKT-176: 17 curated queries) -->
                <div class="examples-section" id="example-queries">
                    <div class="examples-header">
                        <h3>Example Queries</h3>
                        <div class="examples-filter">
                            <button type="button" class="examples-filter-btn active" data-filter="all">All</button>
                            <button type="button" class="examples-filter-btn" data-filter="leaderboard">Leaderboard</button>
                            <button type="button" class="examples-filter-btn" data-filter="batting">Batting</button>
                            <button type="button" class="examples-filter-btn" data-filter="bowling">Bowling</button>
                            <button type="button" class="examples-filter-btn" data-filter="team">Team</button>
                            <button type="button" class="examples-filter-btn" data-filter="matchup">Matchup</button>
                            <button type="button" class="examples-filter-btn" data-filter="phase">Phase</button>
                            <button type="button" class="examples-filter-btn" data-filter="pressure">Pressure</button>
                            <button type="button" class="examples-filter-btn" data-filter="ipl2026">IPL 2026</button>
                        </div>
                    </div>
                    <!-- Pressure Glossary Panel (TKT-050 Glossary)  visible when Pressure filter active -->
                    <div id="pressure-glossary-panel" style="display: none; margin-bottom: 16px; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border); border-radius: 12px; padding: 16px 20px; font-size: 12px; line-height: 1.6;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; cursor: pointer; user-select: none;" onclick="const bd = document.getElementById('pressure-glossary-detail'); const isOpen = bd.style.maxHeight !== '0px' && bd.style.maxHeight; bd.style.maxHeight = isOpen ? '0px' : '1500px'; this.querySelector('.pg-arrow').style.transform = isOpen ? '' : 'rotate(180deg)';">
                            <span style="font-size: 14px; font-weight: 700; color: var(--text-primary);">Pressure Glossary</span>
                            <span class="pg-arrow" style="font-size: 10px; color: var(--text-tertiary); transition: transform 0.3s ease;">&#9660;</span>
                            <span style="font-size: 11px; color: var(--text-tertiary); margin-left: auto;">What do CLUTCH, EXTREME, SR Delta mean?</span>
                        </div>
                        <div id="pressure-glossary-detail" style="max-height: 0px; overflow: hidden; transition: max-height 0.4s ease;">
                            <div style="margin-bottom: 12px;">
                                <div style="font-size: 12px; font-weight: 700; color: var(--accent); margin-bottom: 6px;">Pressure Bands (RRR-Based)</div>
                                <div style="color: var(--text-secondary); font-size: 11px;">
                                    <strong style="color: var(--text-primary);">COMFORTABLE</strong> (RRR &lt; 8) Cruising, normal play &middot;
                                    <strong style="color: var(--text-primary);">BUILDING</strong> (8-10) Above par, acceleration begins &middot;
                                    <strong style="color: var(--text-primary);">HIGH</strong> (10-12) Boundaries needed every 2-3 balls &middot;
                                    <strong style="color: var(--text-primary);">EXTREME</strong> (12-15) Six-hitting territory &middot;
                                    <strong style="color: var(--text-primary);">NEAR_IMPOSSIBLE</strong> (15+) Continuous boundaries required
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <div style="font-size: 12px; font-weight: 700; color: var(--accent); margin-bottom: 6px;">Pressure Ratings</div>
                                <div style="color: var(--text-secondary); font-size: 11px;">
                                    <strong style="color: var(--accent-green);">CLUTCH</strong> SR improves 10%+ under pressure &middot;
                                    <strong style="color: var(--accent);">PRESSURE_PROOF</strong> Metrics within &plusmn;5% across all bands &middot;
                                    <strong style="color: var(--accent-yellow);">MODERATE</strong> 5-10% change under pressure &middot;
                                    <strong style="color: var(--accent-red);">PRESSURE_SENSITIVE</strong> SR drops 10%+ under pressure &middot;
                                    <strong style="color: var(--accent-green);">FINISHER</strong> SR &gt; 170 in 15+ band (batters) &middot;
                                    <strong style="color: var(--accent);">CLOSER</strong> Economy &lt; 8.5 in 15+ band (bowlers)
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <div style="font-size: 12px; font-weight: 700; color: var(--accent); margin-bottom: 6px;">Entry Context (Batter Only)</div>
                                <div style="color: var(--text-secondary); font-size: 11px;">
                                    <strong style="color: var(--text-primary);">FRESH</strong> (&lt;10 balls) Facing pressure cold &middot;
                                    <strong style="color: var(--text-primary);">BUILDING</strong> (10-25) Partially established &middot;
                                    <strong style="color: var(--text-primary);">SET</strong> (25-40) Well established &middot;
                                    <strong style="color: var(--text-primary);">DEEP_SET</strong> (40+) Fully in rhythm
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 700; color: var(--accent); margin-bottom: 6px;">Key Metrics</div>
                                <div style="color: var(--text-secondary); font-size: 11px;">
                                    <strong style="color: var(--text-primary);">W.Score</strong> = SR Delta x sample-size bonus (log2) x death-overs bonus (30% for overs 16-20) &middot;
                                    <strong style="color: var(--text-primary);">SR Delta</strong> = % change in strike rate under pressure vs overall &middot;
                                    <strong style="color: var(--text-primary);">Death Pressure Ratio</strong> = Pressure balls in overs 16-20 / total pressure balls
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="examples-grid" id="examples-grid">
                        <!-- Cards rendered by TKT-176 JS -->
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p class="footer-text">
                Cricket Playbook  The Film Room | EPIC-012 | Powered by DuckDB-WASM | <a href="https://github.com/dwijesh-r/cricket-playbook" target="_blank">View on GitHub</a>
            </p>
        </footer>
    </main>

    <!-- Status Bar  TKT-173 will wire up live stats -->
    <div class="status-bar" id="db-status-bar">
        <div class="status-bar-left">
            <div class="status-indicator">
                <span class="status-dot loading" id="status-dot"></span>
                <span id="status-text">Setting up...</span>
            </div>
        </div>
        <div class="status-bar-right">
            <span>15 scouting reports</span>
            <span>&middot;</span>
            <span>52 play diagrams</span>
            <span>&middot;</span>
            <span>Every IPL delivery</span>
        </div>
    </div>

    <!-- Global form submission blocker: prevent any accidental page reloads on mobile -->
    <script>
        document.addEventListener('submit', function(e) { e.preventDefault(); return false; }, true);
    </script>

    <!-- Safety timeout: if module fails to load, show error instead of infinite spinner -->
    <script>
        window._filmRoomReady = false;
        setTimeout(function() {
            if (!window._filmRoomReady) {
                var overlay = document.getElementById('loading-overlay');
                var progressText = document.getElementById('loading-progress-text');
                if (overlay && !overlay.classList.contains('hidden')) {
                    if (progressText) progressText.textContent = 'Loading timed out  a CDN dependency may be unreachable. Check browser console (F12) for details.';
                    var btn = document.createElement('button');
                    btn.textContent = 'Dismiss & Browse Page';
                    btn.style.cssText = 'margin-top:16px;padding:10px 24px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:13px;font-weight:600;';
                    btn.onclick = function() { overlay.classList.add('hidden'); };
                    overlay.querySelector('.loading-steps').insertAdjacentElement('afterend', btn);
                }
            }
        }, 25000);
    </script>

    <!-- Main Application Module (TKT-173 DuckDB + TKT-174 CodeMirror & Enhancements) -->
    <script type="module">
        /* ==================== THEME ==================== */
        window.toggleTheme = function() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            document.querySelector('.theme-toggle').textContent = newTheme === 'dark' ? '\u{1F319}' : '\u{2600}\u{FE0F}';
        };

        /* ==================== MOBILE MENU ==================== */
        window.toggleMobileMenu = function() {
            const menu = document.getElementById('mobile-nav-menu');
            const btn = document.querySelector('.mobile-menu-btn');
            menu.classList.toggle('active');
            btn.classList.toggle('active');
        };

        /* ==================== INIT ==================== */
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.querySelector('.theme-toggle').textContent = savedTheme === 'dark' ? '\u{1F319}' : '\u{2600}\u{FE0F}';

        // Timer - User's local timezone
        function updateTime() {
            document.getElementById('navTime').textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
        }
        updateTime();
        setInterval(updateTime, 1000);

        /* ==================== UTILITY: escapeHtml (must be defined before usage) ==================== */
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        function escapeAttr(str) {
            return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        /* ==================== UTILITY: escapeSql  doubles single quotes to prevent SQL injection ==================== */
        function escapeSql(str) {
            return str.replace(/'/g, "''");
        }

        /* ==================== CODEMIRROR REMOVED  TEXTAREA FALLBACK (TKT-174) ==================== */
        /* CodeMirror 6 removed: 8 CDN ESM imports caused page-blocking hangs on GitHub Pages.
           The textarea works reliably. CodeMirror can be re-added later via a bundled build. */

        /* ---- Textarea keyboard shortcut: Ctrl+Enter to run ---- */
        document.getElementById('sql-editor-textarea').addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                if (window.executeQuery) window.executeQuery();
            }
        });

        // Helper: get SQL from textarea
        function getEditorSQL() {
            return document.getElementById('sql-editor-textarea').value;
        }

        // Helper: set SQL in textarea
        function setEditorSQL(sqlText) {
            document.getElementById('sql-editor-textarea').value = sqlText;
        }
        window.setEditorSQL = setEditorSQL;

        function clearEditor() {
            setEditorSQL('');
            document.getElementById('sql-editor-textarea').focus();
        }

        /* ==================== QUERY HISTORY (TKT-174) ==================== */
        const HISTORY_KEY = 'cricket_playbook_query_history';
        const MAX_HISTORY = 10;

        function getQueryHistory() {
            try {
                return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            } catch { return []; }
        }

        function saveQueryHistory(sqlText) {
            const trimmed = sqlText.trim();
            if (!trimmed) return;
            let history = getQueryHistory();
            // Remove duplicate if exists
            history = history.filter(h => h.sql !== trimmed);
            // Add to front
            history.unshift({ sql: trimmed, timestamp: Date.now() });
            // Cap at MAX_HISTORY
            if (history.length > MAX_HISTORY) history = history.slice(0, MAX_HISTORY);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }

        function renderQueryHistoryDropdown() {
            const dropdown = document.getElementById('query-history-dropdown');
            const history = getQueryHistory();
            if (history.length === 0) {
                dropdown.innerHTML = '<div class="query-history-empty">No query history yet</div>';
                return;
            }
            let html = '';
            for (const entry of history) {
                const timeStr = new Date(entry.timestamp).toLocaleString('en-US', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                const preview = entry.sql.replace(/\n/g, ' ').substring(0, 80);
                html += `<div class="query-history-item" data-sql="${escapeAttr(entry.sql)}" title="${escapeAttr(entry.sql)}">
                    ${escapeHtml(preview)}${entry.sql.length > 80 ? '...' : ''}
                    <div style="font-size:10px;color:var(--text-tertiary);margin-top:2px;">${timeStr}</div>
                </div>`;
            }
            dropdown.innerHTML = html;

            // Wire click handlers
            dropdown.querySelectorAll('.query-history-item').forEach(item => {
                item.addEventListener('click', function() {
                    setEditorSQL(this.getAttribute('data-sql'));
                    dropdown.classList.remove('open');
                    document.getElementById('sql-editor-textarea').focus();
                    document.getElementById('sql-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
            });
        }

        // History button toggle
        document.getElementById('history-button').addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('query-history-dropdown');
            renderQueryHistoryDropdown();
            dropdown.classList.toggle('open');
        });

        // Close dropdown on outside click
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('query-history-dropdown');
            if (!e.target.closest('.query-history-wrapper')) {
                dropdown.classList.remove('open');
            }
        });

        /* ==================== RESULTS PANEL ENHANCEMENTS (TKT-174) ==================== */
        const PAGE_SIZE = 50;
        let currentPage = 0;
        let sortColumn = null;
        let sortDirection = 'asc'; // 'asc' or 'desc'
        let currentResultColumns = [];
        let currentResultRows = [];
        let currentElapsed = '0';

        function renderResultsPage() {
            const resultsWrapper = document.getElementById('results-table-wrapper');
            const paginationEl = document.getElementById('results-pagination');
            const paginationInfo = document.getElementById('pagination-info');
            const paginationControls = document.getElementById('pagination-controls');
            const resultsMeta = document.getElementById('results-meta');

            const columns = currentResultColumns;
            let rows = [...currentResultRows];
            const totalRows = rows.length;

            if (totalRows === 0) {
                paginationEl.classList.remove('visible');
                resultsWrapper.innerHTML = `
                    <div class="results-empty">
                        <div class="results-empty-icon">\u{1F4CB}</div>
                        <div class="results-empty-text">Query returned 0 rows</div>
                        <div class="results-empty-hint">Executed in ${currentElapsed}s</div>
                    </div>`;
                resultsMeta.textContent = `0 rows \u00B7 ${currentElapsed}s`;
                return;
            }

            // Sort if applicable
            if (sortColumn !== null && columns[sortColumn] !== undefined) {
                const colName = columns[sortColumn];
                rows.sort((a, b) => {
                    let va = a[colName], vb = b[colName];
                    if (va === null || va === undefined) va = '';
                    if (vb === null || vb === undefined) vb = '';
                    if (typeof va === 'number' && typeof vb === 'number') {
                        return sortDirection === 'asc' ? va - vb : vb - va;
                    }
                    const sa = String(va), sb = String(vb);
                    // Try numeric comparison
                    const na = parseFloat(sa), nb = parseFloat(sb);
                    if (!isNaN(na) && !isNaN(nb)) {
                        return sortDirection === 'asc' ? na - nb : nb - na;
                    }
                    return sortDirection === 'asc' ? sa.localeCompare(sb) : sb.localeCompare(sa);
                });
            }

            // Pagination
            const totalPages = Math.ceil(totalRows / PAGE_SIZE);
            if (currentPage >= totalPages) currentPage = totalPages - 1;
            if (currentPage < 0) currentPage = 0;
            const startIdx = currentPage * PAGE_SIZE;
            const endIdx = Math.min(startIdx + PAGE_SIZE, totalRows);
            const pageRows = rows.slice(startIdx, endIdx);

            // Update meta
            resultsMeta.textContent = `Showing ${(startIdx + 1).toLocaleString()}-${endIdx.toLocaleString()} of ${totalRows.toLocaleString()} rows \u00B7 ${currentElapsed}s`;

            // Build table
            let html = '<table class="results-table"><thead><tr>';
            html += '<th style="width:40px;text-align:right;min-width:40px;">#</th>';
            for (let ci = 0; ci < columns.length; ci++) {
                const sortClass = sortColumn === ci ? (sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc') : '';
                const sortIcon = sortColumn === ci ? (sortDirection === 'asc' ? '\u25B2' : '\u25BC') : '\u25B2';
                html += `<th class="${sortClass}" data-col-idx="${ci}" style="position:relative;">`;
                html += `${escapeHtml(columns[ci])}<span class="sort-icon">${sortIcon}</span>`;
                html += `<div class="col-resize-handle" data-col-idx="${ci}"></div>`;
                html += `</th>`;
            }
            html += '</tr></thead><tbody>';

            for (let i = 0; i < pageRows.length; i++) {
                html += '<tr>';
                html += `<td style="text-align:right;color:var(--text-tertiary);font-size:10px;">${startIdx + i + 1}</td>`;
                for (const col of columns) {
                    const val = pageRows[i][col];
                    const display = val === null || val === undefined
                        ? '<span style="color:var(--text-tertiary);font-style:italic">NULL</span>'
                        : escapeHtml(String(val));
                    html += `<td>${display}</td>`;
                }
                html += '</tr>';
            }
            html += '</tbody></table>';
            resultsWrapper.innerHTML = html;

            // Pagination controls
            if (totalPages > 1) {
                paginationEl.classList.add('visible');
                paginationInfo.textContent = `Showing ${(startIdx + 1).toLocaleString()}\u2013${endIdx.toLocaleString()} of ${totalRows.toLocaleString()} rows \u00B7 ${currentElapsed}s`;

                let ctrlHtml = '';
                ctrlHtml += `<button type="button" class="pagination-btn" id="pg-prev" ${currentPage === 0 ? 'disabled' : ''}>\u25C0 Prev</button>`;

                // Show page numbers (max 7 visible)
                const maxVisible = 7;
                let startPage = Math.max(0, currentPage - Math.floor(maxVisible / 2));
                let endPage = Math.min(totalPages, startPage + maxVisible);
                if (endPage - startPage < maxVisible) startPage = Math.max(0, endPage - maxVisible);

                if (startPage > 0) {
                    ctrlHtml += `<button type="button" class="pagination-btn" data-page="0">1</button>`;
                    if (startPage > 1) ctrlHtml += `<span style="color:var(--text-tertiary);padding:0 4px;">...</span>`;
                }

                for (let p = startPage; p < endPage; p++) {
                    ctrlHtml += `<button class="pagination-btn${p === currentPage ? ' active' : ''}" data-page="${p}">${p + 1}</button>`;
                }

                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) ctrlHtml += `<span style="color:var(--text-tertiary);padding:0 4px;">...</span>`;
                    ctrlHtml += `<button type="button" class="pagination-btn" data-page="${totalPages - 1}">${totalPages}</button>`;
                }

                ctrlHtml += `<button type="button" class="pagination-btn" id="pg-next" ${currentPage >= totalPages - 1 ? 'disabled' : ''}>Next \u25B6</button>`;
                paginationControls.innerHTML = ctrlHtml;

                // Wire pagination events
                document.getElementById('pg-prev')?.addEventListener('click', () => { currentPage--; renderResultsPage(); });
                document.getElementById('pg-next')?.addEventListener('click', () => { currentPage++; renderResultsPage(); });
                paginationControls.querySelectorAll('[data-page]').forEach(btn => {
                    btn.addEventListener('click', function() {
                        currentPage = parseInt(this.getAttribute('data-page'));
                        renderResultsPage();
                    });
                });
            } else {
                paginationEl.classList.remove('visible');
                // Show simple info for small result sets
            }

            // Wire sort click on column headers
            resultsWrapper.querySelectorAll('.results-table th[data-col-idx]').forEach(th => {
                th.addEventListener('click', function(e) {
                    if (e.target.classList.contains('col-resize-handle')) return; // Don't sort on resize
                    const idx = parseInt(this.getAttribute('data-col-idx'));
                    if (sortColumn === idx) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = idx;
                        sortDirection = 'asc';
                    }
                    currentPage = 0;
                    renderResultsPage();
                });
            });

            // Wire column resize
            wireColumnResize();
        }

        // ---- Column Resize (TKT-174) ----
        function wireColumnResize() {
            const handles = document.querySelectorAll('.col-resize-handle');
            handles.forEach(handle => {
                handle.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const th = this.parentElement;
                    const startX = e.pageX;
                    const startWidth = th.offsetWidth;
                    this.classList.add('resizing');

                    function onMouseMove(e2) {
                        const diff = e2.pageX - startX;
                        th.style.width = Math.max(40, startWidth + diff) + 'px';
                        th.style.minWidth = Math.max(40, startWidth + diff) + 'px';
                    }

                    function onMouseUp() {
                        handle.classList.remove('resizing');
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    }

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            });
        }

        /* ==================== DuckDB-WASM INITIALIZATION (TKT-173) ==================== */
        /* NOTE: DuckDB import is deferred to avoid top-level await blocking module evaluation.
           The import happens inside loadAndInitDuckDB() which is called at the bottom of this module. */
        let duckdb = null;

        // Global state
        let db = null;
        let conn = null;
        let lastQueryResults = null;
        let totalRowsLoaded = 0;

        // UI references
        const progressBar = document.getElementById('loading-progress');
        const progressText = document.getElementById('loading-progress-text');
        const overlay = document.getElementById('loading-overlay');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');

        // Table manifest - all 15 Parquet files
        const TABLE_FILES = [
            'dim_bowler_classification',
            'dim_franchise_alias',
            'dim_match',
            'dim_player',
            'dim_player_name_history',
            'dim_team',
            'dim_tournament',
            'dim_venue',
            'fact_ball',
            'fact_player_match_performance',
            'fact_powerplay',
            'ipl_2026_contracts',
            'ipl_2026_squads',
            'player_clusters_batters',
            'player_clusters_bowlers',
            'founder_squads_2026'
        ];

        function setLoadingStep(stepId, state) {
            const el = document.getElementById(stepId);
            if (!el) return;
            el.classList.remove('active', 'done');
            if (state === 'active') {
                el.classList.add('active');
                el.querySelector('.check').textContent = '...';
            } else if (state === 'done') {
                el.classList.add('done');
                el.querySelector('.check').textContent = '\u2713';
            }
        }

        function setProgress(pct, text) {
            progressBar.style.width = pct + '%';
            if (text) progressText.textContent = text;
        }

        function setStatus(state, text) {
            statusDot.classList.remove('loading', 'error');
            if (state === 'loading') statusDot.classList.add('loading');
            if (state === 'error') statusDot.classList.add('error');
            statusText.textContent = text;
        }

        // Detect mobile: small screen OR touch-only device
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || (window.innerWidth <= 768 && 'ontouchstart' in window);

        async function initDuckDB() {
            try {
                // Mobile: use httpfs (HTTP range requests) for large tables to avoid memory crashes
                // Desktop: load all tables into memory for maximum performance

                setLoadingStep('step-engine', 'active');
                setProgress(5, isMobile ? 'Mobile mode  warming up engine...' : 'Warming up the analytics engine...');

                const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
                const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

                const worker_url = URL.createObjectURL(
                    new Blob([`importScripts("${bundle.mainWorker}");`], { type: 'text/javascript' })
                );

                const worker = new Worker(worker_url);
                const logger = new duckdb.ConsoleLogger();
                db = new duckdb.AsyncDuckDB(logger, worker);

                // SharedArrayBuffer requires COOP/COEP headers (not available on GitHub Pages)
                // Fall back to single-threaded mode gracefully
                const hasSAB = typeof SharedArrayBuffer !== 'undefined';
                try {
                    await db.instantiate(bundle.mainModule, hasSAB ? bundle.pthreadWorker : null);
                } catch (instantiateErr) {
                    console.warn('Multi-threaded init failed, falling back to single-threaded:', instantiateErr.message);
                    await db.instantiate(bundle.mainModule);
                }
                URL.revokeObjectURL(worker_url);

                conn = await db.connect();

                setLoadingStep('step-engine', 'done');
                setProgress(20, 'Engine ready  loading the scouting data...');

                setLoadingStep('step-tables', 'active');
                const basePath = 'data/sql_lab/tables/';

                // fact_ball is ~14MB  too large for mobile memory.
                // On mobile, use httpfs (HTTP range requests) so DuckDB fetches only the
                // column chunks needed per query (~200-500KB) instead of the full file.
                const HEAVY_TABLES = ['fact_ball'];

                for (let i = 0; i < TABLE_FILES.length; i++) {
                    const tableName = TABLE_FILES[i];
                    const filePath = basePath + tableName + '.parquet';
                    const pct = 20 + Math.round(((i + 1) / TABLE_FILES.length) * 50);
                    setProgress(pct, `Scouting ${tableName.replace(/_/g, ' ')}... ${i + 1}/${TABLE_FILES.length}`);

                    try {
                        if (isMobile && HEAVY_TABLES.includes(tableName)) {
                            // Mobile httpfs: register URL for HTTP range requests  no full download
                            const fileUrl = new URL(filePath, window.location.href).href;
                            await db.registerFileURL(tableName + '.parquet', fileUrl, duckdb.DuckDBDataProtocol.HTTP, false);
                            await conn.query(`CREATE VIEW ${tableName} AS SELECT * FROM read_parquet('${tableName}.parquet')`);
                            const countResult = await conn.query(`SELECT count(*) AS cnt FROM ${tableName}`);
                            const rows = Number(countResult.toArray()[0].cnt);
                            totalRowsLoaded += rows;
                            console.log(` ${tableName}: remote Parquet via httpfs (${rows} rows)`);
                        } else {
                            // Desktop (all tables) + Mobile (small tables): full load into memory
                            const response = await fetch(filePath);
                            if (!response.ok) throw new Error(`HTTP ${response.status} for ${filePath}`);
                            const buffer = new Uint8Array(await response.arrayBuffer());
                            await db.registerFileBuffer(tableName + '.parquet', buffer);
                            await conn.query(`CREATE TABLE ${tableName} AS SELECT * FROM read_parquet('${tableName}.parquet')`);
                            const countResult = await conn.query(`SELECT count(*) AS cnt FROM ${tableName}`);
                            const rows = Number(countResult.toArray()[0].cnt);
                            totalRowsLoaded += rows;
                        }
                    } catch (tableErr) {
                        console.error(`Failed to load table ${tableName}:`, tableErr);
                    }
                }

                setLoadingStep('step-tables', 'done');
                setProgress(70, `All scouting reports loaded  ${formatRowCount(totalRowsLoaded)} data points`);

                setLoadingStep('step-views', 'active');
                setProgress(72, 'Drawing up the play diagrams...');

                let viewsCreated = 0;
                let viewsFailed = 0;

                try {
                    const viewsResponse = await fetch('data/sql_lab/views.sql');
                    if (!viewsResponse.ok) throw new Error(`HTTP ${viewsResponse.status} for views.sql`);
                    const viewsSql = await viewsResponse.text();
                    const viewStatements = viewsSql.split(/(?=CREATE OR REPLACE VIEW)/i).filter(s => s.trim().length > 0 && s.trim().startsWith('CREATE'));

                    for (let i = 0; i < viewStatements.length; i++) {
                        const stmt = viewStatements[i].trim();
                        if (!stmt) continue;
                        const cleanStmt = stmt.replace(/;\s*$/, '');
                        try {
                            await conn.query(cleanStmt);
                            viewsCreated++;
                        } catch (viewErr) {
                            viewsFailed++;
                            console.warn(`View creation failed: ${viewErr.message.substring(0, 120)}`);
                        }
                        if (i % 5 === 0) {
                            const pct = 72 + Math.round(((i + 1) / viewStatements.length) * 23);
                            setProgress(pct, `Building playbook page ${i + 1} of ${viewStatements.length}...`);
                        }
                    }
                } catch (viewsErr) {
                    console.error('Failed to load views.sql:', viewsErr);
                }

                setLoadingStep('step-views', 'done');
                setProgress(95, `${viewsCreated} play diagrams ready`);

                setLoadingStep('step-ready', 'active');
                setProgress(100, `Game time! ${formatRowCount(totalRowsLoaded)} data points loaded`);

                await new Promise(resolve => setTimeout(resolve, 600));

                setLoadingStep('step-ready', 'done');
                overlay.classList.add('hidden');

                setStatus('connected', 'Film Room Active');
                updateStatusBarStats(viewsCreated);
                document.getElementById('run-button').disabled = false;

                console.log(`The Film Room ready: ${TABLE_FILES.length} tables, ${viewsCreated} views, ${formatRowCount(totalRowsLoaded)} rows`);
                if (viewsFailed > 0) console.warn(`${viewsFailed} views failed to create`);

            } catch (err) {
                console.error('DuckDB initialization failed:', err);
                setStatus('error', 'Technical Timeout');
                progressText.textContent = 'The engine stalled: ' + err.message;
                statusDot.classList.remove('loading');
                statusDot.classList.add('error');

                const overlayEl = document.getElementById('loading-overlay');
                const dismissBtn = document.createElement('button');
                dismissBtn.textContent = 'Dismiss & Continue';
                dismissBtn.style.cssText = 'margin-top:16px;padding:8px 20px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:13px;font-weight:600;';
                dismissBtn.onclick = () => overlayEl.classList.add('hidden');
                overlayEl.appendChild(dismissBtn);
            }
        }

        function formatRowCount(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(0) + 'K';
            return String(n);
        }

        function updateStatusBarStats(viewCount) {
            const rightBar = document.querySelector('.status-bar-right');
            rightBar.innerHTML = `
                <span>${TABLE_FILES.length} scouting reports</span>
                <span>&middot;</span>
                <span>${viewCount} play diagrams</span>
                <span>&middot;</span>
                <span>${formatRowCount(totalRowsLoaded)} data points</span>
            `;
        }

        /* ==================== SQL QUERY EXECUTION (TKT-173, enhanced TKT-174) ==================== */
        async function executeQuery() {
            if (!conn) {
                showError('Database not connected. Please wait for initialization to complete.');
                return;
            }

            const sqlText = getEditorSQL().trim();
            if (!sqlText) {
                showError('Please enter a SQL query.');
                return;
            }

            const runBtn = document.getElementById('run-button');
            const resultsMeta = document.getElementById('results-meta');

            runBtn.disabled = true;
            runBtn.innerHTML = '&#9654; Running...';
            resultsMeta.textContent = 'Executing query...';

            const startTime = performance.now();

            try {
                const result = await conn.query(sqlText);
                const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);

                const rows = result.toArray().map(row => {
                    const obj = {};
                    for (const field of result.schema.fields) {
                        let val = row[field.name];
                        if (typeof val === 'bigint') val = Number(val);
                        obj[field.name] = val;
                    }
                    return obj;
                });

                const columns = result.schema.fields.map(f => f.name);

                // Store for export
                lastQueryResults = { columns, rows };

                // Save to query history (TKT-174)
                saveQueryHistory(sqlText);

                // Render with pagination (TKT-174)
                currentResultColumns = columns;
                currentResultRows = rows;
                currentElapsed = elapsed;
                currentPage = 0;
                sortColumn = null;
                sortDirection = 'asc';
                renderResultsPage();

            } catch (err) {
                const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
                showError(err.message, elapsed);
                document.getElementById('results-pagination').classList.remove('visible');
            } finally {
                runBtn.disabled = false;
                runBtn.innerHTML = '&#9654; Run';
            }
        }

        // Make executeQuery available globally so CodeMirror keymap can call it
        window.executeQuery = executeQuery;

        function showError(message, elapsed) {
            const resultsMeta = document.getElementById('results-meta');
            const resultsWrapper = document.getElementById('results-table-wrapper');

            resultsMeta.textContent = elapsed ? `Error \u00B7 ${elapsed}s` : 'Error';
            resultsWrapper.innerHTML = `
                <div class="results-empty" style="color: var(--accent-red);">
                    <div class="results-empty-icon">\u26A0\uFE0F</div>
                    <div class="results-empty-text" style="color: var(--accent-red); font-weight: 600;">Query Error</div>
                    <div class="results-empty-hint" style="color: var(--text-secondary); max-width: 600px; word-break: break-word; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.6; text-align: left; background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-top: 8px;">${escapeHtml(message)}</div>
                </div>`;
        }

        /* ==================== COPY BUTTON (TKT-173, updated for CodeMirror TKT-174) ==================== */
        function copySQL() {
            const sqlText = getEditorSQL();
            if (!sqlText.trim()) return;

            navigator.clipboard.writeText(sqlText).then(() => {
                const btn = document.getElementById('copy-button');
                const original = btn.innerHTML;
                btn.innerHTML = '\u2705 Copied!';
                btn.style.borderColor = 'var(--accent-green)';
                setTimeout(() => { btn.innerHTML = original; btn.style.borderColor = ''; }, 1500);
            }).catch(() => {
                // Fallback
                const ta = document.createElement('textarea');
                ta.value = sqlText;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                const btn = document.getElementById('copy-button');
                const original = btn.innerHTML;
                btn.innerHTML = '\u2705 Copied!';
                setTimeout(() => { btn.innerHTML = original; }, 1500);
            });
        }

        /* ==================== EXPORT BUTTON (TKT-173) ==================== */
        function exportCSV() {
            if (!lastQueryResults || !lastQueryResults.rows.length) {
                const btn = document.getElementById('export-button');
                const original = btn.innerHTML;
                btn.innerHTML = '\u274C No data';
                setTimeout(() => { btn.innerHTML = original; }, 1500);
                return;
            }

            const { columns, rows } = lastQueryResults;
            const csvRows = [];
            csvRows.push(columns.map(c => `"${c.replace(/"/g, '""')}"`).join(','));
            for (const row of rows) {
                const values = columns.map(col => {
                    const val = row[col];
                    if (val === null || val === undefined) return '';
                    return `"${String(val).replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            }

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `research_desk_export_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            const btn = document.getElementById('export-button');
            const original = btn.innerHTML;
            btn.innerHTML = '\u2705 Exported!';
            btn.style.borderColor = 'var(--accent-green)';
            setTimeout(() => { btn.innerHTML = original; btn.style.borderColor = ''; }, 1500);
        }

        /* ==================== WIRE BUTTONS ==================== */
        document.getElementById('run-button').addEventListener('click', executeQuery);
        document.getElementById('copy-button').addEventListener('click', copySQL);
        document.getElementById('export-button').addEventListener('click', exportCSV);

        /* ==================== TKT-175: INTERACTIVE SCHEMA BROWSER ==================== */
        let tableMetadata = null;
        let currentSchemaScope = 'default';

        // View category definitions with icons and descriptions
        const VIEW_CATEGORIES = [
            { id: 'batting',   label: 'Batting',           icon: '&#127951;', desc: 'Career stats, phase splits, strike rates, averages' },
            { id: 'bowling',   label: 'Bowling',           icon: '&#127936;', desc: 'Wickets, economy, phase splits, bowling types' },
            { id: 'pressure',  label: 'Pressure / Clutch', icon: '&#128293;', desc: 'Pressure bands, dot sequences, boundary sequences' },
            { id: 'matchups',  label: 'Matchups',          icon: '&#9876;',   desc: 'Batter vs bowler, batter vs team, bowler vs team' },
            { id: 'venue',     label: 'Venue',             icon: '&#127967;', desc: 'Venue profiles, player venue splits, phase by venue' },
            { id: 'squad',     label: 'Squad / Team',      icon: '&#128101;', desc: 'Team rosters, squad batting/bowling, phase scoring' },
            { id: 'season',    label: 'Season & Trends',   icon: '&#128200;', desc: 'By season, by tournament, innings progression' },
            { id: 'benchmarks',label: 'Benchmarks',        icon: '&#128202;', desc: 'Career benchmarks, batting/bowling percentiles' },
            { id: 'leaderboard', label: 'Leaderboards',    icon: '&#127942;', desc: 'Top run scorers, top wicket takers, best SR/economy' },
        ];

        // Assign views to refined categories (overrides the flat metadata category)
        function classifyView(name, metaCategory) {
            const n = name.toLowerCase();
            // Matchups: batter_vs_bowler, batter_vs_team, bowler_vs_team, bowler_vs_batter, vs_bowler_type
            if (n.includes('_vs_bowler') || n.includes('_vs_team') || n.includes('_vs_batter') || n.includes('handedness')) return 'matchups';
            // Venue
            if (n.includes('_venue')) return 'venue';
            // Squad / Team
            if (n.includes('_squad_') || n.includes('_team_roster') || n.includes('_team_phase_scoring')) return 'squad';
            // Season & Trends
            if (n.includes('_by_season') || n.includes('_by_tournament') || n.includes('_innings_progression') || n.includes('_match_context') || n.includes('_partnership_analysis') || n.includes('_required_rate') || n.includes('_wicket_clusters') || n.includes('_new_batter_vulnerability') || n.includes('_entry_point') || n.includes('_batting_order_flexibility') || n.includes('_bowling_change_impact')) return 'season';
            // Pressure
            if (metaCategory === 'pressure' || n.includes('_pressure_') || n.includes('_dot_ball_pressure') || n.includes('_dot_sequences') || n.includes('_boundary_sequences')) return 'pressure';
            // Benchmarks
            if (n.includes('_benchmark') || n.includes('_percentile')) return 'benchmarks';
            // Leaderboards
            if (metaCategory === 'leaderboard' || n.includes('_top_run_') || n.includes('_top_wicket_') || n.includes('_best_economy') || n.includes('_best_strike_rate') || n.includes('_powerplay_hitters') || n.includes('_death_over_specialists')) return 'leaderboard';
            // Fall through to batting/bowling from metadata
            if (metaCategory === 'bowling') return 'bowling';
            return 'batting';
        }

        // Determine scope from view name
        function getViewScope(name) {
            if (name.endsWith('_alltime')) return 'alltime';
            if (name.endsWith('_since2023')) return 'since2023';
            return 'default';
        }

        // Create a human-readable display name from a view name
        function viewDisplayName(name) {
            let display = name
                .replace(/^analytics_ipl_/, '')
                .replace(/^analytics_t20_/, 't20_')
                .replace(/^analytics_/, '')
                .replace(/_alltime$/, '')
                .replace(/_since2023$/, '');
            // Convert underscores to spaces and title-case
            display = display.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            // Fix common abbreviations
            display = display.replace(/\bVs\b/g, 'vs').replace(/\bPct\b/g, '%').replace(/\bSr\b/g, 'SR').replace(/\bIpl\b/g, 'IPL').replace(/\bT20\b/g, 'T20');
            return display;
        }

        // Human-readable description for a view (uses metadata desc or generates one)
        function viewDescription(name, info) {
            const desc = (info.description || '').trim();
            // If description is just the auto-generated short label, generate a better one
            if (desc && desc.length > 20) return desc;
            const n = name.toLowerCase();
            if (n.includes('_career')) return 'Career aggregates across all matches';
            if (n.includes('_phase_percentile')) return 'Percentile rankings by match phase';
            if (n.includes('_percentile')) return 'Percentile rankings for key metrics';
            if (n.includes('_phase_distribution')) return 'Phase-wise workload distribution';
            if (n.includes('_phase')) return 'Splits by powerplay, middle, and death overs';
            if (n.includes('_venue')) return 'Performance broken down by ground';
            if (n.includes('_vs_bowler_type')) return 'Splits against pace, spin, and variants';
            if (n.includes('_vs_bowler')) return 'Head-to-head matchup statistics';
            if (n.includes('_vs_team')) return 'Performance against each franchise';
            if (n.includes('_vs_batter')) return 'Bowler head-to-head vs specific batters';
            if (n.includes('_pressure_deltas')) return 'How pressure changes batting/bowling output';
            if (n.includes('_pressure_bands')) return 'Performance across low/medium/high pressure';
            if (n.includes('_benchmark')) return 'Reference thresholds for key metrics';
            if (n.includes('_squad_batting')) return 'Team-level batting aggregates';
            if (n.includes('_squad_bowling')) return 'Team-level bowling aggregates';
            if (n.includes('_team_roster')) return 'Current squad composition and roles';
            if (n.includes('_team_phase_scoring')) return 'Team scoring rates by match phase';
            if (n.includes('_venue_profile')) return 'Ground characteristics and scoring trends';
            if (n.includes('_innings_progression')) return 'Over-by-over scoring and wicket patterns';
            if (n.includes('_match_context')) return 'Situational performance in match scenarios';
            if (n.includes('_partnership')) return 'Partnership-level analysis and patterns';
            if (n.includes('_entry_point')) return 'Batting position and entry point impact';
            if (n.includes('_order_flexibility')) return 'Batting order versatility metrics';
            if (n.includes('_over_breakdown')) return 'Bowling breakdown by specific overs';
            if (n.includes('_change_impact')) return 'Bowling change impact on game flow';
            if (n.includes('_wicket_clusters')) return 'Patterns of wickets falling in clusters';
            if (n.includes('_dot_ball_pressure')) return 'Dot ball accumulation pressure metrics';
            if (n.includes('_dot_sequences')) return 'Consecutive dot ball sequence analysis';
            if (n.includes('_boundary_sequences')) return 'Boundary-heavy over sequences';
            if (n.includes('_required_rate')) return 'Performance at different required run rates';
            if (n.includes('_new_batter_vulnerability')) return 'New batter early-innings vulnerability';
            if (n.includes('_handedness')) return 'Left-hand vs right-hand matchup splits';
            return desc || 'Analytics view';
        }

        // Load metadata and build interactive schema browser
        async function buildInteractiveSchema() {
            try {
                const resp = await fetch('data/sql_lab/table_metadata.json');
                if (!resp.ok) throw new Error('Failed to load metadata');
                tableMetadata = await resp.json();
            } catch(e) {
                console.warn('TKT-175: Could not load table_metadata.json:', e);
                return;
            }

            renderSchemaGroups();
        }

        function renderSchemaGroups() {
            const container = document.getElementById('schema-groups-container');
            if (!container || !tableMetadata) return;

            // Group tables by type
            const tableGroups = [
                { label: 'Dimension Tables', type: 'dimension', cssClass: 'dim', icon: '&#9679;' },
                { label: 'Fact Tables', type: 'fact', cssClass: 'fact', icon: '&#9679;' },
                { label: 'Reference Tables', type: 'reference', cssClass: 'ref', icon: '&#9679;' },
                { label: 'Analytics Tables', type: 'analytics', cssClass: 'cluster', icon: '&#9679;' },
            ];

            let html = '';

            // --- Render table groups (unchanged) ---
            for (const group of tableGroups) {
                const tables = Object.entries(tableMetadata.tables || {}).filter(([, info]) => info.type === group.type);
                if (tables.length === 0) continue;

                html += `<div class="schema-group" data-group-type="${group.type}">`;
                html += `<div class="schema-group-label"><span class="group-chevron">&#9660;</span>${group.label} (${tables.length})</div>`;

                for (const [name, info] of tables) {
                    const rowDisplay = formatSchemaRowCount(info.rows);
                    html += buildSchemaItem(name, info, group.cssClass, rowDisplay, 'table');
                }
                html += `</div>`;
            }

            // --- Render views grouped by category with scope filtering ---
            const allViews = Object.entries(tableMetadata.views || {});

            // Classify and deduplicate views: group by base name, filter by scope
            const viewsByCategory = {};
            for (const cat of VIEW_CATEGORIES) {
                viewsByCategory[cat.id] = [];
            }

            // Collect unique base view names for the current scope
            const seenBaseNames = new Set();

            for (const [name, info] of allViews) {
                const scope = getViewScope(name);
                const cat = classifyView(name, info.category);

                // For scope filtering: show "default" views always, and also show scoped views matching the toggle
                if (currentSchemaScope === 'default') {
                    // Show only default-scope views (no _alltime or _since2023 suffix)
                    if (scope !== 'default') continue;
                } else if (currentSchemaScope === 'alltime') {
                    // Show alltime views; for views that don't have an alltime variant, show default
                    if (scope === 'since2023') continue;
                    if (scope === 'default') {
                        // Check if an alltime variant exists
                        const alltimeVariant = name + '_alltime';
                        if (tableMetadata.views[alltimeVariant]) continue; // skip default, alltime exists
                    }
                } else if (currentSchemaScope === 'since2023') {
                    if (scope === 'alltime') continue;
                    if (scope === 'default') {
                        const since2023Variant = name + '_since2023';
                        if (tableMetadata.views[since2023Variant]) continue;
                    }
                }

                if (!viewsByCategory[cat]) viewsByCategory[cat] = [];
                viewsByCategory[cat].push({ name, info, scope });
            }

            // Render each view category
            for (const cat of VIEW_CATEGORIES) {
                const views = viewsByCategory[cat.id] || [];
                if (views.length === 0) continue;

                html += `<div class="schema-view-category" data-view-category="${cat.id}">`;
                html += `<div class="schema-view-category-header">`;
                html += `<span class="group-chevron">&#9660;</span>`;
                html += `<span class="cat-icon">${cat.icon}</span>`;
                html += `<span>${cat.label}</span>`;
                html += `<span class="cat-count">${views.length}</span>`;
                html += `</div>`;
                html += `<div class="schema-view-items">`;

                for (const { name, info } of views) {
                    const displayName = viewDisplayName(name);
                    const desc = viewDescription(name, info);
                    html += buildSchemaItem(name, info, 'view', '', 'view', displayName);
                    html += `<span class="schema-view-item-desc" data-desc-for="${name}">${desc}</span>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            container.innerHTML = html;
            wireSchemaInteractions();
        }

        // Scope toggle handler
        function setSchemaScope(scope) {
            currentSchemaScope = scope;
            document.querySelectorAll('.schema-scope-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-scope') === scope);
            });
            // Re-render the schema groups with new scope
            renderSchemaGroups();
        }
        window.setSchemaScope = setSchemaScope;

        function formatSchemaRowCount(n) {
            if (n === undefined || n === null) return '';
            if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(0) + 'K';
            return String(n);
        }

        function getColTypeClass(type) {
            const t = (type || '').toUpperCase();
            if (t === 'VARCHAR') return 'type-varchar';
            if (t === 'BIGINT') return 'type-bigint';
            if (t === 'HUGEINT') return 'type-hugeint';
            if (t === 'INTEGER') return 'type-integer';
            if (t === 'DOUBLE') return 'type-double';
            if (t === 'BOOLEAN') return 'type-boolean';
            return 'type-default';
        }

        function buildSchemaItem(name, info, cssClass, rowDisplay, itemType, displayLabel) {
            const columns = info.columns || [];
            const dataAttr = itemType === 'view' ? `data-view="${name}"` : `data-table="${name}"`;
            const label = displayLabel || name;
            let html = '';
            html += `<div class="schema-item schema-item-${cssClass}" ${dataAttr}>`;
            html += `<span class="chevron">&#9654;</span>`;
            html += `<span class="icon">&#9679;</span>`;
            html += `<span class="table-name" title="${name}">${label}</span>`;
            html += `<button type="button" class="query-btn" title="SELECT * FROM ${name} LIMIT 100">SQL</button>`;
            if (rowDisplay) html += `<span class="row-count">${rowDisplay}</span>`;
            html += `</div>`;

            // Column sub-list
            html += `<div class="schema-columns" data-parent="${name}">`;
            for (const col of columns) {
                const typeClass = getColTypeClass(col.type);
                const tooltip = col.description ? ` title="${escapeHtml(col.description)}"` : '';
                html += `<div class="schema-col-item" data-col="${col.name}" data-parent-table="${name}"${tooltip}>`;
                html += `<span class="col-name">${col.name}</span>`;
                html += `<span class="col-type ${typeClass}">${col.type}</span>`;
                html += `</div>`;
            }
            html += `</div>`;
            return html;
        }

        function wireSchemaInteractions() {
            // Click table group label to collapse/expand
            document.querySelectorAll('#schema-groups-container .schema-group-label').forEach(label => {
                label.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const group = this.closest('.schema-group');
                    if (group) group.classList.toggle('group-collapsed');
                });
            });

            // Click view category header to collapse/expand
            document.querySelectorAll('#schema-groups-container .schema-view-category-header').forEach(header => {
                header.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const cat = this.closest('.schema-view-category');
                    if (cat) cat.classList.toggle('cat-collapsed');
                });
            });

            // Click schema item to expand/collapse columns
            document.querySelectorAll('#schema-groups-container .schema-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    // If clicking the SQL button, load query instead
                    if (e.target.classList.contains('query-btn')) {
                        e.stopPropagation();
                        const tableName = this.getAttribute('data-table') || this.getAttribute('data-view');
                        if (!tableName) return;
                        setEditorSQL(`SELECT * FROM ${tableName} LIMIT 100;`);
                        document.getElementById('sql-editor-textarea').focus();
                        document.getElementById('sql-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });
                        return;
                    }

                    const tableName = this.getAttribute('data-table') || this.getAttribute('data-view');
                    if (!tableName) return;

                    const columnsEl = document.querySelector(`.schema-columns[data-parent="${tableName}"]`);
                    if (!columnsEl) return;

                    const isExpanded = this.classList.contains('expanded');
                    if (isExpanded) {
                        this.classList.remove('expanded');
                        columnsEl.classList.remove('visible');
                    } else {
                        this.classList.add('expanded');
                        columnsEl.classList.add('visible');
                    }
                });
            });

            // Click column to insert into textarea at cursor
            document.querySelectorAll('#schema-groups-container .schema-col-item').forEach(colItem => {
                colItem.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const colName = this.getAttribute('data-col');
                    if (!colName) return;

                    const ta = document.getElementById('sql-editor-textarea');
                    const pos = ta.selectionStart || ta.value.length;
                    ta.value = ta.value.slice(0, pos) + colName + ta.value.slice(pos);
                    ta.focus();
                    ta.selectionStart = ta.selectionEnd = pos + colName.length;
                });
            });
        }

        // Schema search: filter by table/view name, display name, description, AND column names
        document.getElementById('schema-search').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase().trim();
            const quickStart = document.getElementById('schema-quick-start');

            // Hide quick start when searching, show when empty
            if (quickStart) quickStart.style.display = query ? 'none' : '';

            document.querySelectorAll('#schema-groups-container .schema-item').forEach(item => {
                const tableName = (item.getAttribute('data-table') || item.getAttribute('data-view') || '').toLowerCase();
                const displayName = (item.querySelector('.table-name')?.textContent || '').toLowerCase();
                const columnsEl = document.querySelector(`.schema-columns[data-parent="${tableName}"]`);
                // Also check the description text
                const descEl = document.querySelector(`.schema-view-item-desc[data-desc-for="${item.getAttribute('data-view')}"]`);
                const descText = descEl ? descEl.textContent.toLowerCase() : '';

                if (!query) {
                    item.style.display = '';
                    if (descEl) descEl.style.display = '';
                    // Remove search-triggered expansions
                    if (item.hasAttribute('data-search-expanded')) {
                        item.classList.remove('expanded');
                        item.removeAttribute('data-search-expanded');
                        if (columnsEl) columnsEl.classList.remove('visible');
                    }
                    if (columnsEl) {
                        columnsEl.style.display = '';
                        columnsEl.querySelectorAll('.schema-col-item').forEach(c => c.style.display = '');
                    }
                    return;
                }

                // Check table/view name match or display name match or description match
                let tableMatch = tableName.includes(query) || displayName.includes(query) || descText.includes(query);

                // Check column name matches
                let anyColMatch = false;
                if (columnsEl) {
                    columnsEl.querySelectorAll('.schema-col-item').forEach(colItem => {
                        const colName = (colItem.getAttribute('data-col') || '').toLowerCase();
                        if (colName.includes(query)) {
                            anyColMatch = true;
                            colItem.style.display = '';
                        } else {
                            colItem.style.display = tableMatch ? '' : 'none';
                        }
                    });
                }

                if (tableMatch || anyColMatch) {
                    item.style.display = '';
                    if (descEl) descEl.style.display = '';
                    // Auto-expand if column match found
                    if (anyColMatch && !tableMatch && columnsEl) {
                        if (!item.classList.contains('expanded')) {
                            item.setAttribute('data-search-expanded', 'true');
                        }
                        item.classList.add('expanded');
                        columnsEl.classList.add('visible');
                    }
                } else {
                    item.style.display = 'none';
                    if (descEl) descEl.style.display = 'none';
                    if (columnsEl) columnsEl.style.display = 'none';
                }
            });

            // Show/hide table group labels if all their items are hidden
            document.querySelectorAll('#schema-groups-container .schema-group').forEach(group => {
                const hasVisible = Array.from(group.querySelectorAll('.schema-item')).some(i => i.style.display !== 'none');
                group.style.display = hasVisible ? '' : 'none';
            });

            // Show/hide view category blocks if all their items are hidden
            document.querySelectorAll('#schema-groups-container .schema-view-category').forEach(cat => {
                const hasVisible = Array.from(cat.querySelectorAll('.schema-item')).some(i => i.style.display !== 'none');
                cat.style.display = hasVisible ? '' : 'none';
            });
        });

        /* ==================== SCHEMA SIDEBAR COLLAPSE (mobile) ==================== */
        document.querySelector('.schema-header').addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                document.querySelector('.schema-sidebar').classList.toggle('collapsed');
            }
        });

        // Build the schema browser
        buildInteractiveSchema();

        /* ==================== TKT-176: EXAMPLE QUERIES GALLERY ==================== */
        const EXAMPLE_QUERIES = [
            // Leaderboard
            {
                category: 'leaderboard',
                title: 'Top 20 IPL Run Scorers',
                description: 'All-time highest run scorers in IPL history with strike rates and averages.',
                sql: `SELECT player_name, innings, runs, balls_faced,\n  highest_score, fifties, hundreds,\n  ROUND(strike_rate, 1) AS strike_rate,\n  ROUND(batting_average, 1) AS avg\nFROM analytics_top_run_scorers\nLIMIT 20;`
            },
            {
                category: 'leaderboard',
                title: 'Top 20 IPL Wicket Takers',
                description: 'All-time leading wicket takers in IPL with economy and bowling averages.',
                sql: `SELECT player_name, matches_bowled, wickets,\n  ROUND(overs_bowled, 1) AS overs,\n  best_wickets || '/' || best_runs AS best,\n  ROUND(economy_rate, 2) AS economy,\n  ROUND(bowling_average, 1) AS avg\nFROM analytics_top_wicket_takers\nLIMIT 20;`
            },
            {
                category: 'leaderboard',
                title: 'Highest Strike Rates (min 500 balls)',
                description: 'Batters with the best strike rates in IPL, minimum 500 balls faced.',
                sql: `SELECT player_name, innings, runs, balls_faced,\n  ROUND(strike_rate, 2) AS strike_rate,\n  ROUND(batting_average, 1) AS avg,\n  ROUND(boundary_pct, 1) AS boundary_pct\nFROM analytics_ipl_batting_career\nWHERE balls_faced >= 500\nORDER BY strike_rate DESC\nLIMIT 20;`
            },
            // Batting
            {
                category: 'batting',
                title: 'Best Powerplay Batters',
                description: 'Top performers in the powerplay phase by strike rate, minimum 200 balls.',
                sql: `SELECT player_name, innings, runs, balls_faced,\n  ROUND(strike_rate, 2) AS strike_rate,\n  ROUND(batting_average, 1) AS avg,\n  ROUND(boundary_pct, 1) AS boundary_pct\nFROM analytics_ipl_batter_phase\nWHERE match_phase = 'powerplay'\n  AND balls_faced >= 200\nORDER BY strike_rate DESC\nLIMIT 20;`
            },
            {
                category: 'batting',
                title: 'Death Over Batting Specialists',
                description: 'Batters with the best death overs strike rate, minimum 200 balls faced.',
                sql: `SELECT player_name, innings, runs, balls_faced,\n  ROUND(strike_rate, 2) AS strike_rate,\n  fours, sixes,\n  ROUND(boundary_pct, 1) AS boundary_pct\nFROM analytics_ipl_batter_phase\nWHERE match_phase = 'death'\n  AND balls_faced >= 200\nORDER BY strike_rate DESC\nLIMIT 20;`
            },
            {
                category: 'batting',
                title: 'Most Sixes in IPL History',
                description: 'Players who have hit the most sixes across all IPL seasons.',
                sql: `SELECT player_name, innings, runs,\n  sixes, fours,\n  ROUND(strike_rate, 2) AS strike_rate,\n  ROUND(boundary_pct, 1) AS boundary_pct\nFROM analytics_ipl_batting_career\nWHERE balls_faced >= 100\nORDER BY sixes DESC\nLIMIT 20;`
            },
            // Bowling
            {
                category: 'bowling',
                title: 'Best Death Bowlers',
                description: 'Bowlers with the best economy rate in death overs, minimum 200 balls.',
                sql: `SELECT player_name, matches, balls_bowled,\n  ROUND(overs, 1) AS overs,\n  runs_conceded, wickets,\n  ROUND(economy_rate, 2) AS economy,\n  ROUND(dot_ball_pct, 1) AS dot_pct\nFROM analytics_ipl_bowler_phase\nWHERE match_phase = 'death'\n  AND balls_bowled >= 200\nORDER BY economy_rate ASC\nLIMIT 20;`
            },
            {
                category: 'bowling',
                title: 'Spin vs Pace Economy by Phase',
                description: 'Compare spin and pace bowling economy across powerplay, middle, and death phases.',
                sql: `SELECT\n  bc.bowling_style,\n  bp.match_phase,\n  COUNT(DISTINCT bp.player_id) AS bowlers,\n  SUM(bp.balls_bowled) AS total_balls,\n  ROUND(SUM(bp.runs_conceded) * 6.0 / SUM(bp.balls_bowled), 2) AS economy,\n  ROUND(SUM(bp.dot_balls) * 100.0 / SUM(bp.balls_bowled), 1) AS dot_pct\nFROM analytics_ipl_bowler_phase bp\nJOIN dim_bowler_classification bc ON bp.player_id = bc.player_id\nWHERE bp.balls_bowled >= 60\nGROUP BY bc.bowling_style, bp.match_phase\nORDER BY bc.bowling_style, bp.match_phase;`
            },
            {
                category: 'bowling',
                title: 'Most Dot Balls in IPL Career',
                description: 'Bowlers who have bowled the most dot balls in IPL history.',
                sql: `SELECT player_name, matches_bowled,\n  ROUND(overs_bowled, 1) AS overs,\n  wickets, dot_balls,\n  ROUND(dot_ball_pct, 1) AS dot_pct,\n  ROUND(economy_rate, 2) AS economy\nFROM analytics_ipl_bowling_career\nWHERE balls_bowled >= 300\nORDER BY dot_balls DESC\nLIMIT 20;`
            },
            // Team
            {
                category: 'team',
                title: 'IPL 2026 Squad Spend by Team',
                description: 'Total and average squad spend per team for IPL 2026 mega auction.',
                sql: `SELECT team_name,\n  COUNT(*) AS squad_size,\n  ROUND(SUM(price_cr), 2) AS total_spend_cr,\n  ROUND(AVG(price_cr), 2) AS avg_price_cr,\n  ROUND(MAX(price_cr), 2) AS top_buy_cr\nFROM ipl_2026_contracts\nGROUP BY team_name\nORDER BY total_spend_cr DESC;`
            },
            {
                category: 'team',
                title: 'Team Win Rates by Venue (IPL)',
                description: 'How each IPL team performs at different venues, sorted by win percentage.',
                sql: `SELECT dt.team_name, v.venue_name,\n  COUNT(*) AS matches,\n  SUM(CASE WHEN m.winner_id = dt.team_id THEN 1 ELSE 0 END) AS wins,\n  ROUND(SUM(CASE WHEN m.winner_id = dt.team_id THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) AS win_pct\nFROM dim_match m\nJOIN dim_venue v ON m.venue_id = v.venue_id\nJOIN dim_tournament t ON m.tournament_id = t.tournament_id\nJOIN dim_team dt ON dt.team_id IN (m.team1_id, m.team2_id)\nWHERE t.tournament_name LIKE '%Indian Premier League%'\nGROUP BY dt.team_name, v.venue_name\nHAVING COUNT(*) >= 5\nORDER BY win_pct DESC\nLIMIT 25;`
            },
            {
                category: 'team',
                title: 'Strongest Batting Lineups (IPL 2026)',
                description: 'IPL 2026 squads ranked by combined historical IPL batting performance.',
                sql: `SELECT team_name,\n  COUNT(*) AS batters,\n  SUM(ipl_runs) AS total_ipl_runs,\n  ROUND(AVG(ipl_sr), 1) AS avg_strike_rate,\n  ROUND(AVG(ipl_avg), 1) AS avg_batting_avg\nFROM analytics_ipl_squad_batting\nWHERE ipl_innings >= 5\nGROUP BY team_name\nORDER BY total_ipl_runs DESC;`
            },
            // Matchup
            {
                category: 'matchup',
                title: 'Virat Kohli vs Left-Arm Pace',
                description: 'How Virat Kohli has performed against left-arm pace bowling in IPL.',
                sql: `SELECT batter_name, bowler_type,\n  balls, runs, dismissals,\n  ROUND(strike_rate, 2) AS strike_rate,\n  ROUND(average, 1) AS average,\n  ROUND(boundary_pct, 1) AS boundary_pct\nFROM analytics_ipl_batter_vs_bowler_type\nWHERE batter_name LIKE '%Kohli%'\nORDER BY bowler_type;`
            },
            {
                category: 'matchup',
                title: 'Jasprit Bumrah vs Top Batters',
                description: 'Bumrah head-to-head record against batters with 10+ balls faced.',
                sql: `SELECT batter_name, balls, runs, dismissals,\n  ROUND(strike_rate, 2) AS strike_rate,\n  ROUND(dot_ball_pct, 1) AS dot_pct\nFROM analytics_ipl_batter_vs_bowler\nWHERE bowler_name LIKE '%Bumrah%'\n  AND balls >= 10\nORDER BY balls DESC\nLIMIT 20;`
            },
            // Phase Analysis
            {
                category: 'phase',
                title: 'Powerplay Run Rate by Team (Recent Seasons)',
                description: 'Average powerplay run rate per team in recent IPL seasons.',
                sql: `SELECT dt_bat.team_name AS batting_team,\n  COUNT(DISTINCT fb.match_id) AS matches,\n  SUM(fb.total_runs) AS pp_runs,\n  SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) AS pp_balls,\n  ROUND(SUM(fb.total_runs) * 6.0 / SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 2) AS run_rate\nFROM fact_ball fb\nJOIN dim_match m ON fb.match_id = m.match_id\nJOIN dim_tournament t ON m.tournament_id = t.tournament_id\nJOIN dim_team dt_bat ON fb.batting_team_id = dt_bat.team_id\nWHERE t.tournament_name LIKE '%Indian Premier League%'\n  AND m.season IN ('2024', '2024/25', '2025')\n  AND fb.match_phase = 'powerplay'\nGROUP BY dt_bat.team_name\nHAVING SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) >= 100\nORDER BY run_rate DESC;`
            },
            // Pressure Performance
            {
                category: 'pressure',
                title: 'Clutch Batters Under Extreme Pressure',
                description: 'Batters who thrive when Required Run Rate exceeds 12 (IPL 2023+).',
                sql: `SELECT player_name, pressure_band, balls_faced,\n  ROUND(strike_rate, 1) AS strike_rate,\n  ROUND(batting_average, 1) AS average,\n  ROUND(boundary_pct, 1) AS boundary_pct,\n  ROUND(dot_ball_pct, 1) AS dot_pct,\n  entry_context\nFROM analytics_ipl_batter_pressure_bands_since2023\nWHERE pressure_band IN ('EXTREME', 'NEAR_IMPOSSIBLE')\n  AND balls_faced >= 15\nORDER BY strike_rate DESC\nLIMIT 20;`
            },
            {
                category: 'pressure',
                title: 'Best Death Bowlers Under Pressure',
                description: 'Bowlers with lowest economy when opposition RRR is 10+ (IPL 2023+).',
                sql: `SELECT player_name, pressure_band, legal_balls,\n  ROUND(economy, 2) AS economy,\n  ROUND(dot_ball_pct, 1) AS dot_pct,\n  ROUND(boundary_conceded_pct, 1) AS bdry_pct_conc,\n  wickets, ROUND(bowling_strike_rate, 1) AS bowl_sr\nFROM analytics_ipl_bowler_pressure_bands_since2023\nWHERE pressure_band IN ('HIGH', 'EXTREME')\n  AND legal_balls >= 15\nORDER BY economy ASC\nLIMIT 20;`
            },
            {
                category: 'pressure',
                title: 'Pressure Performance Ratings',
                description: 'How player metrics change across pressure bands  CLUTCH, PRESSURE_PROOF, or SENSITIVE.',
                sql: `SELECT player_name, role,\n  ROUND(overall_sr, 1) AS overall_sr,\n  ROUND(pressure_sr, 1) AS pressure_sr,\n  ROUND(sr_delta_pct, 1) AS sr_delta_pct,\n  ROUND(pressure_score, 1) AS pressure_score,\n  pressure_rating, entry_context\nFROM analytics_ipl_pressure_deltas_since2023\nWHERE pressure_rating IN ('CLUTCH', 'FINISHER', 'CLOSER')\nORDER BY pressure_score DESC\nLIMIT 25;`
            },
            {
                category: 'pressure',
                title: 'Dot Ball Sequences Under Pressure',
                description: 'Bowlers who build consecutive dot ball streaks when RRR > 10 (IPL 2023+).',
                sql: `SELECT bowler_name, dot_sequences,\n  total_dots_in_sequences,\n  ROUND(avg_dot_seq_length, 1) AS avg_seq_len,\n  max_dot_seq AS max_streak\nFROM analytics_ipl_pressure_dot_sequences_since2023\nWHERE dot_sequences >= 3\nORDER BY avg_dot_seq_length DESC\nLIMIT 20;`
            },
            // IPL 2026
            {
                category: 'ipl2026',
                title: 'IPL 2026 Overseas Players',
                description: 'All overseas players in IPL 2026 squads with their roles and nationalities.',
                sql: `SELECT team_name, player_name, nationality,\n  role, age, batting_hand,\n  bowling_type\nFROM ipl_2026_squads\nWHERE nationality != 'IND'\nORDER BY team_name, player_name;`
            },
            {
                category: 'ipl2026',
                title: 'Most Expensive IPL 2026 Buys',
                description: 'The biggest price tags from the IPL 2026 mega auction and retentions.',
                sql: `SELECT c.player_name, c.team_name,\n  c.price_cr, c.acquisition_type,\n  s.nationality, s.role, s.age\nFROM ipl_2026_contracts c\nJOIN ipl_2026_squads s\n  ON c.player_name = s.player_name\n  AND c.team_name = s.team_name\nORDER BY c.price_cr DESC\nLIMIT 25;`
            },
            {
                category: 'ipl2026',
                title: 'Founder Predicted XIIs',
                description: 'The Founder\'s predicted XII for each team with roles, ages, nationalities, IPL experience, and price.',
                sql: `SELECT team_abbrev, squad_number AS pos,\n  player_name, role, age,\n  nationality, price_cr,\n  ipl_matches, batting_hand\nFROM founder_squads_2026\nWHERE is_predicted_xii = true\nORDER BY team_abbrev, squad_number;`
            },
            {
                category: 'ipl2026',
                title: 'IPL 2026 Final Version',
                description: 'Complete merged view: Founder selections + analytics tags + contracts + experience data.',
                sql: `SELECT team_abbrev, squad_number AS pos,\n  player_name, role, age,\n  nationality, price_cr,\n  ipl_matches, is_predicted_xii,\n  batter_classification,\n  bowler_classification\nFROM IPL_2026_Final_Version\nWHERE is_predicted_xii = true\nORDER BY team_abbrev, squad_number;`
            },
        ];

        function renderExampleQueries(filter) {
            const grid = document.getElementById('examples-grid');
            const filtered = filter === 'all' ? EXAMPLE_QUERIES : EXAMPLE_QUERIES.filter(q => q.category === filter);

            let html = '';
            for (const q of filtered) {
                const catClass = q.category === 'ipl2026' ? 'ipl2026' : q.category;
                const catLabel = q.category === 'ipl2026' ? 'IPL 2026' : q.category.charAt(0).toUpperCase() + q.category.slice(1);
                const sqlPreview = q.sql.replace(/\n/g, ' ').substring(0, 65);
                html += `<div class="example-card" data-category="${q.category}">`;
                html += `<span class="example-card-category ${catClass}">${catLabel}</span>`;
                html += `<h4>${escapeHtml(q.title)}</h4>`;
                html += `<div class="example-card-desc">${escapeHtml(q.description)}</div>`;
                html += `<p title="${escapeHtml(q.sql)}">${escapeHtml(sqlPreview)}...</p>`;
                html += `<button type="button" class="load-btn" data-sql="${escapeAttr(q.sql)}">&#9654; Load Query</button>`;
                html += `</div>`;
            }
            grid.innerHTML = html;

            // Wire load buttons
            grid.querySelectorAll('.load-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const sqlText = this.getAttribute('data-sql');
                    setEditorSQL(sqlText);
                    document.getElementById('sql-editor-textarea').focus();
                    document.getElementById('sql-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
            });

            // Also make the whole card clickable (loads query)
            grid.querySelectorAll('.example-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (e.target.classList.contains('load-btn')) return; // Already handled
                    const btn = this.querySelector('.load-btn');
                    if (btn) {
                        const sqlText = btn.getAttribute('data-sql');
                        setEditorSQL(sqlText);
                        document.getElementById('sql-editor-textarea').focus();
                        document.getElementById('sql-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            });
        }

        // Render initial gallery
        renderExampleQueries('all');

        /* ==================== EXAMPLE FILTER (TKT-176) ==================== */
        document.querySelectorAll('.examples-filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.examples-filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const filterVal = this.getAttribute('data-filter') || 'all';
                renderExampleQueries(filterVal);
                // Show/hide pressure glossary panel (TKT-050 Glossary)
                const glossaryPanel = document.getElementById('pressure-glossary-panel');
                if (glossaryPanel) {
                    glossaryPanel.style.display = filterVal === 'pressure' ? 'block' : 'none';
                }
            });
        });

        /* ==================== NATURAL LANGUAGE QUERY ENGINE (TKT-177 + TKT-181 Phase 1) ==================== */
        /* 5-Stage Pipeline: Entity Extraction -> Intent Classification -> View Coverage -> Query Router -> Fallback */

        // ================================================================
        // SECTION 1: REFERENCE DICTIONARIES
        // ================================================================

        // ---- 1A: Team alias map (expanded with historical aliases) ----
        const TEAM_ALIASES = {
            'csk':  'Chennai Super Kings',
            'chennai': 'Chennai Super Kings',
            'super kings': 'Chennai Super Kings',
            'chennai super kings': 'Chennai Super Kings',
            'mi':   'Mumbai Indians',
            'mumbai': 'Mumbai Indians',
            'mumbai indians': 'Mumbai Indians',
            'rcb':  'Royal Challengers Bengaluru',
            'bangalore': 'Royal Challengers Bengaluru',
            'bengaluru': 'Royal Challengers Bengaluru',
            'royal challengers': 'Royal Challengers Bengaluru',
            'royal challengers bangalore': 'Royal Challengers Bengaluru',
            'royal challengers bengaluru': 'Royal Challengers Bengaluru',
            'kkr':  'Kolkata Knight Riders',
            'kolkata': 'Kolkata Knight Riders',
            'knight riders': 'Kolkata Knight Riders',
            'kolkata knight riders': 'Kolkata Knight Riders',
            'dc':   'Delhi Capitals',
            'delhi': 'Delhi Capitals',
            'capitals': 'Delhi Capitals',
            'delhi capitals': 'Delhi Capitals',
            'delhi daredevils': 'Delhi Capitals',
            'dd': 'Delhi Capitals',
            'pbks': 'Punjab Kings',
            'punjab': 'Punjab Kings',
            'kxip': 'Punjab Kings',
            'kings xi punjab': 'Punjab Kings',
            'kings xi': 'Punjab Kings',
            'punjab kings': 'Punjab Kings',
            'rr':   'Rajasthan Royals',
            'rajasthan': 'Rajasthan Royals',
            'royals': 'Rajasthan Royals',
            'rajasthan royals': 'Rajasthan Royals',
            'srh':  'Sunrisers Hyderabad',
            'hyderabad': 'Sunrisers Hyderabad',
            'sunrisers': 'Sunrisers Hyderabad',
            'sunrisers hyderabad': 'Sunrisers Hyderabad',
            'deccan chargers': 'Sunrisers Hyderabad',
            'deccan': 'Sunrisers Hyderabad',
            'gt':   'Gujarat Titans',
            'gujarat': 'Gujarat Titans',
            'titans': 'Gujarat Titans',
            'gujarat titans': 'Gujarat Titans',
            'lsg':  'Lucknow Super Giants',
            'lucknow': 'Lucknow Super Giants',
            'super giants': 'Lucknow Super Giants',
            'lucknow super giants': 'Lucknow Super Giants',
        };

        // ---- 1B: Player nickname/alias map (50+ common nicknames -> full names) ----
        const PLAYER_ALIASES = {
            // Indian batters (nicknames + full names  DB names)
            'sky': 'SA Yadav', 'surya': 'SA Yadav', 'suryakumar': 'SA Yadav',
            'suryakumar yadav': 'SA Yadav',
            'kohli': 'V Kohli', 'virat': 'V Kohli', 'vk': 'V Kohli', 'king kohli': 'V Kohli',
            'virat kohli': 'V Kohli',
            'rohit': 'RG Sharma', 'hitman': 'RG Sharma', 'ro': 'RG Sharma',
            'rohit sharma': 'RG Sharma',
            'pant': 'RR Pant', 'rishabh': 'RR Pant',
            'rishabh pant': 'RR Pant',
            'dhoni': 'MS Dhoni', 'msd': 'MS Dhoni', 'thala': 'MS Dhoni', 'mahi': 'MS Dhoni',
            'gill': 'Shubman Gill', 'shubman': 'Shubman Gill',
            'shubman gill': 'Shubman Gill',
            'iyer': 'SS Iyer', 'shreyas': 'SS Iyer',
            'shreyas iyer': 'SS Iyer',
            'kl': 'KL Rahul', 'kl rahul': 'KL Rahul', 'rahul': 'KL Rahul',
            'sanju': 'SV Samson', 'samson': 'SV Samson',
            'sanju samson': 'SV Samson',
            'rutu': 'RD Gaikwad', 'ruturaj': 'RD Gaikwad', 'gaikwad': 'RD Gaikwad',
            'ruturaj gaikwad': 'RD Gaikwad',
            'kishan': 'Ishan Kishan', 'ishan': 'Ishan Kishan',
            'ishan kishan': 'Ishan Kishan',
            'tilak': 'Tilak Varma', 'tilak varma': 'Tilak Varma',
            'rinku': 'RK Singh', 'rinku singh': 'RK Singh',
            'jaiswal': 'YBK Jaiswal', 'yashasvi': 'YBK Jaiswal',
            'yashasvi jaiswal': 'YBK Jaiswal',
            'padikkal': 'D Padikkal', 'devdutt': 'D Padikkal',
            'devdutt padikkal': 'D Padikkal',
            // Indian bowlers (nicknames + full names  DB names)
            'bumrah': 'JJ Bumrah', 'jasprit': 'JJ Bumrah', 'boom': 'JJ Bumrah',
            'jasprit bumrah': 'JJ Bumrah',
            'chahal': 'YS Chahal', 'yuzi': 'YS Chahal',
            'yuzvendra chahal': 'YS Chahal',
            'ashwin': 'R Ashwin', 'ash': 'R Ashwin', 'ravi ashwin': 'R Ashwin',
            'ravichandran ashwin': 'R Ashwin',
            'jadeja': 'RA Jadeja', 'jaddu': 'RA Jadeja', 'sir jadeja': 'RA Jadeja',
            'ravindra jadeja': 'RA Jadeja',
            'shami': 'Mohammed Shami', 'md shami': 'Mohammed Shami',
            'mohammed shami': 'Mohammed Shami',
            'siraj': 'Mohammed Siraj', 'md siraj': 'Mohammed Siraj',
            'mohammed siraj': 'Mohammed Siraj',
            'kuldeep': 'Kuldeep Yadav', 'kuldeep yadav': 'Kuldeep Yadav',
            'arshdeep': 'Arshdeep Singh', 'arshdeep singh': 'Arshdeep Singh',
            'bishnoi': 'Ravi Bishnoi', 'ravi bishnoi': 'Ravi Bishnoi',
            'avesh': 'Avesh Khan', 'avesh khan': 'Avesh Khan',
            'umran': 'Umran Malik', 'umran malik': 'Umran Malik',
            // Indian all-rounders (nicknames + full names  DB names)
            'hardik': 'HH Pandya', 'hp': 'HH Pandya', 'hardik pandya': 'HH Pandya',
            'krunal': 'KH Pandya', 'krunal pandya': 'KH Pandya',
            'axar': 'AR Patel', 'axar patel': 'AR Patel',
            'shardul': 'SN Thakur', 'lord shardul': 'SN Thakur', 'shardul thakur': 'SN Thakur',
            'venky': 'VR Iyer', 'venkatesh': 'VR Iyer',
            'venkatesh iyer': 'VR Iyer',
            // Additional Indian players
            'riyan parag': 'R Parag', 'parag': 'R Parag',
            'shivam dube': 'S Dube', 'dube': 'S Dube',
            'patidar': 'RM Patidar', 'rajat patidar': 'RM Patidar',
            'abhishek sharma': 'Abhishek Sharma', 'abhishek': 'Abhishek Sharma',
            'hetmyer': 'SO Hetmyer', 'shimron hetmyer': 'SO Hetmyer',
            'de kock': 'Q de Kock', 'quinton': 'Q de Kock', 'quinton de kock': 'Q de Kock',
            // Overseas batters (nicknames + full names  DB names)
            'abd': 'AB de Villiers', 'ab de villiers': 'AB de Villiers', 'ab': 'AB de Villiers',
            'gayle': 'CH Gayle', 'universe boss': 'CH Gayle', 'chris gayle': 'CH Gayle',
            'warner': 'DA Warner', 'david warner': 'DA Warner', 'bull': 'DA Warner',
            'buttler': 'JC Buttler', 'jos': 'JC Buttler', 'jos buttler': 'JC Buttler',
            'bairstow': 'JM Bairstow', 'jonny': 'JM Bairstow',
            'jonny bairstow': 'JM Bairstow',
            'head': 'TM Head', 'travis head': 'TM Head',
            'salt': 'PD Salt', 'phil salt': 'PD Salt',
            'du plessis': 'F du Plessis', 'faf': 'F du Plessis',
            'faf du plessis': 'F du Plessis',
            'maxwell': 'GJ Maxwell', 'maxi': 'GJ Maxwell', 'glenn maxwell': 'GJ Maxwell',
            'pooran': 'N Pooran', 'nicholas pooran': 'N Pooran',
            'green': 'C Green', 'cameron green': 'C Green',
            'marsh': 'MR Marsh', 'mitch marsh': 'MR Marsh',
            'mitchell marsh': 'MR Marsh',
            'klaasen': 'H Klaasen', 'heinrich': 'H Klaasen',
            'heinrich klaasen': 'H Klaasen',
            'markram': 'AK Markram', 'aiden markram': 'AK Markram',
            'miller': 'DA Miller', 'killer miller': 'DA Miller',
            'david miller': 'DA Miller',
            // Overseas bowlers (nicknames + full names  DB names)
            'rashid': 'Rashid Khan', 'rashid khan': 'Rashid Khan',
            'narine': 'SP Narine', 'sunil narine': 'SP Narine',
            'starc': 'MA Starc', 'mitchell starc': 'MA Starc',
            'cummins': 'PJ Cummins', 'pat cummins': 'PJ Cummins',
            'rabada': 'K Rabada', 'kg': 'K Rabada', 'kagiso': 'K Rabada',
            'kagiso rabada': 'K Rabada',
            'archer': 'JC Archer', 'jofra': 'JC Archer', 'jofra archer': 'JC Archer',
            'boult': 'TA Boult', 'trent boult': 'TA Boult',
            'zampa': 'A Zampa', 'adam zampa': 'A Zampa',
            'hasaranga': 'PW Hasaranga', 'wanindu': 'PW Hasaranga',
            'wanindu hasaranga': 'PW Hasaranga',
            'theekshana': 'M Theekshana', 'maheesh': 'M Theekshana',
            'maheesh theekshana': 'M Theekshana',
            'ferguson': 'LH Ferguson', 'lockie': 'LH Ferguson',
            'lockie ferguson': 'LH Ferguson',
            'topley': 'RJW Topley', 'reece topley': 'RJW Topley',
            // Overseas all-rounders (nicknames + full names  DB names)
            'stokes': 'BA Stokes', 'ben stokes': 'BA Stokes',
            'russell': 'AD Russell', 'dre russ': 'AD Russell', 'andre russell': 'AD Russell',
            'curran': 'SM Curran', 'sam curran': 'SM Curran',
            'livingstone': 'LS Livingstone', 'liam livingstone': 'LS Livingstone',
            'stoinis': 'MP Stoinis', 'marcus stoinis': 'MP Stoinis',
            // Non-squad but searchable players
            'jfm': 'J Fraser-McGurk', 'fraser mcgurk': 'J Fraser-McGurk',
            'jake fraser mcgurk': 'J Fraser-McGurk',
            // Full roster name  career DB name (auto-generated from player_id joins)
            'abhishek porel': 'Abishek Porel',
            'ajinkya rahane': 'AM Rahane', 'rahane': 'AM Rahane',
            'akeal hosein': 'AJ Hosein',
            'aman khan': 'Aman Hakim Khan',
            'angkrish raghuvanshi': 'A Raghuvanshi',
            'anrich nortje': 'A Nortje', 'nortje': 'A Nortje',
            'anshul kamboj': 'A Kamboj',
            'anukul roy': 'AS Roy',
            'arshin kulkarni': 'AA Kulkarni',
            'ayush badoni': 'A Badoni', 'badoni': 'A Badoni',
            'ayush mhatre': 'A Mhatre',
            'bhuvneshwar kumar': 'B Kumar', 'bhuvi': 'B Kumar', 'bhuvneshwar': 'B Kumar',
            'corbin bosch': 'C Bosch',
            'deepak chahar': 'DL Chahar',
            'dewald brevis': 'D Brevis', 'brevis': 'D Brevis', 'baby ab': 'D Brevis',
            'digvesh rathi': 'DS Rathi',
            'donovan ferreira': 'D Ferreira',
            'dushmantha chameera': 'PVD Chameera', 'chameera': 'PVD Chameera',
            'eshan malinga': 'E Malinga',
            'glenn phillips': 'GD Phillips', 'phillips': 'GD Phillips',
            'harshal patel': 'HV Patel', 'harshal': 'HV Patel',
            'ishant sharma': 'I Sharma', 'ishant': 'I Sharma',
            'jacob bethell': 'JG Bethell', 'bethell': 'JG Bethell',
            'jamie overton': 'J Overton',
            'jayant yadav': 'J Yadav',
            'jaydev unadkat': 'JD Unadkat', 'unadkat': 'JD Unadkat',
            'jitesh sharma': 'JM Sharma',
            'josh hazlewood': 'JR Hazlewood', 'hazlewood': 'JR Hazlewood',
            'josh inglis': 'JP Inglis', 'inglis': 'JP Inglis',
            'kamindu mendis': 'PHKD Mendis', 'mendis': 'PHKD Mendis',
            'karun nair': 'KK Nair', 'nair': 'KK Nair',
            'khaleel ahmed': 'KK Ahmed', 'khaleel': 'KK Ahmed',
            'kuldeep sen': 'KR Sen',
            'kwena maphaka': 'KT Maphaka', 'maphaka': 'KT Maphaka',
            'kyle jamieson': 'KA Jamieson', 'jamieson': 'KA Jamieson',
            'lungi ngidi': 'L Ngidi', 'ngidi': 'L Ngidi',
            'manav suthar': 'MJ Suthar',
            'manimaran siddharth': 'M Siddharth', 'siddharth': 'M Siddharth',
            'manish pandey': 'MK Pandey',
            'marco jansen': 'M Jansen', 'jansen': 'M Jansen',
            'matheesha pathirana': 'M Pathirana', 'pathirana': 'M Pathirana',
            'matt henry': 'MJ Henry',
            'matthew short': 'MW Short',
            'mitchell santner': 'MJ Santner', 'santner': 'MJ Santner',
            'nandre burger': 'N Burger',
            'nathan ellis': 'NT Ellis', 'ellis': 'NT Ellis',
            'nehal wadhera': 'N Wadhera', 'wadhera': 'N Wadhera',
            'nitish kumar reddy': 'Nithish Kumar Reddy', 'nitish reddy': 'Nithish Kumar Reddy',
            'nitish rana': 'N Rana',
            'prabhsimran singh': 'P Simran Singh',
            'prasidh krishna': 'M Prasidh Krishna', 'prasidh': 'M Prasidh Krishna',
            'prithvi shaw': 'PP Shaw', 'shaw': 'PP Shaw',
            'rachin ravindra': 'R Ravindra',
            'rahul chahar': 'RD Chahar',
            'rahul tewatia': 'R Tewatia', 'tewatia': 'R Tewatia',
            'rahul tripathi': 'RA Tripathi', 'tripathi': 'RA Tripathi',
            'raj bawa': 'RA Bawa',
            'robin minz': 'R Minz',
            'romario shepherd': 'R Shepherd',
            'rovman powell': 'R Powell', 'powell': 'R Powell',
            'ryan rickelton': 'RD Rickelton',
            'sai kishore': 'R Sai Kishore',
            'sai sudharsan': 'B Sai Sudharsan', 'sudharsan': 'B Sai Sudharsan',
            'sarfaraz khan': 'SN Khan', 'sarfaraz': 'SN Khan',
            'shahrukh khan': 'M Shahrukh Khan',
            'sherfane rutherford': 'SE Rutherford',
            'shreyas gopal': 'S Gopal',
            'tim david': 'TH David',
            'tristan stubbs': 'T Stubbs', 'stubbs': 'T Stubbs',
            'tushar deshpande': 'TU Deshpande', 'deshpande': 'TU Deshpande',
            'vaibhav arora': 'VG Arora',
            'vaibhav suryavanshi': 'V Suryavanshi', 'suryavanshi': 'V Suryavanshi',
            'varun chakravarthy': 'CV Varun', 'varun': 'CV Varun', 'mystery spinner': 'CV Varun',
            'will jacks': 'WG Jacks', 'jacks': 'WG Jacks',
            'xavier bartlett': 'XC Bartlett', 'bartlett': 'XC Bartlett',
        };

        // ---- 1C: Phase keywords map (expanded) ----
        const PHASE_MAP = {
            'powerplay': 'powerplay', 'pp': 'powerplay', 'power play': 'powerplay',
            'first 6': 'powerplay', 'opening overs': 'powerplay', 'first six': 'powerplay',
            'middle': 'middle', 'middle overs': 'middle', 'overs 7-15': 'middle',
            'consolidation': 'middle', 'middle phase': 'middle',
            'death': 'death', 'death overs': 'death', 'slog': 'death',
            'last 5': 'death', 'slog overs': 'death', 'overs 16-20': 'death',
            'last five': 'death', 'finishing overs': 'death',
        };

        // ---- 1D: Venue map (city -> ground name patterns for ILIKE) ----
        const VENUE_MAP = {
            // City names -> venue ILIKE patterns
            'mumbai': 'Wankhede', 'wankhede': 'Wankhede',
            'chennai': null, // Chennai conflicts with team name, handled separately
            'chepauk': 'Chidambaram', 'chidambaram': 'Chidambaram', 'ma chidambaram': 'Chidambaram',
            'bangalore': null, 'bengaluru': null, // Conflicts with team name
            'chinnaswamy': 'Chinnaswamy', 'chinnaswami': 'Chinnaswamy',
            'kolkata': null, // Conflicts with team name
            'eden gardens': 'Eden Gardens', 'eden': 'Eden Gardens',
            'delhi': null, // Conflicts with team name
            'kotla': 'Kotla', 'feroz shah': 'Feroz Shah Kotla', 'arun jaitley': 'Arun Jaitley',
            'hyderabad': null, // Conflicts with team name
            'rajiv gandhi': 'Rajiv Gandhi', 'uppal': 'Rajiv Gandhi',
            'jaipur': 'Jaipur', 'sawai mansingh': 'Sawai Mansingh',
            'mohali': 'Mohali', 'chandigarh': 'Mohali', 'is bindra': 'Mohali', 'pca': 'Mohali',
            'lucknow': null, // Conflicts with team name
            'ekana': 'Ekana', 'bharat ratna': 'Ekana',
            'ahmedabad': 'Ahmedabad', 'narendra modi': 'Narendra Modi', 'motera': 'Narendra Modi',
            'dharamsala': 'Dharamsala', 'dharamshala': 'Dharamsala', 'himachal': 'Dharamsala',
            'pune': 'Pune', 'gahunje': 'Gahunje', 'mca': 'Pune',
            'guwahati': 'Guwahati', 'barsapara': 'Barsapara',
            'visakhapatnam': 'Visakhapatnam', 'vizag': 'Visakhapatnam',
            'indore': 'Indore', 'holkar': 'Holkar',
            'ranchi': 'Ranchi', 'jsca': 'Ranchi',
            'navi mumbai': 'Navi Mumbai', 'dy patil': 'DY Patil',
            'sharjah': 'Sharjah', 'dubai': 'Dubai', 'abu dhabi': 'Abu Dhabi',
            'centurion': 'Centurion', 'newlands': 'Newlands', 'cape town': 'Newlands',
        };

        // ---- 1E: Bowler type classification map ----
        const BOWLER_TYPE_MAP = {
            'spin': ['spin', 'off-spin', 'leg-spin', 'left-arm orthodox', 'left-arm wrist spin',
                     'Right-arm off-spin', 'Right-arm leg-spin', 'Left-arm orthodox', 'Left-arm wrist spin'],
            'spinner': ['spin', 'off-spin', 'leg-spin', 'left-arm orthodox', 'left-arm wrist spin',
                        'Right-arm off-spin', 'Right-arm leg-spin', 'Left-arm orthodox', 'Left-arm wrist spin'],
            'spinners': ['spin', 'off-spin', 'leg-spin', 'left-arm orthodox', 'left-arm wrist spin',
                         'Right-arm off-spin', 'Right-arm leg-spin', 'Left-arm orthodox', 'Left-arm wrist spin'],
            'pace': ['pace', 'fast', 'medium', 'Right-arm pace', 'Left-arm pace', 'Right-arm medium', 'Left-arm medium'],
            'fast': ['pace', 'fast', 'Right-arm pace', 'Left-arm pace'],
            'seam': ['pace', 'fast', 'medium', 'Right-arm pace', 'Left-arm pace'],
            'quick': ['pace', 'fast', 'Right-arm pace', 'Left-arm pace'],
            'off-spin': ['off-spin', 'Right-arm off-spin'],
            'off spin': ['off-spin', 'Right-arm off-spin'],
            'offie': ['off-spin', 'Right-arm off-spin'],
            'offspin': ['off-spin', 'Right-arm off-spin'],
            'off spinner': ['off-spin', 'Right-arm off-spin'],
            'leg-spin': ['leg-spin', 'Right-arm leg-spin', 'Left-arm wrist spin'],
            'leg spin': ['leg-spin', 'Right-arm leg-spin', 'Left-arm wrist spin'],
            'leggie': ['leg-spin', 'Right-arm leg-spin', 'Left-arm wrist spin'],
            'legspin': ['leg-spin', 'Right-arm leg-spin', 'Left-arm wrist spin'],
            'leg spinner': ['leg-spin', 'Right-arm leg-spin', 'Left-arm wrist spin'],
            'wrist spin': ['leg-spin', 'Right-arm leg-spin', 'Left-arm wrist spin'],
            'wrist spinner': ['leg-spin', 'Right-arm leg-spin', 'Left-arm wrist spin'],
            'left-arm spin': ['Left-arm orthodox', 'Left-arm wrist spin'],
            'left arm spin': ['Left-arm orthodox', 'Left-arm wrist spin'],
            'left-arm orthodox': ['Left-arm orthodox'],
            'left arm orthodox': ['Left-arm orthodox'],
            'sla': ['Left-arm orthodox'],
            'left-arm pace': ['Left-arm pace', 'Left-arm medium'],
            'left arm pace': ['Left-arm pace', 'Left-arm medium'],
            'left-arm quick': ['Left-arm pace'],
            'left arm quick': ['Left-arm pace'],
            'left-arm fast': ['Left-arm pace'],
            'right-arm pace': ['Right-arm pace', 'Right-arm medium'],
            'right arm pace': ['Right-arm pace', 'Right-arm medium'],
        };

        // Simplified bowler type for view-based queries (maps to bowler_type column values in squad views)
        const BOWLER_TYPE_SIMPLE = {
            'spin': 'Spin', 'spinner': 'Spin', 'spinners': 'Spin',
            'off-spin': 'Spin', 'off spin': 'Spin', 'offie': 'Spin', 'offspin': 'Spin', 'off spinner': 'Spin',
            'leg-spin': 'Spin', 'leg spin': 'Spin', 'leggie': 'Spin', 'legspin': 'Spin', 'leg spinner': 'Spin',
            'wrist spin': 'Spin', 'wrist spinner': 'Spin',
            'left-arm spin': 'Spin', 'left arm spin': 'Spin', 'left-arm orthodox': 'Spin', 'left arm orthodox': 'Spin', 'sla': 'Spin',
            'pace': 'Pace', 'fast': 'Pace', 'seam': 'Pace', 'quick': 'Pace',
            'left-arm pace': 'Pace', 'left arm pace': 'Pace', 'left-arm quick': 'Pace', 'left arm quick': 'Pace', 'left-arm fast': 'Pace',
            'right-arm pace': 'Pace', 'right arm pace': 'Pace',
        };

        // ---- 1F: Metric keyword map ----
        const METRIC_MAP = {
            'strike rate': { col: 'strike_rate', dir: 'DESC' },
            'sr': { col: 'strike_rate', dir: 'DESC' },
            'average': { col: 'batting_average', dir: 'DESC', bowling_col: 'bowling_average', bowling_dir: 'ASC' },
            'avg': { col: 'batting_average', dir: 'DESC', bowling_col: 'bowling_average', bowling_dir: 'ASC' },
            'economy': { col: 'economy_rate', dir: 'ASC' },
            'econ': { col: 'economy_rate', dir: 'ASC' },
            'economy rate': { col: 'economy_rate', dir: 'ASC' },
            'boundary %': { col: 'boundary_pct', dir: 'DESC' },
            'boundary pct': { col: 'boundary_pct', dir: 'DESC' },
            'boundaries': { col: 'boundary_pct', dir: 'DESC' },
            'dot ball %': { col: 'dot_ball_pct', dir: 'DESC' },
            'dot ball pct': { col: 'dot_ball_pct', dir: 'DESC' },
            'dot balls': { col: 'dot_ball_pct', dir: 'DESC' },
            'wickets': { col: 'wickets', dir: 'DESC' },
            'runs': { col: 'runs', dir: 'DESC' },
            'sixes': { col: 'sixes', dir: 'DESC' },
            '6s': { col: 'sixes', dir: 'DESC' },
            'fours': { col: 'fours', dir: 'DESC' },
            '4s': { col: 'fours', dir: 'DESC' },
            'fifties': { col: 'fifties', dir: 'DESC' },
            '50s': { col: 'fifties', dir: 'DESC' },
            'hundreds': { col: 'hundreds', dir: 'DESC' },
            '100s': { col: 'hundreds', dir: 'DESC' },
            'centuries': { col: 'hundreds', dir: 'DESC' },
        };

        // ================================================================
        // SECTION 2: HELPER FUNCTIONS (preserved + expanded)
        // ================================================================

        // ---- Resolve a team token to canonical name ----
        function resolveTeamName(token) {
            const lower = token.toLowerCase().trim();
            if (TEAM_ALIASES[lower]) return TEAM_ALIASES[lower];
            for (const [alias, full] of Object.entries(TEAM_ALIASES)) {
                if (alias.includes(lower) || lower.includes(alias)) return full;
            }
            return token;
        }

        // ---- Detect if a token looks like a team abbreviation or name ----
        function isTeamToken(token) {
            const lower = token.toLowerCase().trim();
            return TEAM_ALIASES.hasOwnProperty(lower) ||
                Object.values(TEAM_ALIASES).some(v => v.toLowerCase().includes(lower));
        }

        // ---- Helper: extract a limit number from the query ----
        function extractLimit(query) {
            const match = query.match(/\b(?:top|best|worst|first|last)\s+(\d+)\b/i);
            if (match) return parseInt(match[1]);
            const limitMatch = query.match(/\blimit\s+(\d+)\b/i);
            if (limitMatch) return parseInt(limitMatch[1]);
            return 20;
        }

        // ---- Simple Levenshtein distance for fuzzy matching ----
        function levenshtein(a, b) {
            const m = a.length, n = b.length;
            if (m === 0) return n;
            if (n === 0) return m;
            // Use single-row optimization for memory efficiency
            let prev = Array.from({ length: n + 1 }, (_, i) => i);
            let curr = new Array(n + 1);
            for (let i = 1; i <= m; i++) {
                curr[0] = i;
                for (let j = 1; j <= n; j++) {
                    const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                    curr[j] = Math.min(prev[j] + 1, curr[j - 1] + 1, prev[j - 1] + cost);
                }
                [prev, curr] = [curr, prev];
            }
            return prev[n];
        }

        // ================================================================
        // SECTION 3: STAGE 1  ENTITY EXTRACTION ENGINE
        // ================================================================

        /**
         * extractEntities(query)
         * Priority-ordered extraction pipeline. Each extractor removes matched
         * tokens from the remaining query string so later extractors do not
         * re-match the same text.
         *
         * Returns: { players, teams, phases, venues, seasons, bowlerTypes,
         *            metrics, modifiers, role, remainingTokens }
         */
        function extractEntities(query) {
            const original = query.trim();
            let remaining = original.toLowerCase();

            const entities = {
                players: [],
                teams: [],
                phases: [],
                venues: [],
                seasons: [],
                bowlerTypes: [],
                metrics: [],
                modifiers: {
                    winLoss: null,
                    innings: null,
                    stage: null,
                    limit: extractLimit(remaining),
                    totalContext: null,
                    breakdownByPhase: false,
                },
                role: null,
                hasVsToken: false,
                remainingTokens: '',
            };

            // -- Helper: remove matched text from remaining --
            function consume(text) {
                const escaped = text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                remaining = remaining.replace(new RegExp('\\b' + escaped + '\\b', 'gi'), ' ').replace(/\s+/g, ' ').trim();
            }

            // -- Helper: try to consume text (returns true if found) --
            function tryConsume(text) {
                const lower = text.toLowerCase();
                if (remaining.includes(lower)) {
                    consume(lower);
                    return true;
                }
                return false;
            }

            // -- Detect "vs" token early (needed for intent classification) --
            if (/\b(?:vs\.?|versus|against|v\.?)\b/i.test(remaining)) {
                entities.hasVsToken = true;
            }

            // -- Detect "wins vs losses" / "split" modifiers BEFORE other extraction --
            if (/\b(?:wins?\s+(?:vs\.?|versus|and|&)\s+loss(?:es)?|win.?loss|split)\b/i.test(remaining)) {
                entities.modifiers.winLoss = 'split';
                remaining = remaining.replace(/\b(?:wins?\s+(?:vs\.?|versus|and|&)\s+loss(?:es)?|win.?loss|split)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            } else if (/\b(?:in\s+wins?|when\s+winning|while\s+winning)\b/i.test(remaining)) {
                entities.modifiers.winLoss = 'wins';
                remaining = remaining.replace(/\b(?:in\s+wins?|when\s+winning|while\s+winning)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            } else if (/\b(?:in\s+loss(?:es)?|when\s+losing|while\s+losing)\b/i.test(remaining)) {
                entities.modifiers.winLoss = 'losses';
                remaining = remaining.replace(/\b(?:in\s+loss(?:es)?|when\s+losing|while\s+losing)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            }

            // -- Detect innings context --
            if (/\b(?:batting\s+first|setting|first\s+innings|1st\s+innings)\b/i.test(remaining)) {
                entities.modifiers.innings = 1;
                remaining = remaining.replace(/\b(?:batting\s+first|setting|first\s+innings|1st\s+innings)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            } else if (/\b(?:chasing|batting\s+second|second\s+innings|2nd\s+innings)\b/i.test(remaining)) {
                entities.modifiers.innings = 2;
                remaining = remaining.replace(/\b(?:chasing|batting\s+second|second\s+innings|2nd\s+innings)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            } else if (/\b(?:defending)\b/i.test(remaining)) {
                entities.modifiers.innings = 2; // bowling in 2nd innings
                entities.role = entities.role || 'bowling'; // defending implies bowling context
                remaining = remaining.replace(/\bdefending\b/gi, ' ').replace(/\s+/g, ' ').trim();
            }

            // -- Detect stage context --
            if (/\b(?:playoffs?|knock\s*outs?|knockout)\b/i.test(remaining)) {
                entities.modifiers.stage = 'playoff';
                remaining = remaining.replace(/\b(?:playoffs?|knock\s*outs?|knockout)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            } else if (/\b(?:league\s+stage|group\s+stage|league\s+phase)\b/i.test(remaining)) {
                entities.modifiers.stage = 'league';
                remaining = remaining.replace(/\b(?:league\s+stage|group\s+stage|league\s+phase)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            } else if (/\b(?:finals?|the\s+final)\b/i.test(remaining)) {
                entities.modifiers.stage = 'final';
                remaining = remaining.replace(/\b(?:finals?|the\s+final)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            }

            // -- Detect total context (above 180, etc.) --
            const totalMatch = remaining.match(/\b(?:totals?\s+)?(?:above|over|more\s+than|>=?)\s+(\d{2,3})\b/i);
            if (totalMatch) {
                entities.modifiers.totalContext = { operator: '>=', value: parseInt(totalMatch[1]) };
                remaining = remaining.replace(totalMatch[0], ' ').replace(/\s+/g, ' ').trim();
            }

            // -- Detect role (batting / bowling) --
            if (/\bbowl(?:ing|ers?)?\b/i.test(remaining) || /\b(wicket.?tak(?:ers?|ing)|spell|overs?\s*bowled)\b/i.test(remaining)) {
                entities.role = 'bowling';
            }
            if (/\bbat(?:ting|ters?|smen|sman)?\b/i.test(remaining) || /\b(run.?scorers?|hitters?|strikers?|innings\s*played|openers?)\b/i.test(remaining)) {
                entities.role = entities.role === 'bowling' ? 'both' : 'batting';
            }
            // Metric-implied role: economy/wickets -> bowling, runs/sixes/fours/average/SR -> batting
            if (!entities.role) {
                if (/\b(economy|econ|wickets?|maiden|dot.?ball.?%?)\b/i.test(remaining)) {
                    entities.role = 'bowling';
                } else if (/\b(runs?|sixes|fours|centuries|fifties|hundreds|strike.?rate|sr\b|boundaries)\b/i.test(remaining)) {
                    entities.role = 'batting';
                }
            }

            // -- STEP 1: Extract seasons (years) BEFORE player names to avoid confusion --
            // Ranges: "2023-2025", "since 2023", "from 2023 to 2025"
            const rangeMatch = remaining.match(/\b(?:since|from|after)\s+(20[12]\d)\b/i);
            if (rangeMatch) {
                entities.seasons.push({ type: 'range', from: rangeMatch[1], to: null });
                remaining = remaining.replace(rangeMatch[0], ' ').replace(/\s+/g, ' ').trim();
            }
            const rangeMatch2 = remaining.match(/\b(20[12]\d)\s*[-]\s*(20[12]\d)\b/);
            if (rangeMatch2) {
                entities.seasons.push({ type: 'range', from: rangeMatch2[1], to: rangeMatch2[2] });
                remaining = remaining.replace(rangeMatch2[0], ' ').replace(/\s+/g, ' ').trim();
            }
            // Relative seasons
            if (/\b(?:last\s+season|previous\s+season)\b/i.test(remaining)) {
                entities.seasons.push({ type: 'exact', value: '2025' });
                remaining = remaining.replace(/\b(?:last\s+season|previous\s+season)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            } else if (/\b(?:this\s+(?:season|year)|current\s+season)\b/i.test(remaining)) {
                entities.seasons.push({ type: 'exact', value: '2026' });
                remaining = remaining.replace(/\b(?:this\s+(?:season|year)|current\s+season)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            }
            // Exact years
            const yearMatches = remaining.match(/\b(20[12]\d)\b/g);
            if (yearMatches) {
                yearMatches.forEach(y => {
                    if (!entities.seasons.some(s => s.value === y || s.from === y)) {
                        entities.seasons.push({ type: 'exact', value: y });
                        consume(y);
                    }
                });
            }

            // -- STEP 2: Extract player names (longest match first) --
            // First try multi-word aliases (longest first for greedy match)
            const sortedAliases = Object.keys(PLAYER_ALIASES).sort((a, b) => b.length - a.length);
            for (const alias of sortedAliases) {
                if (entities.players.length >= 2) break; // Max 2 players
                const aliasLower = alias.toLowerCase();
                // Use word boundary matching
                const aliasRegex = new RegExp('\\b' + aliasLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
                if (aliasRegex.test(remaining)) {
                    const fullName = PLAYER_ALIASES[alias];
                    // Avoid duplicates
                    if (!entities.players.some(p => p.name === fullName)) {
                        entities.players.push({ name: fullName, matchedAs: alias, confidence: 0.95 });
                        remaining = remaining.replace(aliasRegex, ' ').replace(/\s+/g, ' ').trim();
                    }
                }
            }

            // -- STEP 3: Extract team names (longest match first) --
            const sortedTeamAliases = Object.keys(TEAM_ALIASES).sort((a, b) => b.length - a.length);
            for (const alias of sortedTeamAliases) {
                if (entities.teams.length >= 2) break;
                const aliasLower = alias.toLowerCase();
                const aliasRegex = new RegExp('\\b' + aliasLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
                if (aliasRegex.test(remaining)) {
                    const canonical = TEAM_ALIASES[alias];
                    if (!entities.teams.some(t => t.canonical === canonical)) {
                        entities.teams.push({ name: alias, canonical: canonical, confidence: 0.95 });
                        remaining = remaining.replace(aliasRegex, ' ').replace(/\s+/g, ' ').trim();
                    }
                }
            }

            // -- STEP 4: Extract phases (longest match first) --
            const sortedPhases = Object.keys(PHASE_MAP).sort((a, b) => b.length - a.length);
            for (const keyword of sortedPhases) {
                const keyRegex = new RegExp('\\b' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
                if (keyRegex.test(remaining)) {
                    const phase = PHASE_MAP[keyword];
                    if (!entities.phases.includes(phase)) {
                        entities.phases.push(phase);
                        remaining = remaining.replace(keyRegex, ' ').replace(/\s+/g, ' ').trim();
                    }
                }
            }

            // -- STEP 4B: Detect "broken down by phases" / "phase wise" / "across phases" --
            // When user wants a phase-level breakdown without naming specific phases
            if (entities.phases.length === 0) {
                const breakdownByPhase = /\b(?:broken\s+down\s+by|split\s+by|grouped?\s+by|across|compare\s+across|per|each|every|all)\s*(?:phases?|overs?)\b/i.test(remaining)
                    || /\bphase\s*(?:wise|breakdown)\b/i.test(remaining)
                    || /\bby\s+phase\b/i.test(remaining);
                if (breakdownByPhase) {
                    entities.modifiers.breakdownByPhase = true;
                    remaining = remaining.replace(/\b(?:broken\s+down\s+by|split\s+by|grouped?\s+by|across|compare\s+across|per|each|every|all)\s*(?:phases?|overs?)\b/gi, ' ').replace(/\s+/g, ' ').trim();
                    remaining = remaining.replace(/\bphase\s*(?:wise|breakdown)\b/gi, ' ').replace(/\s+/g, ' ').trim();
                    remaining = remaining.replace(/\bby\s+phase\b/gi, ' ').replace(/\s+/g, ' ').trim();
                }
            }

            // -- STEP 5: Extract venues --
            const sortedVenues = Object.keys(VENUE_MAP).sort((a, b) => b.length - a.length);
            for (const keyword of sortedVenues) {
                if (entities.venues.length >= 1) break;
                // Skip venue keywords that are null (city/team conflict)
                if (VENUE_MAP[keyword] === null) continue;
                const keyRegex = new RegExp('\\b' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
                if (keyRegex.test(remaining)) {
                    entities.venues.push({ keyword: keyword, pattern: VENUE_MAP[keyword] });
                    remaining = remaining.replace(keyRegex, ' ').replace(/\s+/g, ' ').trim();
                }
            }

            // -- STEP 6: Extract bowler types (longest match first) --
            const sortedBowlerTypes = Object.keys(BOWLER_TYPE_MAP).sort((a, b) => b.length - a.length);
            for (const keyword of sortedBowlerTypes) {
                if (entities.bowlerTypes.length >= 1) break;
                const keyRegex = new RegExp('\\b' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
                if (keyRegex.test(remaining)) {
                    entities.bowlerTypes.push({
                        keyword: keyword,
                        styles: BOWLER_TYPE_MAP[keyword],
                        simple: BOWLER_TYPE_SIMPLE[keyword] || 'Pace',
                    });
                    remaining = remaining.replace(keyRegex, ' ').replace(/\s+/g, ' ').trim();
                }
            }

            // -- STEP 7: Extract metrics --
            const sortedMetrics = Object.keys(METRIC_MAP).sort((a, b) => b.length - a.length);
            for (const keyword of sortedMetrics) {
                const keyRegex = new RegExp('\\b' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
                if (keyRegex.test(remaining)) {
                    const metric = METRIC_MAP[keyword];
                    if (!entities.metrics.some(m => m.col === metric.col)) {
                        entities.metrics.push({ ...metric, keyword });
                    }
                    // Do NOT consume metric keywords -- they are also useful for role detection
                    break; // Only capture primary metric
                }
            }

            // Strip common noise words from remaining
            remaining = remaining.replace(/\b(show|me|get|find|search|look\s*up|for|of|in|the|how|does|do|has|what|is|are|his|her|their|stats?|record|performance|data|numbers?|info|details|profile|by|with|and|a|an|at|on|to|from|broken\s+down|split|grouped?|across|compare|per|each|every)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            // Strip "vs" token from remaining
            remaining = remaining.replace(/\b(?:vs\.?|versus|against|v\.?)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            // Strip limit tokens
            remaining = remaining.replace(/\b(?:top|best|worst|first|last|most|leading|highest|lowest)\s*\d*\b/gi, ' ').replace(/\s+/g, ' ').trim();
            // Strip role tokens
            remaining = remaining.replace(/\b(?:bat(?:ting|ters?|smen|sman)?|bowl(?:ing|ers?)?|all.?rounders?|run.?scorers?|hitters?|strikers?|wicket.?takers?)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            // Strip phase/overs/season noise
            remaining = remaining.replace(/\b(?:overs?|phase|season\s*wise|year\s*wise|per\s*(?:season|year)|by\s*(?:season|year)|each\s*(?:season|year)|every\s*(?:season|year)|yearly|annually|all\s*seasons?|over\s*the\s*years?|ipl|t20|season\s*by\s*season|year\s*by\s*year)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            // Strip pressure/clutch tokens
            remaining = remaining.replace(/\b(?:pressure|clutch|chok(?:e|er|ing)|finisher|closer|rrr|required\s*run\s*rate)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            // Strip contract/auction tokens
            remaining = remaining.replace(/\b(?:most\s*expensive|highest\s*paid|costliest|auction|contracts?|price|retained|rtm|cheap|bargain|affordable)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            // Strip squad/roster tokens
            remaining = remaining.replace(/\b(?:squad|roster|team\s*list|players?|overseas|foreign|international|non.?indian|imports?|uncapped|capped)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            // Strip leftover tokens
            remaining = remaining.replace(/\b(?:who|which|limit|when|where|did|during)\b/gi, ' ').replace(/\s+/g, ' ').trim();

            entities.remainingTokens = remaining;

            // -- Post-processing: if we found no players but remaining has 3+ chars, it might be a player name --
            if (entities.players.length === 0 && remaining.length >= 3 && !isTeamToken(remaining)) {
                // Check if remaining tokens look like a player name (not common cricket words)
                const noiseCheck = /^(run|ball|over|match|team|game|score|win|loss|total|rate|dot|boundary|six|four|wicket|maiden|catch|drop|field)$/i;
                if (!noiseCheck.test(remaining)) {
                    // Fuzzy match against aliases
                    let bestMatch = null;
                    let bestDist = Infinity;
                    for (const [alias, fullName] of Object.entries(PLAYER_ALIASES)) {
                        const dist = levenshtein(remaining.toLowerCase(), alias.toLowerCase());
                        if (dist <= 2 && dist < bestDist) {
                            bestDist = dist;
                            bestMatch = fullName;
                        }
                    }
                    if (bestMatch) {
                        entities.players.push({ name: bestMatch, matchedAs: remaining, confidence: 0.7 });
                        remaining = '';
                    } else {
                        // Smart fallback: for multi-word names, use last name only
                        // because DB often has abbreviated first names (e.g., "TU Deshpande" not "Tushar Deshpande")
                        const words = remaining.trim().split(/\s+/);
                        if (words.length >= 2) {
                            const lastName = words[words.length - 1];
                            entities.players.push({ name: lastName, matchedAs: remaining, confidence: 0.4 });
                        } else {
                            entities.players.push({ name: remaining, matchedAs: remaining, confidence: 0.5 });
                        }
                        remaining = '';
                    }
                }
            }

            entities.remainingTokens = remaining;
            return entities;
        }

        // ================================================================
        // SECTION 4: STAGE 2  INTENT CLASSIFIER
        // ================================================================

        /**
         * classifyIntent(entities, originalQuery)
         * Returns one of: PLAYER_LOOKUP, MATCHUP, LEADERBOARD, TEAM_ANALYSIS,
         * TEAM_COMPARISON, COMPARISON, PRESSURE, SEASON_TREND, CONTRACTS,
         * SQUAD, OVERSEAS, EXPLORATORY
         */
        function classifyIntent(entities, originalQuery) {
            const lower = originalQuery.toLowerCase();

            // Detect season-wise queries
            const isSeasonWise = /\b(year\s*(?:wise|by\s*year)|season\s*(?:wise|by\s*season)|per\s*(?:season|year)|by\s*(?:season|year)|each\s*(?:season|year)|every\s*(?:season|year)|season\s*by\s*season|year\s*by\s*year|yearly|annually|all\s*seasons?|over\s*the\s*years?)\b/i.test(lower);
            if (isSeasonWise) return 'SEASON_TREND';

            // Contract/auction queries
            if (/\b(most expensive|highest paid|costliest|auction|contracts?|price|retained|rtm|bargain|cheap(?:est)?)\b/i.test(lower)) return 'CONTRACTS';

            // Overseas/foreign queries
            if (/\b(overseas|foreign|international|non.?indian|imports?)\b/i.test(lower)) return 'OVERSEAS';

            // Squad/roster queries
            if (/\b(squad|roster|team\s*list|lineup|playing\s*xi|xi)\b/i.test(lower) || /\bwho\s+(is|are)\s+in\b/i.test(lower)) return 'SQUAD';

            // Pressure/clutch queries
            if (/\b(pressure|clutch|chok(?:e|er|ing)|finisher|closer|rrr|required run rate|under\s*pressure|crunch|tight)\b/i.test(lower)) return 'PRESSURE';

            // Two players = matchup
            if (entities.players.length === 2) return 'MATCHUP';

            // Player vs team
            if (entities.players.length === 1 && entities.teams.length === 1 && entities.hasVsToken) return 'PLAYER_VS_TEAM';
            // Also catch "Kohli against MI" or "Kohli vs MI" without explicit vs token
            if (entities.players.length === 1 && entities.teams.length === 1 && /\b(against|facing|versus)\b/i.test(lower)) return 'PLAYER_VS_TEAM';

            // Player vs bowler type
            if (entities.players.length === 1 && entities.bowlerTypes.length >= 1) return 'PLAYER_VS_TYPE';

            // Leaderboard tokens (expanded set)
            const hasLeaderboardToken = /\b(top|best|worst|most|highest|leading|lowest|greatest|elite|dominant)\b/i.test(lower);

            // "compare X and Y" or "X vs Y" with two teams
            if (entities.teams.length === 2) return 'TEAM_COMPARISON';
            // Explicit comparison keywords with one team and no player
            if (/\b(compare|comparison|head.?to.?head)\b/i.test(lower) && entities.teams.length >= 1) return 'TEAM_COMPARISON';

            // Leaderboard (no specific player)
            if (hasLeaderboardToken && entities.players.length === 0) return 'LEADERBOARD';

            // Single player with team context (not explicit vs but team present)
            if (entities.players.length === 1 && entities.teams.length === 1) return 'PLAYER_VS_TEAM';

            // Single player lookup
            if (entities.players.length === 1) return 'PLAYER_LOOKUP';

            // Single team analysis
            if (entities.teams.length === 1 && entities.players.length === 0) return 'TEAM_ANALYSIS';

            // Win/loss comparison
            if (entities.modifiers.winLoss === 'split') return 'COMPARISON';

            // Role-only leaderboard (e.g., "bowling stats" or "batting averages")
            if (entities.role && entities.metrics.length > 0 && entities.players.length === 0) return 'LEADERBOARD';

            return 'EXPLORATORY';
        }

        // ================================================================
        // SECTION 5: STAGE 3  VIEW COVERAGE MATRIX + VIEW FINDER
        // ================================================================

        /**
         * VIEW_COVERAGE: Maps each relevant view to its supported dimensions and role.
         * Dimensions: 'player', 'phase', 'venue', 'team', 'bowlerType', 'matchup', 'pressure', 'season', 'squad'
         * Role: 'batting', 'bowling', 'matchup', 'pressure', 'team', 'squad', 'reference'
         * Scope: 'default' (recent/standard), 'alltime', 'since2023'
         *
         * The findBestView() function matches required dimensions to find the
         * most specific view that covers all of them.
         */
        const VIEW_COVERAGE = {
            // --- Batting career ---
            'analytics_ipl_batting_career':                 { dims: ['player'], role: 'batting', scope: 'default', playerCol: 'player_name', orderDefault: 'runs DESC' },
            'analytics_ipl_batting_career_alltime':         { dims: ['player'], role: 'batting', scope: 'alltime', playerCol: 'player_name', orderDefault: 'runs DESC' },
            'analytics_ipl_batting_career_since2023':       { dims: ['player'], role: 'batting', scope: 'since2023', playerCol: 'player_name', orderDefault: 'runs DESC' },

            // --- Bowling career ---
            'analytics_ipl_bowling_career':                 { dims: ['player'], role: 'bowling', scope: 'default', playerCol: 'player_name', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowling_career_alltime':         { dims: ['player'], role: 'bowling', scope: 'alltime', playerCol: 'player_name', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowling_career_since2023':       { dims: ['player'], role: 'bowling', scope: 'since2023', playerCol: 'player_name', orderDefault: 'wickets DESC' },

            // --- Batter phase ---
            'analytics_ipl_batter_phase':                   { dims: ['player', 'phase'], role: 'batting', scope: 'default', playerCol: 'player_name', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_phase_alltime':           { dims: ['player', 'phase'], role: 'batting', scope: 'alltime', playerCol: 'player_name', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_phase_since2023':         { dims: ['player', 'phase'], role: 'batting', scope: 'since2023', playerCol: 'player_name', orderDefault: 'runs DESC' },

            // --- Bowler phase ---
            'analytics_ipl_bowler_phase':                   { dims: ['player', 'phase'], role: 'bowling', scope: 'default', playerCol: 'player_name', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_phase_alltime':           { dims: ['player', 'phase'], role: 'bowling', scope: 'alltime', playerCol: 'player_name', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_phase_since2023':         { dims: ['player', 'phase'], role: 'bowling', scope: 'since2023', playerCol: 'player_name', orderDefault: 'wickets DESC' },

            // --- Batter venue ---
            'analytics_ipl_batter_venue':                   { dims: ['player', 'venue'], role: 'batting', scope: 'default', playerCol: 'batter_name', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_venue_alltime':           { dims: ['player', 'venue'], role: 'batting', scope: 'alltime', playerCol: 'batter_name', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_venue_since2023':         { dims: ['player', 'venue'], role: 'batting', scope: 'since2023', playerCol: 'batter_name', orderDefault: 'runs DESC' },

            // --- Bowler venue ---
            'analytics_ipl_bowler_venue':                   { dims: ['player', 'venue'], role: 'bowling', scope: 'default', playerCol: 'bowler_name', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_venue_alltime':           { dims: ['player', 'venue'], role: 'bowling', scope: 'alltime', playerCol: 'bowler_name', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_venue_since2023':         { dims: ['player', 'venue'], role: 'bowling', scope: 'since2023', playerCol: 'bowler_name', orderDefault: 'wickets DESC' },

            // --- Batter venue + phase ---
            'analytics_ipl_batter_venue_phase':             { dims: ['player', 'venue', 'phase'], role: 'batting', scope: 'default', playerCol: 'batter_name', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_venue_phase_alltime':     { dims: ['player', 'venue', 'phase'], role: 'batting', scope: 'alltime', playerCol: 'batter_name', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_venue_phase_since2023':   { dims: ['player', 'venue', 'phase'], role: 'batting', scope: 'since2023', playerCol: 'batter_name', orderDefault: 'runs DESC' },

            // --- Bowler venue + phase ---
            'analytics_ipl_bowler_venue_phase':             { dims: ['player', 'venue', 'phase'], role: 'bowling', scope: 'default', playerCol: 'bowler_name', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_venue_phase_alltime':     { dims: ['player', 'venue', 'phase'], role: 'bowling', scope: 'alltime', playerCol: 'bowler_name', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_venue_phase_since2023':   { dims: ['player', 'venue', 'phase'], role: 'bowling', scope: 'since2023', playerCol: 'bowler_name', orderDefault: 'wickets DESC' },

            // --- Batter vs team ---
            'analytics_ipl_batter_vs_team':                 { dims: ['player', 'team'], role: 'batting', scope: 'default', playerCol: 'batter_name', teamCol: 'opposition', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_vs_team_alltime':         { dims: ['player', 'team'], role: 'batting', scope: 'alltime', playerCol: 'batter_name', teamCol: 'opposition', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_vs_team_since2023':       { dims: ['player', 'team'], role: 'batting', scope: 'since2023', playerCol: 'batter_name', teamCol: 'opposition', orderDefault: 'runs DESC' },

            // --- Batter vs team + phase ---
            'analytics_ipl_batter_vs_team_phase':           { dims: ['player', 'team', 'phase'], role: 'batting', scope: 'default', playerCol: 'batter_name', teamCol: 'opposition', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_vs_team_phase_alltime':   { dims: ['player', 'team', 'phase'], role: 'batting', scope: 'alltime', playerCol: 'batter_name', teamCol: 'opposition', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_vs_team_phase_since2023': { dims: ['player', 'team', 'phase'], role: 'batting', scope: 'since2023', playerCol: 'batter_name', teamCol: 'opposition', orderDefault: 'runs DESC' },

            // --- Bowler vs team ---
            'analytics_ipl_bowler_vs_team':                 { dims: ['player', 'team'], role: 'bowling', scope: 'default', playerCol: 'bowler_name', teamCol: 'opposition', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_vs_team_alltime':         { dims: ['player', 'team'], role: 'bowling', scope: 'alltime', playerCol: 'bowler_name', teamCol: 'opposition', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_vs_team_since2023':       { dims: ['player', 'team'], role: 'bowling', scope: 'since2023', playerCol: 'bowler_name', teamCol: 'opposition', orderDefault: 'wickets DESC' },

            // --- Bowler vs team + phase ---
            'analytics_ipl_bowler_vs_team_phase':           { dims: ['player', 'team', 'phase'], role: 'bowling', scope: 'default', playerCol: 'bowler_name', teamCol: 'opposition', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_vs_team_phase_alltime':   { dims: ['player', 'team', 'phase'], role: 'bowling', scope: 'alltime', playerCol: 'bowler_name', teamCol: 'opposition', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_vs_team_phase_since2023': { dims: ['player', 'team', 'phase'], role: 'bowling', scope: 'since2023', playerCol: 'bowler_name', teamCol: 'opposition', orderDefault: 'wickets DESC' },

            // --- Batter vs bowler (matchup) ---
            'analytics_ipl_batter_vs_bowler':               { dims: ['matchup'], role: 'matchup', scope: 'default', playerCol: 'batter_name', bowlerCol: 'bowler_name', orderDefault: 'balls DESC' },
            'analytics_ipl_batter_vs_bowler_alltime':       { dims: ['matchup'], role: 'matchup', scope: 'alltime', playerCol: 'batter_name', bowlerCol: 'bowler_name', orderDefault: 'balls DESC' },
            'analytics_ipl_batter_vs_bowler_since2023':     { dims: ['matchup'], role: 'matchup', scope: 'since2023', playerCol: 'batter_name', bowlerCol: 'bowler_name', orderDefault: 'balls DESC' },

            // --- Batter vs bowler + phase ---
            'analytics_ipl_batter_vs_bowler_phase':         { dims: ['matchup', 'phase'], role: 'matchup', scope: 'default', playerCol: 'batter_name', bowlerCol: 'bowler_name', orderDefault: 'balls DESC' },
            'analytics_ipl_batter_vs_bowler_phase_alltime': { dims: ['matchup', 'phase'], role: 'matchup', scope: 'alltime', playerCol: 'batter_name', bowlerCol: 'bowler_name', orderDefault: 'balls DESC' },
            'analytics_ipl_batter_vs_bowler_phase_since2023':{ dims: ['matchup', 'phase'], role: 'matchup', scope: 'since2023', playerCol: 'batter_name', bowlerCol: 'bowler_name', orderDefault: 'balls DESC' },

            // --- Batter vs bowler type ---
            'analytics_ipl_batter_vs_bowler_type':          { dims: ['player', 'bowlerType'], role: 'batting', scope: 'default', playerCol: 'batter_name', orderDefault: 'balls DESC' },
            'analytics_ipl_batter_vs_bowler_type_alltime':  { dims: ['player', 'bowlerType'], role: 'batting', scope: 'alltime', playerCol: 'batter_name', orderDefault: 'balls DESC' },
            'analytics_ipl_batter_vs_bowler_type_since2023':{ dims: ['player', 'bowlerType'], role: 'batting', scope: 'since2023', playerCol: 'batter_name', orderDefault: 'balls DESC' },

            // --- Batter vs bowler type + phase ---
            'analytics_ipl_batter_vs_bowler_type_phase':    { dims: ['player', 'bowlerType', 'phase'], role: 'batting', scope: 'default', playerCol: 'batter_name', orderDefault: 'balls DESC' },
            'analytics_ipl_batter_vs_bowler_type_phase_alltime': { dims: ['player', 'bowlerType', 'phase'], role: 'batting', scope: 'alltime', playerCol: 'batter_name', orderDefault: 'balls DESC' },
            'analytics_ipl_batter_vs_bowler_type_phase_since2023': { dims: ['player', 'bowlerType', 'phase'], role: 'batting', scope: 'since2023', playerCol: 'batter_name', orderDefault: 'balls DESC' },

            // --- Pressure bands ---
            'analytics_ipl_batter_pressure_bands_since2023': { dims: ['player', 'pressure'], role: 'pressure_batting', scope: 'since2023', playerCol: 'player_name', orderDefault: 'strike_rate DESC' },
            'analytics_ipl_batter_pressure_bands_alltime':   { dims: ['player', 'pressure'], role: 'pressure_batting', scope: 'alltime', playerCol: 'player_name', orderDefault: 'strike_rate DESC' },
            'analytics_ipl_bowler_pressure_bands_since2023': { dims: ['player', 'pressure'], role: 'pressure_bowling', scope: 'since2023', playerCol: 'player_name', orderDefault: 'economy ASC' },
            'analytics_ipl_bowler_pressure_bands_alltime':   { dims: ['player', 'pressure'], role: 'pressure_bowling', scope: 'alltime', playerCol: 'player_name', orderDefault: 'economy ASC' },

            // --- Pressure deltas ---
            'analytics_ipl_pressure_deltas_since2023':       { dims: ['pressure'], role: 'pressure_delta', scope: 'since2023', playerCol: 'player_name', orderDefault: 'pressure_rating DESC' },
            'analytics_ipl_pressure_deltas_alltime':         { dims: ['pressure'], role: 'pressure_delta', scope: 'alltime', playerCol: 'player_name', orderDefault: 'pressure_rating DESC' },

            // --- Pressure sequences ---
            'analytics_ipl_pressure_dot_sequences_since2023': { dims: ['pressure'], role: 'pressure_dot_seq', scope: 'since2023', playerCol: 'bowler_name', orderDefault: 'avg_dot_seq_length DESC' },
            'analytics_ipl_pressure_dot_sequences_alltime':   { dims: ['pressure'], role: 'pressure_dot_seq', scope: 'alltime', playerCol: 'bowler_name', orderDefault: 'avg_dot_seq_length DESC' },
            'analytics_ipl_pressure_boundary_sequences_since2023': { dims: ['pressure'], role: 'pressure_bdry_seq', scope: 'since2023', playerCol: 'batter_name', orderDefault: 'avg_boundary_seq_length DESC' },
            'analytics_ipl_pressure_boundary_sequences_alltime':   { dims: ['pressure'], role: 'pressure_bdry_seq', scope: 'alltime', playerCol: 'batter_name', orderDefault: 'avg_boundary_seq_length DESC' },

            // --- Squad views ---
            'analytics_ipl_squad_batting':                   { dims: ['squad'], role: 'squad_batting', scope: 'default', playerCol: 'player_name', teamCol: 'team_name', orderDefault: 'ipl_runs DESC NULLS LAST' },
            'analytics_ipl_squad_batting_phase':             { dims: ['squad', 'phase'], role: 'squad_batting', scope: 'default', playerCol: 'player_name', teamCol: 'team_name', orderDefault: 'runs DESC NULLS LAST' },
            'analytics_ipl_squad_bowling':                   { dims: ['squad'], role: 'squad_bowling', scope: 'default', playerCol: 'player_name', teamCol: 'team_name', orderDefault: 'player_name' },
            'analytics_ipl_squad_bowling_phase':             { dims: ['squad', 'phase'], role: 'squad_bowling', scope: 'default', playerCol: 'player_name', teamCol: 'team_name', orderDefault: 'economy_rate ASC NULLS LAST' },
        };

        /**
         * findBestView(entities, intent)
         * Determines required dimensions from entities and finds the most specific
         * view that covers all of them.
         * Returns: { viewName, viewMeta } or null if no view matches.
         */
        function findBestView(entities, intent) {
            // Build required dimension set
            const requiredDims = new Set();
            let requiredRole = null; // batting, bowling, matchup
            let preferredScope = 'default';

            // Determine scope from season entities
            if (entities.seasons.length > 0) {
                const s = entities.seasons[0];
                if (s.type === 'range' && s.from && parseInt(s.from) >= 2023) {
                    preferredScope = 'since2023';
                } else if (s.type === 'exact' && parseInt(s.value) >= 2023) {
                    preferredScope = 'since2023';
                } else {
                    preferredScope = 'alltime';
                }
            }

            // Build dimensions
            if (intent === 'MATCHUP') {
                requiredDims.add('matchup');
                requiredRole = 'matchup';
            } else if (entities.players.length >= 1) {
                requiredDims.add('player');
            }

            if (entities.phases.length > 0 || entities.modifiers.breakdownByPhase) requiredDims.add('phase');
            if (entities.venues.length > 0) requiredDims.add('venue');
            if (entities.bowlerTypes.length > 0) requiredDims.add('bowlerType');

            // Team dimension (for player-vs-team, not squad)
            if (entities.teams.length >= 1 && entities.players.length >= 1 && !['SQUAD', 'TEAM_ANALYSIS'].includes(intent)) {
                requiredDims.add('team');
            }

            // Squad dimension
            if (intent === 'TEAM_ANALYSIS' || intent === 'SQUAD') {
                requiredDims.add('squad');
            }

            // Pressure dimension
            if (intent === 'PRESSURE') {
                requiredDims.add('pressure');
            }

            // Determine role
            if (requiredRole === null) {
                if (entities.role === 'bowling') {
                    requiredRole = 'bowling';
                } else if (entities.role === 'batting' || entities.role === null) {
                    requiredRole = 'batting';
                }
            }

            // Disqualifying modifiers: these require dynamic SQL (Phase 2)
            if (entities.modifiers.winLoss || entities.modifiers.innings || entities.modifiers.stage || entities.modifiers.totalContext) {
                return null; // Cannot be satisfied by a view
            }

            // Find matching views
            const candidates = [];
            for (const [viewName, meta] of Object.entries(VIEW_COVERAGE)) {
                // Check scope compatibility
                if (preferredScope === 'since2023' && meta.scope !== 'since2023' && meta.scope !== 'default') continue;
                if (preferredScope === 'alltime' && meta.scope !== 'alltime' && meta.scope !== 'default') continue;
                if (preferredScope === 'default' && meta.scope !== 'default') continue;

                // Check that view dimensions are a superset of required dimensions
                const viewDims = new Set(meta.dims);
                let coversAll = true;
                for (const dim of requiredDims) {
                    if (!viewDims.has(dim)) { coversAll = false; break; }
                }
                if (!coversAll) continue;

                // Check role compatibility
                if (requiredRole === 'batting') {
                    if (!['batting', 'matchup', 'squad_batting', 'pressure_batting', 'pressure_delta', 'pressure_bdry_seq'].includes(meta.role)) continue;
                } else if (requiredRole === 'bowling') {
                    if (!['bowling', 'squad_bowling', 'pressure_bowling', 'pressure_delta', 'pressure_dot_seq'].includes(meta.role)) continue;
                } else if (requiredRole === 'matchup') {
                    if (meta.role !== 'matchup') continue;
                }

                // Score: prefer more specific views (more dimensions = better match)
                // and prefer scope-matched views
                let score = meta.dims.length * 10;
                if (meta.scope === preferredScope) score += 5;
                if (meta.scope === 'default' && preferredScope === 'default') score += 3;

                candidates.push({ viewName, meta, score });
            }

            if (candidates.length === 0) return null;

            // Sort by score descending (most specific first), then by dims length ascending for tie-break
            candidates.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return a.meta.dims.length - b.meta.dims.length; // prefer fewer extra dims
            });

            return { viewName: candidates[0].viewName, viewMeta: candidates[0].meta };
        }

        // ================================================================
        // SECTION 5B: STAGE 3B  DYNAMIC SQL QUERY BUILDER (Phase 2, TKT-185/186/187/188)
        // ================================================================

        /**
         * QueryBuilder: Composable SQL generator for dynamic queries.
         *
         * Used when context modifiers (win/loss, innings, stage, total context)
         * are present and no pre-built view can satisfy the query.
         * Builds valid DuckDB SQL by stacking independent filter modules.
         *
         * All user-provided strings are escaped via escapeSql() to prevent injection.
         * The IPL filter CTE is always included as the base.
         */
        class QueryBuilder {
            constructor() {
                this.selects = [];
                this.from = 'fact_ball fb';
                this.joins = new Map();   // key -> join clause (Map preserves order, deduplicates)
                this.wheres = [];
                this.groupBys = [];
                this.havings = [];
                this.ctes = new Map();    // name -> SQL (de-duplicated CTEs)
                this.orderBy = null;
                this.limit = 20;
                this._role = 'batting';   // 'batting' or 'bowling'
                this._winLossMode = null; // 'wins', 'losses', or 'split'
                this._seasonGroupBy = false;
            }

            // --- IPL Filter CTE (always included as base) ---
            addIPLFilter() {
                this.ctes.set('ipl', `ipl AS (
  SELECT dm.match_id, dm.winner_id, dm.season, dm.stage, dm.match_date
  FROM dim_match dm
  JOIN dim_tournament dtt ON dm.tournament_id = dtt.tournament_id
  WHERE dtt.tournament_name = 'Indian Premier League'
)`);
                // Ensure fact_ball is joined to ipl CTE
                this.joins.set('ipl', 'JOIN ipl ON fb.match_id = ipl.match_id');
                return this;
            }

            // --- Player Filter ---
            addPlayerFilter(name, role) {
                const safeName = escapeSql(name);
                if (role === 'bowling') {
                    this._role = 'bowling';
                    this.joins.set('dim_player_bowler', 'JOIN dim_player dp ON fb.bowler_id = dp.player_id');
                    this.wheres.push(`dp.current_name ILIKE '%${safeName}%'`);
                    if (!this.groupBys.includes('dp.current_name')) {
                        this.groupBys.push('dp.current_name');
                    }
                } else {
                    this._role = 'batting';
                    this.joins.set('dim_player_batter', 'JOIN dim_player dp ON fb.batter_id = dp.player_id');
                    this.wheres.push(`dp.current_name ILIKE '%${safeName}%'`);
                    if (!this.groupBys.includes('dp.current_name')) {
                        this.groupBys.push('dp.current_name');
                    }
                }
                return this;
            }

            // --- Team Filter ---
            addTeamFilter(teamCanonical, role) {
                const safeTeam = escapeSql(teamCanonical);
                if (role === 'bowling' || this._role === 'bowling') {
                    this.joins.set('dim_team_bowling', 'JOIN dim_team dt_bowl ON fb.bowling_team_id = dt_bowl.team_id');
                    this.joins.set('dim_franchise_alias_bowl', 'LEFT JOIN dim_franchise_alias fa_bowl ON dt_bowl.team_name = fa_bowl.team_name');
                    this.wheres.push(`COALESCE(fa_bowl.canonical_name, dt_bowl.team_name) ILIKE '%${safeTeam}%'`);
                } else {
                    this.joins.set('dim_team_batting', 'JOIN dim_team dt_bat ON fb.batting_team_id = dt_bat.team_id');
                    this.joins.set('dim_franchise_alias_bat', 'LEFT JOIN dim_franchise_alias fa_bat ON dt_bat.team_name = fa_bat.team_name');
                    this.wheres.push(`COALESCE(fa_bat.canonical_name, dt_bat.team_name) ILIKE '%${safeTeam}%'`);
                }
                return this;
            }

            // --- Phase Filter ---
            addPhaseFilter(phases) {
                if (!Array.isArray(phases)) phases = [phases];
                if (phases.length === 1) {
                    this.wheres.push(`fb.match_phase = '${escapeSql(phases[0])}'`);
                } else {
                    const phaseList = phases.map(p => `'${escapeSql(p)}'`).join(', ');
                    this.wheres.push(`fb.match_phase IN (${phaseList})`);
                }
                // Add match_phase to GROUP BY and SELECT if multiple phases are being compared
                if (phases.length > 1 && !this.groupBys.includes('fb.match_phase')) {
                    this.groupBys.push('fb.match_phase');
                    this.selects.push('fb.match_phase');
                }
                return this;
            }

            // --- Venue Filter ---
            addVenueFilter(venuePattern) {
                const safeVenue = escapeSql(venuePattern);
                this.joins.set('dim_venue', 'JOIN dim_venue dv ON ipl.match_id = fb.match_id');
                // dim_venue needs joining via dim_match; since we use the ipl CTE we need a separate approach
                // Actually, we need to join dim_match for venue_id. Since ipl CTE already has match_id,
                // we need to get venue from dim_match directly.
                this.joins.delete('dim_venue');
                this.joins.set('dim_match_venue', 'JOIN dim_match dm_v ON fb.match_id = dm_v.match_id');
                this.joins.set('dim_venue', 'JOIN dim_venue dv ON dm_v.venue_id = dv.venue_id');
                this.wheres.push(`(dv.venue_name ILIKE '%${safeVenue}%' OR dv.city ILIKE '%${safeVenue}%')`);
                return this;
            }

            // --- Season Filter ---
            addSeasonFilter(seasons) {
                if (!Array.isArray(seasons)) seasons = [seasons];
                for (const s of seasons) {
                    if (s.type === 'range' && s.from) {
                        this.wheres.push(`ipl.season >= '${escapeSql(s.from)}'`);
                        if (s.to) {
                            this.wheres.push(`ipl.season <= '${escapeSql(s.to)}'`);
                        }
                    } else if (s.type === 'exact' && s.value) {
                        this.wheres.push(`ipl.season = '${escapeSql(s.value)}'`);
                    }
                }
                return this;
            }

            // --- Season GROUP BY (for "season wise" / "year by year") ---
            addSeasonGroupBy() {
                this._seasonGroupBy = true;
                if (!this.groupBys.includes('ipl.season')) {
                    this.groupBys.push('ipl.season');
                }
                return this;
            }

            // --- Win/Loss Filter ---
            addWinLossFilter(mode) {
                // mode: 'wins', 'losses', or 'split'
                this._winLossMode = mode;

                // Ensure ipl CTE has winner_id (it does by default)
                // We need to exclude no-result matches for meaningful win/loss data
                this.wheres.push('ipl.winner_id IS NOT NULL');

                if (mode === 'wins') {
                    if (this._role === 'bowling') {
                        this.wheres.push('ipl.winner_id = fb.bowling_team_id');
                    } else {
                        this.wheres.push('ipl.winner_id = fb.batting_team_id');
                    }
                } else if (mode === 'losses') {
                    if (this._role === 'bowling') {
                        this.wheres.push('ipl.winner_id != fb.bowling_team_id');
                    } else {
                        this.wheres.push('ipl.winner_id != fb.batting_team_id');
                    }
                } else if (mode === 'split') {
                    // Add match_result as a computed column + GROUP BY dimension
                    const teamCol = this._role === 'bowling' ? 'fb.bowling_team_id' : 'fb.batting_team_id';
                    const caseExpr = `CASE WHEN ipl.winner_id = ${teamCol} THEN 'WON' ELSE 'LOST' END`;
                    this.selects.push(`${caseExpr} AS match_result`);
                    if (!this.groupBys.includes(caseExpr)) {
                        this.groupBys.push(caseExpr);
                    }
                }
                return this;
            }

            // --- Innings Filter ---
            addInningsFilter(innings) {
                this.wheres.push(`fb.innings = ${parseInt(innings)}`);
                return this;
            }

            // --- Stage Filter (playoff/league/final) ---
            addStageFilter(stage) {
                if (stage === 'playoff') {
                    this.wheres.push(`LOWER(ipl.stage) IN ('playoff', 'final', 'qualifier 1', 'qualifier 2', 'eliminator', 'qualifier', 'semi final', 'semi-final')`);
                } else if (stage === 'league') {
                    this.wheres.push(`LOWER(ipl.stage) NOT IN ('playoff', 'final', 'qualifier 1', 'qualifier 2', 'eliminator', 'qualifier', 'semi final', 'semi-final')`);
                } else if (stage === 'final') {
                    this.wheres.push(`LOWER(ipl.stage) = 'final'`);
                }
                return this;
            }

            // --- Bowler Type Filter ---
            addBowlerTypeFilter(styles) {
                if (!Array.isArray(styles)) styles = [styles];
                const safeStyles = styles.map(s => `'${escapeSql(s)}'`).join(', ');
                this.joins.set('dim_bowler_classification', 'LEFT JOIN dim_bowler_classification bc ON fb.bowler_id = bc.player_id');
                this.wheres.push(`(bc.bowling_style IN (${safeStyles}) OR LOWER(bc.bowling_style) IN (${safeStyles.toLowerCase()}))`);
                return this;
            }

            // --- Total Context Filter (e.g., "defending 180+") ---
            addTotalContextFilter(operator, value) {
                const safeVal = parseInt(value);
                if (isNaN(safeVal)) return this;
                this.ctes.set('inn1_total', `inn1_total AS (
  SELECT match_id, SUM(total_runs) AS first_inn_total
  FROM fact_ball
  WHERE innings = 1
  GROUP BY match_id
  HAVING SUM(total_runs) ${operator} ${safeVal}
)`);
                this.joins.set('inn1_total', 'JOIN inn1_total i1t ON fb.match_id = i1t.match_id');
                return this;
            }

            // --- Standard Batting Aggregation ---
            setBattingAggregation() {
                this._role = 'batting';
                // Prepend player_name to selects
                const baseSelects = [
                    'dp.current_name AS player_name',
                ];
                const aggSelects = [
                    'COUNT(DISTINCT fb.match_id) AS innings',
                    'SUM(fb.batter_runs) AS runs',
                    'SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) AS balls',
                    "ROUND(SUM(fb.batter_runs) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS strike_rate",
                    "ROUND(SUM(fb.batter_runs) * 1.0 / NULLIF(SUM(CASE WHEN fb.is_wicket AND fb.player_out_id = fb.batter_id THEN 1 ELSE 0 END), 0), 2) AS average",
                    "SUM(CASE WHEN fb.batter_runs = 4 THEN 1 ELSE 0 END) AS fours",
                    "SUM(CASE WHEN fb.batter_runs = 6 THEN 1 ELSE 0 END) AS sixes",
                    "ROUND(SUM(CASE WHEN fb.batter_runs IN (4, 6) THEN 1 ELSE 0 END) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS boundary_pct",
                    "ROUND(SUM(CASE WHEN fb.batter_runs = 0 AND fb.is_legal_ball THEN 1 ELSE 0 END) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS dot_ball_pct",
                ];
                this.selects = [...baseSelects, ...this.selects, ...aggSelects];
                if (!this.orderBy) this.orderBy = 'runs DESC';
                return this;
            }

            // --- Standard Bowling Aggregation ---
            setBowlingAggregation() {
                this._role = 'bowling';
                const baseSelects = [
                    'dp.current_name AS player_name',
                ];
                const aggSelects = [
                    'COUNT(DISTINCT fb.match_id) AS matches',
                    "ROUND(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) / 6.0, 1) AS overs",
                    "SUM(fb.total_runs) AS runs_conceded",
                    "SUM(CASE WHEN fb.is_wicket AND fb.wicket_type NOT IN ('run out', 'retired hurt', 'retired out') THEN 1 ELSE 0 END) AS wickets",
                    "ROUND(SUM(fb.total_runs) * 6.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS economy",
                    "ROUND(SUM(fb.total_runs) * 1.0 / NULLIF(SUM(CASE WHEN fb.is_wicket AND fb.wicket_type NOT IN ('run out', 'retired hurt', 'retired out') THEN 1 ELSE 0 END), 0), 2) AS bowling_average",
                    "ROUND(SUM(CASE WHEN fb.batter_runs = 0 AND fb.extra_runs = 0 AND fb.is_legal_ball THEN 1 ELSE 0 END) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS dot_ball_pct",
                ];
                this.selects = [...baseSelects, ...this.selects, ...aggSelects];
                if (!this.orderBy) this.orderBy = 'wickets DESC';
                return this;
            }

            // --- Team-level Batting Aggregation (no player GROUP BY) ---
            setTeamBattingAggregation(teamCanonical) {
                this._role = 'batting';
                const safeTeam = escapeSql(teamCanonical);
                this.joins.set('dim_team_batting', 'JOIN dim_team dt_bat ON fb.batting_team_id = dt_bat.team_id');
                this.joins.set('dim_franchise_alias_bat', 'LEFT JOIN dim_franchise_alias fa_bat ON dt_bat.team_name = fa_bat.team_name');
                this.wheres.push(`COALESCE(fa_bat.canonical_name, dt_bat.team_name) ILIKE '%${safeTeam}%'`);

                const baseSelects = [
                    "COALESCE(fa_bat.canonical_name, dt_bat.team_name) AS team_name",
                ];
                const aggSelects = [
                    'COUNT(DISTINCT fb.match_id) AS matches',
                    'SUM(fb.batter_runs) AS runs',
                    'SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) AS balls',
                    "ROUND(SUM(fb.batter_runs) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS strike_rate",
                    "ROUND(SUM(CASE WHEN fb.batter_runs IN (4, 6) THEN 1 ELSE 0 END) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS boundary_pct",
                ];
                this.selects = [...baseSelects, ...this.selects, ...aggSelects];
                this.groupBys = this.groupBys.filter(g => g !== 'dp.current_name');
                if (!this.groupBys.includes("COALESCE(fa_bat.canonical_name, dt_bat.team_name)")) {
                    this.groupBys.push("COALESCE(fa_bat.canonical_name, dt_bat.team_name)");
                }
                if (!this.orderBy) this.orderBy = 'runs DESC';
                return this;
            }

            // --- Team-level Bowling Aggregation (no player GROUP BY) ---
            setTeamBowlingAggregation(teamCanonical) {
                this._role = 'bowling';
                const safeTeam = escapeSql(teamCanonical);
                this.joins.set('dim_team_bowling', 'JOIN dim_team dt_bowl ON fb.bowling_team_id = dt_bowl.team_id');
                this.joins.set('dim_franchise_alias_bowl', 'LEFT JOIN dim_franchise_alias fa_bowl ON dt_bowl.team_name = fa_bowl.team_name');
                this.wheres.push(`COALESCE(fa_bowl.canonical_name, dt_bowl.team_name) ILIKE '%${safeTeam}%'`);

                const baseSelects = [
                    "COALESCE(fa_bowl.canonical_name, dt_bowl.team_name) AS team_name",
                ];
                const aggSelects = [
                    'COUNT(DISTINCT fb.match_id) AS matches',
                    "ROUND(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) / 6.0, 1) AS overs",
                    "SUM(fb.total_runs) AS runs_conceded",
                    "SUM(CASE WHEN fb.is_wicket AND fb.wicket_type NOT IN ('run out', 'retired hurt', 'retired out') THEN 1 ELSE 0 END) AS wickets",
                    "ROUND(SUM(fb.total_runs) * 6.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS economy",
                    "ROUND(SUM(CASE WHEN fb.batter_runs = 0 AND fb.extra_runs = 0 AND fb.is_legal_ball THEN 1 ELSE 0 END) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS dot_ball_pct",
                ];
                this.selects = [...baseSelects, ...this.selects, ...aggSelects];
                this.groupBys = this.groupBys.filter(g => g !== 'dp.current_name');
                if (!this.groupBys.includes("COALESCE(fa_bowl.canonical_name, dt_bowl.team_name)")) {
                    this.groupBys.push("COALESCE(fa_bowl.canonical_name, dt_bowl.team_name)");
                }
                if (!this.orderBy) this.orderBy = 'economy ASC';
                return this;
            }

            // --- Leaderboard Batting Aggregation (no specific player filter) ---
            setLeaderboardBattingAggregation(minBalls) {
                this._role = 'batting';
                this.joins.set('dim_player_batter', 'JOIN dim_player dp ON fb.batter_id = dp.player_id');
                if (!this.groupBys.includes('dp.current_name')) {
                    this.groupBys.push('dp.current_name');
                }
                const baseSelects = [
                    'dp.current_name AS player_name',
                ];
                const aggSelects = [
                    'COUNT(DISTINCT fb.match_id) AS innings',
                    'SUM(fb.batter_runs) AS runs',
                    'SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) AS balls',
                    "ROUND(SUM(fb.batter_runs) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS strike_rate",
                    "ROUND(SUM(fb.batter_runs) * 1.0 / NULLIF(SUM(CASE WHEN fb.is_wicket AND fb.player_out_id = fb.batter_id THEN 1 ELSE 0 END), 0), 2) AS average",
                    "ROUND(SUM(CASE WHEN fb.batter_runs IN (4, 6) THEN 1 ELSE 0 END) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS boundary_pct",
                    "ROUND(SUM(CASE WHEN fb.batter_runs = 0 AND fb.is_legal_ball THEN 1 ELSE 0 END) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS dot_ball_pct",
                ];
                this.selects = [...baseSelects, ...this.selects, ...aggSelects];
                if (minBalls) {
                    this.havings.push(`SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) >= ${parseInt(minBalls)}`);
                }
                if (!this.orderBy) this.orderBy = 'runs DESC';
                return this;
            }

            // --- Leaderboard Bowling Aggregation (no specific player filter) ---
            setLeaderboardBowlingAggregation(minBalls) {
                this._role = 'bowling';
                this.joins.set('dim_player_bowler', 'JOIN dim_player dp ON fb.bowler_id = dp.player_id');
                if (!this.groupBys.includes('dp.current_name')) {
                    this.groupBys.push('dp.current_name');
                }
                const baseSelects = [
                    'dp.current_name AS player_name',
                ];
                const aggSelects = [
                    'COUNT(DISTINCT fb.match_id) AS matches',
                    "ROUND(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) / 6.0, 1) AS overs",
                    "SUM(fb.total_runs) AS runs_conceded",
                    "SUM(CASE WHEN fb.is_wicket AND fb.wicket_type NOT IN ('run out', 'retired hurt', 'retired out') THEN 1 ELSE 0 END) AS wickets",
                    "ROUND(SUM(fb.total_runs) * 6.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS economy",
                    "ROUND(SUM(fb.total_runs) * 1.0 / NULLIF(SUM(CASE WHEN fb.is_wicket AND fb.wicket_type NOT IN ('run out', 'retired hurt', 'retired out') THEN 1 ELSE 0 END), 0), 2) AS bowling_average",
                    "ROUND(SUM(CASE WHEN fb.batter_runs = 0 AND fb.extra_runs = 0 AND fb.is_legal_ball THEN 1 ELSE 0 END) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS dot_ball_pct",
                ];
                this.selects = [...baseSelects, ...this.selects, ...aggSelects];
                if (minBalls) {
                    this.havings.push(`SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) >= ${parseInt(minBalls)}`);
                }
                if (!this.orderBy) this.orderBy = 'wickets DESC';
                return this;
            }

            // --- Set ORDER BY ---
            setOrderBy(orderExpr) {
                this.orderBy = orderExpr;
                return this;
            }

            // --- Set LIMIT ---
            setLimit(n) {
                this.limit = parseInt(n) || 20;
                return this;
            }

            // --- Build the final SQL string ---
            build() {
                let sql = '-- NL Search: dynamic query (Phase 2 QueryBuilder)\n';

                // CTEs
                if (this.ctes.size > 0) {
                    sql += 'WITH ' + Array.from(this.ctes.values()).join(',\n') + '\n';
                }

                // SELECT
                if (this.selects.length === 0) {
                    sql += 'SELECT *\n';
                } else {
                    // De-duplicate selects (by alias if present)
                    const seen = new Set();
                    const uniqueSelects = [];
                    for (const s of this.selects) {
                        const aliasMatch = s.match(/\bAS\s+(\w+)\s*$/i);
                        const key = aliasMatch ? aliasMatch[1].toLowerCase() : s;
                        if (!seen.has(key)) {
                            seen.add(key);
                            uniqueSelects.push(s);
                        }
                    }
                    sql += 'SELECT\n  ' + uniqueSelects.join(',\n  ') + '\n';
                }

                // FROM
                sql += `FROM ${this.from}\n`;

                // JOINs
                if (this.joins.size > 0) {
                    sql += Array.from(this.joins.values()).join('\n') + '\n';
                }

                // WHERE
                if (this.wheres.length > 0) {
                    // De-duplicate where clauses
                    const uniqueWheres = [...new Set(this.wheres)];
                    sql += 'WHERE ' + uniqueWheres.join('\n  AND ') + '\n';
                }

                // GROUP BY
                if (this.groupBys.length > 0) {
                    sql += 'GROUP BY ' + this.groupBys.join(', ') + '\n';
                }

                // HAVING
                if (this.havings.length > 0) {
                    sql += 'HAVING ' + this.havings.join('\n  AND ') + '\n';
                }

                // ORDER BY
                if (this.orderBy) {
                    // For season trend queries, order by season first
                    if (this._seasonGroupBy) {
                        sql += `ORDER BY ipl.season\n`;
                    } else if (this._winLossMode === 'split') {
                        sql += `ORDER BY ${this.orderBy}, match_result\n`;
                    } else {
                        sql += `ORDER BY ${this.orderBy}\n`;
                    }
                }

                // LIMIT
                sql += `LIMIT ${this.limit};`;

                return sql;
            }
        }

        // ================================================================
        // SECTION 5C: DYNAMIC QUERY ORCHESTRATOR (Phase 2, TKT-185)
        // ================================================================

        /**
         * buildDynamicQuery(entities, intent)
         *
         * Orchestrates QueryBuilder to generate dynamic SQL based on
         * extracted entities and classified intent.
         *
         * Called when context modifiers are present (win/loss, innings, stage,
         * total context) and no pre-built view can satisfy the query.
         *
         * Returns: { sql, type, entity, context } or null
         */
        function buildDynamicQuery(entities, intent) {
            const qb = new QueryBuilder();

            // Always start with IPL filter
            qb.addIPLFilter();

            // Determine role: check explicit role, metric keywords, and remaining tokens
            const bowlingMetricCols = ['economy_rate', 'wickets'];
            const hasBowlingMetric = entities.metrics.some(m =>
                bowlingMetricCols.includes(m.col) || (m.keyword && /\b(economy|econ|wickets?)\b/i.test(m.keyword))
            );
            const isBowling = entities.role === 'bowling' || (
                entities.role !== 'batting' && (
                    hasBowlingMetric ||
                    /\b(bowl(?:ing|ers?)?|wicket.?takers?|economy|econ|dot.?ball)\b/i.test(entities.remainingTokens || '')
                )
            );
            const role = isBowling ? 'bowling' : 'batting';

            // Track description pieces for the 'context' return field
            const contextParts = [];

            // --- PLAYER FILTER ---
            if (entities.players.length >= 1) {
                qb.addPlayerFilter(entities.players[0].name, role);
            }

            // --- TEAM FILTER (for player-vs-team or team-level queries) ---
            if (entities.teams.length >= 1 && entities.players.length >= 1) {
                // Player vs specific opposition team
                const oppRole = isBowling ? 'batting' : 'bowling';
                // For "Bumrah economy vs MI" -> filter MI as batting team (opposition)
                if (isBowling) {
                    const safeTeam = escapeSql(entities.teams[0].canonical);
                    qb.joins.set('dim_team_batting', 'JOIN dim_team dt_opp ON fb.batting_team_id = dt_opp.team_id');
                    qb.joins.set('dim_franchise_alias_opp', 'LEFT JOIN dim_franchise_alias fa_opp ON dt_opp.team_name = fa_opp.team_name');
                    qb.wheres.push(`COALESCE(fa_opp.canonical_name, dt_opp.team_name) ILIKE '%${safeTeam}%'`);
                } else {
                    const safeTeam = escapeSql(entities.teams[0].canonical);
                    qb.joins.set('dim_team_bowling', 'JOIN dim_team dt_opp ON fb.bowling_team_id = dt_opp.team_id');
                    qb.joins.set('dim_franchise_alias_opp', 'LEFT JOIN dim_franchise_alias fa_opp ON dt_opp.team_name = fa_opp.team_name');
                    qb.wheres.push(`COALESCE(fa_opp.canonical_name, dt_opp.team_name) ILIKE '%${safeTeam}%'`);
                }
                contextParts.push('vs ' + entities.teams[0].canonical);
            }

            // --- TEAM-LEVEL QUERIES (no specific player, team analysis with modifiers) ---
            if (entities.teams.length >= 1 && entities.players.length === 0 && intent === 'TEAM_ANALYSIS') {
                if (isBowling) {
                    qb.setTeamBowlingAggregation(entities.teams[0].canonical);
                } else {
                    qb.setTeamBattingAggregation(entities.teams[0].canonical);
                }
                contextParts.push(entities.teams[0].canonical);
            }

            // --- LEADERBOARD QUERIES (no specific player) ---
            if (intent === 'LEADERBOARD' && entities.players.length === 0) {
                const minBalls = entities.phases.length > 0 ? 120 : 300;
                if (isBowling) {
                    qb.setLeaderboardBowlingAggregation(minBalls);
                } else {
                    qb.setLeaderboardBattingAggregation(minBalls);
                }
                contextParts.push('leaderboard');
            }

            // --- PHASE FILTER ---
            if (entities.phases.length > 0) {
                qb.addPhaseFilter(entities.phases);
                contextParts.push(entities.phases.join('/'));
            }

            // --- VENUE FILTER ---
            if (entities.venues.length > 0) {
                qb.addVenueFilter(entities.venues[0].pattern);
                contextParts.push('at ' + entities.venues[0].keyword);
            }

            // --- SEASON FILTER ---
            if (entities.seasons.length > 0) {
                qb.addSeasonFilter(entities.seasons);
                const s = entities.seasons[0];
                if (s.type === 'range') {
                    contextParts.push('since ' + s.from);
                } else if (s.type === 'exact') {
                    contextParts.push(s.value);
                }
            }

            // --- WIN/LOSS FILTER ---
            if (entities.modifiers.winLoss) {
                qb.addWinLossFilter(entities.modifiers.winLoss);
                contextParts.push(entities.modifiers.winLoss === 'split' ? 'wins vs losses' : 'in ' + entities.modifiers.winLoss);
            }

            // --- INNINGS FILTER ---
            if (entities.modifiers.innings) {
                qb.addInningsFilter(entities.modifiers.innings);
                contextParts.push(entities.modifiers.innings === 1 ? 'batting first' : 'chasing/defending');
            }

            // --- STAGE FILTER ---
            if (entities.modifiers.stage) {
                qb.addStageFilter(entities.modifiers.stage);
                contextParts.push(entities.modifiers.stage);
            }

            // --- TOTAL CONTEXT FILTER ---
            if (entities.modifiers.totalContext) {
                qb.addTotalContextFilter(entities.modifiers.totalContext.operator, entities.modifiers.totalContext.value);
                contextParts.push('total ' + entities.modifiers.totalContext.operator + ' ' + entities.modifiers.totalContext.value);
            }

            // --- BOWLER TYPE FILTER ---
            if (entities.bowlerTypes.length > 0) {
                qb.addBowlerTypeFilter(entities.bowlerTypes[0].styles);
                contextParts.push('vs ' + entities.bowlerTypes[0].keyword);
            }

            // --- Set aggregation template (if not already set by team/leaderboard) ---
            // Check if aggregation columns are already set (team/leaderboard paths set them).
            // Win/loss split may have added match_result to selects, but that is not an aggregation.
            const hasAggregation = qb.selects.some(s =>
                /\bAS\s+(?:innings|runs|balls|strike_rate|average|wickets|overs|economy|runs_conceded|matches)\b/i.test(s)
            );
            if (!hasAggregation) {
                // Single-player or multi-player query: use standard aggregation
                if (isBowling) {
                    qb.setBowlingAggregation();
                } else {
                    qb.setBattingAggregation();
                }
            }

            // --- Handle season-wise GROUP BY for SEASON_TREND intent ---
            if (intent === 'SEASON_TREND') {
                qb.addSeasonGroupBy();
                // Also add season to selects
                if (!qb.selects.some(s => s.includes('ipl.season'))) {
                    qb.selects.splice(1, 0, 'ipl.season');
                }
            }

            // --- METRIC-BASED ORDERING ---
            if (entities.metrics.length > 0) {
                const m = entities.metrics[0];
                const col = isBowling && m.bowling_col ? m.bowling_col : m.col;
                const dir = isBowling && m.bowling_dir ? m.bowling_dir : m.dir;
                qb.setOrderBy(`${col} ${dir}`);
            }

            // --- LIMIT ---
            qb.setLimit(entities.modifiers.limit);

            // --- Determine entity and type for return ---
            let entity = 'dynamic query';
            let type = 'dynamic';
            if (entities.players.length >= 1) {
                entity = entities.players[0].name;
                type = isBowling ? 'player_bowling' : 'player_lookup';
                if (entities.modifiers.winLoss === 'split') type = 'comparison';
            } else if (entities.teams.length >= 1) {
                entity = entities.teams[0].canonical;
                type = 'team_analysis';
            } else if (intent === 'LEADERBOARD') {
                entity = isBowling ? 'bowlers' : 'batters';
                type = 'leaderboard';
            }

            return {
                sql: qb.build(),
                type,
                entity,
                context: contextParts.join(' | ') || null
            };
        }

        // Expose for debugging
        window._nlQueryBuilder = QueryBuilder;
        window._nlBuildDynamicQuery = buildDynamicQuery;

        // ================================================================
        // SECTION 6: STAGE 4  QUERY ROUTER (naturalLanguageToSQL)
        // ================================================================

        /**
         * naturalLanguageToSQL(query)
         * The main NL-to-SQL engine. Uses the 5-stage pipeline:
         * 1. Entity Extraction
         * 2. Intent Classification
         * 3. View Coverage (fast path) or Dynamic SQL (QueryBuilder)
         * 4. SQL Generation
         * 5. Validation + Fallback
         *
         * Returns: { sql, type, entity, context } or null
         */
        function naturalLanguageToSQL(query) {
            const q = query.trim();
            if (!q) return null;
            const lower = q.toLowerCase();

            // --- Tier 4 fallback: If query looks like raw SQL, skip NL processing ---
            if (/^\s*(?:SELECT|WITH|INSERT|UPDATE|DELETE|CREATE|DROP|ALTER)\b/i.test(q)) {
                return null; // Let the SQL editor handle it
            }

            // --- Stage 1: Entity Extraction ---
            const entities = extractEntities(q);

            // --- Stage 2: Intent Classification ---
            const intent = classifyIntent(entities, q);

            // --- Helper: build WHERE clauses for view-based queries ---
            function buildViewSQL(viewName, meta, entities, intent) {
                const wheres = [];
                let orderBy = meta.orderDefault || 'player_name';
                const limit = entities.modifiers.limit;

                // Player filter
                if (entities.players.length >= 1 && meta.playerCol) {
                    const playerName = escapeSql(entities.players[0].name);
                    wheres.push(`${meta.playerCol} ILIKE '%${playerName}%'`);
                }

                // Second player (matchup bowler)
                if (entities.players.length >= 2 && meta.bowlerCol) {
                    const bowlerName = escapeSql(entities.players[1].name);
                    wheres.push(`${meta.bowlerCol} ILIKE '%${bowlerName}%'`);
                }

                // Team filter
                if (entities.teams.length >= 1 && meta.teamCol) {
                    const teamName = escapeSql(entities.teams[0].canonical);
                    wheres.push(`${meta.teamCol} ILIKE '%${teamName}%'`);
                }

                // Phase filter (skip if user wants full phase breakdown)
                if (entities.phases.length >= 1 && !entities.modifiers.breakdownByPhase) {
                    if (entities.phases.length === 1) {
                        wheres.push(`match_phase = '${escapeSql(entities.phases[0])}'`);
                    } else {
                        const phaseList = entities.phases.map(p => `'${escapeSql(p)}'`).join(', ');
                        wheres.push(`match_phase IN (${phaseList})`);
                    }
                }

                // Venue filter
                if (entities.venues.length >= 1) {
                    const venuePattern = escapeSql(entities.venues[0].pattern);
                    wheres.push(`venue ILIKE '%${venuePattern}%'`);
                }

                // Bowler type filter (for batter_vs_bowler_type views)
                if (entities.bowlerTypes.length >= 1 && meta.dims.includes('bowlerType')) {
                    // These views have a 'bowler_type' column with simple values
                    const btSimple = entities.bowlerTypes[0].simple;
                    if (btSimple) {
                        wheres.push(`bowler_type ILIKE '%${escapeSql(btSimple)}%'`);
                    }
                }

                // Pressure band filter
                if (intent === 'PRESSURE' && meta.dims.includes('pressure')) {
                    wheres.push(`pressure_band IN ('HIGH', 'EXTREME', 'NEAR_IMPOSSIBLE')`);
                }

                // Metric-based ordering
                if (entities.metrics.length > 0) {
                    const m = entities.metrics[0];
                    const isB = entities.role === 'bowling';
                    const col = isB && m.bowling_col ? m.bowling_col : m.col;
                    const dir = isB && m.bowling_dir ? m.bowling_dir : m.dir;
                    orderBy = `${col} ${dir}`;
                }

                const whereClause = wheres.length > 0 ? '\nWHERE ' + wheres.join('\n  AND ') : '';
                const limitClause = (intent === 'PLAYER_LOOKUP' || intent === 'MATCHUP' || intent === 'PLAYER_VS_TEAM' || intent === 'PLAYER_VS_TYPE') ? '' : `\nLIMIT ${limit}`;

                // For leaderboard queries without a specific player, add minimum sample filter
                let minFilter = '';
                if (intent === 'LEADERBOARD' && entities.players.length === 0) {
                    if (meta.role === 'batting' && meta.dims.includes('phase')) {
                        minFilter = wheres.length > 0 ? '\n  AND balls_faced >= 120' : '\nWHERE balls_faced >= 120';
                    } else if (meta.role === 'batting') {
                        minFilter = wheres.length > 0 ? '\n  AND innings >= 10' : '\nWHERE innings >= 10';
                    } else if (meta.role === 'bowling' && meta.dims.includes('phase')) {
                        minFilter = wheres.length > 0 ? '\n  AND balls_bowled >= 120' : '\nWHERE balls_bowled >= 120';
                    } else if (meta.role === 'bowling') {
                        minFilter = wheres.length > 0 ? '\n  AND matches_bowled >= 10' : '\nWHERE matches_bowled >= 10';
                    }
                }

                return `SELECT *\nFROM ${viewName}${whereClause}${minFilter}\nORDER BY ${orderBy}${limitClause};`;
            }

            // ==============================================
            // INTENT-SPECIFIC ROUTING
            // ==============================================

            // --- CONTRACTS ---
            if (intent === 'CONTRACTS') {
                const limit = entities.modifiers.limit;
                const isCheap = /\b(cheap|lowest|bargain|affordable)\b/.test(lower);
                let teamFound = entities.teams.length > 0 ? entities.teams[0].canonical : null;
                if (teamFound) {
                    return {
                        sql: `SELECT player_name, team_name, price_cr, acquisition_type, year_joined\nFROM ipl_2026_contracts\nWHERE team_name ILIKE '%${escapeSql(teamFound)}%'\nORDER BY price_cr ${isCheap ? 'ASC' : 'DESC'};`,
                        type: 'contracts',
                        entity: teamFound
                    };
                }
                return {
                    sql: `SELECT player_name, team_name, price_cr, acquisition_type, year_joined\nFROM ipl_2026_contracts\nORDER BY price_cr ${isCheap ? 'ASC' : 'DESC'}\nLIMIT ${limit};`,
                    type: 'contracts',
                    entity: isCheap ? 'cheapest players' : 'most expensive'
                };
            }

            // --- OVERSEAS ---
            if (intent === 'OVERSEAS') {
                let teamFound = entities.teams.length > 0 ? entities.teams[0].canonical : null;
                const teamClause = teamFound ? `\n  AND team_name ILIKE '%${escapeSql(teamFound)}%'` : '';
                return {
                    sql: `SELECT player_name, team_name, nationality, role, age\nFROM ipl_2026_squads\nWHERE nationality != 'IND'${teamClause}\nORDER BY team_name, player_name;`,
                    type: 'overseas',
                    entity: teamFound || 'all teams'
                };
            }

            // --- SQUAD ---
            if (intent === 'SQUAD') {
                let teamFound = entities.teams.length > 0 ? entities.teams[0].canonical : null;
                if (teamFound) {
                    // If user also wants stats (phase, batting/bowling role), show stats not roster
                    const wantsStats = entities.phases.length > 0 || entities.modifiers.breakdownByPhase || entities.role === 'batting' || entities.role === 'bowling';
                    if (wantsStats) {
                        const isBowling = entities.role === 'bowling';
                        if (entities.phases.length > 0 || entities.modifiers.breakdownByPhase) {
                            const view = isBowling ? 'analytics_ipl_squad_bowling_phase' : 'analytics_ipl_squad_batting_phase';
                            let phaseFilter = '';
                            if (!entities.modifiers.breakdownByPhase && entities.phases.length > 0) {
                                phaseFilter = entities.phases.length === 1
                                    ? `\n  AND match_phase = '${escapeSql(entities.phases[0])}'`
                                    : `\n  AND match_phase IN (${entities.phases.map(p => `'${escapeSql(p)}'`).join(', ')})`;
                            }
                            return {
                                sql: `SELECT *\nFROM ${view}\nWHERE team_name ILIKE '%${escapeSql(teamFound)}%'${phaseFilter}\nORDER BY ${isBowling ? 'match_phase, economy_rate ASC NULLS LAST' : 'match_phase, runs DESC NULLS LAST'};`,
                                type: 'squad_stats',
                                entity: teamFound,
                                context: (isBowling ? 'bowling' : 'batting') + (entities.phases[0] ? ' | ' + entities.phases[0] : ' | all phases')
                            };
                        }
                        // Just batting/bowling role without phase
                        const view = isBowling ? 'analytics_ipl_squad_bowling' : 'analytics_ipl_squad_batting';
                        return {
                            sql: `SELECT *\nFROM ${view}\nWHERE team_name ILIKE '%${escapeSql(teamFound)}%'\nORDER BY ${isBowling ? 'player_name' : 'ipl_runs DESC NULLS LAST'};`,
                            type: 'squad_stats',
                            entity: teamFound,
                            context: isBowling ? 'bowling' : 'batting'
                        };
                    }
                    // Pure roster query
                    return {
                        sql: `SELECT player_name, role, nationality, age, batting_hand, bowling_type\nFROM ipl_2026_squads\nWHERE team_name ILIKE '%${escapeSql(teamFound)}%'\nORDER BY role, player_name;`,
                        type: 'squad',
                        entity: teamFound
                    };
                }
                // No team specified -- fall through to exploratory
            }

            // --- PRESSURE ---
            if (intent === 'PRESSURE') {
                const isBowling = entities.role === 'bowling' || /\b(closer|economy|dot)\b/.test(lower);
                const limit = entities.modifiers.limit;
                const hasPlayer = entities.players.length >= 1;
                const playerName = hasPlayer ? escapeSql(entities.players[0].name) : null;
                const playerFilter = hasPlayer ? `\n  AND player_name ILIKE '%${playerName}%'` : '';
                const bowlerPlayerFilter = hasPlayer ? `\n  AND bowler_name ILIKE '%${playerName}%'` : '';
                const limitClause = hasPlayer ? '' : `\nLIMIT ${limit}`;
                const minBallsFilter = hasPlayer ? '' : '\n  AND legal_balls >= 15';
                const minFacedFilter = hasPlayer ? '' : '\n  AND balls_faced >= 15';

                if (/\b(dot.*seq|streak|consecutive)\b/.test(lower)) {
                    const view = isBowling ? 'analytics_ipl_pressure_dot_sequences_since2023' : 'analytics_ipl_pressure_boundary_sequences_since2023';
                    const pCol = isBowling ? 'bowler_name' : 'batter_name';
                    const pFilter = hasPlayer ? `\n  AND ${pCol} ILIKE '%${playerName}%'` : '';
                    const seqMin = hasPlayer ? '' : `\nWHERE total_${isBowling ? 'dots_in_sequences' : 'boundaries_in_sequences'} >= 3`;
                    const whereKw = seqMin ? '' : '\nWHERE 1=1';
                    return {
                        sql: `SELECT * FROM ${view}${seqMin || whereKw}${pFilter}\nORDER BY avg_${isBowling ? 'dot_seq' : 'boundary_seq'}_length DESC${limitClause};`,
                        type: 'pressure_sequences',
                        entity: hasPlayer ? entities.players[0].name : (isBowling ? 'dot sequences' : 'boundary sequences')
                    };
                }
                if (/\b(rating|delta|change)\b/.test(lower)) {
                    const ratingFilter = hasPlayer ? '' : "\n  AND pressure_rating IS NOT NULL";
                    return {
                        sql: `SELECT player_name, role, ROUND(overall_sr, 1) AS overall_sr, ROUND(pressure_sr, 1) AS pressure_sr, ROUND(sr_delta_pct, 1) AS delta_pct, pressure_rating, entry_context\nFROM analytics_ipl_pressure_deltas_since2023\nWHERE 1=1${ratingFilter}${playerFilter}\nORDER BY sr_delta_pct DESC${limitClause};`,
                        type: 'pressure_ratings',
                        entity: hasPlayer ? entities.players[0].name : 'pressure ratings'
                    };
                }
                if (isBowling) {
                    return {
                        sql: `SELECT player_name, pressure_band, legal_balls, ROUND(economy, 2) AS economy, ROUND(dot_ball_pct, 1) AS dot_pct, ROUND(boundary_conceded_pct, 1) AS bdry_pct, wickets\nFROM analytics_ipl_bowler_pressure_bands_since2023\nWHERE pressure_band IN ('HIGH', 'EXTREME', 'NEAR_IMPOSSIBLE')${minBallsFilter}${playerFilter}\nORDER BY economy ASC${limitClause};`,
                        type: 'pressure_bowling',
                        entity: hasPlayer ? entities.players[0].name : 'bowlers under pressure'
                    };
                }
                return {
                    sql: `SELECT player_name, pressure_band, balls_faced, ROUND(strike_rate, 1) AS strike_rate, ROUND(boundary_pct, 1) AS boundary_pct, ROUND(dot_ball_pct, 1) AS dot_pct, entry_context\nFROM analytics_ipl_batter_pressure_bands_since2023\nWHERE pressure_band IN ('HIGH', 'EXTREME', 'NEAR_IMPOSSIBLE')${minFacedFilter}${playerFilter}\nORDER BY strike_rate DESC${limitClause};`,
                    type: 'pressure_batting',
                    entity: hasPlayer ? entities.players[0].name : 'batters under pressure'
                };
            }

            // --- SEASON_TREND ---
            if (intent === 'SEASON_TREND') {
                // If context modifiers are present, route through QueryBuilder for full filter support
                if (entities.modifiers.winLoss || entities.modifiers.innings || entities.modifiers.stage || entities.modifiers.totalContext) {
                    return buildDynamicQuery(entities, intent);
                }
                let playerName = entities.players.length > 0 ? entities.players[0].name : entities.remainingTokens;
                if (!playerName || playerName.length < 2) return null;
                playerName = escapeSql(playerName);
                const isBowling = entities.role === 'bowling';
                if (isBowling) {
                    return {
                        sql: `WITH ipl AS (\n  SELECT dm.match_id, dm.season\n  FROM dim_match dm\n  JOIN dim_tournament dt ON dm.tournament_id = dt.tournament_id\n  WHERE dt.tournament_name = 'Indian Premier League'\n)\nSELECT dp.current_name AS player_name, ipl.season,\n  count(DISTINCT fb.match_id) AS matches,\n  round(sum(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) / 6.0, 1) AS overs,\n  sum(fb.total_runs) AS runs_conceded,\n  sum(CASE WHEN fb.is_wicket AND fb.wicket_type NOT IN ('run out','retired hurt','retired out') THEN 1 ELSE 0 END) AS wickets,\n  round(sum(fb.total_runs) * 6.0 / nullif(sum(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS economy,\n  round(sum(fb.total_runs) * 1.0 / nullif(sum(CASE WHEN fb.is_wicket AND fb.wicket_type NOT IN ('run out','retired hurt','retired out') THEN 1 ELSE 0 END), 0), 2) AS average\nFROM fact_ball fb\nJOIN dim_player dp ON fb.bowler_id = dp.player_id\nJOIN ipl ON fb.match_id = ipl.match_id\nWHERE dp.current_name ILIKE '%${playerName}%'\nGROUP BY dp.current_name, ipl.season\nORDER BY ipl.season;`,
                        type: 'player_season',
                        entity: playerName,
                        context: 'bowling'
                    };
                }
                return {
                    sql: `WITH ipl AS (\n  SELECT dm.match_id, dm.season\n  FROM dim_match dm\n  JOIN dim_tournament dt ON dm.tournament_id = dt.tournament_id\n  WHERE dt.tournament_name = 'Indian Premier League'\n)\nSELECT dp.current_name AS player_name, ipl.season,\n  count(DISTINCT fb.match_id) AS innings,\n  sum(fb.batter_runs) AS runs,\n  sum(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) AS balls,\n  round(sum(fb.batter_runs) * 100.0 / nullif(sum(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS strike_rate,\n  round(sum(fb.batter_runs) * 1.0 / nullif(sum(CASE WHEN fb.is_wicket AND fb.player_out_id = fb.batter_id THEN 1 ELSE 0 END), 0), 2) AS average,\n  sum(CASE WHEN fb.batter_runs = 4 THEN 1 ELSE 0 END) AS fours,\n  sum(CASE WHEN fb.batter_runs = 6 THEN 1 ELSE 0 END) AS sixes\nFROM fact_ball fb\nJOIN dim_player dp ON fb.batter_id = dp.player_id\nJOIN ipl ON fb.match_id = ipl.match_id\nWHERE dp.current_name ILIKE '%${playerName}%'\nGROUP BY dp.current_name, ipl.season\nORDER BY ipl.season;`,
                    type: 'player_season',
                    entity: playerName,
                    context: 'batting'
                };
            }

            // --- TEAM_ANALYSIS ---
            if (intent === 'TEAM_ANALYSIS' && entities.teams.length >= 1) {
                // If context modifiers are present, route through QueryBuilder for full filter support
                if (entities.modifiers.winLoss || entities.modifiers.innings || entities.modifiers.stage || entities.modifiers.totalContext) {
                    return buildDynamicQuery(entities, intent);
                }

                const teamName = entities.teams[0].canonical;
                const isBowling = entities.role === 'bowling';

                // Team + phase
                if (entities.phases.length > 0) {
                    const view = isBowling ? 'analytics_ipl_squad_bowling_phase' : 'analytics_ipl_squad_batting_phase';
                    const phaseFilter = entities.phases.length === 1
                        ? `\n  AND match_phase = '${escapeSql(entities.phases[0])}'`
                        : `\n  AND match_phase IN (${entities.phases.map(p => `'${escapeSql(p)}'`).join(', ')})`;
                    return {
                        sql: `SELECT * FROM ${view}\nWHERE team_name ILIKE '%${escapeSql(teamName)}%'${phaseFilter}\nORDER BY ${isBowling ? 'economy_rate ASC NULLS LAST' : 'runs DESC NULLS LAST'};`,
                        type: 'team_analysis',
                        entity: teamName,
                        context: isBowling ? 'bowling' : 'batting'
                    };
                }

                // Team batting/bowling (no phase)
                if (entities.role === 'bowling' || entities.role === 'batting') {
                    const view = isBowling ? 'analytics_ipl_squad_bowling' : 'analytics_ipl_squad_batting';
                    return {
                        sql: `SELECT * FROM ${view}\nWHERE team_name ILIKE '%${escapeSql(teamName)}%'\nORDER BY ${isBowling ? 'player_name' : 'ipl_runs DESC NULLS LAST'};`,
                        type: 'team_analysis',
                        entity: teamName,
                        context: isBowling ? 'bowling' : 'batting'
                    };
                }

                // Default: show squad
                return {
                    sql: `SELECT player_name, role, nationality, age, batting_hand, bowling_type\nFROM ipl_2026_squads\nWHERE team_name ILIKE '%${escapeSql(teamName)}%'\nORDER BY role, player_name;`,
                    type: 'squad',
                    entity: teamName
                };
            }

            // --- MATCHUP (player vs player) ---
            if (intent === 'MATCHUP' && entities.players.length >= 2) {
                // If context modifiers are present, route through QueryBuilder
                if (entities.modifiers.winLoss || entities.modifiers.innings || entities.modifiers.stage || entities.modifiers.totalContext) {
                    // For matchup with modifiers, build a dynamic batting query with both player filters
                    const qb = new QueryBuilder();
                    qb.addIPLFilter();
                    qb.joins.set('dim_player_batter', 'JOIN dim_player dp ON fb.batter_id = dp.player_id');
                    qb.joins.set('dim_player_bowler', 'JOIN dim_player dp_bowl ON fb.bowler_id = dp_bowl.player_id');
                    qb.wheres.push(`dp.current_name ILIKE '%${escapeSql(entities.players[0].name)}%'`);
                    qb.wheres.push(`dp_bowl.current_name ILIKE '%${escapeSql(entities.players[1].name)}%'`);
                    qb.groupBys.push('dp.current_name', 'dp_bowl.current_name');
                    if (entities.phases.length > 0) qb.addPhaseFilter(entities.phases);
                    if (entities.seasons.length > 0) qb.addSeasonFilter(entities.seasons);
                    if (entities.modifiers.winLoss) qb.addWinLossFilter(entities.modifiers.winLoss);
                    if (entities.modifiers.innings) qb.addInningsFilter(entities.modifiers.innings);
                    if (entities.modifiers.stage) qb.addStageFilter(entities.modifiers.stage);
                    if (entities.modifiers.totalContext) qb.addTotalContextFilter(entities.modifiers.totalContext.operator, entities.modifiers.totalContext.value);
                    // Set batting aggregation for matchup
                    qb.selects = [
                        'dp.current_name AS batter_name',
                        'dp_bowl.current_name AS bowler_name',
                        ...(qb.selects.filter(s => s.includes('match_result'))),
                        'SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) AS balls',
                        'SUM(fb.batter_runs) AS runs',
                        "SUM(CASE WHEN fb.is_wicket AND fb.player_out_id = fb.batter_id THEN 1 ELSE 0 END) AS dismissals",
                        "ROUND(SUM(fb.batter_runs) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS strike_rate",
                        "ROUND(SUM(CASE WHEN fb.batter_runs IN (4, 6) THEN 1 ELSE 0 END) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS boundary_pct",
                        "ROUND(SUM(CASE WHEN fb.batter_runs = 0 AND fb.is_legal_ball THEN 1 ELSE 0 END) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS dot_ball_pct",
                    ];
                    qb.setOrderBy('balls DESC');
                    qb.setLimit(entities.modifiers.limit);
                    return {
                        sql: qb.build(),
                        type: 'matchup',
                        entity: entities.players[0].name,
                        context: entities.players[1].name
                    };
                }

                const batter = escapeSql(entities.players[0].name);
                const bowler = escapeSql(entities.players[1].name);

                // Check for phase or breakdownByPhase
                if (entities.phases.length > 0 || entities.modifiers.breakdownByPhase) {
                    const scope = entities.seasons.length > 0 && entities.seasons[0].from && parseInt(entities.seasons[0].from) >= 2023 ? '_since2023' : '';
                    const viewName = `analytics_ipl_batter_vs_bowler_phase${scope}`;
                    let phaseFilter = '';
                    if (!entities.modifiers.breakdownByPhase && entities.phases.length > 0) {
                        phaseFilter = entities.phases.length === 1
                            ? `\n  AND match_phase = '${escapeSql(entities.phases[0])}'`
                            : `\n  AND match_phase IN (${entities.phases.map(p => `'${escapeSql(p)}'`).join(', ')})`;
                    }
                    return {
                        sql: `SELECT *\nFROM ${viewName}\nWHERE batter_name ILIKE '%${batter}%'\n  AND bowler_name ILIKE '%${bowler}%'${phaseFilter}\nORDER BY match_phase, balls DESC;`,
                        type: 'matchup',
                        entity: entities.players[0].name,
                        context: entities.players[1].name + (entities.modifiers.breakdownByPhase ? ' | by phase' : '')
                    };
                }

                return {
                    sql: `SELECT *\nFROM analytics_ipl_batter_vs_bowler\nWHERE batter_name ILIKE '%${batter}%'\n  AND bowler_name ILIKE '%${bowler}%'\nORDER BY balls DESC;`,
                    type: 'matchup',
                    entity: entities.players[0].name,
                    context: entities.players[1].name
                };
            }

            // --- PLAYER_VS_TEAM ---
            if (intent === 'PLAYER_VS_TEAM' && entities.players.length >= 1 && entities.teams.length >= 1) {
                // If context modifiers are present, route through QueryBuilder
                if (entities.modifiers.winLoss || entities.modifiers.innings || entities.modifiers.stage || entities.modifiers.totalContext) {
                    return buildDynamicQuery(entities, intent);
                }

                const playerName = escapeSql(entities.players[0].name);
                const teamName = escapeSql(entities.teams[0].canonical);
                const isBowling = entities.role === 'bowling';

                if (entities.phases.length > 0 || entities.modifiers.breakdownByPhase) {
                    const viewName = isBowling ? 'analytics_ipl_bowler_vs_team_phase' : 'analytics_ipl_batter_vs_team_phase';
                    const pCol = isBowling ? 'bowler_name' : 'batter_name';
                    let phaseFilter = '';
                    if (!entities.modifiers.breakdownByPhase && entities.phases.length > 0) {
                        phaseFilter = entities.phases.length === 1
                            ? `\n  AND match_phase = '${escapeSql(entities.phases[0])}'`
                            : `\n  AND match_phase IN (${entities.phases.map(p => `'${escapeSql(p)}'`).join(', ')})`;
                    }
                    return {
                        sql: `SELECT *\nFROM ${viewName}\nWHERE ${pCol} ILIKE '%${playerName}%'\n  AND opposition ILIKE '%${teamName}%'${phaseFilter}\nORDER BY match_phase, ${isBowling ? 'wickets DESC' : 'runs DESC'};`,
                        type: 'player_vs_team',
                        entity: entities.players[0].name,
                        context: entities.teams[0].canonical + (entities.modifiers.breakdownByPhase ? ' | by phase' : '')
                    };
                }

                const viewName = isBowling ? 'analytics_ipl_bowler_vs_team' : 'analytics_ipl_batter_vs_team';
                const pCol = isBowling ? 'bowler_name' : 'batter_name';
                return {
                    sql: `SELECT *\nFROM ${viewName}\nWHERE ${pCol} ILIKE '%${playerName}%'\n  AND opposition ILIKE '%${teamName}%'\nORDER BY ${isBowling ? 'wickets DESC' : 'runs DESC'};`,
                    type: 'player_vs_team',
                    entity: entities.players[0].name,
                    context: entities.teams[0].canonical
                };
            }

            // --- PLAYER_VS_TYPE ---
            if (intent === 'PLAYER_VS_TYPE' && entities.players.length >= 1) {
                // If context modifiers are present, route through QueryBuilder
                if (entities.modifiers.winLoss || entities.modifiers.innings || entities.modifiers.stage || entities.modifiers.totalContext) {
                    return buildDynamicQuery(entities, intent);
                }

                const playerName = escapeSql(entities.players[0].name);

                if (entities.phases.length > 0) {
                    return {
                        sql: `SELECT *\nFROM analytics_ipl_batter_vs_bowler_type_phase\nWHERE batter_name ILIKE '%${playerName}%'\n  AND match_phase = '${escapeSql(entities.phases[0])}'\nORDER BY balls DESC;`,
                        type: 'player_vs_type',
                        entity: entities.players[0].name,
                        context: entities.bowlerTypes[0].keyword
                    };
                }

                return {
                    sql: `SELECT *\nFROM analytics_ipl_batter_vs_bowler_type\nWHERE batter_name ILIKE '%${playerName}%'\nORDER BY balls DESC;`,
                    type: 'player_vs_type',
                    entity: entities.players[0].name,
                    context: entities.bowlerTypes[0].keyword
                };
            }

            // --- LEADERBOARD ---
            if (intent === 'LEADERBOARD') {
                // If context modifiers OR venue present, route through QueryBuilder for full filter support
                if (entities.modifiers.winLoss || entities.modifiers.innings || entities.modifiers.stage || entities.modifiers.totalContext || entities.venues.length > 0) {
                    return buildDynamicQuery(entities, intent);
                }

                const limit = entities.modifiers.limit;
                const isBowling = entities.role === 'bowling' || /\b(bowl(?:ers?|ing)?|wicket.?takers?|wickets?|economy|econ|dot.?ball)\b/.test(lower);

                // Phase leaderboard
                if (entities.phases.length > 0) {
                    if (isBowling) {
                        let orderBy = 'wickets DESC';
                        if (entities.metrics.length > 0) {
                            const m = entities.metrics[0];
                            orderBy = `${m.bowling_col || m.col} ${m.bowling_dir || m.dir}`;
                        } else if (/economy|econ/.test(lower)) {
                            orderBy = 'economy_rate ASC';
                        } else if (/dot.?ball/.test(lower)) {
                            orderBy = 'dot_ball_pct DESC';
                        }
                        const phaseFilter = `match_phase = '${escapeSql(entities.phases[0])}'`;
                        return {
                            sql: `SELECT player_name, match_phase, matches, balls_bowled, overs, runs_conceded, wickets, economy_rate, dot_ball_pct\nFROM analytics_ipl_bowler_phase\nWHERE ${phaseFilter}\n  AND balls_bowled >= 120\nORDER BY ${orderBy}\nLIMIT ${limit};`,
                            type: 'phase_leaderboard',
                            entity: entities.phases[0] + ' bowlers',
                            context: 'bowling'
                        };
                    } else {
                        let orderBy = 'strike_rate DESC';
                        if (entities.metrics.length > 0) {
                            const m = entities.metrics[0];
                            orderBy = `${m.col} ${m.dir}`;
                        } else if (/average|avg/.test(lower)) {
                            orderBy = 'batting_average DESC';
                        } else if (/boundary/.test(lower)) {
                            orderBy = 'boundary_pct DESC';
                        }
                        const phaseFilter = `match_phase = '${escapeSql(entities.phases[0])}'`;
                        return {
                            sql: `SELECT player_name, match_phase, innings, runs, balls_faced, strike_rate, batting_average, boundary_pct\nFROM analytics_ipl_batter_phase\nWHERE ${phaseFilter}\n  AND balls_faced >= 120\nORDER BY ${orderBy}\nLIMIT ${limit};`,
                            type: 'phase_leaderboard',
                            entity: entities.phases[0] + ' batters',
                            context: 'batting'
                        };
                    }
                }

                // Career leaderboard
                if (isBowling) {
                    let orderBy = 'wickets DESC';
                    if (/economy|econ\b/.test(lower)) orderBy = 'economy_rate ASC';
                    else if (/dot.?ball/.test(lower)) orderBy = 'dot_ball_pct DESC';
                    else if (/\baverage\b/.test(lower)) orderBy = 'bowling_average ASC';
                    else if (/strike.?rate|sr\b/.test(lower)) orderBy = 'bowling_strike_rate ASC';
                    const minFilter = /economy|econ|dot.?ball|average|strike.?rate|sr/.test(lower) ? '\n  AND balls_bowled >= 500' : '';
                    return {
                        sql: `SELECT player_name, primary_role, matches_bowled, overs_bowled, wickets, economy_rate, bowling_average, bowling_strike_rate, dot_ball_pct, best_wickets, best_runs\nFROM analytics_ipl_bowling_career\nWHERE matches_bowled >= 10${minFilter}\nORDER BY ${orderBy}\nLIMIT ${limit};`,
                        type: 'leaderboard',
                        entity: 'bowlers',
                        context: orderBy.split(' ')[0]
                    };
                }

                // Batting leaderboard
                let orderBy = 'runs DESC';
                if (/strike.?rate|sr\b/.test(lower)) orderBy = 'strike_rate DESC';
                else if (/\baverage\b/.test(lower)) orderBy = 'batting_average DESC';
                else if (/\b(centuries|hundreds|100s)\b/.test(lower)) orderBy = 'hundreds DESC';
                else if (/\b(fifties|50s)\b/.test(lower)) orderBy = 'fifties DESC';
                else if (/\bsixes\b/.test(lower)) orderBy = 'sixes DESC';
                else if (/\bfours\b/.test(lower)) orderBy = 'fours DESC';
                else if (/\b(boundaries)\b/.test(lower)) orderBy = 'boundary_pct DESC';
                const minFilter = /strike.?rate|sr|average/.test(lower) ? '\n  AND balls_faced >= 500' : '';
                return {
                    sql: `SELECT player_name, primary_role, innings, runs, balls_faced, strike_rate, batting_average, boundary_pct, fifties, hundreds, sixes\nFROM analytics_ipl_batting_career\nWHERE innings >= 10${minFilter}\nORDER BY ${orderBy}\nLIMIT ${limit};`,
                    type: 'leaderboard',
                    entity: 'batters',
                    context: orderBy.split(' ')[0]
                };
            }

            // --- PLAYER_LOOKUP (single player, possibly with dimensions) ---
            if (intent === 'PLAYER_LOOKUP' && entities.players.length >= 1) {
                const playerName = entities.players[0].name;

                // Check for context modifiers that require dynamic SQL (Phase 2 QueryBuilder)
                if (entities.modifiers.winLoss || entities.modifiers.innings || entities.modifiers.stage || entities.modifiers.totalContext) {
                    return buildDynamicQuery(entities, intent);
                }

                // Try view-based routing
                const bestView = findBestView(entities, intent);
                if (bestView) {
                    const sql = buildViewSQL(bestView.viewName, bestView.viewMeta, entities, intent);
                    // Determine type from view
                    let type = 'player_lookup';
                    if (bestView.viewMeta.dims.includes('venue')) type = 'player_venue';
                    if (bestView.viewMeta.dims.includes('phase')) type = 'phase';
                    if (bestView.viewMeta.role === 'bowling') type = 'player_bowling';
                    return {
                        sql,
                        type,
                        entity: playerName,
                        context: entities.phases[0] || entities.venues[0]?.pattern || null
                    };
                }

                // Fallback: direct career lookup
                const isBowling = entities.role === 'bowling';
                if (isBowling) {
                    return {
                        sql: `SELECT player_name, primary_role, matches_bowled, overs_bowled, wickets, economy_rate, bowling_average, bowling_strike_rate, dot_ball_pct\nFROM analytics_ipl_bowling_career\nWHERE player_name ILIKE '%${escapeSql(playerName)}%';`,
                        type: 'player_bowling',
                        entity: playerName
                    };
                }
                return {
                    sql: `SELECT player_name, primary_role, innings, runs, balls_faced, strike_rate, batting_average, boundary_pct, fifties, hundreds, sixes\nFROM analytics_ipl_batting_career\nWHERE player_name ILIKE '%${escapeSql(playerName)}%';`,
                    type: 'player_lookup',
                    entity: playerName
                };
            }

            // --- TEAM_COMPARISON ---
            if (intent === 'TEAM_COMPARISON' && entities.teams.length >= 2) {
                const t1 = entities.teams[0].canonical;
                const t2 = entities.teams[1].canonical;
                const isBowling = entities.role === 'bowling';
                const hasModifiers = entities.modifiers.winLoss || entities.modifiers.innings || entities.modifiers.stage || entities.modifiers.totalContext;

                // Use QueryBuilder for comparisons with modifiers or phase/season filters
                if (hasModifiers || entities.phases.length > 0 || entities.seasons.length > 0) {
                    const qb = new QueryBuilder();
                    qb.addIPLFilter();
                    const teamCol = isBowling ? 'fb.bowling_team_id' : 'fb.batting_team_id';
                    const joinAlias = isBowling ? 'dt_bowl' : 'dt_bat';
                    const faAlias = isBowling ? 'fa_bowl' : 'fa_bat';
                    qb.joins.set('dim_team_comp', `JOIN dim_team ${joinAlias} ON ${teamCol} = ${joinAlias}.team_id`);
                    qb.joins.set('dim_franchise_comp', `LEFT JOIN dim_franchise_alias ${faAlias} ON ${joinAlias}.team_name = ${faAlias}.team_name`);
                    qb.wheres.push(`COALESCE(${faAlias}.canonical_name, ${joinAlias}.team_name) IN ('${escapeSql(t1)}', '${escapeSql(t2)}')`);
                    const teamExpr = `COALESCE(${faAlias}.canonical_name, ${joinAlias}.team_name)`;
                    qb.groupBys.push(teamExpr);

                    if (entities.phases.length > 0) qb.addPhaseFilter(entities.phases);
                    if (entities.seasons.length > 0) qb.addSeasonFilter(entities.seasons);
                    if (entities.modifiers.winLoss) qb.addWinLossFilter(entities.modifiers.winLoss);
                    if (entities.modifiers.innings) qb.addInningsFilter(entities.modifiers.innings);
                    if (entities.modifiers.stage) qb.addStageFilter(entities.modifiers.stage);
                    if (entities.modifiers.totalContext) qb.addTotalContextFilter(entities.modifiers.totalContext.operator, entities.modifiers.totalContext.value);

                    if (isBowling) {
                        qb.selects = [
                            `${teamExpr} AS team_name`,
                            ...qb.selects.filter(s => s.includes('match_result')),
                            'COUNT(DISTINCT fb.match_id) AS matches',
                            "ROUND(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) / 6.0, 1) AS overs",
                            "SUM(fb.total_runs) AS runs_conceded",
                            "SUM(CASE WHEN fb.is_wicket AND fb.wicket_type NOT IN ('run out', 'retired hurt', 'retired out') THEN 1 ELSE 0 END) AS wickets",
                            "ROUND(SUM(fb.total_runs) * 6.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS economy",
                            "ROUND(SUM(CASE WHEN fb.batter_runs = 0 AND fb.extra_runs = 0 AND fb.is_legal_ball THEN 1 ELSE 0 END) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS dot_ball_pct",
                        ];
                        qb.setOrderBy('economy ASC');
                    } else {
                        qb.selects = [
                            `${teamExpr} AS team_name`,
                            ...qb.selects.filter(s => s.includes('match_result')),
                            'COUNT(DISTINCT fb.match_id) AS matches',
                            'SUM(fb.batter_runs) AS runs',
                            'SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) AS balls',
                            "ROUND(SUM(fb.batter_runs) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS strike_rate",
                            "ROUND(SUM(CASE WHEN fb.batter_runs IN (4, 6) THEN 1 ELSE 0 END) * 100.0 / NULLIF(SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS boundary_pct",
                        ];
                        qb.setOrderBy('runs DESC');
                    }
                    qb.setLimit(entities.modifiers.limit);
                    return {
                        sql: qb.build(),
                        type: 'team_comparison',
                        entity: t1,
                        context: t2
                    };
                }

                // Simple comparison without modifiers: use existing squad views
                const view = isBowling ? 'analytics_ipl_squad_bowling' : 'analytics_ipl_squad_batting';
                const orderCol = isBowling ? 'player_name' : 'ipl_runs DESC NULLS LAST';
                return {
                    sql: `-- Team comparison: ${t1} vs ${t2}\nSELECT * FROM ${view}\nWHERE team_name ILIKE '%${escapeSql(t1)}%'\n   OR team_name ILIKE '%${escapeSql(t2)}%'\nORDER BY team_name, ${orderCol};`,
                    type: 'team_comparison',
                    entity: t1,
                    context: t2
                };
            }

            // --- EXPLORATORY / FALLBACK ---
            // Last resort: if we have any remaining text, try it as a player name
            if (entities.remainingTokens.length >= 2) {
                const guess = entities.remainingTokens;
                if (isTeamToken(guess)) {
                    const teamName = resolveTeamName(guess);
                    if (entities.role === 'bowling') {
                        return {
                            sql: `SELECT * FROM analytics_ipl_squad_bowling\nWHERE team_name ILIKE '%${escapeSql(teamName)}%'\nORDER BY player_name;`,
                            type: 'team_analysis',
                            entity: teamName,
                            context: 'bowling'
                        };
                    }
                    if (entities.role === 'batting') {
                        return {
                            sql: `SELECT * FROM analytics_ipl_squad_batting\nWHERE team_name ILIKE '%${escapeSql(teamName)}%'\nORDER BY ipl_runs DESC NULLS LAST;`,
                            type: 'team_analysis',
                            entity: teamName,
                            context: 'batting'
                        };
                    }
                    return {
                        sql: `SELECT player_name, role, nationality, age, batting_hand, bowling_type\nFROM ipl_2026_squads\nWHERE team_name ILIKE '%${escapeSql(teamName)}%'\nORDER BY role, player_name;`,
                        type: 'squad',
                        entity: teamName
                    };
                }

                // Try as player name
                const isBowling = entities.role === 'bowling';
                if (isBowling) {
                    return {
                        sql: `SELECT player_name, primary_role, matches_bowled, overs_bowled, wickets, economy_rate, bowling_average, bowling_strike_rate, dot_ball_pct\nFROM analytics_ipl_bowling_career\nWHERE player_name ILIKE '%${escapeSql(guess)}%';`,
                        type: 'player_bowling',
                        entity: guess
                    };
                }
                return {
                    sql: `SELECT player_name, primary_role, innings, runs, balls_faced, strike_rate, batting_average, boundary_pct, fifties, hundreds, sixes\nFROM analytics_ipl_batting_career\nWHERE player_name ILIKE '%${escapeSql(guess)}%';`,
                    type: 'player_lookup',
                    entity: guess
                };
            }

            // --- SMART PARTIAL EXECUTION ---
            // If entities were extracted but no intent matched perfectly, attempt best-effort query
            const hasEntities = entities.players.length > 0 || entities.teams.length > 0 ||
                                entities.phases.length > 0 || entities.venues.length > 0;
            if (hasEntities) {
                return buildPartialQuery(entities, intent);
            }

            return null;
        }

        /**
         * buildPartialQuery(entities, intent)
         * Generates a best-effort query when intent routing didn't find a perfect match.
         * Uses whatever entities were extracted to build a useful query.
         * Annotates what was understood vs what was missed.
         */
        function buildPartialQuery(entities, intent) {
            const isBowling = entities.role === 'bowling';
            const contextParts = [];
            const missedParts = [];

            // Priority: player > team > venue > phase
            if (entities.players.length >= 1) {
                const playerName = entities.players[0].name;

                // Check for context modifiers (defer to dynamic builder)
                if (entities.modifiers.winLoss || entities.modifiers.innings || entities.modifiers.stage || entities.modifiers.totalContext) {
                    return buildDynamicQuery(entities, intent || 'PLAYER_LOOKUP');
                }

                // Try view-based routing with relaxed matching
                const bestView = findBestView(entities, 'PLAYER_LOOKUP');
                if (bestView) {
                    const sql = buildViewSQL(bestView.viewName, bestView.viewMeta, entities, 'PLAYER_LOOKUP');
                    return {
                        sql,
                        type: 'player_lookup',
                        entity: playerName,
                        context: 'partial match',
                        partial: true
                    };
                }

                // Fallback: career lookup with available filters
                if (isBowling) {
                    return {
                        sql: `SELECT player_name, primary_role, matches_bowled, overs_bowled, wickets, economy_rate, bowling_average, bowling_strike_rate, dot_ball_pct\nFROM analytics_ipl_bowling_career\nWHERE player_name ILIKE '%${escapeSql(playerName)}%';`,
                        type: 'player_bowling',
                        entity: playerName,
                        context: 'partial match',
                        partial: true
                    };
                }
                return {
                    sql: `SELECT player_name, primary_role, innings, runs, balls_faced, strike_rate, batting_average, boundary_pct, fifties, hundreds, sixes\nFROM analytics_ipl_batting_career\nWHERE player_name ILIKE '%${escapeSql(playerName)}%';`,
                    type: 'player_lookup',
                    entity: playerName,
                    context: 'partial match',
                    partial: true
                };
            }

            if (entities.teams.length >= 1) {
                const teamName = entities.teams[0].canonical;
                const view = isBowling ? 'analytics_ipl_squad_bowling' : 'analytics_ipl_squad_batting';
                const orderCol = isBowling ? 'player_name' : 'ipl_runs DESC NULLS LAST';
                let phaseFilter = '';
                if (entities.phases.length > 0) {
                    const phaseView = isBowling ? 'analytics_ipl_squad_bowling_phase' : 'analytics_ipl_squad_batting_phase';
                    phaseFilter = `\n  AND match_phase = '${escapeSql(entities.phases[0])}'`;
                    return {
                        sql: `SELECT * FROM ${phaseView}\nWHERE team_name ILIKE '%${escapeSql(teamName)}%'${phaseFilter}\nORDER BY ${isBowling ? 'economy_rate ASC NULLS LAST' : 'runs DESC NULLS LAST'};`,
                        type: 'team_analysis',
                        entity: teamName,
                        context: 'partial match',
                        partial: true
                    };
                }
                return {
                    sql: `SELECT * FROM ${view}\nWHERE team_name ILIKE '%${escapeSql(teamName)}%'\nORDER BY ${orderCol};`,
                    type: 'team_analysis',
                    entity: teamName,
                    context: 'partial match',
                    partial: true
                };
            }

            // Phase-only or venue-only: show leaderboard
            if (entities.phases.length > 0) {
                const phase = entities.phases[0];
                if (isBowling) {
                    return {
                        sql: `SELECT player_name, match_phase, matches, balls_bowled, overs, runs_conceded, wickets, economy_rate, dot_ball_pct\nFROM analytics_ipl_bowler_phase\nWHERE match_phase = '${escapeSql(phase)}'\n  AND balls_bowled >= 120\nORDER BY wickets DESC\nLIMIT 20;`,
                        type: 'phase_leaderboard',
                        entity: phase + ' bowlers',
                        context: 'partial match',
                        partial: true
                    };
                }
                return {
                    sql: `SELECT player_name, match_phase, innings, runs, balls_faced, strike_rate, batting_average, boundary_pct\nFROM analytics_ipl_batter_phase\nWHERE match_phase = '${escapeSql(phase)}'\n  AND balls_faced >= 120\nORDER BY strike_rate DESC\nLIMIT 20;`,
                    type: 'phase_leaderboard',
                    entity: phase + ' batters',
                    context: 'partial match',
                    partial: true
                };
            }

            return null;
        }

        // Make it globally accessible
        window.naturalLanguageToSQL = naturalLanguageToSQL;
        // Also expose entity extraction and intent for debugging / Phase 2
        window._nlExtractEntities = extractEntities;
        window._nlClassifyIntent = classifyIntent;
        window._nlFindBestView = findBestView;

        /* ==================== "THE FIRST TAKE" INSIGHT GENERATOR (TKT-177) ==================== */
        let lastNLQueryType = null;
        let lastNLEntity = null;
        let lastNLContext = null;
        let lastNLEntities = null;
        let lastNLIntent = null;
        let lastNLViewName = null;
        let isCurrentNLQuery = false;

        function generateFirstTakeInsight(columns, rows, queryType, entity, context) {
            if (!rows || rows.length === 0) {
                return `<p style="font-size:13px;color:var(--text-secondary);line-height:1.6;">
                    No results to analyse here. That is unusual \u2014 let us check if the query or spelling needs adjusting.
                    Try a broader search or check the schema browser for available views.
                </p>`;
            }

            const firstRow = rows[0];
            const totalRows = rows.length;

            function fmt(n) {
                if (n === null || n === undefined) return 'N/A';
                if (typeof n === 'number') return n % 1 === 0 ? n.toLocaleString() : n.toFixed(2);
                return String(n);
            }

            function colAvg(colName) {
                const vals = rows.map(r => r[colName]).filter(v => v !== null && v !== undefined && typeof v === 'number');
                if (vals.length === 0) return null;
                return vals.reduce((a, b) => a + b, 0) / vals.length;
            }

            function pctAboveAvg(val, avg) {
                if (!avg || avg === 0) return null;
                return (((val - avg) / avg) * 100).toFixed(1);
            }

            let insight = '';

            switch (queryType) {
                case 'leaderboard': {
                    const name = firstRow.player_name || firstRow.batter_name || 'The leader';
                    if (context === 'runs' || context === 'wickets') {
                        const statVal = firstRow[context] || firstRow.runs || firstRow.wickets;
                        const avg = colAvg(context) || colAvg('runs') || colAvg('wickets');
                        const pct = pctAboveAvg(statVal, avg);
                        insight = `Right, let us talk about this leaderboard. <strong>${escapeHtml(name)}</strong> sits at the top with <strong>${fmt(statVal)} ${context}</strong>.`;
                        if (pct && parseFloat(pct) > 0) {
                            insight += ` That is <strong>${pct}%</strong> above the group average in this sample.`;
                        }
                        insight += ` When you are scouting, this is your benchmark \u2014 everyone else is chasing this standard.`;
                        if (totalRows >= 3) {
                            const third = rows[2];
                            insight += ` Keep an eye on <strong>${escapeHtml(third.player_name || third.batter_name || 'the third name')}</strong> in third \u2014 that is often where the real value sits in squad building.`;
                        }
                    } else {
                        const keyStat = context || 'strike_rate';
                        const val = firstRow[keyStat];
                        insight = `Looking at this data, <strong>${escapeHtml(name)}</strong> leads with a ${keyStat.replace(/_/g, ' ')} of <strong>${fmt(val)}</strong>.`;
                        insight += ` This is a ${totalRows}-deep leaderboard \u2014 important to look beyond the headline number and consider sample size before drawing conclusions.`;
                    }
                    break;
                }
                case 'player_lookup':
                case 'player_bowling': {
                    const name = firstRow.player_name || firstRow.batter_name || entity;
                    if (firstRow.innings !== undefined) {
                        insight = `Here is the career dossier on <strong>${escapeHtml(name)}</strong>: <strong>${fmt(firstRow.innings)}</strong> innings`;
                        if (firstRow.runs !== undefined) insight += `, <strong>${fmt(firstRow.runs)}</strong> runs`;
                        if (firstRow.batting_average !== undefined) insight += ` at an average of <strong>${fmt(firstRow.batting_average)}</strong>`;
                        if (firstRow.strike_rate !== undefined) insight += ` and a strike rate of <strong>${fmt(firstRow.strike_rate)}</strong>`;
                        insight += '.';
                        if (firstRow.strike_rate && firstRow.strike_rate > 140) {
                            insight += ` That strike rate is in the impact zone \u2014 this is someone who shifts momentum.`;
                        } else if (firstRow.batting_average && firstRow.batting_average > 35) {
                            insight += ` Averaging above 35 in T20 cricket \u2014 that is rare consistency under pressure.`;
                        }
                    } else if (firstRow.wickets !== undefined) {
                        insight = `The bowling profile for <strong>${escapeHtml(name)}</strong>: <strong>${fmt(firstRow.wickets)}</strong> wickets`;
                        if (firstRow.economy_rate !== undefined) insight += ` at an economy of <strong>${fmt(firstRow.economy_rate)}</strong>`;
                        if (firstRow.bowling_average !== undefined) insight += `, average <strong>${fmt(firstRow.bowling_average)}</strong>`;
                        if (firstRow.bowling_strike_rate !== undefined) insight += `, strike rate <strong>${fmt(firstRow.bowling_strike_rate)}</strong>`;
                        insight += '.';
                        if (firstRow.economy_rate && firstRow.economy_rate < 7.5) {
                            insight += ` An economy under 7.5 in T20s is elite \u2014 this bowler controls scoring pressure.`;
                        }
                    } else {
                        insight = `Data loaded for <strong>${escapeHtml(name)}</strong>. ${totalRows} record${totalRows > 1 ? 's' : ''} found.`;
                    }
                    break;
                }
                case 'squad': {
                    const teamName = entity || 'This squad';
                    const overseas = rows.filter(r => r.nationality && r.nationality !== 'IND').length;
                    const indian = totalRows - overseas;
                    insight = `<strong>${escapeHtml(teamName)}</strong> has <strong>${totalRows}</strong> players in the squad`;
                    insight += ` \u2014 <strong>${overseas}</strong> overseas slots used.`;
                    if (overseas > 0) {
                        const overseasNames = rows.filter(r => r.nationality && r.nationality !== 'IND').slice(0, 4).map(r => r.player_name);
                        insight += ` Key overseas contingent: ${overseasNames.map(n => '<strong>' + escapeHtml(n) + '</strong>').join(', ')}.`;
                    }
                    insight += ` That is ${indian} Indian players forming the core \u2014 crucial for building the middle overs structure.`;
                    break;
                }
                case 'team_analysis': {
                    const teamName = entity || 'This team';
                    const side = context || 'batting';
                    insight = `<strong>${escapeHtml(teamName)}</strong> ${side} analysis across <strong>${totalRows}</strong> squad members.`;
                    if (side === 'batting' && firstRow.ipl_runs !== undefined) {
                        const topScorer = rows.reduce((a, b) => ((b.ipl_runs || 0) > (a.ipl_runs || 0) ? b : a), rows[0]);
                        insight += ` The anchor is <strong>${escapeHtml(topScorer.player_name)}</strong> with <strong>${fmt(topScorer.ipl_runs)}</strong> IPL runs.`;
                        const uncapped = rows.filter(r => !r.ipl_innings || r.ipl_innings === 0).length;
                        if (uncapped > 0) insight += ` ${uncapped} player${uncapped > 1 ? 's are' : ' is'} uncapped at IPL level \u2014 development opportunities there.`;
                    }
                    break;
                }
                case 'contracts': {
                    const topPlayer = firstRow.player_name || 'Top pick';
                    insight = `Looking at the money \u2014 <strong>${escapeHtml(topPlayer)}</strong> at <strong>${fmt(firstRow.price_cr)} Cr</strong>`;
                    if (firstRow.team_name) insight += ` for ${escapeHtml(firstRow.team_name)}`;
                    insight += '.';
                    if (totalRows >= 5) {
                        const totalSpend = rows.reduce((s, r) => s + (r.price_cr || 0), 0);
                        insight += ` Top ${totalRows} contracts total <strong>${fmt(totalSpend)} Cr</strong>.`;
                    }
                    insight += ` Always compare contract value against actual output \u2014 that is where you find market inefficiencies.`;
                    break;
                }
                case 'player_vs_team': {
                    const name = firstRow.player_name || entity;
                    insight = `<strong>${escapeHtml(name)}</strong> vs <strong>${escapeHtml(context || 'opposition')}</strong>: `;
                    if (firstRow.runs !== undefined) insight += `<strong>${fmt(firstRow.runs)}</strong> runs`;
                    if (firstRow.balls_faced !== undefined) insight += ` off <strong>${fmt(firstRow.balls_faced)}</strong> balls`;
                    if (firstRow.strike_rate !== undefined) insight += ` (SR: <strong>${fmt(firstRow.strike_rate)}</strong>)`;
                    insight += '. ';
                    insight += `Matchup data like this is gold in pre-tournament preparation \u2014 it tells you where to target or protect.`;
                    break;
                }
                case 'matchup': {
                    const batter = firstRow.batter_name || entity;
                    const bowler = firstRow.bowler_name || context;
                    insight = `Head-to-head: <strong>${escapeHtml(batter)}</strong> vs <strong>${escapeHtml(bowler)}</strong> \u2014 `;
                    if (firstRow.balls !== undefined) insight += `<strong>${fmt(firstRow.balls)}</strong> balls faced, `;
                    if (firstRow.runs !== undefined) insight += `<strong>${fmt(firstRow.runs)}</strong> runs, `;
                    if (firstRow.dismissals !== undefined) insight += `<strong>${fmt(firstRow.dismissals)}</strong> dismissals`;
                    if (firstRow.strike_rate !== undefined) insight += ` (SR: <strong>${fmt(firstRow.strike_rate)}</strong>)`;
                    insight += '. ';
                    if (firstRow.balls && firstRow.balls < 12) {
                        insight += `Small sample though \u2014 need at least 12 deliveries to read anything meaningful into this.`;
                    } else {
                        insight += `This is actionable intelligence for field placement and bowling changes.`;
                    }
                    break;
                }
                case 'player_vs_type': {
                    const name = firstRow.batter_name || entity;
                    insight = `<strong>${escapeHtml(name)}</strong> breakdown by bowler type:`;
                    for (const row of rows.slice(0, 4)) {
                        if (row.bowler_type) {
                            insight += ` vs ${escapeHtml(row.bowler_type)}: SR <strong>${fmt(row.strike_rate)}</strong> (${fmt(row.balls)} balls);`;
                        }
                    }
                    insight += ` This split is essential for planning bowling rotations \u2014 expose the weakness, protect against the strength.`;
                    break;
                }
                case 'phase_leaderboard':
                case 'phase': {
                    const phase = context || entity || 'this phase';
                    const name = firstRow.player_name || 'The leader';
                    insight = `Phase breakdown for <strong>${escapeHtml(String(phase))}</strong>: <strong>${escapeHtml(name)}</strong> leads.`;
                    if (firstRow.strike_rate !== undefined) insight += ` Strike rate: <strong>${fmt(firstRow.strike_rate)}</strong>.`;
                    if (firstRow.economy_rate !== undefined) insight += ` Economy: <strong>${fmt(firstRow.economy_rate)}</strong>.`;
                    if (firstRow.wickets !== undefined) insight += ` Wickets: <strong>${fmt(firstRow.wickets)}</strong>.`;
                    insight += ` Phase-specific data separates genuine match-winners from flat-track performers. Context is everything in T20 cricket.`;
                    break;
                }
                case 'overseas': {
                    insight = `<strong>${totalRows}</strong> overseas players across ${escapeHtml(entity || 'the squads')}.`;
                    const nationalities = {};
                    rows.forEach(r => { if (r.nationality) nationalities[r.nationality] = (nationalities[r.nationality] || 0) + 1; });
                    const topNations = Object.entries(nationalities).sort((a, b) => b[1] - a[1]).slice(0, 3);
                    if (topNations.length > 0) {
                        insight += ` Top nationalities: ${topNations.map(([n, c]) => `<strong>${escapeHtml(n)}</strong> (${c})`).join(', ')}.`;
                    }
                    insight += ` The overseas composition defines a squad's ceiling \u2014 you need the right balance of impact and reliability.`;
                    break;
                }
                case 'player_season': {
                    const name = firstRow.player_name || escapeHtml(entity);
                    const seasons = rows.map(r => r.season).filter(Boolean);
                    insight = `<strong>${escapeHtml(name)}</strong> across <strong>${seasons.length}</strong> IPL season${seasons.length > 1 ? 's' : ''} (${seasons[0]}\u2013${seasons[seasons.length - 1]}).`;
                    if (context === 'batting' && firstRow.runs !== undefined) {
                        const bestSeason = rows.reduce((best, r) => (r.runs || 0) > (best.runs || 0) ? r : best, rows[0]);
                        const totalRuns = rows.reduce((sum, r) => sum + (r.runs || 0), 0);
                        insight += ` Career total: <strong>${totalRuns.toLocaleString()}</strong> runs. Peak season: <strong>${bestSeason.season}</strong> with <strong>${(bestSeason.runs || 0).toLocaleString()}</strong> runs at SR ${fmt(bestSeason.strike_rate)}.`;
                    } else if (context === 'bowling' && firstRow.wickets !== undefined) {
                        const bestSeason = rows.reduce((best, r) => (r.wickets || 0) > (best.wickets || 0) ? r : best, rows[0]);
                        const totalWickets = rows.reduce((sum, r) => sum + (r.wickets || 0), 0);
                        insight += ` Career total: <strong>${totalWickets}</strong> wickets. Peak season: <strong>${bestSeason.season}</strong> with <strong>${bestSeason.wickets}</strong> wickets at econ ${fmt(bestSeason.economy)}.`;
                    }
                    insight += ` Year-by-year tape shows you the arc \u2014 who is peaking and who is fading.`;
                    break;
                }
                case 'player_venue': {
                    const name = firstRow.batter_name || firstRow.bowler_name || escapeHtml(entity);
                    const venue = firstRow.venue || escapeHtml(context);
                    if (firstRow.runs !== undefined) {
                        insight = `<strong>${escapeHtml(name)}</strong> at <strong>${escapeHtml(venue)}</strong>: <strong>${firstRow.runs}</strong> runs in <strong>${firstRow.innings}</strong> innings, SR ${fmt(firstRow.strike_rate)}, avg ${fmt(firstRow.average)}.`;
                        if (firstRow.sixes) insight += ` Hit <strong>${firstRow.sixes}</strong> sixes here.`;
                    } else if (firstRow.wickets !== undefined) {
                        insight = `<strong>${escapeHtml(name)}</strong> at <strong>${escapeHtml(venue)}</strong>: <strong>${firstRow.wickets}</strong> wickets in <strong>${firstRow.matches}</strong> matches, economy ${fmt(firstRow.economy)}.`;
                    }
                    insight += ` Ground conditions matter \u2014 the best scouts always check the venue tape first.`;
                    break;
                }
                case 'comparison':
                case 'dynamic': {
                    // Dynamic query results (Phase 2 QueryBuilder output)
                    const name = firstRow.player_name || firstRow.team_name || escapeHtml(entity);
                    if (firstRow.match_result && totalRows >= 2) {
                        // Win/loss split comparison
                        const wonRow = rows.find(r => r.match_result === 'WON');
                        const lostRow = rows.find(r => r.match_result === 'LOST');
                        insight = `<strong>${escapeHtml(name)}</strong> \u2014 wins vs losses split:`;
                        if (wonRow && lostRow) {
                            if (wonRow.strike_rate !== undefined && lostRow.strike_rate !== undefined) {
                                const srDelta = (wonRow.strike_rate - lostRow.strike_rate).toFixed(1);
                                insight += ` SR in wins: <strong>${fmt(wonRow.strike_rate)}</strong> vs losses: <strong>${fmt(lostRow.strike_rate)}</strong> (delta: ${srDelta}).`;
                                if (parseFloat(srDelta) > 20) {
                                    insight += ` That is a massive gap \u2014 this player lifts their game significantly in winning causes.`;
                                } else if (parseFloat(srDelta) < -5) {
                                    insight += ` Interesting \u2014 actually strikes harder in losses. Might be playing catch-up innings.`;
                                }
                            }
                            if (wonRow.economy !== undefined && lostRow.economy !== undefined) {
                                const econDelta = (lostRow.economy - wonRow.economy).toFixed(2);
                                insight += ` Economy in wins: <strong>${fmt(wonRow.economy)}</strong> vs losses: <strong>${fmt(lostRow.economy)}</strong> (gap: ${econDelta}).`;
                                if (parseFloat(econDelta) > 1.5) {
                                    insight += ` The economy gap tells the story \u2014 restriction is the key to this bowler's winning formula.`;
                                }
                            }
                        }
                    } else if (firstRow.runs !== undefined) {
                        insight = `Dynamic analysis for <strong>${escapeHtml(name)}</strong>: <strong>${fmt(firstRow.runs)}</strong> runs`;
                        if (firstRow.strike_rate !== undefined) insight += ` at SR <strong>${fmt(firstRow.strike_rate)}</strong>`;
                        if (firstRow.average !== undefined) insight += `, avg <strong>${fmt(firstRow.average)}</strong>`;
                        insight += ` across <strong>${fmt(firstRow.innings || firstRow.matches)}</strong> ${firstRow.innings !== undefined ? 'innings' : 'matches'}.`;
                        if (context) insight += ` Context: ${escapeHtml(context)}.`;
                    } else if (firstRow.wickets !== undefined) {
                        insight = `Dynamic analysis for <strong>${escapeHtml(name)}</strong>: <strong>${fmt(firstRow.wickets)}</strong> wickets`;
                        if (firstRow.economy !== undefined) insight += ` at economy <strong>${fmt(firstRow.economy)}</strong>`;
                        insight += ` in <strong>${fmt(firstRow.matches)}</strong> matches.`;
                        if (context) insight += ` Context: ${escapeHtml(context)}.`;
                    } else {
                        insight = `Dynamic query returned <strong>${totalRows}</strong> row${totalRows > 1 ? 's' : ''} for <strong>${escapeHtml(name)}</strong>.`;
                        if (context) insight += ` Filters applied: ${escapeHtml(context)}.`;
                    }
                    insight += ` This is the kind of drill-down that separates scouting from guessing.`;
                    break;
                }
                default: {
                    insight = `${totalRows} row${totalRows > 1 ? 's' : ''} returned. `;
                    if (firstRow.player_name) {
                        insight += `First entry: <strong>${escapeHtml(firstRow.player_name)}</strong>. `;
                    }
                    insight += `Dig into the data \u2014 the details often tell a different story than the headlines.`;
                }
            }

            return `<p style="font-size:13px;color:var(--text-secondary);line-height:1.6;">${insight}</p>`;
        }

        // ---- Update the insight card after query execution ----
        function updateFirstTakeInsight(columns, rows) {
            const insightSection = document.getElementById('andy-flower-insights');
            if (!insightSection) return;

            const insightHTML = generateFirstTakeInsight(
                columns, rows,
                lastNLQueryType, lastNLEntity, lastNLContext
            );

            insightSection.innerHTML = `
                <div class="insight-card">
                    <div class="insight-card-header">
                        <span class="icon">\u{1F3CF}</span>
                        <h4>The First Take</h4>
                        <span class="badge">Cricket Context</span>
                    </div>
                    <p class="insight-subtitle" style="font-size: 13px; font-style: italic; color: var(--text-secondary); margin-bottom: 8px;">
                        "Stephen A. wished he had this data before going on air"
                    </p>
                    ${insightHTML}
                </div>`;
        }

        /* ==================== WIRE NL SEARCH BAR (TKT-177) ==================== */
        const nlInput = document.getElementById('nl-search-input');

        // ---- Query Explanation Panel renderer ----
        function renderQueryExplanation(entities, intent, resultCount, viewSource) {
            const panel = document.getElementById('query-explanation-panel');
            if (!panel) return;

            let tagsHTML = '';

            // Player tags
            entities.players.forEach(p => {
                tagsHTML += `<span class="qe-tag player">Player: ${escapeHtml(p.name)}</span>`;
            });

            // Team tags
            entities.teams.forEach(t => {
                tagsHTML += `<span class="qe-tag team">Team: ${escapeHtml(t.canonical)}</span>`;
            });

            // Phase tags
            entities.phases.forEach(p => {
                tagsHTML += `<span class="qe-tag phase">Phase: ${escapeHtml(p)}</span>`;
            });

            // Venue tags
            entities.venues.forEach(v => {
                tagsHTML += `<span class="qe-tag venue">Venue: ${escapeHtml(v.keyword)}</span>`;
            });

            // Season tags
            entities.seasons.forEach(s => {
                const label = s.type === 'range' ? ('Since ' + s.from) : s.value;
                tagsHTML += `<span class="qe-tag season">Season: ${escapeHtml(label)}</span>`;
            });

            // Bowler type tags
            entities.bowlerTypes.forEach(bt => {
                tagsHTML += `<span class="qe-tag bowler-type">Type: ${escapeHtml(bt.keyword)}</span>`;
            });

            // Role tag
            if (entities.role) {
                tagsHTML += `<span class="qe-tag role">Role: ${escapeHtml(entities.role)}</span>`;
            }

            // Modifier tags
            if (entities.modifiers.winLoss) {
                tagsHTML += `<span class="qe-tag modifier">Split: ${escapeHtml(entities.modifiers.winLoss)}</span>`;
            }
            if (entities.modifiers.innings) {
                tagsHTML += `<span class="qe-tag modifier">${entities.modifiers.innings === 1 ? 'Batting first' : 'Chasing'}</span>`;
            }
            if (entities.modifiers.stage) {
                tagsHTML += `<span class="qe-tag modifier">Stage: ${escapeHtml(entities.modifiers.stage)}</span>`;
            }
            if (entities.modifiers.breakdownByPhase) {
                tagsHTML += `<span class="qe-tag modifier">By phase</span>`;
            }

            // Intent tag
            tagsHTML += `<span class="qe-separator">|</span>`;
            tagsHTML += `<span class="qe-tag intent">Intent: ${escapeHtml(intent)}</span>`;

            // Route line
            let routeHTML = '';
            if (resultCount !== null) {
                routeHTML = `<div class="qe-route"><span class="qe-arrow">&rarr;</span> ${resultCount} result${resultCount !== 1 ? 's' : ''}`;
                if (viewSource) {
                    routeHTML += ` from <strong>${escapeHtml(viewSource)}</strong>`;
                }
                routeHTML += `</div>`;
            }

            panel.innerHTML = `
                <div class="query-explanation-header">
                    <span class="qe-icon">&#128270;</span> Query Understanding
                </div>
                <div class="query-explanation-tags">${tagsHTML}</div>
                ${routeHTML}`;
            panel.classList.add('visible');
        }

        function hideQueryExplanation() {
            const panel = document.getElementById('query-explanation-panel');
            if (panel) {
                panel.classList.remove('visible');
                panel.innerHTML = '';
            }
        }

        // ---- Disambiguation: find similar example queries ----
        // ================================================================
        // QUERY TEMPLATE GALLERY (50+ parameterized examples)
        // ================================================================
        const NL_QUERY_TEMPLATES = [
            // --- Tier 1: Player Career Lookup ---
            { text: 'Kohli stats', desc: 'Player career batting', intent: 'PLAYER_LOOKUP', dims: ['player'] },
            { text: 'Bumrah bowling', desc: 'Player career bowling', intent: 'PLAYER_LOOKUP', dims: ['player'], role: 'bowling' },
            { text: 'Pant career', desc: 'Player career batting', intent: 'PLAYER_LOOKUP', dims: ['player'] },

            // --- Tier 2: Player + Phase ---
            { text: 'Kohli in powerplay', desc: 'Player phase batting', intent: 'PLAYER_LOOKUP', dims: ['player', 'phase'] },
            { text: 'Bumrah in death overs', desc: 'Player phase bowling', intent: 'PLAYER_LOOKUP', dims: ['player', 'phase'], role: 'bowling' },
            { text: 'SKY middle overs', desc: 'Player phase batting', intent: 'PLAYER_LOOKUP', dims: ['player', 'phase'] },
            { text: 'Kohli by phase', desc: 'Player breakdown by phase', intent: 'PLAYER_LOOKUP', dims: ['player', 'phase'] },

            // --- Tier 3: Player + Venue ---
            { text: 'Kohli at Chinnaswamy', desc: 'Player venue splits', intent: 'PLAYER_LOOKUP', dims: ['player', 'venue'] },
            { text: 'Gill at Wankhede', desc: 'Player venue splits', intent: 'PLAYER_LOOKUP', dims: ['player', 'venue'] },
            { text: 'Warner at Eden Gardens', desc: 'Player venue splits', intent: 'PLAYER_LOOKUP', dims: ['player', 'venue'] },

            // --- Tier 4: Player vs Team ---
            { text: 'Kohli vs MI', desc: 'Player vs opposition team', intent: 'PLAYER_VS_TEAM', dims: ['player', 'team'] },
            { text: 'Bumrah vs CSK', desc: 'Bowler vs opposition team', intent: 'PLAYER_VS_TEAM', dims: ['player', 'team'], role: 'bowling' },
            { text: 'Warner vs RCB in powerplay', desc: 'Player vs team + phase', intent: 'PLAYER_VS_TEAM', dims: ['player', 'team', 'phase'] },

            // --- Tier 5: Head-to-Head Matchups ---
            { text: 'Kohli vs Bumrah', desc: 'Head-to-head matchup', intent: 'MATCHUP', dims: ['matchup'] },
            { text: 'Kohli vs Rashid Khan', desc: 'Batter vs bowler matchup', intent: 'MATCHUP', dims: ['matchup'] },
            { text: 'Kohli vs Bumrah by phase', desc: 'Matchup breakdown by phase', intent: 'MATCHUP', dims: ['matchup', 'phase'] },
            { text: 'Pant vs Bumrah in powerplay since 2023', desc: 'Matchup with filters', intent: 'MATCHUP', dims: ['matchup', 'phase'] },

            // --- Tier 6: Bowler Type Matchup ---
            { text: 'Pant against spin', desc: 'Batter vs bowling type', intent: 'PLAYER_VS_TYPE', dims: ['player', 'bowlerType'] },
            { text: 'Kohli vs left-arm pace', desc: 'Batter vs specific bowling type', intent: 'PLAYER_VS_TYPE', dims: ['player', 'bowlerType'] },
            { text: 'SKY vs leg-spin in death', desc: 'Batter vs bowling type + phase', intent: 'PLAYER_VS_TYPE', dims: ['player', 'bowlerType', 'phase'] },

            // --- Tier 7: Leaderboards ---
            { text: 'top 10 run scorers', desc: 'Batting leaderboard by runs', intent: 'LEADERBOARD', dims: [] },
            { text: 'top 10 wicket takers', desc: 'Bowling leaderboard by wickets', intent: 'LEADERBOARD', dims: [], role: 'bowling' },
            { text: 'best death bowlers by economy', desc: 'Phase bowling leaderboard', intent: 'LEADERBOARD', dims: ['phase'], role: 'bowling' },
            { text: 'best powerplay batters', desc: 'Phase batting leaderboard', intent: 'LEADERBOARD', dims: ['phase'] },
            { text: 'highest strike rate in death overs', desc: 'Death over specialists', intent: 'LEADERBOARD', dims: ['phase'] },
            { text: 'most sixes in IPL', desc: 'Sixes leaderboard', intent: 'LEADERBOARD', dims: [] },
            { text: 'top run scorers at Wankhede', desc: 'Venue leaderboard', intent: 'LEADERBOARD', dims: ['venue'] },
            { text: 'best average in middle overs', desc: 'Phase batting average', intent: 'LEADERBOARD', dims: ['phase'] },
            { text: 'most economical bowlers', desc: 'Economy rate leaderboard', intent: 'LEADERBOARD', dims: [], role: 'bowling' },

            // --- Tier 8: Team Analysis ---
            { text: 'CSK squad', desc: 'Team roster', intent: 'SQUAD', dims: ['squad'] },
            { text: 'MI batting', desc: 'Team batting stats', intent: 'TEAM_ANALYSIS', dims: ['squad'] },
            { text: 'RCB bowling in death overs', desc: 'Team bowling by phase', intent: 'TEAM_ANALYSIS', dims: ['squad', 'phase'], role: 'bowling' },
            { text: 'CSK batting in powerplay', desc: 'Team batting by phase', intent: 'TEAM_ANALYSIS', dims: ['squad', 'phase'] },
            { text: 'GT bowling', desc: 'Team bowling stats', intent: 'TEAM_ANALYSIS', dims: ['squad'], role: 'bowling' },

            // --- Tier 9: Team Comparison ---
            { text: 'MI vs CSK bowling economy', desc: 'Team comparison', intent: 'TEAM_COMPARISON', dims: ['team', 'team'] },
            { text: 'compare RCB and MI batting', desc: 'Team comparison', intent: 'TEAM_COMPARISON', dims: ['team', 'team'] },
            { text: 'CSK vs MI in powerplay since 2023', desc: 'Team comparison with filters', intent: 'TEAM_COMPARISON', dims: ['team', 'team', 'phase'] },

            // --- Tier 10: Win/Loss Context ---
            { text: 'Kohli in wins vs losses', desc: 'Win/loss performance split', intent: 'PLAYER_LOOKUP', dims: ['player'], modifiers: ['winLoss'] },
            { text: 'SKY middle overs wins vs losses', desc: 'Phase + win/loss split', intent: 'PLAYER_LOOKUP', dims: ['player', 'phase'], modifiers: ['winLoss'] },
            { text: 'Bumrah economy in wins', desc: 'Bowling in wins only', intent: 'PLAYER_LOOKUP', dims: ['player'], modifiers: ['winLoss'], role: 'bowling' },
            { text: 'CSK batting in wins since 2023', desc: 'Team batting in wins', intent: 'TEAM_ANALYSIS', dims: ['squad'], modifiers: ['winLoss'] },

            // --- Tier 11: Season Trends ---
            { text: 'Kohli season wise', desc: 'Season-by-season breakdown', intent: 'SEASON_TREND', dims: ['player'] },
            { text: 'Bumrah year by year bowling', desc: 'Bowling season trend', intent: 'SEASON_TREND', dims: ['player'], role: 'bowling' },

            // --- Tier 12: Innings Context ---
            { text: 'Bumrah economy when defending', desc: 'Bowling in 2nd innings', intent: 'PLAYER_LOOKUP', dims: ['player'], modifiers: ['innings'], role: 'bowling' },
            { text: 'best death bowlers when chasing', desc: 'Bowling leaderboard + innings', intent: 'LEADERBOARD', dims: ['phase'], modifiers: ['innings'], role: 'bowling' },
            { text: 'Kohli batting first vs chasing', desc: 'Innings context comparison', intent: 'PLAYER_LOOKUP', dims: ['player'], modifiers: ['innings'] },

            // --- Tier 13: Playoff/Stage Context ---
            { text: 'Kohli in playoffs', desc: 'Knockout performance', intent: 'PLAYER_LOOKUP', dims: ['player'], modifiers: ['stage'] },
            { text: 'best death bowlers in playoffs', desc: 'Playoff leaderboard', intent: 'LEADERBOARD', dims: ['phase'], modifiers: ['stage'], role: 'bowling' },

            // --- Tier 14: Pressure / Clutch ---
            { text: 'clutch batters', desc: 'Batters under pressure', intent: 'PRESSURE', dims: ['pressure'] },
            { text: 'best finishers under pressure', desc: 'Pressure batting performers', intent: 'PRESSURE', dims: ['pressure'] },
            { text: 'pressure bowlers', desc: 'Bowlers under pressure', intent: 'PRESSURE', dims: ['pressure'], role: 'bowling' },
            { text: 'pressure ratings', desc: 'Pressure rating delta analysis', intent: 'PRESSURE', dims: ['pressure'] },

            // --- Tier 15: Contracts ---
            { text: 'most expensive players', desc: 'IPL 2026 auction prices', intent: 'CONTRACTS', dims: [] },
            { text: 'MI contracts', desc: 'Team auction spending', intent: 'CONTRACTS', dims: ['team'] },
            { text: 'cheapest buys', desc: 'Bargain auction picks', intent: 'CONTRACTS', dims: [] },

            // --- Tier 16: Overseas ---
            { text: 'RCB overseas players', desc: 'Overseas squad roster', intent: 'OVERSEAS', dims: ['team'] },
            { text: 'overseas players', desc: 'All overseas players', intent: 'OVERSEAS', dims: [] },

            // --- Tier 17: Complex Composite ---
            { text: 'Kohli at Chinnaswamy in death overs', desc: 'Player + venue + phase', intent: 'PLAYER_LOOKUP', dims: ['player', 'venue', 'phase'] },
            { text: 'Bumrah economy vs MI in powerplay', desc: 'Player + team + phase + metric', intent: 'PLAYER_VS_TEAM', dims: ['player', 'team', 'phase'], role: 'bowling' },
            { text: 'top 5 spinners in middle overs by economy', desc: 'Bowler type + phase leaderboard', intent: 'LEADERBOARD', dims: ['phase', 'bowlerType'], role: 'bowling' },
        ];

        function findSimilarExamples(query, maxResults, extractedEntities) {
            const lower = query.toLowerCase();
            const words = lower.split(/\s+/).filter(w => w.length >= 3);
            const scored = [];

            for (const ex of NL_QUERY_TEMPLATES) {
                const exLower = ex.text.toLowerCase();
                let score = 0;

                // Word overlap scoring
                for (const word of words) {
                    if (exLower.includes(word)) score += 3;
                }
                const exWords = exLower.split(/\s+/);
                for (const ew of exWords) {
                    if (ew.length >= 3 && lower.includes(ew)) score += 1;
                }

                // Intent matching bonus (if entities were extracted)
                if (extractedEntities) {
                    // Boost examples that share extracted dimensions
                    if (extractedEntities.players.length > 0 && ex.dims.includes('player')) score += 4;
                    if (extractedEntities.teams.length > 0 && (ex.dims.includes('team') || ex.dims.includes('squad'))) score += 4;
                    if (extractedEntities.phases.length > 0 && ex.dims.includes('phase')) score += 4;
                    if (extractedEntities.venues.length > 0 && ex.dims.includes('venue')) score += 4;
                    if (extractedEntities.bowlerTypes.length > 0 && ex.dims.includes('bowlerType')) score += 4;

                    // Role matching bonus
                    if (extractedEntities.role === 'bowling' && ex.role === 'bowling') score += 3;
                    if (extractedEntities.role === 'batting' && ex.role !== 'bowling') score += 2;

                    // Modifier matching bonus
                    if (extractedEntities.modifiers.winLoss && ex.modifiers && ex.modifiers.includes('winLoss')) score += 5;
                    if (extractedEntities.modifiers.stage && ex.modifiers && ex.modifiers.includes('stage')) score += 5;
                    if (extractedEntities.modifiers.innings && ex.modifiers && ex.modifiers.includes('innings')) score += 5;
                }

                if (score > 0) {
                    scored.push({ ...ex, score });
                }
            }

            scored.sort((a, b) => b.score - a.score);

            // If no substring matches, return diverse defaults based on what was extracted
            if (scored.length === 0) {
                // Curate based on entities
                if (extractedEntities && extractedEntities.players.length > 0) {
                    const pName = extractedEntities.players[0].name;
                    return [
                        { text: `${pName} stats`, desc: 'Career batting stats', score: 10 },
                        { text: `${pName} bowling`, desc: 'Career bowling stats', score: 9 },
                        { text: `${pName} by phase`, desc: 'Phase breakdown', score: 8 },
                        { text: `${pName} wins vs losses`, desc: 'Win/loss split', score: 7 },
                        { text: `${pName} season wise`, desc: 'Season trend', score: 6 },
                    ].slice(0, maxResults);
                }
                if (extractedEntities && extractedEntities.teams.length > 0) {
                    const tName = extractedEntities.teams[0].canonical;
                    const abbr = extractedEntities.teams[0].name;
                    return [
                        { text: `${abbr} squad`, desc: 'Team roster', score: 10 },
                        { text: `${abbr} batting`, desc: 'Team batting stats', score: 9 },
                        { text: `${abbr} bowling`, desc: 'Team bowling stats', score: 8 },
                        { text: `${abbr} batting in powerplay`, desc: 'Team phase stats', score: 7 },
                        { text: `${abbr} contracts`, desc: 'Auction spending', score: 6 },
                    ].slice(0, maxResults);
                }
                return NL_QUERY_TEMPLATES.filter((_, i) => i % 4 === 0).slice(0, maxResults);
            }

            // Deduplicate by intent+dims to ensure diversity
            const seen = new Set();
            const diverse = [];
            for (const item of scored) {
                const key = item.intent + ':' + (item.dims || []).join(',');
                if (!seen.has(key)) {
                    seen.add(key);
                    diverse.push(item);
                }
                if (diverse.length >= maxResults) break;
            }
            return diverse;
        }

        // ---- Disambiguation: check for ambiguous player matches ----
        function findAmbiguousPlayers(query) {
            const lower = query.toLowerCase().trim();
            const words = lower.split(/\s+/).filter(w => w.length >= 3);
            const ambiguous = [];

            for (const word of words) {
                // Skip common noise words
                if (/^(show|stats|get|find|best|top|worst|bowling|batting|career|run|runs|wicket|wickets|team|player|death|powerplay|middle|phase|overs?|squad|roster|year|wise|season|most|highest|lowest|average|economy|strike|rate|wins?|loss|losses|split|against|versus|chasing|setting|playoffs?)$/.test(word)) continue;

                // Skip if this word is a team alias
                if (isTeamToken(word)) continue;

                const matches = new Map(); // canonical name -> best alias that matched
                for (const [alias, fullName] of Object.entries(PLAYER_ALIASES)) {
                    const aliasLower = alias.toLowerCase();
                    // Exact match on single-word alias
                    if (aliasLower === word) {
                        if (!matches.has(fullName)) {
                            matches.set(fullName, alias);
                        }
                    }
                    // Also check if word is a last-name part of a multi-word alias
                    // e.g., "pandya" should match "hardik pandya" and "krunal pandya"
                    else if (aliasLower.split(/\s+/).some(part => part === word) && aliasLower.includes(' ')) {
                        if (!matches.has(fullName)) {
                            // Prefer the short alias for display
                            const shortAlias = Object.entries(PLAYER_ALIASES).find(([a, n]) => n === fullName && !a.includes(' '));
                            matches.set(fullName, shortAlias ? shortAlias[0] : alias);
                        }
                    }
                }
                // Only ambiguous if multiple different canonical names matched the same word
                if (matches.size > 1) {
                    ambiguous.push({
                        token: word,
                        players: Array.from(matches.entries()).map(([name, alias]) => ({
                            name,
                            alias,
                        }))
                    });
                }
            }
            return ambiguous;
        }

        // ---- Render disambiguation card ----
        function renderDisambiguation(ambiguousResults, originalQuery) {
            const panel = document.getElementById('disambiguation-panel');
            if (!panel) return;

            if (!ambiguousResults || ambiguousResults.length === 0) {
                panel.innerHTML = '';
                return;
            }

            const amb = ambiguousResults[0]; // Handle first ambiguous token
            let optionsHTML = '';
            amb.players.forEach(p => {
                // Build a new query replacing the ambiguous token with the full name
                const newQuery = originalQuery.replace(
                    new RegExp('\\b' + amb.token.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i'),
                    p.alias
                );
                optionsHTML += `<button type="button" class="disambiguation-option" onclick="document.getElementById('nl-search-input').value='${escapeAttr(p.alias)}';handleNLSearch();">${escapeHtml(p.name)} <span style="color:var(--text-tertiary);font-weight:400;">(${escapeHtml(p.alias)})</span></button>`;
            });

            panel.innerHTML = `
                <div class="disambiguation-card">
                    <h4>&#9888; Multiple players match "${escapeHtml(amb.token)}":</h4>
                    <div class="disambiguation-options">${optionsHTML}</div>
                </div>`;
        }

        // ---- Render fallback suggestions ----
        function renderFallbackSuggestions(query, entities) {
            const panel = document.getElementById('disambiguation-panel');
            if (!panel) return;

            const suggestions = findSimilarExamples(query, 5, entities);
            let suggestionsHTML = '';
            suggestions.forEach(s => {
                suggestionsHTML += `<div class="fallback-suggestion-item" onclick="document.getElementById('nl-search-input').value='${escapeAttr(s.text)}';handleNLSearch();">
                    <span class="fsi-icon">&#9654;</span>
                    <strong>"${escapeHtml(s.text)}"</strong>
                    <span style="color:var(--text-tertiary);">&mdash; ${escapeHtml(s.desc)}</span>
                </div>`;
            });

            // Build "what I understood" section if entities were partially extracted
            let understoodHTML = '';
            if (entities) {
                const parts = [];
                if (entities.players.length > 0) parts.push(`<span class="qe-tag player">Player: ${escapeHtml(entities.players[0].name)}</span>`);
                if (entities.teams.length > 0) parts.push(`<span class="qe-tag team">Team: ${escapeHtml(entities.teams[0].canonical)}</span>`);
                if (entities.phases.length > 0) parts.push(`<span class="qe-tag phase">Phase: ${escapeHtml(entities.phases[0])}</span>`);
                if (entities.venues.length > 0) parts.push(`<span class="qe-tag venue">Venue: ${escapeHtml(entities.venues[0].keyword)}</span>`);
                if (entities.role) parts.push(`<span class="qe-tag role">Role: ${escapeHtml(entities.role)}</span>`);
                if (parts.length > 0) {
                    understoodHTML = `<div style="margin-bottom:10px;padding:8px 12px;background:rgba(100,210,80,0.08);border-radius:8px;">
                        <span style="font-size:12px;font-weight:600;color:var(--text-secondary);">Understood:</span> ${parts.join(' ')}
                        <span style="font-size:11px;color:var(--text-tertiary);margin-left:8px;">but couldn't determine what analysis to run</span>
                    </div>`;
                }
            }

            // Build "available analyses" hint if a player or team was detected
            let analysisHintsHTML = '';
            if (entities && entities.players.length > 0) {
                const pName = entities.players[0].name;
                analysisHintsHTML = `<div style="margin-top:8px;padding:8px 12px;font-size:12px;color:var(--text-tertiary);border-top:1px solid var(--border-subtle);">
                    Available for <strong>${escapeHtml(pName)}</strong>: career stats, phase breakdown, venue splits, vs team, vs bowler type, matchup, pressure, season trend, wins vs losses
                </div>`;
            } else if (entities && entities.teams.length > 0) {
                const tName = entities.teams[0].canonical;
                analysisHintsHTML = `<div style="margin-top:8px;padding:8px 12px;font-size:12px;color:var(--text-tertiary);border-top:1px solid var(--border-subtle);">
                    Available for <strong>${escapeHtml(tName)}</strong>: squad roster, batting stats, bowling stats, phase breakdown, contracts, overseas players, comparison
                </div>`;
            }

            panel.innerHTML = `
                <div class="disambiguation-card" style="border-color: rgba(255, 159, 10, 0.2);">
                    ${understoodHTML}
                    <h4>&#128269; Try one of these queries:</h4>
                    <div class="fallback-suggestions">${suggestionsHTML}</div>
                    ${analysisHintsHTML}
                </div>`;
        }

        function clearDisambiguation() {
            const panel = document.getElementById('disambiguation-panel');
            if (panel) panel.innerHTML = '';
        }

        // ---- Extract view name from SQL for display ----
        function extractViewFromSQL(sql) {
            if (!sql) return null;
            const match = sql.match(/FROM\s+(\w+)/i);
            return match ? match[1] : null;
        }

        function handleNLSearch() {
            const query = nlInput.value.trim();
            if (!query) return;

            // Clear previous disambiguation/explanation
            clearDisambiguation();
            hideQueryExplanation();

            // Pre-extract entities and intent for explanation panel
            const entities = extractEntities(query);
            const intent = classifyIntent(entities, query);
            lastNLEntities = entities;
            lastNLIntent = intent;

            // Check for ambiguous player matches before running
            const ambiguous = findAmbiguousPlayers(query);

            const result = naturalLanguageToSQL(query);
            if (result) {
                // If there's ambiguity, show disambiguation but still run the first match
                if (ambiguous.length > 0 && entities.players.length === 0) {
                    renderDisambiguation(ambiguous, query);
                    return; // Don't run query, let user pick
                }

                lastNLQueryType = result.type;
                lastNLEntity = result.entity || null;
                lastNLContext = result.context || null;
                lastNLViewName = extractViewFromSQL(result.sql);
                isCurrentNLQuery = true;

                // Show query explanation immediately (result count filled after execution)
                renderQueryExplanation(entities, intent, null, lastNLViewName);

                // If partial match, show a hint about what was approximated
                if (result.partial) {
                    const panel = document.getElementById('disambiguation-panel');
                    if (panel) {
                        const suggestions = findSimilarExamples(query, 3, entities);
                        let sugHTML = '';
                        suggestions.forEach(s => {
                            sugHTML += `<div class="fallback-suggestion-item" style="padding:4px 8px;" onclick="document.getElementById('nl-search-input').value='${escapeAttr(s.text)}';handleNLSearch();">
                                <span class="fsi-icon">&#9654;</span> <strong>"${escapeHtml(s.text)}"</strong>
                                <span style="color:var(--text-tertiary);">&mdash; ${escapeHtml(s.desc)}</span>
                            </div>`;
                        });
                        panel.innerHTML = `<div class="disambiguation-card" style="border-color:rgba(100,210,80,0.3);background:rgba(100,210,80,0.03);">
                            <h4 style="font-size:12px;margin-bottom:6px;">Showing best-effort results. For more precise analysis, try:</h4>
                            <div class="fallback-suggestions">${sugHTML}</div>
                        </div>`;
                    }
                }

                setEditorSQL(result.sql);
                document.getElementById('sql-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Auto-execute after a brief delay to let user see the SQL
                setTimeout(() => {
                    window.executeQuery();
                }, 300);
            } else {
                // No pattern matched
                // Check for disambiguation first
                if (ambiguous.length > 0) {
                    renderDisambiguation(ambiguous, query);
                } else {
                    // Show context-aware fallback suggestions
                    renderFallbackSuggestions(query, entities);
                }
            }
        }

        window.handleNLSearch = handleNLSearch;

        nlInput.addEventListener('keydown', function(e) {
            const dropdown = document.getElementById('nl-typeahead');
            if (e.key === 'Enter') {
                e.preventDefault();
                // If typeahead is visible and has a selected item, use it
                const selected = dropdown ? dropdown.querySelector('.typeahead-item.selected') : null;
                if (selected && dropdown.style.display !== 'none') {
                    nlInput.value = selected.dataset.query;
                    dropdown.style.display = 'none';
                }
                handleNLSearch();
            } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                if (dropdown && dropdown.style.display !== 'none') {
                    e.preventDefault();
                    const items = dropdown.querySelectorAll('.typeahead-item');
                    if (items.length === 0) return;
                    let idx = -1;
                    items.forEach((item, i) => { if (item.classList.contains('selected')) idx = i; });
                    items.forEach(item => item.classList.remove('selected'));
                    if (e.key === 'ArrowDown') idx = (idx + 1) % items.length;
                    else idx = idx <= 0 ? items.length - 1 : idx - 1;
                    items[idx].classList.add('selected');
                    items[idx].scrollIntoView({ block: 'nearest' });
                }
            } else if (e.key === 'Escape') {
                if (dropdown) dropdown.style.display = 'none';
            }
        });

        // --- Typeahead: show suggestions as user types ---
        let _typeaheadTimer = null;
        nlInput.addEventListener('input', function() {
            clearTimeout(_typeaheadTimer);
            const dropdown = document.getElementById('nl-typeahead');
            if (!dropdown) return;
            const val = nlInput.value.trim();
            if (val.length < 3) {
                dropdown.style.display = 'none';
                return;
            }
            _typeaheadTimer = setTimeout(() => {
                const entities = extractEntities(val);
                const matches = findSimilarExamples(val, 6, entities);
                if (matches.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }
                let html = '';
                matches.forEach((m, i) => {
                    html += `<div class="typeahead-item${i === 0 ? ' selected' : ''}" data-query="${escapeAttr(m.text)}"
                        onclick="document.getElementById('nl-search-input').value='${escapeAttr(m.text)}';document.getElementById('nl-typeahead').style.display='none';handleNLSearch();"
                        onmouseenter="document.querySelectorAll('.typeahead-item').forEach(el=>el.classList.remove('selected'));this.classList.add('selected');"
                        style="padding:8px 16px;cursor:pointer;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border-subtle, #222);transition:background 0.15s;">
                        <span style="color:var(--accent);font-size:11px;opacity:0.7;">&#9654;</span>
                        <span style="font-weight:500;font-size:13px;">${escapeHtml(m.text)}</span>
                        <span style="margin-left:auto;font-size:11px;color:var(--text-tertiary);opacity:0.6;">${escapeHtml(m.desc)}</span>
                    </div>`;
                });
                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            }, 150); // 150ms debounce
        });

        // Hide typeahead when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('nl-typeahead');
            if (dropdown && !e.target.closest('.nl-search-bar')) {
                dropdown.style.display = 'none';
            }
        });

        // ---- Side-by-Side Comparison Renderer ----
        function renderWinLossComparison(columns, rows) {
            const wonRows = rows.filter(r => r.match_result === 'WON');
            const lostRows = rows.filter(r => r.match_result === 'LOST');

            if (wonRows.length === 0 && lostRows.length === 0) return false;

            const wonRow = wonRows[0] || {};
            const lostRow = lostRows[0] || {};

            // Pick key metrics to display (skip non-metric columns)
            const skipCols = new Set(['match_result', 'player_name', 'batter_name', 'bowler_name', 'team_name', 'current_name']);
            const metricCols = columns.filter(c => !skipCols.has(c));

            function fmtVal(v) {
                if (v === null || v === undefined) return 'N/A';
                if (typeof v === 'number') return v % 1 === 0 ? v.toLocaleString() : v.toFixed(2);
                return String(v);
            }

            // Determine whether higher is better for a metric
            function higherIsBetter(colName) {
                const lower = colName.toLowerCase();
                if (/economy|dot_ball_pct|dot_pct|avg_dot/.test(lower)) return false; // lower is better
                return true; // default: higher is better
            }

            // Build metrics HTML for a card
            function buildMetricsHTML(row) {
                let html = '';
                for (const col of metricCols) {
                    html += `<div class="comparison-metric-row">
                        <span class="comparison-metric-label">${escapeHtml(col.replace(/_/g, ' '))}</span>
                        <span class="comparison-metric-value">${fmtVal(row[col])}</span>
                    </div>`;
                }
                return html;
            }

            // Build deltas
            let deltasHTML = '';
            for (const col of metricCols) {
                const wVal = wonRow[col];
                const lVal = lostRow[col];
                if (typeof wVal === 'number' && typeof lVal === 'number') {
                    const delta = wVal - lVal;
                    const hib = higherIsBetter(col);
                    const isGood = hib ? delta > 0 : delta < 0;
                    const cls = Math.abs(delta) < 0.01 ? 'neutral' : (isGood ? 'positive' : 'negative');
                    const sign = delta > 0 ? '+' : '';
                    const displayDelta = delta % 1 === 0 ? delta.toLocaleString() : delta.toFixed(2);
                    deltasHTML += `<span class="delta-chip ${cls}">
                        <span class="delta-label">${escapeHtml(col.replace(/_/g, ' '))}:</span>
                        ${sign}${displayDelta}
                    </span>`;
                }
            }

            // Get player/team name for the header
            const headerName = wonRow.player_name || wonRow.batter_name || wonRow.bowler_name || wonRow.team_name || lostRow.player_name || lostRow.batter_name || '';

            const resultsWrapper = document.getElementById('results-table-wrapper');
            resultsWrapper.innerHTML = `
                ${headerName ? `<div style="padding: 12px 20px 0; font-size: 14px; font-weight: 700;">${escapeHtml(headerName)} &mdash; Wins vs Losses</div>` : ''}
                <div class="comparison-container">
                    <div class="comparison-card wins-card">
                        <div class="comparison-card-header">
                            <span class="cc-icon">&#9989;</span>
                            <h4 style="color: var(--accent-green);">In Wins</h4>
                            <span class="cc-count">${wonRows.length} match${wonRows.length !== 1 ? 'es' : ''}</span>
                        </div>
                        <div class="comparison-metrics">${buildMetricsHTML(wonRow)}</div>
                    </div>
                    <div class="comparison-card losses-card">
                        <div class="comparison-card-header">
                            <span class="cc-icon">&#10060;</span>
                            <h4 style="color: var(--accent-red);">In Losses</h4>
                            <span class="cc-count">${lostRows.length} match${lostRows.length !== 1 ? 'es' : ''}</span>
                        </div>
                        <div class="comparison-metrics">${buildMetricsHTML(lostRow)}</div>
                    </div>
                </div>
                ${deltasHTML ? `<div class="comparison-deltas">${deltasHTML}</div>` : ''}
            `;
            return true;
        }

        // ---- Patch executeQuery to generate insights after results ----
        const _originalExecuteQuery = executeQuery;

        async function executeQueryWithInsights() {
            await _originalExecuteQuery();

            if (isCurrentNLQuery) {
                // Update query explanation panel with result count
                if (lastNLEntities && lastNLIntent && currentResultRows) {
                    renderQueryExplanation(lastNLEntities, lastNLIntent, currentResultRows.length, lastNLViewName);
                }

                // Check for side-by-side comparison rendering
                if (currentResultRows && currentResultRows.length > 0 && currentResultColumns.includes('match_result')) {
                    const hasWon = currentResultRows.some(r => r.match_result === 'WON');
                    const hasLost = currentResultRows.some(r => r.match_result === 'LOST');
                    if (hasWon && hasLost && lastNLEntities && lastNLEntities.modifiers && lastNLEntities.modifiers.winLoss === 'split') {
                        renderWinLossComparison(currentResultColumns, currentResultRows);
                        // Hide pagination for comparison view
                        document.getElementById('results-pagination').classList.remove('visible');
                    }
                }

                // Reset the NL query flag after processing
                isCurrentNLQuery = false;
            } else {
                // Manual query: hide NL-specific panels
                hideQueryExplanation();
                clearDisambiguation();
            }

            if (currentResultRows && currentResultRows.length > 0) {
                updateFirstTakeInsight(currentResultColumns, currentResultRows);
            }
        }

        window.executeQuery = executeQueryWithInsights;
        window.executeQueryWithInsights = executeQueryWithInsights;
        document.getElementById('run-button').removeEventListener('click', _originalExecuteQuery);
        document.getElementById('run-button').addEventListener('click', executeQueryWithInsights);

        // Update NL search bar placeholder
        nlInput.placeholder = "Ask in plain English: player stats, matchups, leaderboards, team squads...";

        /* ==================== START INITIALIZATION ==================== */
        /* Import DuckDB with a 15-second timeout so a hung CDN never blocks the page */
        function importWithTimeout(url, ms) {
            return Promise.race([
                import(url),
                new Promise((_, reject) => setTimeout(() => reject(new Error('CDN import timed out after ' + ms + 'ms')), ms))
            ]);
        }

        async function loadAndInitDuckDB() {
            try {
                duckdb = await importWithTimeout('https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.29.0/+esm', 15000);
                console.log('DuckDB-WASM loaded successfully');
                await initDuckDB();
            } catch (err) {
                console.error('DuckDB-WASM failed to load:', err);
                const overlayEl = document.getElementById('loading-overlay');
                const progressTextEl = document.getElementById('loading-progress-text');
                if (progressTextEl) progressTextEl.textContent = 'Analytics engine failed to load: ' + err.message;
                const btn = document.createElement('button');
                btn.textContent = 'Dismiss & Browse Page';
                btn.style.cssText = 'margin-top:16px;padding:10px 24px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:13px;font-weight:600;';
                btn.onclick = () => overlayEl.classList.add('hidden');
                overlayEl.querySelector('.loading-steps').insertAdjacentElement('afterend', btn);
            }
        }

        // Signal to safety timeout that module evaluation completed successfully
        window._filmRoomReady = true;

        // Kick off DuckDB load (non-blocking  page is already rendered)
        loadAndInitDuckDB();
    </script>

    <!-- Navigation Guide Button -->
    <button type="button" class="nav-guide-btn" onclick="toggleNavGuide()" title="Quick Navigation Guide" style="
        position: fixed; bottom: 48px; right: 20px; width: 52px; height: 52px;
        border-radius: 50%; background: var(--bg-secondary); border: 1px solid var(--border);
        color: var(--text-secondary); font-size: 22px; cursor: pointer; z-index: 90;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 16px var(--shadow); transition: all 0.2s ease;
    "></button>

    <!-- Navigation Guide Modal -->
    <div class="nav-guide-overlay" id="nav-guide-overlay" onclick="closeNavGuide(event)" style="
        display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
        z-index: 150; align-items: center; justify-content: center;
    ">
        <div class="nav-guide-modal" onclick="event.stopPropagation()" style="
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 16px; padding: 28px 24px; max-width: 420px; width: 90%;
            max-height: 80vh; overflow-y: auto; position: relative;
        ">
            <button type="button" class="nav-guide-close" onclick="toggleNavGuide()" style="
                position: absolute; top: 12px; right: 12px; background: none; border: none;
                color: var(--text-tertiary); font-size: 18px; cursor: pointer; padding: 4px 8px;
            ">&#10005;</button>
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 18px; font-weight: 800;"> The Playbook Rundown</h3>
                <p style="font-size: 13px; color: var(--text-secondary);">Your pre-game briefing from the coaching staff</p>
            </div>
            <a href="index.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;"></span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">Home  "The Main Event"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">The Lab homepage. Your IPL 2026 analytics command center.</p>
                </div>
            </a>
            <a href="teams.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;"></span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">Team Breakdowns  "The Dugout"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">Andy Flower's domain. Predicted XIs, depth charts, full rosters.</p>
                </div>
            </a>
            <a href="artifacts.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;"></span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">Artifacts  "The Trophy Cabinet"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">All 10 franchise stat packs. Stephen Curry approved  clean data.</p>
                </div>
            </a>
            <a href="analysis.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;"></span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">Analysis  "Studying Film"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">Tom Brady's film room. Matchups, clusters, phase breakdowns.</p>
                </div>
            </a>
            <a href="research.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;"></span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">Research  "Pep's Tactical Notebook"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">Methodology docs. The science behind the grades.</p>
                </div>
            </a>
            <a href="research-desk.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; background: rgba(10,132,255,0.08); border: 1px solid rgba(10,132,255,0.15);">
                <span style="font-size: 24px;"></span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">The Film Room  "Breaking Down Tape"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);"> You Are Here. Pull up the tape on any player, team, or matchup. The full scouting database, coach-style.</p>
                </div>
            </a>
            <a href="about.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;"></span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">About  "The Origin Story"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">The story, the vision, the Founder. How Cricket Playbook came to be.</p>
                </div>
            </a>
            <a href="../../mission_control/dashboard/index.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;"></span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">The Boardroom  "Front Office Moves"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">Florentino's war room. Tickets, sprints, agent roster.</p>
                </div>
            </a>
        </div>
    </div>

    <script>
        function toggleNavGuide() {
            const overlay = document.getElementById('nav-guide-overlay');
            const isVisible = overlay.style.display === 'flex';
            overlay.style.display = isVisible ? 'none' : 'flex';
        }
        function closeNavGuide(e) {
            if (e.target === e.currentTarget) toggleNavGuide();
        }

        /* Schema sidebar mobile toggle */
        function toggleSchemaSidebar() {
            const sidebar = document.getElementById('schema-browser');
            const overlay = document.getElementById('schema-overlay');
            const isOpen = sidebar.classList.contains('open');
            if (isOpen) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('active');
            }
        }
    </script>
</body>
</html>
