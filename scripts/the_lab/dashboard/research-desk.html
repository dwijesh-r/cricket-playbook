<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Film Room - The Lab</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* ==================== THEME SYSTEM ==================== */
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --bg-elevated: #3a3a3c;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --text-tertiary: #636366;
            --accent: #0a84ff;
            --accent-green: #30d158;
            --accent-yellow: #ffd60a;
            --accent-orange: #ff9f0a;
            --accent-red: #ff453a;
            --accent-purple: #bf5af2;
            --accent-pink: #ff375f;
            --accent-teal: #64d2ff;
            --border: rgba(255, 255, 255, 0.1);
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.08);
            --shadow: rgba(0, 0, 0, 0.4);
        }

        [data-theme="light"] {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e5e5ea;
            --bg-elevated: #d1d1d6;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-tertiary: #8e8e93;
            --accent: #007aff;
            --accent-green: #28cd41;
            --accent-yellow: #ffcc00;
            --accent-orange: #ff9500;
            --accent-red: #ff3b30;
            --accent-purple: #af52de;
            --accent-pink: #ff2d55;
            --accent-teal: #5ac8fa;
            --border: rgba(0, 0, 0, 0.08);
            --glass: rgba(0, 0, 0, 0.03);
            --glass-border: rgba(0, 0, 0, 0.06);
            --shadow: rgba(0, 0, 0, 0.15);
        }

        /* ==================== TOOLTIP SYSTEM (TKT-109) ==================== */
        .has-tooltip {
            position: relative;
            cursor: help;
        }
        .has-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 4px 12px var(--shadow);
        }
        .has-tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            font-size: 10px;
            color: var(--text-tertiary);
            cursor: help;
            margin-left: 4px;
            vertical-align: middle;
        }
        .help-icon:hover { color: var(--accent); }
        .has-tooltip-below::after {
            bottom: auto;
            top: calc(100% + 8px);
        }

        /* Mobile-safe tooltip adjustments */
        @media (max-width: 768px) {
            .has-tooltip::after {
                white-space: normal;
                max-width: 200px;
                left: 0;
                transform: none;
                font-size: 11px;
            }
        }
        @media (max-width: 480px) {
            .has-tooltip::after {
                max-width: 160px;
                padding: 6px 10px;
                font-size: 10px;
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ==================== BACKGROUND ==================== */
        .bg-gradient {
            position: fixed; inset: 0; z-index: -4;
            background: linear-gradient(135deg, #000000 0%, #0a0a12 25%, #0d1020 50%, #0a0a15 75%, #000000 100%);
        }
        [data-theme="light"] .bg-gradient {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #f1f3f5 100%);
        }
        .bg-gradient::before {
            content: ''; position: absolute; top: -20%; right: -10%; width: 60%; height: 60%;
            background: radial-gradient(ellipse, rgba(10, 132, 255, 0.18) 0%, transparent 70%);
            filter: blur(80px);
        }
        .bg-grid {
            position: fixed; inset: 0; z-index: -2;
            background-image: linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 60px 60px;
        }
        [data-theme="light"] .bg-grid {
            background-image: linear-gradient(rgba(0, 0, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
        }

        /* ==================== NAVIGATION ==================== */
        .nav {
            position: fixed; top: 0; left: 0; right: 0; height: 56px;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px; z-index: 100;
        }
        [data-theme="light"] .nav { background: rgba(245, 245, 247, 0.85); }
        .nav-brand { display: flex; align-items: center; gap: 12px; }
        .nav-logo {
            width: 32px; height: 32px; border-radius: 8px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-purple) 100%);
            display: flex; align-items: center; justify-content: center; font-size: 16px;
        }
        .nav-title { font-size: 15px; font-weight: 600; letter-spacing: -0.3px; }
        .nav-title span { color: var(--accent); }
        .nav-tabs {
            display: flex; gap: 4px;
            background: var(--bg-secondary); border-radius: 10px; padding: 4px;
        }
        .nav-tab {
            padding: 6px 14px; border-radius: 8px; font-size: 13px; font-weight: 500;
            color: var(--text-secondary); text-decoration: none; transition: all 0.2s ease;
            white-space: nowrap;
        }
        .nav-tab:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .nav-tab.active {
            color: var(--text-primary); background: var(--bg-tertiary);
            box-shadow: 0 1px 3px var(--shadow);
        }
        .nav-actions { display: flex; align-items: center; gap: 12px; }
        .nav-time { font-size: 12px; color: var(--text-tertiary); font-variant-numeric: tabular-nums; }

        /* Theme Toggle */
        .theme-toggle {
            width: 36px; height: 36px; border-radius: 10px;
            background: var(--bg-secondary); border: 1px solid var(--border);
            color: var(--text-primary); cursor: pointer; font-size: 16px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
        }
        .theme-toggle:hover { background: var(--bg-tertiary); }

        /* Mobile hamburger menu */
        .mobile-menu-btn {
            display: none;
            width: 38px; height: 38px; border-radius: 10px;
            background: var(--bg-secondary); border: 1px solid var(--border);
            color: var(--text-primary); cursor: pointer;
            flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; padding: 8px;
        }
        .mobile-menu-btn span {
            display: block; width: 18px; height: 2px;
            background: currentColor; border-radius: 1px; transition: all 0.3s ease;
        }
        .mobile-menu-btn.active span:nth-child(1) { transform: rotate(45deg) translate(4px, 4px); }
        .mobile-menu-btn.active span:nth-child(2) { opacity: 0; }
        .mobile-menu-btn.active span:nth-child(3) { transform: rotate(-45deg) translate(4px, -4px); }

        /* Mobile Navigation Dropdown */
        .mobile-nav-menu {
            display: none; position: fixed; top: 56px; left: 0; right: 0;
            background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            flex-direction: column; padding: 8px 16px;
            z-index: 99; transform: translateY(-10px); opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        .mobile-nav-menu.active { transform: translateY(0); opacity: 1; pointer-events: auto; }
        [data-theme="light"] .mobile-nav-menu { background: rgba(245, 245, 247, 0.95); }
        .mobile-nav-menu .nav-tab {
            padding: 12px 16px; border-radius: 8px; font-size: 15px;
            display: block; width: 100%;
        }
        .mobile-nav-menu .nav-tab.active {
            background: var(--bg-tertiary); color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .nav-tabs { display: none; }
            .mobile-menu-btn { display: flex; }
            .mobile-nav-menu { display: flex; }
        }

        /* ==================== MAIN LAYOUT ==================== */
        .main {
            padding-top: 72px;
            min-height: 100vh;
        }

        .page-header {
            padding: 32px 24px 16px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .page-title {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
        }
        .page-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            max-width: 700px;
            line-height: 1.6;
        }

        /* ==================== RESEARCH DESK LAYOUT ==================== */
        .desk-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 0;
            max-width: 1400px;
            margin: 16px auto 0;
            padding: 0 24px;
            min-height: calc(100vh - 200px);
        }

        /* ==================== SCHEMA BROWSER (LEFT SIDEBAR) ==================== */
        .schema-sidebar {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px 0 0 12px;
            overflow-y: auto;
            max-height: calc(100vh - 180px);
            position: sticky;
            top: 72px;
        }
        .schema-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 2;
        }
        .schema-header h3 {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }
        .schema-search {
            width: 100%;
            padding: 8px 12px;
            margin: 12px 16px;
            width: calc(100% - 32px);
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;  /* min 16px prevents iOS auto-zoom on focus */
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s ease;
            touch-action: manipulation;
        }
        .schema-search:focus { border-color: var(--accent); }
        .schema-search::placeholder { color: var(--text-tertiary); }

        .schema-group {
            padding: 8px 0;
        }
        .schema-group-label {
            padding: 6px 16px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-tertiary);
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s ease;
        }
        .schema-group-label:hover { color: var(--text-secondary); }
        .schema-group-label .group-chevron {
            font-size: 8px;
            transition: transform 0.2s ease;
        }
        .schema-group.group-collapsed .schema-group-label .group-chevron {
            transform: rotate(-90deg);
        }
        .schema-group.group-collapsed .schema-item,
        .schema-group.group-collapsed .schema-columns {
            display: none;
        }
        .schema-item {
            padding: 6px 16px 6px 24px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .schema-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .schema-item .icon {
            font-size: 10px;
            opacity: 0.6;
        }
        .schema-item-dim .icon { color: var(--accent-teal); }
        .schema-item-fact .icon { color: var(--accent-orange); }
        .schema-item-ref .icon { color: var(--accent-green); }
        .schema-item-cluster .icon { color: var(--accent-purple); }
        .schema-item-view .icon { color: var(--accent-yellow); }
        .schema-item .row-count {
            margin-left: auto;
            font-size: 10px;
            color: var(--text-tertiary);
        }

        /* ---- Interactive Schema Browser (TKT-175) ---- */
        .schema-item .chevron {
            font-size: 8px;
            transition: transform 0.2s ease;
            color: var(--text-tertiary);
            flex-shrink: 0;
        }
        .schema-item.expanded .chevron {
            transform: rotate(90deg);
        }
        .schema-item .table-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .schema-item .query-btn {
            display: none;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            background: var(--accent);
            color: #fff;
            border: none;
            cursor: pointer;
            flex-shrink: 0;
            line-height: 1.4;
            transition: opacity 0.15s ease;
        }
        .schema-item:hover .query-btn {
            display: inline-block;
        }
        .schema-columns {
            display: none;
            padding: 2px 0 6px 0;
            background: rgba(0,0,0,0.1);
            border-bottom: 1px solid var(--border);
        }
        [data-theme="light"] .schema-columns {
            background: rgba(0,0,0,0.02);
        }
        .schema-columns.visible {
            display: block;
        }
        .schema-col-item {
            padding: 3px 16px 3px 40px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.12s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .schema-col-item:hover {
            background: rgba(10, 132, 255, 0.08);
            color: var(--text-primary);
        }
        .schema-col-item .col-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .schema-col-item .col-type {
            font-size: 9px;
            font-weight: 600;
            padding: 1px 5px;
            border-radius: 3px;
            flex-shrink: 0;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .schema-col-item .col-type.type-varchar { background: rgba(10, 132, 255, 0.12); color: var(--accent); }
        .schema-col-item .col-type.type-bigint { background: rgba(255, 159, 10, 0.12); color: var(--accent-orange); }
        .schema-col-item .col-type.type-hugeint { background: rgba(255, 159, 10, 0.12); color: var(--accent-orange); }
        .schema-col-item .col-type.type-integer { background: rgba(255, 159, 10, 0.12); color: var(--accent-orange); }
        .schema-col-item .col-type.type-double { background: rgba(48, 209, 88, 0.12); color: var(--accent-green); }
        .schema-col-item .col-type.type-boolean { background: rgba(191, 90, 242, 0.12); color: var(--accent-purple); }
        .schema-col-item .col-type.type-default { background: rgba(142, 142, 147, 0.12); color: var(--text-tertiary); }
        .schema-col-item .col-desc {
            display: none;
        }
        .schema-col-item:hover .col-desc {
            display: none; /* Use tooltip instead */
        }

        /* ---- Example Card Enhancements (TKT-176) ---- */
        .example-card-category.phase { background: rgba(100, 210, 255, 0.15); color: var(--accent-teal); }
        .example-card-category.ipl2026 { background: rgba(255, 55, 95, 0.15); color: var(--accent-pink); }
        .example-card-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 8px;
            font-family: inherit;
        }
        .example-card p {
            font-size: 11px;
            color: var(--text-tertiary);
            line-height: 1.4;
            font-family: 'JetBrains Mono', monospace;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .example-card .load-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--accent);
            color: #fff;
            transition: all 0.15s ease;
        }
        .example-card .load-btn:hover {
            background: #0977e6;
        }

        /* ==================== MAIN WORKSPACE ==================== */
        .workspace {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-left: none;
            border-radius: 0 12px 12px 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        /* ---- Natural Language Search Bar ---- */
        .nl-search-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }
        .nl-search-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 16px;
            transition: border-color 0.2s ease;
        }
        .nl-search-bar:focus-within { border-color: var(--accent); }
        .nl-search-icon { font-size: 16px; color: var(--text-tertiary); }
        .nl-search-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 16px;  /* min 16px prevents iOS auto-zoom on focus */
            font-family: inherit;
            outline: none;
            touch-action: manipulation;
        }
        .nl-search-input::placeholder { color: var(--text-tertiary); }
        .nl-search-hint {
            font-size: 11px;
            color: var(--text-tertiary);
            padding: 6px 0 0 28px;
        }
        .nl-search-hint kbd {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1px 5px;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* ---- SQL Editor Area ---- */
        .sql-editor-section {
            padding: 0;
            border-bottom: 1px solid var(--border);
        }
        .editor-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }
        [data-theme="light"] .editor-toolbar {
            background: rgba(0,0,0,0.02);
        }
        .editor-toolbar-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .editor-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
        }
        .editor-toolbar-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .editor-btn {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .editor-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }
        .editor-btn.run-btn {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        .editor-btn.run-btn:hover {
            background: #0977e6;
            border-color: #0977e6;
        }
        .sql-editor-wrapper {
            position: relative;
            min-height: 160px;
            max-height: 300px;
        }
        .sql-editor-placeholder {
            width: 100%;
            min-height: 160px;
            max-height: 300px;
            padding: 16px 20px;
            background: var(--bg-primary);
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            border: none;
            outline: none;
            resize: vertical;
            tab-size: 2;
        }
        [data-theme="light"] .sql-editor-placeholder {
            background: #f8f9fa;
        }

        /* ---- Results Panel ---- */
        .results-section {
            padding: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 200px;
        }
        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }
        [data-theme="light"] .results-header {
            background: rgba(0,0,0,0.02);
        }
        .results-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
        }
        .results-meta {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        .results-table-wrapper {
            overflow: auto;
            flex: 1;
            max-height: 400px;
        }
        .results-table {
            min-width: 100%;
            width: max-content;
            border-collapse: collapse;
            font-size: 12px;
        }
        .results-table th {
            position: sticky;
            top: 0;
            background: var(--bg-tertiary);
            padding: 8px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        .results-table th:hover { color: var(--accent); }
        .results-table th .sort-icon { margin-left: 4px; font-size: 10px; opacity: 0.4; }
        .results-table td {
            padding: 6px 12px;
            border-bottom: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-primary);
            white-space: normal;
            word-break: break-word;
            max-width: 320px;
        }
        .results-table tr:nth-child(even) {
            background: var(--glass);
        }
        .results-table tr:hover {
            background: rgba(10, 132, 255, 0.08);
        }
        .results-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 20px;
            color: var(--text-tertiary);
            text-align: center;
        }
        .results-empty-icon { font-size: 36px; margin-bottom: 12px; opacity: 0.4; }
        .results-empty-text { font-size: 14px; margin-bottom: 4px; }
        .results-empty-hint { font-size: 12px; color: var(--text-tertiary); }

        /* ---- Andy Flower Insights Card ---- */
        .insights-section {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
        }
        .insight-card {
            background: linear-gradient(135deg, rgba(10, 132, 255, 0.08) 0%, rgba(191, 90, 242, 0.06) 100%);
            border: 1px solid rgba(10, 132, 255, 0.15);
            border-radius: 12px;
            padding: 16px 20px;
        }
        .insight-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .insight-card-header .icon { font-size: 20px; }
        .insight-card-header h4 {
            font-size: 13px;
            font-weight: 700;
            color: var(--accent);
        }
        .insight-card-header .badge {
            margin-left: auto;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(10, 132, 255, 0.15);
            color: var(--accent);
            font-weight: 600;
        }
        .insight-card p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* ---- Example Queries Gallery ---- */
        .examples-section {
            padding: 20px;
            border-top: 1px solid var(--border);
        }
        .examples-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }
        .examples-header h3 {
            font-size: 14px;
            font-weight: 700;
        }
        .examples-filter {
            display: flex;
            gap: 4px;
        }
        .examples-filter-btn {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        .examples-filter-btn:hover,
        .examples-filter-btn.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 10px;
        }
        .example-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .example-card:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }
        .example-card-category {
            display: inline-block;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 6px;
        }
        .example-card-category.batting { background: rgba(10, 132, 255, 0.15); color: var(--accent); }
        .example-card-category.bowling { background: rgba(255, 69, 58, 0.15); color: var(--accent-red); }
        .example-card-category.team { background: rgba(48, 209, 88, 0.15); color: var(--accent-green); }
        .example-card-category.leaderboard { background: rgba(255, 214, 10, 0.15); color: var(--accent-yellow); }
        .example-card-category.matchup { background: rgba(191, 90, 242, 0.15); color: var(--accent-purple); }
        .example-card h4 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .example-card p {
            font-size: 11px;
            color: var(--text-tertiary);
            line-height: 1.4;
            font-family: 'JetBrains Mono', monospace;
        }

        /* ==================== LOADING OVERLAY ==================== */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            transition: opacity 0.5s ease;
        }
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
            display: none;
        }
        .loading-icon { font-size: 48px; }
        .loading-title {
            font-size: 20px;
            font-weight: 700;
        }
        .loading-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .loading-progress-container {
            width: 320px;
            max-width: 80vw;
        }
        .loading-progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }
        .loading-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-purple) 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .loading-progress-text {
            text-align: center;
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 8px;
        }
        .loading-steps {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 12px;
        }
        .loading-step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-tertiary);
        }
        .loading-step.active { color: var(--accent); }
        .loading-step.done { color: var(--accent-green); }
        .loading-step .check { font-size: 14px; }

        /* ==================== STATUS BAR ==================== */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 11px;
            color: var(--text-tertiary);
            z-index: 100;
        }
        .status-bar-left, .status-bar-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-green);
        }
        .status-dot.loading {
            background: var(--accent-yellow);
            animation: pulse 1.5s ease infinite;
        }
        .status-dot.error { background: var(--accent-red); }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ==================== FOOTER ==================== */
        .footer {
            padding: 40px 24px 52px;
            text-align: center;
            border-top: 1px solid var(--border);
        }
        .footer-text { font-size: 12px; color: var(--text-tertiary); }
        .footer a { color: var(--accent); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .desk-container {
                grid-template-columns: 1fr;
                padding: 0 12px;
            }
            .schema-sidebar {
                border-radius: 12px 12px 0 0;
                max-height: none;
                position: static;
            }
            .schema-sidebar.collapsed .schema-group { display: none; }
            .schema-sidebar.collapsed .schema-search { display: none; }
            .workspace {
                border-left: 1px solid var(--border);
                border-radius: 0 0 12px 12px;
            }
            .page-header { padding: 20px 12px 12px; }
            .page-title { font-size: 24px; }
            .examples-grid { grid-template-columns: 1fr; }
            .mobile-nav-menu .nav-tab { min-height: 44px; }
        }
        @media (max-width: 480px) {
            .page-title { font-size: 20px; }
            .page-subtitle { font-size: 13px; }
            .editor-toolbar { flex-wrap: wrap; gap: 6px; }
            .nl-search-bar { padding: 8px 12px; }
        }

        /* ==================== CODEMIRROR OVERRIDES (TKT-174) ==================== */
        .sql-editor-wrapper .cm-editor {
            min-height: 160px;
            max-height: 300px;
            overflow-y: auto;
        }
        .sql-editor-wrapper .cm-editor.cm-focused {
            outline: none;
        }
        .sql-editor-wrapper .cm-scroller {
            overflow: auto;
        }

        /* ---- Pagination Controls (TKT-174) ---- */
        .results-pagination {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 8px 20px;
            border-top: 1px solid var(--border);
            background: rgba(0,0,0,0.15);
            font-size: 12px;
            color: var(--text-secondary);
        }
        .results-pagination.visible { display: flex; }
        [data-theme="light"] .results-pagination { background: rgba(0,0,0,0.02); }
        .results-pagination-info {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-tertiary);
        }
        .results-pagination-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .pagination-btn {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            transition: all 0.15s ease;
        }
        .pagination-btn:hover:not(:disabled) {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }
        .pagination-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .pagination-btn.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        /* ---- Column Resize Handle (TKT-174) ---- */
        .results-table th { position: relative; }
        .col-resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: col-resize;
            background: transparent;
            z-index: 3;
        }
        .col-resize-handle:hover,
        .col-resize-handle.resizing { background: var(--accent); }

        /* ---- Sort Indicators (TKT-174) ---- */
        .results-table th.sorted-asc .sort-icon,
        .results-table th.sorted-desc .sort-icon { opacity: 1; color: var(--accent); }

        /* ---- Query History Dropdown (TKT-174) ---- */
        .query-history-wrapper { position: relative; }
        .query-history-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            right: 0;
            width: 420px;
            max-height: 320px;
            overflow-y: auto;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 8px 32px var(--shadow);
            z-index: 50;
            padding: 4px;
        }
        .query-history-dropdown.open { display: block; }
        .query-history-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s ease;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-bottom: 1px solid var(--border);
        }
        .query-history-item:last-child { border-bottom: none; }
        .query-history-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .query-history-empty {
            padding: 16px;
            text-align: center;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* ---- Editor Shortcuts Hint (TKT-174) ---- */
        .editor-shortcuts-hint {
            padding: 4px 20px 6px;
            font-size: 10px;
            color: var(--text-tertiary);
            background: rgba(0,0,0,0.1);
            border-top: 1px solid var(--border);
        }
        [data-theme="light"] .editor-shortcuts-hint { background: rgba(0,0,0,0.02); }
        .editor-shortcuts-hint kbd {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 0px 4px;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
        }

        @media (max-width: 768px) {
            .query-history-dropdown { width: 280px; }
        }

        /* ==================== ENHANCED MOBILE RESPONSIVE ==================== */

        /* Mobile schema toggle button */
        .schema-toggle-btn {
            display: none;
            position: fixed;
            bottom: 48px;
            left: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            z-index: 90;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px var(--shadow);
            transition: all 0.2s ease;
        }
        .schema-toggle-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        /* Schema sidebar overlay for mobile */
        .schema-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .schema-overlay.active { display: block; }

        /* Tablet breakpoint enhancements */
        @media (max-width: 768px) {
            /* Show mobile schema toggle */
            .schema-toggle-btn { display: flex; }

            /* Schema sidebar: fixed overlay on mobile */
            .schema-sidebar {
                position: fixed;
                left: -300px;
                top: 0;
                bottom: 0;
                z-index: 1000;
                width: 280px;
                max-height: 100vh;
                border-radius: 0 12px 12px 0;
                transition: left 0.3s ease;
                background: var(--bg-secondary);
                border-right: 1px solid var(--border);
            }
            .schema-sidebar.open {
                left: 0;
            }

            /* Main content: full width */
            .workspace {
                border-left: 1px solid var(--border);
                border-radius: 12px;
            }

            /* Status bar: smaller text */
            .status-bar { font-size: 11px; padding: 0 12px; }
            .status-bar-left, .status-bar-right { gap: 8px; }

            /* Examples: single column */
            .examples-grid { grid-template-columns: 1fr !important; }
            .examples-filter { flex-wrap: wrap; }

            /* Editor adjustments */
            .nl-search-section { padding: 12px; }
            .insights-section { padding: 12px; }
            .examples-section { padding: 12px; }

            /* Results pagination */
            .results-pagination { flex-wrap: wrap; gap: 8px; padding: 8px 12px; }
            .results-pagination-controls { flex-wrap: wrap; justify-content: center; }
        }

        /* Phone breakpoint enhancements */
        @media (max-width: 480px) {
            /* Editor toolbar: wrap buttons */
            .editor-toolbar { flex-wrap: wrap; gap: 4px; padding: 6px 12px; }
            .editor-toolbar-left, .editor-toolbar-right { gap: 4px; }
            .editor-btn { font-size: 11px; padding: 5px 8px; }

            /* Results table: smaller font */
            .results-table { font-size: 11px; }
            .results-table th { font-size: 10px; padding: 6px 8px; }
            .results-table td { font-size: 11px; padding: 5px 8px; }

            /* Pagination: wrap and center */
            .results-pagination { justify-content: center; }
            .results-pagination-controls { flex-wrap: wrap; justify-content: center; gap: 4px; }
            .pagination-btn { padding: 4px 8px; font-size: 10px; }

            /* NL search bar: compact */
            .nl-search-bar { padding: 8px 10px; gap: 6px; }
            .nl-search-input { font-size: 16px; }  /* keep 16px ‚Äî below triggers iOS auto-zoom */
            .nl-search-hint { padding: 4px 0 0 0; font-size: 10px; }

            /* Insight card: compact */
            .insight-card { padding: 12px 14px; }

            /* Schema toggle position */
            .schema-toggle-btn { bottom: 44px; left: 12px; width: 42px; height: 42px; font-size: 18px; }

            /* Editor shortcuts hint */
            .editor-shortcuts-hint { display: none; }
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    <div class="bg-grid"></div>

    <!-- Mobile Schema Browser Toggle -->
    <button type="button" class="schema-toggle-btn" id="schema-toggle-btn" onclick="toggleSchemaSidebar()" title="Toggle Schema Browser">&#9776;</button>
    <div class="schema-overlay" id="schema-overlay" onclick="toggleSchemaSidebar()"></div>

    <!-- Loading Overlay (TKT-173 will wire up actual logic) -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-icon">üé¨</div>
        <div class="loading-title">Setting Up The Film Room</div>
        <div class="loading-subtitle">Cuing up the game tape...</div>
        <div class="loading-progress-container">
            <div class="loading-progress-bar">
                <div class="loading-progress-fill" id="loading-progress" style="width: 0%"></div>
            </div>
            <div class="loading-progress-text" id="loading-progress-text">Coach is grabbing the remote...</div>
        </div>
        <div class="loading-steps">
            <div class="loading-step active" id="step-engine">
                <span class="check">...</span> Firing up the analytics engine
            </div>
            <div class="loading-step" id="step-tables">
                <span class="check">...</span> Loading 15 scouting reports
            </div>
            <div class="loading-step" id="step-views">
                <span class="check">...</span> Building 52 play diagrams
            </div>
            <div class="loading-step" id="step-ready">
                <span class="check">...</span> Film Room ready ‚Äî play ball
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-brand">
            <div class="nav-logo">üèè</div>
            <div class="nav-title">Cricket <span>Playbook</span></div>
        </div>
        <div class="nav-tabs">
            <a href="index.html" class="nav-tab">Home</a>
            <a href="teams.html" class="nav-tab">Teams</a>
            <a href="artifacts.html" class="nav-tab">Artifacts</a>
            <a href="analysis.html" class="nav-tab">Analysis</a>
            <a href="research.html" class="nav-tab">Research</a>
            <a href="research-desk.html" class="nav-tab active">The Film Room</a>
            <a href="about.html" class="nav-tab">About</a>
        </div>
        <div class="nav-actions">
            <span class="nav-time" id="navTime">--:--:--</span>
            <button type="button" class="mobile-menu-btn" onclick="toggleMobileMenu()" title="Menu">
                <span></span><span></span><span></span>
            </button>
            <button type="button" class="theme-toggle" onclick="toggleTheme()">üåô</button>
        </div>
    </nav>

    <!-- Mobile Navigation Menu -->
    <div class="mobile-nav-menu" id="mobile-nav-menu">
        <a href="index.html" class="nav-tab">üè† Home</a>
        <a href="teams.html" class="nav-tab">üèè Teams</a>
        <a href="artifacts.html" class="nav-tab">üîç Artifacts</a>
        <a href="analysis.html" class="nav-tab">üî¨ Analysis</a>
        <a href="research.html" class="nav-tab">üìö Research</a>
        <a href="research-desk.html" class="nav-tab active">üé¨ The Film Room</a>
        <a href="about.html" class="nav-tab">üåπ About</a>
    </div>

    <main class="main">
        <header class="page-header">
            <div class="typewriter-container">
                <h1 class="page-title">üé¨ The Film Room</h1>
            </div>
            <p class="page-tagline" style="font-size: 17px; font-weight: 600; color: var(--accent); margin-bottom: 8px; font-style: italic;">
                "Where coaches break down the game, one query at a time"
            </p>
            <p class="page-subtitle">
                Every delivery. Every match. Every season. Pull up the tape on any player, team, or matchup
                across IPL history. The playbook is open ‚Äî run your own plays.
            </p>
        </header>

        <div class="desk-container">
            <!-- Schema Browser (Left Sidebar) ‚Äî TKT-175: Interactive -->
            <aside class="schema-sidebar" id="schema-browser">
                <div class="schema-header">
                    <h3>Schema Browser</h3>
                    <span class="has-tooltip has-tooltip-below" data-tooltip="Click to expand columns. Click a column to insert into editor.">
                        <span class="help-icon">?</span>
                    </span>
                </div>
                <input type="text" class="schema-search" placeholder="Search tables, views & columns..." id="schema-search" autocomplete="off">
                <!-- Schema groups will be rendered dynamically by TKT-175 JS -->
                <div id="schema-groups-container"></div>
            </aside>

            <!-- Main Workspace -->
            <div class="workspace">
                <!-- Natural Language Search (TKT-177) -->
                <div class="nl-search-section" id="nl-search-bar">
                    <div class="nl-search-bar">
                        <span class="nl-search-icon">&#128269;</span>
                        <input type="text" class="nl-search-input" placeholder="'Kohli stats', 'Bumrah year wise', 'Kohli at Chinnaswamy', 'top 10 batsmen', 'CSK squad'..." id="nl-search-input" autocomplete="off" enterkeyhint="search">
                        <button type="button" class="nl-search-btn" id="nl-search-btn" title="Search" style="
                            padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 600;
                            cursor: pointer; border: 1px solid var(--accent); background: var(--accent);
                            color: #fff; transition: all 0.2s ease; white-space: nowrap;
                        " onclick="handleNLSearch()">&#9654; Ask</button>
                    </div>
                    <div class="nl-search-hint">
                        <kbd>Enter</kbd> to search &middot; Try: <em>[name] stats</em> &middot; <em>[name] year wise</em> &middot; <em>[name] at [venue]</em> &middot; <em>[name] vs [name/team]</em> &middot; <em>top N [batsmen/bowlers]</em>
                    </div>
                </div>

                <!-- SQL Editor ‚Äî TKT-174 will wire up CodeMirror -->
                <div class="sql-editor-section" id="sql-editor">
                    <div class="editor-toolbar">
                        <div class="editor-toolbar-left">
                            <span class="editor-label">SQL Editor</span>
                        </div>
                        <div class="editor-toolbar-right">
                            <!-- Query History (TKT-174) -->
                            <div class="query-history-wrapper">
                                <button type="button" class="editor-btn" id="history-button" title="Query history">
                                    &#128338; History
                                </button>
                                <div class="query-history-dropdown" id="query-history-dropdown">
                                    <div class="query-history-empty">No query history yet</div>
                                </div>
                            </div>
                            <button type="button" class="editor-btn run-btn" id="run-button" title="Run query (Ctrl+Enter)">
                                &#9654; Run
                            </button>
                            <button type="button" class="editor-btn" id="copy-button" title="Copy SQL to clipboard">
                                üìã Copy
                            </button>
                            <button type="button" class="editor-btn" id="export-button" title="Export results as CSV">
                                üíæ Export
                            </button>
                        </div>
                    </div>
                    <div class="sql-editor-wrapper" id="sql-editor-wrapper">
                        <textarea class="sql-editor-placeholder" id="sql-editor-textarea"
                            placeholder="-- Write your SQL query here...&#10;-- Example: SELECT * FROM analytics_ipl_batting_career LIMIT 10;&#10;&#10;"
                            spellcheck="false">SELECT
  player_name,
  runs,
  balls_faced,
  strike_rate,
  average
FROM analytics_ipl_batting_career
ORDER BY runs DESC
LIMIT 20;</textarea>
                    </div>
                    <!-- Keyboard shortcuts hint (TKT-174) -->
                    <div class="editor-shortcuts-hint">
                        <kbd>Ctrl+Enter</kbd> Run &middot;
                        <kbd>Ctrl+L</kbd> Clear &middot;
                        <kbd>Ctrl+/</kbd> Comment &middot;
                        <kbd>Ctrl+Space</kbd> Autocomplete
                    </div>
                </div>

                <!-- Results Panel ‚Äî TKT-174 will wire up interactivity -->
                <div class="results-section" id="results-panel">
                    <div class="results-header">
                        <span class="results-label">Results</span>
                        <span class="results-meta" id="results-meta">Run a query to see results</span>
                    </div>
                    <div class="results-table-wrapper" id="results-table-wrapper">
                        <div class="results-empty">
                            <div class="results-empty-icon">üìä</div>
                            <div class="results-empty-text">No results yet</div>
                            <div class="results-empty-hint">Write a SQL query above and click Run, or choose an example query below</div>
                        </div>
                    </div>
                    <!-- Pagination (TKT-174) -->
                    <div class="results-pagination" id="results-pagination">
                        <span class="results-pagination-info" id="pagination-info">Showing 0 rows</span>
                        <div class="results-pagination-controls" id="pagination-controls"></div>
                    </div>
                </div>

                <!-- The First Take (formerly Andy Flower Insights) ‚Äî TKT-177 will wire up -->
                <div class="insights-section" id="andy-flower-insights">
                    <div class="insight-card">
                        <div class="insight-card-header">
                            <span class="icon">üèè</span>
                            <h4>The First Take</h4>
                            <span class="badge">Cricket Context</span>
                        </div>
                        <p class="insight-subtitle" style="font-size: 13px; font-style: italic; color: var(--text-secondary); margin-bottom: 8px;">
                            "Stephen A. wished he had this data before going on air"
                        </p>
                        <p>
                            Run a query to receive cricket context from Andy Flower, our domain expert.
                            He'll provide tactical interpretation of your results, highlight key trends,
                            and suggest related queries to deepen your analysis.
                        </p>
                    </div>
                </div>

                <!-- Example Queries Gallery (TKT-176: 17 curated queries) -->
                <div class="examples-section" id="example-queries">
                    <div class="examples-header">
                        <h3>Example Queries</h3>
                        <div class="examples-filter">
                            <button type="button" class="examples-filter-btn active" data-filter="all">All</button>
                            <button type="button" class="examples-filter-btn" data-filter="leaderboard">Leaderboard</button>
                            <button type="button" class="examples-filter-btn" data-filter="batting">Batting</button>
                            <button type="button" class="examples-filter-btn" data-filter="bowling">Bowling</button>
                            <button type="button" class="examples-filter-btn" data-filter="team">Team</button>
                            <button type="button" class="examples-filter-btn" data-filter="matchup">Matchup</button>
                            <button type="button" class="examples-filter-btn" data-filter="phase">Phase</button>
                            <button type="button" class="examples-filter-btn" data-filter="pressure">Pressure</button>
                            <button type="button" class="examples-filter-btn" data-filter="ipl2026">IPL 2026</button>
                        </div>
                    </div>
                    <div class="examples-grid" id="examples-grid">
                        <!-- Cards rendered by TKT-176 JS -->
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p class="footer-text">
                Cricket Playbook ‚Äî The Film Room | EPIC-012 | Powered by DuckDB-WASM | <a href="https://github.com/dwijesh-r/cricket-playbook" target="_blank">View on GitHub</a>
            </p>
        </footer>
    </main>

    <!-- Status Bar ‚Äî TKT-173 will wire up live stats -->
    <div class="status-bar" id="db-status-bar">
        <div class="status-bar-left">
            <div class="status-indicator">
                <span class="status-dot loading" id="status-dot"></span>
                <span id="status-text">Setting up...</span>
            </div>
        </div>
        <div class="status-bar-right">
            <span>15 scouting reports</span>
            <span>&middot;</span>
            <span>52 play diagrams</span>
            <span>&middot;</span>
            <span>Every IPL delivery</span>
        </div>
    </div>

    <!-- Global form submission blocker: prevent any accidental page reloads on mobile -->
    <script>
        document.addEventListener('submit', function(e) { e.preventDefault(); return false; }, true);
    </script>

    <!-- Safety timeout: if module fails to load, show error instead of infinite spinner -->
    <script>
        window._filmRoomReady = false;
        setTimeout(function() {
            if (!window._filmRoomReady) {
                var overlay = document.getElementById('loading-overlay');
                var progressText = document.getElementById('loading-progress-text');
                if (overlay && !overlay.classList.contains('hidden')) {
                    if (progressText) progressText.textContent = 'Loading timed out ‚Äî a CDN dependency may be unreachable. Check browser console (F12) for details.';
                    var btn = document.createElement('button');
                    btn.textContent = 'Dismiss & Browse Page';
                    btn.style.cssText = 'margin-top:16px;padding:10px 24px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:13px;font-weight:600;';
                    btn.onclick = function() { overlay.classList.add('hidden'); };
                    overlay.querySelector('.loading-steps').insertAdjacentElement('afterend', btn);
                }
            }
        }, 25000);
    </script>

    <!-- Main Application Module (TKT-173 DuckDB + TKT-174 CodeMirror & Enhancements) -->
    <script type="module">
        /* ==================== THEME ==================== */
        window.toggleTheme = function() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            document.querySelector('.theme-toggle').textContent = newTheme === 'dark' ? '\u{1F319}' : '\u{2600}\u{FE0F}';
        };

        /* ==================== MOBILE MENU ==================== */
        window.toggleMobileMenu = function() {
            const menu = document.getElementById('mobile-nav-menu');
            const btn = document.querySelector('.mobile-menu-btn');
            menu.classList.toggle('active');
            btn.classList.toggle('active');
        };

        /* ==================== INIT ==================== */
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.querySelector('.theme-toggle').textContent = savedTheme === 'dark' ? '\u{1F319}' : '\u{2600}\u{FE0F}';

        // Timer - User's local timezone
        function updateTime() {
            document.getElementById('navTime').textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
        }
        updateTime();
        setInterval(updateTime, 1000);

        /* ==================== UTILITY: escapeHtml (must be defined before usage) ==================== */
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        function escapeAttr(str) {
            return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        /* ==================== UTILITY: escapeSql ‚Äî doubles single quotes to prevent SQL injection ==================== */
        function escapeSql(str) {
            return str.replace(/'/g, "''");
        }

        /* ==================== CODEMIRROR REMOVED ‚Äî TEXTAREA FALLBACK (TKT-174) ==================== */
        /* CodeMirror 6 removed: 8 CDN ESM imports caused page-blocking hangs on GitHub Pages.
           The textarea works reliably. CodeMirror can be re-added later via a bundled build. */

        /* ---- Textarea keyboard shortcut: Ctrl+Enter to run ---- */
        document.getElementById('sql-editor-textarea').addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                if (window.executeQuery) window.executeQuery();
            }
        });

        // Helper: get SQL from textarea
        function getEditorSQL() {
            return document.getElementById('sql-editor-textarea').value;
        }

        // Helper: set SQL in textarea
        function setEditorSQL(sqlText) {
            document.getElementById('sql-editor-textarea').value = sqlText;
        }

        function clearEditor() {
            setEditorSQL('');
            document.getElementById('sql-editor-textarea').focus();
        }

        /* ==================== QUERY HISTORY (TKT-174) ==================== */
        const HISTORY_KEY = 'cricket_playbook_query_history';
        const MAX_HISTORY = 10;

        function getQueryHistory() {
            try {
                return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            } catch { return []; }
        }

        function saveQueryHistory(sqlText) {
            const trimmed = sqlText.trim();
            if (!trimmed) return;
            let history = getQueryHistory();
            // Remove duplicate if exists
            history = history.filter(h => h.sql !== trimmed);
            // Add to front
            history.unshift({ sql: trimmed, timestamp: Date.now() });
            // Cap at MAX_HISTORY
            if (history.length > MAX_HISTORY) history = history.slice(0, MAX_HISTORY);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }

        function renderQueryHistoryDropdown() {
            const dropdown = document.getElementById('query-history-dropdown');
            const history = getQueryHistory();
            if (history.length === 0) {
                dropdown.innerHTML = '<div class="query-history-empty">No query history yet</div>';
                return;
            }
            let html = '';
            for (const entry of history) {
                const timeStr = new Date(entry.timestamp).toLocaleString('en-US', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                const preview = entry.sql.replace(/\n/g, ' ').substring(0, 80);
                html += `<div class="query-history-item" data-sql="${escapeAttr(entry.sql)}" title="${escapeAttr(entry.sql)}">
                    ${escapeHtml(preview)}${entry.sql.length > 80 ? '...' : ''}
                    <div style="font-size:10px;color:var(--text-tertiary);margin-top:2px;">${timeStr}</div>
                </div>`;
            }
            dropdown.innerHTML = html;

            // Wire click handlers
            dropdown.querySelectorAll('.query-history-item').forEach(item => {
                item.addEventListener('click', function() {
                    setEditorSQL(this.getAttribute('data-sql'));
                    dropdown.classList.remove('open');
                    document.getElementById('sql-editor-textarea').focus();
                    document.getElementById('sql-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
            });
        }

        // History button toggle
        document.getElementById('history-button').addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('query-history-dropdown');
            renderQueryHistoryDropdown();
            dropdown.classList.toggle('open');
        });

        // Close dropdown on outside click
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('query-history-dropdown');
            if (!e.target.closest('.query-history-wrapper')) {
                dropdown.classList.remove('open');
            }
        });

        /* ==================== RESULTS PANEL ENHANCEMENTS (TKT-174) ==================== */
        const PAGE_SIZE = 50;
        let currentPage = 0;
        let sortColumn = null;
        let sortDirection = 'asc'; // 'asc' or 'desc'
        let currentResultColumns = [];
        let currentResultRows = [];
        let currentElapsed = '0';

        function renderResultsPage() {
            const resultsWrapper = document.getElementById('results-table-wrapper');
            const paginationEl = document.getElementById('results-pagination');
            const paginationInfo = document.getElementById('pagination-info');
            const paginationControls = document.getElementById('pagination-controls');
            const resultsMeta = document.getElementById('results-meta');

            const columns = currentResultColumns;
            let rows = [...currentResultRows];
            const totalRows = rows.length;

            if (totalRows === 0) {
                paginationEl.classList.remove('visible');
                resultsWrapper.innerHTML = `
                    <div class="results-empty">
                        <div class="results-empty-icon">\u{1F4CB}</div>
                        <div class="results-empty-text">Query returned 0 rows</div>
                        <div class="results-empty-hint">Executed in ${currentElapsed}s</div>
                    </div>`;
                resultsMeta.textContent = `0 rows \u00B7 ${currentElapsed}s`;
                return;
            }

            // Sort if applicable
            if (sortColumn !== null && columns[sortColumn] !== undefined) {
                const colName = columns[sortColumn];
                rows.sort((a, b) => {
                    let va = a[colName], vb = b[colName];
                    if (va === null || va === undefined) va = '';
                    if (vb === null || vb === undefined) vb = '';
                    if (typeof va === 'number' && typeof vb === 'number') {
                        return sortDirection === 'asc' ? va - vb : vb - va;
                    }
                    const sa = String(va), sb = String(vb);
                    // Try numeric comparison
                    const na = parseFloat(sa), nb = parseFloat(sb);
                    if (!isNaN(na) && !isNaN(nb)) {
                        return sortDirection === 'asc' ? na - nb : nb - na;
                    }
                    return sortDirection === 'asc' ? sa.localeCompare(sb) : sb.localeCompare(sa);
                });
            }

            // Pagination
            const totalPages = Math.ceil(totalRows / PAGE_SIZE);
            if (currentPage >= totalPages) currentPage = totalPages - 1;
            if (currentPage < 0) currentPage = 0;
            const startIdx = currentPage * PAGE_SIZE;
            const endIdx = Math.min(startIdx + PAGE_SIZE, totalRows);
            const pageRows = rows.slice(startIdx, endIdx);

            // Update meta
            resultsMeta.textContent = `Showing ${(startIdx + 1).toLocaleString()}-${endIdx.toLocaleString()} of ${totalRows.toLocaleString()} rows \u00B7 ${currentElapsed}s`;

            // Build table
            let html = '<table class="results-table"><thead><tr>';
            html += '<th style="width:40px;text-align:right;min-width:40px;">#</th>';
            for (let ci = 0; ci < columns.length; ci++) {
                const sortClass = sortColumn === ci ? (sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc') : '';
                const sortIcon = sortColumn === ci ? (sortDirection === 'asc' ? '\u25B2' : '\u25BC') : '\u25B2';
                html += `<th class="${sortClass}" data-col-idx="${ci}" style="position:relative;">`;
                html += `${escapeHtml(columns[ci])}<span class="sort-icon">${sortIcon}</span>`;
                html += `<div class="col-resize-handle" data-col-idx="${ci}"></div>`;
                html += `</th>`;
            }
            html += '</tr></thead><tbody>';

            for (let i = 0; i < pageRows.length; i++) {
                html += '<tr>';
                html += `<td style="text-align:right;color:var(--text-tertiary);font-size:10px;">${startIdx + i + 1}</td>`;
                for (const col of columns) {
                    const val = pageRows[i][col];
                    const display = val === null || val === undefined
                        ? '<span style="color:var(--text-tertiary);font-style:italic">NULL</span>'
                        : escapeHtml(String(val));
                    html += `<td>${display}</td>`;
                }
                html += '</tr>';
            }
            html += '</tbody></table>';
            resultsWrapper.innerHTML = html;

            // Pagination controls
            if (totalPages > 1) {
                paginationEl.classList.add('visible');
                paginationInfo.textContent = `Showing ${(startIdx + 1).toLocaleString()}\u2013${endIdx.toLocaleString()} of ${totalRows.toLocaleString()} rows \u00B7 ${currentElapsed}s`;

                let ctrlHtml = '';
                ctrlHtml += `<button type="button" class="pagination-btn" id="pg-prev" ${currentPage === 0 ? 'disabled' : ''}>\u25C0 Prev</button>`;

                // Show page numbers (max 7 visible)
                const maxVisible = 7;
                let startPage = Math.max(0, currentPage - Math.floor(maxVisible / 2));
                let endPage = Math.min(totalPages, startPage + maxVisible);
                if (endPage - startPage < maxVisible) startPage = Math.max(0, endPage - maxVisible);

                if (startPage > 0) {
                    ctrlHtml += `<button type="button" class="pagination-btn" data-page="0">1</button>`;
                    if (startPage > 1) ctrlHtml += `<span style="color:var(--text-tertiary);padding:0 4px;">...</span>`;
                }

                for (let p = startPage; p < endPage; p++) {
                    ctrlHtml += `<button class="pagination-btn${p === currentPage ? ' active' : ''}" data-page="${p}">${p + 1}</button>`;
                }

                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) ctrlHtml += `<span style="color:var(--text-tertiary);padding:0 4px;">...</span>`;
                    ctrlHtml += `<button type="button" class="pagination-btn" data-page="${totalPages - 1}">${totalPages}</button>`;
                }

                ctrlHtml += `<button type="button" class="pagination-btn" id="pg-next" ${currentPage >= totalPages - 1 ? 'disabled' : ''}>Next \u25B6</button>`;
                paginationControls.innerHTML = ctrlHtml;

                // Wire pagination events
                document.getElementById('pg-prev')?.addEventListener('click', () => { currentPage--; renderResultsPage(); });
                document.getElementById('pg-next')?.addEventListener('click', () => { currentPage++; renderResultsPage(); });
                paginationControls.querySelectorAll('[data-page]').forEach(btn => {
                    btn.addEventListener('click', function() {
                        currentPage = parseInt(this.getAttribute('data-page'));
                        renderResultsPage();
                    });
                });
            } else {
                paginationEl.classList.remove('visible');
                // Show simple info for small result sets
            }

            // Wire sort click on column headers
            resultsWrapper.querySelectorAll('.results-table th[data-col-idx]').forEach(th => {
                th.addEventListener('click', function(e) {
                    if (e.target.classList.contains('col-resize-handle')) return; // Don't sort on resize
                    const idx = parseInt(this.getAttribute('data-col-idx'));
                    if (sortColumn === idx) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = idx;
                        sortDirection = 'asc';
                    }
                    currentPage = 0;
                    renderResultsPage();
                });
            });

            // Wire column resize
            wireColumnResize();
        }

        // ---- Column Resize (TKT-174) ----
        function wireColumnResize() {
            const handles = document.querySelectorAll('.col-resize-handle');
            handles.forEach(handle => {
                handle.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const th = this.parentElement;
                    const startX = e.pageX;
                    const startWidth = th.offsetWidth;
                    this.classList.add('resizing');

                    function onMouseMove(e2) {
                        const diff = e2.pageX - startX;
                        th.style.width = Math.max(40, startWidth + diff) + 'px';
                        th.style.minWidth = Math.max(40, startWidth + diff) + 'px';
                    }

                    function onMouseUp() {
                        handle.classList.remove('resizing');
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    }

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            });
        }

        /* ==================== DuckDB-WASM INITIALIZATION (TKT-173) ==================== */
        /* NOTE: DuckDB import is deferred to avoid top-level await blocking module evaluation.
           The import happens inside loadAndInitDuckDB() which is called at the bottom of this module. */
        let duckdb = null;

        // Global state
        let db = null;
        let conn = null;
        let lastQueryResults = null;
        let totalRowsLoaded = 0;

        // UI references
        const progressBar = document.getElementById('loading-progress');
        const progressText = document.getElementById('loading-progress-text');
        const overlay = document.getElementById('loading-overlay');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');

        // Table manifest - all 15 Parquet files
        const TABLE_FILES = [
            'dim_bowler_classification',
            'dim_franchise_alias',
            'dim_match',
            'dim_player',
            'dim_player_name_history',
            'dim_team',
            'dim_tournament',
            'dim_venue',
            'fact_ball',
            'fact_player_match_performance',
            'fact_powerplay',
            'ipl_2026_contracts',
            'ipl_2026_squads',
            'player_clusters_batters',
            'player_clusters_bowlers'
        ];

        function setLoadingStep(stepId, state) {
            const el = document.getElementById(stepId);
            if (!el) return;
            el.classList.remove('active', 'done');
            if (state === 'active') {
                el.classList.add('active');
                el.querySelector('.check').textContent = '...';
            } else if (state === 'done') {
                el.classList.add('done');
                el.querySelector('.check').textContent = '\u2713';
            }
        }

        function setProgress(pct, text) {
            progressBar.style.width = pct + '%';
            if (text) progressText.textContent = text;
        }

        function setStatus(state, text) {
            statusDot.classList.remove('loading', 'error');
            if (state === 'loading') statusDot.classList.add('loading');
            if (state === 'error') statusDot.classList.add('error');
            statusText.textContent = text;
        }

        // Detect mobile: small screen OR touch-only device
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || (window.innerWidth <= 768 && 'ontouchstart' in window);

        async function initDuckDB() {
            try {
                // Mobile: use httpfs (HTTP range requests) for large tables to avoid memory crashes
                // Desktop: load all tables into memory for maximum performance

                setLoadingStep('step-engine', 'active');
                setProgress(5, isMobile ? 'Mobile mode ‚Äî warming up engine...' : 'Warming up the analytics engine...');

                const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
                const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

                const worker_url = URL.createObjectURL(
                    new Blob([`importScripts("${bundle.mainWorker}");`], { type: 'text/javascript' })
                );

                const worker = new Worker(worker_url);
                const logger = new duckdb.ConsoleLogger();
                db = new duckdb.AsyncDuckDB(logger, worker);

                // SharedArrayBuffer requires COOP/COEP headers (not available on GitHub Pages)
                // Fall back to single-threaded mode gracefully
                const hasSAB = typeof SharedArrayBuffer !== 'undefined';
                try {
                    await db.instantiate(bundle.mainModule, hasSAB ? bundle.pthreadWorker : null);
                } catch (instantiateErr) {
                    console.warn('Multi-threaded init failed, falling back to single-threaded:', instantiateErr.message);
                    await db.instantiate(bundle.mainModule);
                }
                URL.revokeObjectURL(worker_url);

                conn = await db.connect();

                setLoadingStep('step-engine', 'done');
                setProgress(20, 'Engine ready ‚Äî loading the scouting data...');

                setLoadingStep('step-tables', 'active');
                const basePath = 'data/sql_lab/tables/';

                // fact_ball is ~14MB ‚Äî too large for mobile memory.
                // On mobile, use httpfs (HTTP range requests) so DuckDB fetches only the
                // column chunks needed per query (~200-500KB) instead of the full file.
                const HEAVY_TABLES = ['fact_ball'];

                for (let i = 0; i < TABLE_FILES.length; i++) {
                    const tableName = TABLE_FILES[i];
                    const filePath = basePath + tableName + '.parquet';
                    const pct = 20 + Math.round(((i + 1) / TABLE_FILES.length) * 50);
                    setProgress(pct, `Scouting ${tableName.replace(/_/g, ' ')}... ${i + 1}/${TABLE_FILES.length}`);

                    try {
                        if (isMobile && HEAVY_TABLES.includes(tableName)) {
                            // Mobile httpfs: register URL for HTTP range requests ‚Äî no full download
                            const fileUrl = new URL(filePath, window.location.href).href;
                            await db.registerFileURL(tableName + '.parquet', fileUrl, duckdb.DuckDBDataProtocol.HTTP, false);
                            await conn.query(`CREATE VIEW ${tableName} AS SELECT * FROM read_parquet('${tableName}.parquet')`);
                            const countResult = await conn.query(`SELECT count(*) AS cnt FROM ${tableName}`);
                            const rows = Number(countResult.toArray()[0].cnt);
                            totalRowsLoaded += rows;
                            console.log(`üì± ${tableName}: remote Parquet via httpfs (${rows} rows)`);
                        } else {
                            // Desktop (all tables) + Mobile (small tables): full load into memory
                            const response = await fetch(filePath);
                            if (!response.ok) throw new Error(`HTTP ${response.status} for ${filePath}`);
                            const buffer = new Uint8Array(await response.arrayBuffer());
                            await db.registerFileBuffer(tableName + '.parquet', buffer);
                            await conn.query(`CREATE TABLE ${tableName} AS SELECT * FROM read_parquet('${tableName}.parquet')`);
                            const countResult = await conn.query(`SELECT count(*) AS cnt FROM ${tableName}`);
                            const rows = Number(countResult.toArray()[0].cnt);
                            totalRowsLoaded += rows;
                        }
                    } catch (tableErr) {
                        console.error(`Failed to load table ${tableName}:`, tableErr);
                    }
                }

                setLoadingStep('step-tables', 'done');
                setProgress(70, `All scouting reports loaded ‚Äî ${formatRowCount(totalRowsLoaded)} data points`);

                setLoadingStep('step-views', 'active');
                setProgress(72, 'Drawing up the play diagrams...');

                let viewsCreated = 0;
                let viewsFailed = 0;

                try {
                    const viewsResponse = await fetch('data/sql_lab/views.sql');
                    if (!viewsResponse.ok) throw new Error(`HTTP ${viewsResponse.status} for views.sql`);
                    const viewsSql = await viewsResponse.text();
                    const viewStatements = viewsSql.split(/(?=CREATE OR REPLACE VIEW)/i).filter(s => s.trim().length > 0 && s.trim().startsWith('CREATE'));

                    for (let i = 0; i < viewStatements.length; i++) {
                        const stmt = viewStatements[i].trim();
                        if (!stmt) continue;
                        const cleanStmt = stmt.replace(/;\s*$/, '');
                        try {
                            await conn.query(cleanStmt);
                            viewsCreated++;
                        } catch (viewErr) {
                            viewsFailed++;
                            console.warn(`View creation failed: ${viewErr.message.substring(0, 120)}`);
                        }
                        if (i % 5 === 0) {
                            const pct = 72 + Math.round(((i + 1) / viewStatements.length) * 23);
                            setProgress(pct, `Building playbook page ${i + 1} of ${viewStatements.length}...`);
                        }
                    }
                } catch (viewsErr) {
                    console.error('Failed to load views.sql:', viewsErr);
                }

                setLoadingStep('step-views', 'done');
                setProgress(95, `${viewsCreated} play diagrams ready`);

                setLoadingStep('step-ready', 'active');
                setProgress(100, `Game time! ${formatRowCount(totalRowsLoaded)} data points loaded`);

                await new Promise(resolve => setTimeout(resolve, 600));

                setLoadingStep('step-ready', 'done');
                overlay.classList.add('hidden');

                setStatus('connected', 'Film Room Active');
                updateStatusBarStats(viewsCreated);
                document.getElementById('run-button').disabled = false;

                console.log(`The Film Room ready: ${TABLE_FILES.length} tables, ${viewsCreated} views, ${formatRowCount(totalRowsLoaded)} rows`);
                if (viewsFailed > 0) console.warn(`${viewsFailed} views failed to create`);

            } catch (err) {
                console.error('DuckDB initialization failed:', err);
                setStatus('error', 'Technical Timeout');
                progressText.textContent = 'The engine stalled: ' + err.message;
                statusDot.classList.remove('loading');
                statusDot.classList.add('error');

                const overlayEl = document.getElementById('loading-overlay');
                const dismissBtn = document.createElement('button');
                dismissBtn.textContent = 'Dismiss & Continue';
                dismissBtn.style.cssText = 'margin-top:16px;padding:8px 20px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:13px;font-weight:600;';
                dismissBtn.onclick = () => overlayEl.classList.add('hidden');
                overlayEl.appendChild(dismissBtn);
            }
        }

        function formatRowCount(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(0) + 'K';
            return String(n);
        }

        function updateStatusBarStats(viewCount) {
            const rightBar = document.querySelector('.status-bar-right');
            rightBar.innerHTML = `
                <span>${TABLE_FILES.length} scouting reports</span>
                <span>&middot;</span>
                <span>${viewCount} play diagrams</span>
                <span>&middot;</span>
                <span>${formatRowCount(totalRowsLoaded)} data points</span>
            `;
        }

        /* ==================== SQL QUERY EXECUTION (TKT-173, enhanced TKT-174) ==================== */
        async function executeQuery() {
            if (!conn) {
                showError('Database not connected. Please wait for initialization to complete.');
                return;
            }

            const sqlText = getEditorSQL().trim();
            if (!sqlText) {
                showError('Please enter a SQL query.');
                return;
            }

            const runBtn = document.getElementById('run-button');
            const resultsMeta = document.getElementById('results-meta');

            runBtn.disabled = true;
            runBtn.innerHTML = '&#9654; Running...';
            resultsMeta.textContent = 'Executing query...';

            const startTime = performance.now();

            try {
                const result = await conn.query(sqlText);
                const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);

                const rows = result.toArray().map(row => {
                    const obj = {};
                    for (const field of result.schema.fields) {
                        let val = row[field.name];
                        if (typeof val === 'bigint') val = Number(val);
                        obj[field.name] = val;
                    }
                    return obj;
                });

                const columns = result.schema.fields.map(f => f.name);

                // Store for export
                lastQueryResults = { columns, rows };

                // Save to query history (TKT-174)
                saveQueryHistory(sqlText);

                // Render with pagination (TKT-174)
                currentResultColumns = columns;
                currentResultRows = rows;
                currentElapsed = elapsed;
                currentPage = 0;
                sortColumn = null;
                sortDirection = 'asc';
                renderResultsPage();

            } catch (err) {
                const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
                showError(err.message, elapsed);
                document.getElementById('results-pagination').classList.remove('visible');
            } finally {
                runBtn.disabled = false;
                runBtn.innerHTML = '&#9654; Run';
            }
        }

        // Make executeQuery available globally so CodeMirror keymap can call it
        window.executeQuery = executeQuery;

        function showError(message, elapsed) {
            const resultsMeta = document.getElementById('results-meta');
            const resultsWrapper = document.getElementById('results-table-wrapper');

            resultsMeta.textContent = elapsed ? `Error \u00B7 ${elapsed}s` : 'Error';
            resultsWrapper.innerHTML = `
                <div class="results-empty" style="color: var(--accent-red);">
                    <div class="results-empty-icon">\u26A0\uFE0F</div>
                    <div class="results-empty-text" style="color: var(--accent-red); font-weight: 600;">Query Error</div>
                    <div class="results-empty-hint" style="color: var(--text-secondary); max-width: 600px; word-break: break-word; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.6; text-align: left; background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-top: 8px;">${escapeHtml(message)}</div>
                </div>`;
        }

        /* ==================== COPY BUTTON (TKT-173, updated for CodeMirror TKT-174) ==================== */
        function copySQL() {
            const sqlText = getEditorSQL();
            if (!sqlText.trim()) return;

            navigator.clipboard.writeText(sqlText).then(() => {
                const btn = document.getElementById('copy-button');
                const original = btn.innerHTML;
                btn.innerHTML = '\u2705 Copied!';
                btn.style.borderColor = 'var(--accent-green)';
                setTimeout(() => { btn.innerHTML = original; btn.style.borderColor = ''; }, 1500);
            }).catch(() => {
                // Fallback
                const ta = document.createElement('textarea');
                ta.value = sqlText;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                const btn = document.getElementById('copy-button');
                const original = btn.innerHTML;
                btn.innerHTML = '\u2705 Copied!';
                setTimeout(() => { btn.innerHTML = original; }, 1500);
            });
        }

        /* ==================== EXPORT BUTTON (TKT-173) ==================== */
        function exportCSV() {
            if (!lastQueryResults || !lastQueryResults.rows.length) {
                const btn = document.getElementById('export-button');
                const original = btn.innerHTML;
                btn.innerHTML = '\u274C No data';
                setTimeout(() => { btn.innerHTML = original; }, 1500);
                return;
            }

            const { columns, rows } = lastQueryResults;
            const csvRows = [];
            csvRows.push(columns.map(c => `"${c.replace(/"/g, '""')}"`).join(','));
            for (const row of rows) {
                const values = columns.map(col => {
                    const val = row[col];
                    if (val === null || val === undefined) return '';
                    return `"${String(val).replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            }

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `research_desk_export_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            const btn = document.getElementById('export-button');
            const original = btn.innerHTML;
            btn.innerHTML = '\u2705 Exported!';
            btn.style.borderColor = 'var(--accent-green)';
            setTimeout(() => { btn.innerHTML = original; btn.style.borderColor = ''; }, 1500);
        }

        /* ==================== WIRE BUTTONS ==================== */
        document.getElementById('run-button').addEventListener('click', executeQuery);
        document.getElementById('copy-button').addEventListener('click', copySQL);
        document.getElementById('export-button').addEventListener('click', exportCSV);

        /* ==================== TKT-175: INTERACTIVE SCHEMA BROWSER ==================== */
        let tableMetadata = null;

        // Load metadata and build interactive schema browser
        async function buildInteractiveSchema() {
            try {
                const resp = await fetch('data/sql_lab/table_metadata.json');
                if (!resp.ok) throw new Error('Failed to load metadata');
                tableMetadata = await resp.json();
            } catch(e) {
                console.warn('TKT-175: Could not load table_metadata.json:', e);
                return;
            }

            const container = document.getElementById('schema-groups-container');
            if (!container) return;

            // Group tables by type
            const groups = [
                { label: 'Dimension Tables', type: 'dimension', cssClass: 'dim', icon: '&#9679;' },
                { label: 'Fact Tables', type: 'fact', cssClass: 'fact', icon: '&#9679;' },
                { label: 'Reference Tables', type: 'reference', cssClass: 'ref', icon: '&#9679;' },
                { label: 'Analytics Tables', type: 'analytics', cssClass: 'cluster', icon: '&#9679;' },
            ];

            let html = '';

            // Render table groups
            for (const group of groups) {
                const tables = Object.entries(tableMetadata.tables || {}).filter(([, info]) => info.type === group.type);
                if (tables.length === 0) continue;

                html += `<div class="schema-group" data-group-type="${group.type}">`;
                html += `<div class="schema-group-label"><span class="group-chevron">&#9660;</span>${group.label} (${tables.length})</div>`;

                for (const [name, info] of tables) {
                    const rowDisplay = formatSchemaRowCount(info.rows);
                    html += buildSchemaItem(name, info, group.cssClass, rowDisplay, 'table');
                }
                html += `</div>`;
            }

            // Render views group
            const views = Object.entries(tableMetadata.views || {});
            if (views.length > 0) {
                html += `<div class="schema-group" data-group-type="views">`;
                html += `<div class="schema-group-label"><span class="group-chevron">&#9660;</span>Analytics Views (${views.length})</div>`;
                for (const [name, info] of views) {
                    html += buildSchemaItem(name, info, 'view', '', 'view');
                }
                html += `</div>`;
            }

            container.innerHTML = html;
            wireSchemaInteractions();
        }

        function formatSchemaRowCount(n) {
            if (n === undefined || n === null) return '';
            if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(0) + 'K';
            return String(n);
        }

        function getColTypeClass(type) {
            const t = (type || '').toUpperCase();
            if (t === 'VARCHAR') return 'type-varchar';
            if (t === 'BIGINT') return 'type-bigint';
            if (t === 'HUGEINT') return 'type-hugeint';
            if (t === 'INTEGER') return 'type-integer';
            if (t === 'DOUBLE') return 'type-double';
            if (t === 'BOOLEAN') return 'type-boolean';
            return 'type-default';
        }

        function buildSchemaItem(name, info, cssClass, rowDisplay, itemType) {
            const columns = info.columns || [];
            const dataAttr = itemType === 'view' ? `data-view="${name}"` : `data-table="${name}"`;
            let html = '';
            html += `<div class="schema-item schema-item-${cssClass}" ${dataAttr}>`;
            html += `<span class="chevron">&#9654;</span>`;
            html += `<span class="icon">&#9679;</span>`;
            html += `<span class="table-name">${name}</span>`;
            html += `<button type="button" class="query-btn" title="SELECT * FROM ${name} LIMIT 100">SQL</button>`;
            if (rowDisplay) html += `<span class="row-count">${rowDisplay}</span>`;
            html += `</div>`;

            // Column sub-list
            html += `<div class="schema-columns" data-parent="${name}">`;
            for (const col of columns) {
                const typeClass = getColTypeClass(col.type);
                const tooltip = col.description ? ` title="${escapeHtml(col.description)}"` : '';
                html += `<div class="schema-col-item" data-col="${col.name}" data-parent-table="${name}"${tooltip}>`;
                html += `<span class="col-name">${col.name}</span>`;
                html += `<span class="col-type ${typeClass}">${col.type}</span>`;
                html += `</div>`;
            }
            html += `</div>`;
            return html;
        }

        function wireSchemaInteractions() {
            // Click group label to collapse/expand category
            document.querySelectorAll('#schema-groups-container .schema-group-label').forEach(label => {
                label.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const group = this.closest('.schema-group');
                    if (group) group.classList.toggle('group-collapsed');
                });
            });

            // Click schema item to expand/collapse columns
            document.querySelectorAll('#schema-groups-container .schema-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    // If clicking the SQL button, load query instead
                    if (e.target.classList.contains('query-btn')) {
                        e.stopPropagation();
                        const tableName = this.getAttribute('data-table') || this.getAttribute('data-view');
                        if (!tableName) return;
                        setEditorSQL(`SELECT * FROM ${tableName} LIMIT 100;`);
                        document.getElementById('sql-editor-textarea').focus();
                        document.getElementById('sql-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });
                        return;
                    }

                    const tableName = this.getAttribute('data-table') || this.getAttribute('data-view');
                    if (!tableName) return;

                    const columnsEl = document.querySelector(`.schema-columns[data-parent="${tableName}"]`);
                    if (!columnsEl) return;

                    const isExpanded = this.classList.contains('expanded');
                    if (isExpanded) {
                        this.classList.remove('expanded');
                        columnsEl.classList.remove('visible');
                    } else {
                        this.classList.add('expanded');
                        columnsEl.classList.add('visible');
                    }
                });
            });

            // Click column to insert into textarea at cursor
            document.querySelectorAll('#schema-groups-container .schema-col-item').forEach(colItem => {
                colItem.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const colName = this.getAttribute('data-col');
                    if (!colName) return;

                    const ta = document.getElementById('sql-editor-textarea');
                    const pos = ta.selectionStart || ta.value.length;
                    ta.value = ta.value.slice(0, pos) + colName + ta.value.slice(pos);
                    ta.focus();
                    ta.selectionStart = ta.selectionEnd = pos + colName.length;
                });
            });
        }

        // Schema search: filter by table name AND column names
        document.getElementById('schema-search').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase().trim();

            document.querySelectorAll('#schema-groups-container .schema-item').forEach(item => {
                const tableName = (item.getAttribute('data-table') || item.getAttribute('data-view') || '').toLowerCase();
                const columnsEl = document.querySelector(`.schema-columns[data-parent="${tableName}"]`);

                if (!query) {
                    item.style.display = '';
                    // Remove search-triggered expansions
                    if (item.hasAttribute('data-search-expanded')) {
                        item.classList.remove('expanded');
                        item.removeAttribute('data-search-expanded');
                        if (columnsEl) columnsEl.classList.remove('visible');
                    }
                    if (columnsEl) {
                        columnsEl.style.display = '';
                        columnsEl.querySelectorAll('.schema-col-item').forEach(c => c.style.display = '');
                    }
                    return;
                }

                // Check table name match
                let tableMatch = tableName.includes(query);

                // Check column name matches
                let anyColMatch = false;
                if (columnsEl) {
                    columnsEl.querySelectorAll('.schema-col-item').forEach(colItem => {
                        const colName = (colItem.getAttribute('data-col') || '').toLowerCase();
                        if (colName.includes(query)) {
                            anyColMatch = true;
                            colItem.style.display = '';
                        } else {
                            colItem.style.display = tableMatch ? '' : 'none';
                        }
                    });
                }

                if (tableMatch || anyColMatch) {
                    item.style.display = '';
                    // Auto-expand if column match found
                    if (anyColMatch && !tableMatch && columnsEl) {
                        if (!item.classList.contains('expanded')) {
                            item.setAttribute('data-search-expanded', 'true');
                        }
                        item.classList.add('expanded');
                        columnsEl.classList.add('visible');
                    }
                } else {
                    item.style.display = 'none';
                    if (columnsEl) columnsEl.style.display = 'none';
                }
            });

            // Show/hide group labels if all their items are hidden
            document.querySelectorAll('#schema-groups-container .schema-group').forEach(group => {
                const visibleItems = group.querySelectorAll('.schema-item[style=""], .schema-item:not([style])');
                const hasVisible = Array.from(group.querySelectorAll('.schema-item')).some(i => i.style.display !== 'none');
                group.style.display = hasVisible ? '' : 'none';
            });
        });

        /* ==================== SCHEMA SIDEBAR COLLAPSE (mobile) ==================== */
        document.querySelector('.schema-header').addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                document.querySelector('.schema-sidebar').classList.toggle('collapsed');
            }
        });

        // Build the schema browser
        buildInteractiveSchema();

        /* ==================== TKT-176: EXAMPLE QUERIES GALLERY ==================== */
        const EXAMPLE_QUERIES = [
            // Leaderboard
            {
                category: 'leaderboard',
                title: 'Top 20 IPL Run Scorers',
                description: 'All-time highest run scorers in IPL history with strike rates and averages.',
                sql: `SELECT player_name, innings, runs, balls_faced,\n  highest_score, fifties, hundreds,\n  ROUND(strike_rate, 1) AS strike_rate,\n  ROUND(batting_average, 1) AS avg\nFROM analytics_top_run_scorers\nLIMIT 20;`
            },
            {
                category: 'leaderboard',
                title: 'Top 20 IPL Wicket Takers',
                description: 'All-time leading wicket takers in IPL with economy and bowling averages.',
                sql: `SELECT player_name, matches_bowled, wickets,\n  ROUND(overs_bowled, 1) AS overs,\n  best_wickets || '/' || best_runs AS best,\n  ROUND(economy_rate, 2) AS economy,\n  ROUND(bowling_average, 1) AS avg\nFROM analytics_top_wicket_takers\nLIMIT 20;`
            },
            {
                category: 'leaderboard',
                title: 'Highest Strike Rates (min 500 balls)',
                description: 'Batters with the best strike rates in IPL, minimum 500 balls faced.',
                sql: `SELECT player_name, innings, runs, balls_faced,\n  ROUND(strike_rate, 2) AS strike_rate,\n  ROUND(batting_average, 1) AS avg,\n  ROUND(boundary_pct, 1) AS boundary_pct\nFROM analytics_ipl_batting_career\nWHERE balls_faced >= 500\nORDER BY strike_rate DESC\nLIMIT 20;`
            },
            // Batting
            {
                category: 'batting',
                title: 'Best Powerplay Batters',
                description: 'Top performers in the powerplay phase by strike rate, minimum 200 balls.',
                sql: `SELECT player_name, innings, runs, balls_faced,\n  ROUND(strike_rate, 2) AS strike_rate,\n  ROUND(batting_average, 1) AS avg,\n  ROUND(boundary_pct, 1) AS boundary_pct\nFROM analytics_ipl_batter_phase\nWHERE match_phase = 'powerplay'\n  AND balls_faced >= 200\nORDER BY strike_rate DESC\nLIMIT 20;`
            },
            {
                category: 'batting',
                title: 'Death Over Batting Specialists',
                description: 'Batters with the best death overs strike rate, minimum 200 balls faced.',
                sql: `SELECT player_name, innings, runs, balls_faced,\n  ROUND(strike_rate, 2) AS strike_rate,\n  fours, sixes,\n  ROUND(boundary_pct, 1) AS boundary_pct\nFROM analytics_ipl_batter_phase\nWHERE match_phase = 'death'\n  AND balls_faced >= 200\nORDER BY strike_rate DESC\nLIMIT 20;`
            },
            {
                category: 'batting',
                title: 'Most Sixes in IPL History',
                description: 'Players who have hit the most sixes across all IPL seasons.',
                sql: `SELECT player_name, innings, runs,\n  sixes, fours,\n  ROUND(strike_rate, 2) AS strike_rate,\n  ROUND(boundary_pct, 1) AS boundary_pct\nFROM analytics_ipl_batting_career\nWHERE balls_faced >= 100\nORDER BY sixes DESC\nLIMIT 20;`
            },
            // Bowling
            {
                category: 'bowling',
                title: 'Best Death Bowlers',
                description: 'Bowlers with the best economy rate in death overs, minimum 200 balls.',
                sql: `SELECT player_name, matches, balls_bowled,\n  ROUND(overs, 1) AS overs,\n  runs_conceded, wickets,\n  ROUND(economy_rate, 2) AS economy,\n  ROUND(dot_ball_pct, 1) AS dot_pct\nFROM analytics_ipl_bowler_phase\nWHERE match_phase = 'death'\n  AND balls_bowled >= 200\nORDER BY economy_rate ASC\nLIMIT 20;`
            },
            {
                category: 'bowling',
                title: 'Spin vs Pace Economy by Phase',
                description: 'Compare spin and pace bowling economy across powerplay, middle, and death phases.',
                sql: `SELECT\n  bc.bowling_style,\n  bp.match_phase,\n  COUNT(DISTINCT bp.player_id) AS bowlers,\n  SUM(bp.balls_bowled) AS total_balls,\n  ROUND(SUM(bp.runs_conceded) * 6.0 / SUM(bp.balls_bowled), 2) AS economy,\n  ROUND(SUM(bp.dot_balls) * 100.0 / SUM(bp.balls_bowled), 1) AS dot_pct\nFROM analytics_ipl_bowler_phase bp\nJOIN dim_bowler_classification bc ON bp.player_id = bc.player_id\nWHERE bp.balls_bowled >= 60\nGROUP BY bc.bowling_style, bp.match_phase\nORDER BY bc.bowling_style, bp.match_phase;`
            },
            {
                category: 'bowling',
                title: 'Most Dot Balls in IPL Career',
                description: 'Bowlers who have bowled the most dot balls in IPL history.',
                sql: `SELECT player_name, matches_bowled,\n  ROUND(overs_bowled, 1) AS overs,\n  wickets, dot_balls,\n  ROUND(dot_ball_pct, 1) AS dot_pct,\n  ROUND(economy_rate, 2) AS economy\nFROM analytics_ipl_bowling_career\nWHERE balls_bowled >= 300\nORDER BY dot_balls DESC\nLIMIT 20;`
            },
            // Team
            {
                category: 'team',
                title: 'IPL 2026 Squad Spend by Team',
                description: 'Total and average squad spend per team for IPL 2026 mega auction.',
                sql: `SELECT team_name,\n  COUNT(*) AS squad_size,\n  ROUND(SUM(price_cr), 2) AS total_spend_cr,\n  ROUND(AVG(price_cr), 2) AS avg_price_cr,\n  ROUND(MAX(price_cr), 2) AS top_buy_cr\nFROM ipl_2026_contracts\nGROUP BY team_name\nORDER BY total_spend_cr DESC;`
            },
            {
                category: 'team',
                title: 'Team Win Rates by Venue (IPL)',
                description: 'How each IPL team performs at different venues, sorted by win percentage.',
                sql: `SELECT dt.team_name, v.venue_name,\n  COUNT(*) AS matches,\n  SUM(CASE WHEN m.winner_id = dt.team_id THEN 1 ELSE 0 END) AS wins,\n  ROUND(SUM(CASE WHEN m.winner_id = dt.team_id THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) AS win_pct\nFROM dim_match m\nJOIN dim_venue v ON m.venue_id = v.venue_id\nJOIN dim_tournament t ON m.tournament_id = t.tournament_id\nJOIN dim_team dt ON dt.team_id IN (m.team1_id, m.team2_id)\nWHERE t.tournament_name LIKE '%Indian Premier League%'\nGROUP BY dt.team_name, v.venue_name\nHAVING COUNT(*) >= 5\nORDER BY win_pct DESC\nLIMIT 25;`
            },
            {
                category: 'team',
                title: 'Strongest Batting Lineups (IPL 2026)',
                description: 'IPL 2026 squads ranked by combined historical IPL batting performance.',
                sql: `SELECT team_name,\n  COUNT(*) AS batters,\n  SUM(ipl_runs) AS total_ipl_runs,\n  ROUND(AVG(ipl_sr), 1) AS avg_strike_rate,\n  ROUND(AVG(ipl_avg), 1) AS avg_batting_avg\nFROM analytics_ipl_squad_batting\nWHERE ipl_innings >= 5\nGROUP BY team_name\nORDER BY total_ipl_runs DESC;`
            },
            // Matchup
            {
                category: 'matchup',
                title: 'Virat Kohli vs Left-Arm Pace',
                description: 'How Virat Kohli has performed against left-arm pace bowling in IPL.',
                sql: `SELECT batter_name, bowler_type,\n  balls, runs, dismissals,\n  ROUND(strike_rate, 2) AS strike_rate,\n  ROUND(average, 1) AS average,\n  ROUND(boundary_pct, 1) AS boundary_pct\nFROM analytics_ipl_batter_vs_bowler_type\nWHERE batter_name LIKE '%Kohli%'\nORDER BY bowler_type;`
            },
            {
                category: 'matchup',
                title: 'Jasprit Bumrah vs Top Batters',
                description: 'Bumrah head-to-head record against batters with 10+ balls faced.',
                sql: `SELECT batter_name, balls, runs, dismissals,\n  ROUND(strike_rate, 2) AS strike_rate,\n  ROUND(dot_ball_pct, 1) AS dot_pct\nFROM analytics_ipl_batter_vs_bowler\nWHERE bowler_name LIKE '%Bumrah%'\n  AND balls >= 10\nORDER BY balls DESC\nLIMIT 20;`
            },
            // Phase Analysis
            {
                category: 'phase',
                title: 'Powerplay Run Rate by Team (Recent Seasons)',
                description: 'Average powerplay run rate per team in recent IPL seasons.',
                sql: `SELECT dt_bat.team_name AS batting_team,\n  COUNT(DISTINCT fb.match_id) AS matches,\n  SUM(fb.total_runs) AS pp_runs,\n  SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) AS pp_balls,\n  ROUND(SUM(fb.total_runs) * 6.0 / SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 2) AS run_rate\nFROM fact_ball fb\nJOIN dim_match m ON fb.match_id = m.match_id\nJOIN dim_tournament t ON m.tournament_id = t.tournament_id\nJOIN dim_team dt_bat ON fb.batting_team_id = dt_bat.team_id\nWHERE t.tournament_name LIKE '%Indian Premier League%'\n  AND m.season IN ('2024', '2024/25', '2025')\n  AND fb.match_phase = 'powerplay'\nGROUP BY dt_bat.team_name\nHAVING SUM(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) >= 100\nORDER BY run_rate DESC;`
            },
            // Pressure Performance
            {
                category: 'pressure',
                title: 'Clutch Batters Under Extreme Pressure',
                description: 'Batters who thrive when Required Run Rate exceeds 12 (IPL 2023+).',
                sql: `SELECT player_name, pressure_band, balls_faced,\n  ROUND(strike_rate, 1) AS strike_rate,\n  ROUND(batting_average, 1) AS average,\n  ROUND(boundary_pct, 1) AS boundary_pct,\n  ROUND(dot_ball_pct, 1) AS dot_pct,\n  confidence\nFROM analytics_ipl_batter_pressure_bands_since2023\nWHERE pressure_band IN ('EXTREME', 'NEAR_IMPOSSIBLE')\n  AND balls_faced >= 15\nORDER BY strike_rate DESC\nLIMIT 20;`
            },
            {
                category: 'pressure',
                title: 'Best Death Bowlers Under Pressure',
                description: 'Bowlers with lowest economy when opposition RRR is 10+ (IPL 2023+).',
                sql: `SELECT player_name, pressure_band, balls_bowled,\n  ROUND(economy, 2) AS economy,\n  ROUND(dot_ball_pct, 1) AS dot_pct,\n  ROUND(boundary_pct_conceded, 1) AS bdry_pct_conc,\n  wickets, confidence\nFROM analytics_ipl_bowler_pressure_bands_since2023\nWHERE pressure_band IN ('HIGH', 'EXTREME')\n  AND balls_bowled >= 15\nORDER BY economy ASC\nLIMIT 20;`
            },
            {
                category: 'pressure',
                title: 'Pressure Performance Ratings',
                description: 'How player metrics change across pressure bands ‚Äî CLUTCH, PRESSURE_PROOF, or SENSITIVE.',
                sql: `SELECT player_name, role, pressure_band,\n  ROUND(band_metric, 2) AS band_metric,\n  ROUND(overall_metric, 2) AS overall_metric,\n  ROUND(delta_pct, 1) AS delta_pct,\n  rating\nFROM analytics_ipl_pressure_deltas_since2023\nWHERE rating IN ('CLUTCH', 'FINISHER', 'CLOSER')\nORDER BY delta_pct DESC\nLIMIT 25;`
            },
            {
                category: 'pressure',
                title: 'Dot Ball Sequences Under Pressure',
                description: 'Bowlers who build consecutive dot ball streaks when RRR > 10 (IPL 2023+).',
                sql: `SELECT player_name, total_sequences,\n  total_dots_in_sequences,\n  ROUND(avg_sequence_length, 1) AS avg_seq_len,\n  max_sequence_length AS max_streak,\n  ROUND(recovery_rate, 1) AS recovery_pct\nFROM analytics_ipl_pressure_dot_sequences_since2023\nWHERE total_sequences >= 3\nORDER BY avg_sequence_length DESC\nLIMIT 20;`
            },
            // IPL 2026
            {
                category: 'ipl2026',
                title: 'IPL 2026 Overseas Players',
                description: 'All overseas players in IPL 2026 squads with their roles and nationalities.',
                sql: `SELECT team_name, player_name, nationality,\n  role, age, batting_hand,\n  bowling_type\nFROM ipl_2026_squads\nWHERE nationality != 'India'\nORDER BY team_name, player_name;`
            },
            {
                category: 'ipl2026',
                title: 'Most Expensive IPL 2026 Buys',
                description: 'The biggest price tags from the IPL 2026 mega auction and retentions.',
                sql: `SELECT c.player_name, c.team_name,\n  c.price_cr, c.acquisition_type,\n  s.nationality, s.role, s.age\nFROM ipl_2026_contracts c\nJOIN ipl_2026_squads s\n  ON c.player_name = s.player_name\n  AND c.team_name = s.team_name\nORDER BY c.price_cr DESC\nLIMIT 25;`
            },
        ];

        function renderExampleQueries(filter) {
            const grid = document.getElementById('examples-grid');
            const filtered = filter === 'all' ? EXAMPLE_QUERIES : EXAMPLE_QUERIES.filter(q => q.category === filter);

            let html = '';
            for (const q of filtered) {
                const catClass = q.category === 'ipl2026' ? 'ipl2026' : q.category;
                const catLabel = q.category === 'ipl2026' ? 'IPL 2026' : q.category.charAt(0).toUpperCase() + q.category.slice(1);
                const sqlPreview = q.sql.replace(/\n/g, ' ').substring(0, 65);
                html += `<div class="example-card" data-category="${q.category}">`;
                html += `<span class="example-card-category ${catClass}">${catLabel}</span>`;
                html += `<h4>${escapeHtml(q.title)}</h4>`;
                html += `<div class="example-card-desc">${escapeHtml(q.description)}</div>`;
                html += `<p title="${escapeHtml(q.sql)}">${escapeHtml(sqlPreview)}...</p>`;
                html += `<button type="button" class="load-btn" data-sql="${escapeAttr(q.sql)}">&#9654; Load Query</button>`;
                html += `</div>`;
            }
            grid.innerHTML = html;

            // Wire load buttons
            grid.querySelectorAll('.load-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const sqlText = this.getAttribute('data-sql');
                    setEditorSQL(sqlText);
                    document.getElementById('sql-editor-textarea').focus();
                    document.getElementById('sql-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
            });

            // Also make the whole card clickable (loads query)
            grid.querySelectorAll('.example-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (e.target.classList.contains('load-btn')) return; // Already handled
                    const btn = this.querySelector('.load-btn');
                    if (btn) {
                        const sqlText = btn.getAttribute('data-sql');
                        setEditorSQL(sqlText);
                        document.getElementById('sql-editor-textarea').focus();
                        document.getElementById('sql-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            });
        }

        // Render initial gallery
        renderExampleQueries('all');

        /* ==================== EXAMPLE FILTER (TKT-176) ==================== */
        document.querySelectorAll('.examples-filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.examples-filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const filterVal = this.getAttribute('data-filter') || 'all';
                renderExampleQueries(filterVal);
            });
        });

        /* ==================== NATURAL LANGUAGE QUERY ENGINE (TKT-177 + TKT-181 Phase 1) ==================== */
        /* 5-Stage Pipeline: Entity Extraction -> Intent Classification -> View Coverage -> Query Router -> Fallback */

        // ================================================================
        // SECTION 1: REFERENCE DICTIONARIES
        // ================================================================

        // ---- 1A: Team alias map (expanded with historical aliases) ----
        const TEAM_ALIASES = {
            'csk':  'Chennai Super Kings',
            'chennai': 'Chennai Super Kings',
            'super kings': 'Chennai Super Kings',
            'chennai super kings': 'Chennai Super Kings',
            'mi':   'Mumbai Indians',
            'mumbai': 'Mumbai Indians',
            'mumbai indians': 'Mumbai Indians',
            'rcb':  'Royal Challengers Bengaluru',
            'bangalore': 'Royal Challengers Bengaluru',
            'bengaluru': 'Royal Challengers Bengaluru',
            'royal challengers': 'Royal Challengers Bengaluru',
            'royal challengers bangalore': 'Royal Challengers Bengaluru',
            'royal challengers bengaluru': 'Royal Challengers Bengaluru',
            'kkr':  'Kolkata Knight Riders',
            'kolkata': 'Kolkata Knight Riders',
            'knight riders': 'Kolkata Knight Riders',
            'kolkata knight riders': 'Kolkata Knight Riders',
            'dc':   'Delhi Capitals',
            'delhi': 'Delhi Capitals',
            'capitals': 'Delhi Capitals',
            'delhi capitals': 'Delhi Capitals',
            'delhi daredevils': 'Delhi Capitals',
            'dd': 'Delhi Capitals',
            'pbks': 'Punjab Kings',
            'punjab': 'Punjab Kings',
            'kxip': 'Punjab Kings',
            'kings xi punjab': 'Punjab Kings',
            'kings xi': 'Punjab Kings',
            'punjab kings': 'Punjab Kings',
            'rr':   'Rajasthan Royals',
            'rajasthan': 'Rajasthan Royals',
            'royals': 'Rajasthan Royals',
            'rajasthan royals': 'Rajasthan Royals',
            'srh':  'Sunrisers Hyderabad',
            'hyderabad': 'Sunrisers Hyderabad',
            'sunrisers': 'Sunrisers Hyderabad',
            'sunrisers hyderabad': 'Sunrisers Hyderabad',
            'deccan chargers': 'Sunrisers Hyderabad',
            'deccan': 'Sunrisers Hyderabad',
            'gt':   'Gujarat Titans',
            'gujarat': 'Gujarat Titans',
            'titans': 'Gujarat Titans',
            'gujarat titans': 'Gujarat Titans',
            'lsg':  'Lucknow Super Giants',
            'lucknow': 'Lucknow Super Giants',
            'super giants': 'Lucknow Super Giants',
            'lucknow super giants': 'Lucknow Super Giants',
        };

        // ---- 1B: Player nickname/alias map (50+ common nicknames -> full names) ----
        const PLAYER_ALIASES = {
            // Indian batters
            'sky': 'Suryakumar Yadav', 'surya': 'Suryakumar Yadav', 'suryakumar': 'Suryakumar Yadav',
            'kohli': 'Virat Kohli', 'virat': 'Virat Kohli', 'vk': 'Virat Kohli', 'king kohli': 'Virat Kohli',
            'rohit': 'Rohit Sharma', 'hitman': 'Rohit Sharma', 'ro': 'Rohit Sharma',
            'pant': 'Rishabh Pant', 'rishabh': 'Rishabh Pant',
            'dhoni': 'MS Dhoni', 'msd': 'MS Dhoni', 'thala': 'MS Dhoni', 'mahi': 'MS Dhoni',
            'gill': 'Shubman Gill', 'shubman': 'Shubman Gill',
            'iyer': 'Shreyas Iyer', 'shreyas': 'Shreyas Iyer',
            'kl': 'KL Rahul', 'kl rahul': 'KL Rahul', 'rahul': 'KL Rahul',
            'sanju': 'Sanju Samson', 'samson': 'Sanju Samson',
            'rutu': 'Ruturaj Gaikwad', 'ruturaj': 'Ruturaj Gaikwad', 'gaikwad': 'Ruturaj Gaikwad',
            'kishan': 'Ishan Kishan', 'ishan': 'Ishan Kishan',
            'tilak': 'Tilak Varma', 'tilak varma': 'Tilak Varma',
            'rinku': 'Rinku Singh', 'rinku singh': 'Rinku Singh',
            'jaiswal': 'Yashasvi Jaiswal', 'yashasvi': 'Yashasvi Jaiswal',
            'padikkal': 'Devdutt Padikkal', 'devdutt': 'Devdutt Padikkal',
            // Indian bowlers
            'bumrah': 'Jasprit Bumrah', 'jasprit': 'Jasprit Bumrah', 'boom': 'Jasprit Bumrah',
            'chahal': 'Yuzvendra Chahal', 'yuzi': 'Yuzvendra Chahal',
            'ashwin': 'Ravichandran Ashwin', 'ash': 'Ravichandran Ashwin', 'ravi ashwin': 'Ravichandran Ashwin',
            'jadeja': 'Ravindra Jadeja', 'jaddu': 'Ravindra Jadeja', 'sir jadeja': 'Ravindra Jadeja',
            'shami': 'Mohammed Shami', 'md shami': 'Mohammed Shami',
            'siraj': 'Mohammed Siraj', 'md siraj': 'Mohammed Siraj',
            'kuldeep': 'Kuldeep Yadav', 'kuldeep yadav': 'Kuldeep Yadav',
            'arshdeep': 'Arshdeep Singh', 'arshdeep singh': 'Arshdeep Singh',
            'bishnoi': 'Ravi Bishnoi', 'ravi bishnoi': 'Ravi Bishnoi',
            'avesh': 'Avesh Khan', 'avesh khan': 'Avesh Khan',
            'umran': 'Umran Malik', 'umran malik': 'Umran Malik',
            // Indian all-rounders
            'hardik': 'Hardik Pandya', 'hp': 'Hardik Pandya', 'hardik pandya': 'Hardik Pandya',
            'krunal': 'Krunal Pandya', 'krunal pandya': 'Krunal Pandya',
            'axar': 'Axar Patel', 'axar patel': 'Axar Patel',
            'shardul': 'Shardul Thakur', 'lord shardul': 'Shardul Thakur', 'shardul thakur': 'Shardul Thakur',
            'venky': 'Venkatesh Iyer', 'venkatesh': 'Venkatesh Iyer',
            // Overseas batters
            'abd': 'AB de Villiers', 'ab de villiers': 'AB de Villiers', 'ab': 'AB de Villiers',
            'gayle': 'Chris Gayle', 'universe boss': 'Chris Gayle', 'chris gayle': 'Chris Gayle',
            'warner': 'David Warner', 'david warner': 'David Warner', 'bull': 'David Warner',
            'buttler': 'Jos Buttler', 'jos': 'Jos Buttler', 'jos buttler': 'Jos Buttler',
            'bairstow': 'Jonny Bairstow', 'jonny': 'Jonny Bairstow',
            'head': 'Travis Head', 'travis head': 'Travis Head',
            'salt': 'Phil Salt', 'phil salt': 'Phil Salt',
            'du plessis': 'Faf du Plessis', 'faf': 'Faf du Plessis',
            'maxwell': 'Glenn Maxwell', 'maxi': 'Glenn Maxwell', 'glenn maxwell': 'Glenn Maxwell',
            'pooran': 'Nicholas Pooran', 'nicholas pooran': 'Nicholas Pooran',
            'green': 'Cameron Green', 'cameron green': 'Cameron Green',
            'marsh': 'Mitchell Marsh', 'mitch marsh': 'Mitchell Marsh',
            'klaasen': 'Heinrich Klaasen', 'heinrich': 'Heinrich Klaasen',
            'markram': 'Aiden Markram', 'aiden markram': 'Aiden Markram',
            'miller': 'David Miller', 'killer miller': 'David Miller',
            // Overseas bowlers
            'rashid': 'Rashid Khan', 'rashid khan': 'Rashid Khan',
            'narine': 'Sunil Narine', 'sunil narine': 'Sunil Narine',
            'starc': 'Mitchell Starc', 'mitchell starc': 'Mitchell Starc',
            'cummins': 'Pat Cummins', 'pat cummins': 'Pat Cummins',
            'rabada': 'Kagiso Rabada', 'kg': 'Kagiso Rabada', 'kagiso': 'Kagiso Rabada',
            'archer': 'Jofra Archer', 'jofra': 'Jofra Archer', 'jofra archer': 'Jofra Archer',
            'boult': 'Trent Boult', 'trent boult': 'Trent Boult',
            'zampa': 'Adam Zampa', 'adam zampa': 'Adam Zampa',
            'hasaranga': 'Wanindu Hasaranga', 'wanindu': 'Wanindu Hasaranga',
            'theekshana': 'Maheesh Theekshana', 'maheesh': 'Maheesh Theekshana',
            'ferguson': 'Lockie Ferguson', 'lockie': 'Lockie Ferguson',
            'topley': 'Reece Topley', 'reece topley': 'Reece Topley',
            // Overseas all-rounders
            'stokes': 'Ben Stokes', 'ben stokes': 'Ben Stokes',
            'russell': 'Andre Russell', 'dre russ': 'Andre Russell', 'andre russell': 'Andre Russell',
            'curran': 'Sam Curran', 'sam curran': 'Sam Curran',
            'livingstone': 'Liam Livingstone', 'liam livingstone': 'Liam Livingstone',
            'stoinis': 'Marcus Stoinis', 'marcus stoinis': 'Marcus Stoinis',
        };

        // ---- 1C: Phase keywords map (expanded) ----
        const PHASE_MAP = {
            'powerplay': 'powerplay', 'pp': 'powerplay', 'power play': 'powerplay',
            'first 6': 'powerplay', 'opening overs': 'powerplay', 'first six': 'powerplay',
            'middle': 'middle', 'middle overs': 'middle', 'overs 7-15': 'middle',
            'consolidation': 'middle', 'middle phase': 'middle',
            'death': 'death', 'death overs': 'death', 'slog': 'death',
            'last 5': 'death', 'slog overs': 'death', 'overs 16-20': 'death',
            'last five': 'death', 'finishing overs': 'death',
        };

        // ---- 1D: Venue map (city -> ground name patterns for ILIKE) ----
        const VENUE_MAP = {
            // City names -> venue ILIKE patterns
            'mumbai': 'Wankhede', 'wankhede': 'Wankhede',
            'chennai': null, // Chennai conflicts with team name, handled separately
            'chepauk': 'Chidambaram', 'chidambaram': 'Chidambaram', 'ma chidambaram': 'Chidambaram',
            'bangalore': null, 'bengaluru': null, // Conflicts with team name
            'chinnaswamy': 'Chinnaswamy', 'chinnaswami': 'Chinnaswamy',
            'kolkata': null, // Conflicts with team name
            'eden gardens': 'Eden Gardens', 'eden': 'Eden Gardens',
            'delhi': null, // Conflicts with team name
            'kotla': 'Kotla', 'feroz shah': 'Feroz Shah Kotla', 'arun jaitley': 'Arun Jaitley',
            'hyderabad': null, // Conflicts with team name
            'rajiv gandhi': 'Rajiv Gandhi', 'uppal': 'Rajiv Gandhi',
            'jaipur': 'Jaipur', 'sawai mansingh': 'Sawai Mansingh',
            'mohali': 'Mohali', 'chandigarh': 'Mohali', 'is bindra': 'Mohali', 'pca': 'Mohali',
            'lucknow': null, // Conflicts with team name
            'ekana': 'Ekana', 'bharat ratna': 'Ekana',
            'ahmedabad': 'Ahmedabad', 'narendra modi': 'Narendra Modi', 'motera': 'Narendra Modi',
            'dharamsala': 'Dharamsala', 'dharamshala': 'Dharamsala', 'himachal': 'Dharamsala',
            'pune': 'Pune', 'gahunje': 'Gahunje', 'mca': 'Pune',
            'guwahati': 'Guwahati', 'barsapara': 'Barsapara',
            'visakhapatnam': 'Visakhapatnam', 'vizag': 'Visakhapatnam',
            'indore': 'Indore', 'holkar': 'Holkar',
            'ranchi': 'Ranchi', 'jsca': 'Ranchi',
            'navi mumbai': 'Navi Mumbai', 'dy patil': 'DY Patil',
            'sharjah': 'Sharjah', 'dubai': 'Dubai', 'abu dhabi': 'Abu Dhabi',
            'centurion': 'Centurion', 'newlands': 'Newlands', 'cape town': 'Newlands',
        };

        // ---- 1E: Bowler type classification map ----
        const BOWLER_TYPE_MAP = {
            'spin': ['spin', 'off-spin', 'leg-spin', 'left-arm orthodox', 'left-arm wrist spin',
                     'Right-arm off-spin', 'Right-arm leg-spin', 'Left-arm orthodox', 'Left-arm wrist spin'],
            'spinner': ['spin', 'off-spin', 'leg-spin', 'left-arm orthodox', 'left-arm wrist spin',
                        'Right-arm off-spin', 'Right-arm leg-spin', 'Left-arm orthodox', 'Left-arm wrist spin'],
            'spinners': ['spin', 'off-spin', 'leg-spin', 'left-arm orthodox', 'left-arm wrist spin',
                         'Right-arm off-spin', 'Right-arm leg-spin', 'Left-arm orthodox', 'Left-arm wrist spin'],
            'pace': ['pace', 'fast', 'medium', 'Right-arm pace', 'Left-arm pace', 'Right-arm medium', 'Left-arm medium'],
            'fast': ['pace', 'fast', 'Right-arm pace', 'Left-arm pace'],
            'seam': ['pace', 'fast', 'medium', 'Right-arm pace', 'Left-arm pace'],
            'quick': ['pace', 'fast', 'Right-arm pace', 'Left-arm pace'],
            'off-spin': ['off-spin', 'Right-arm off-spin'],
            'off spin': ['off-spin', 'Right-arm off-spin'],
            'offie': ['off-spin', 'Right-arm off-spin'],
            'offspin': ['off-spin', 'Right-arm off-spin'],
            'off spinner': ['off-spin', 'Right-arm off-spin'],
            'leg-spin': ['leg-spin', 'Right-arm leg-spin', 'Left-arm wrist spin'],
            'leg spin': ['leg-spin', 'Right-arm leg-spin', 'Left-arm wrist spin'],
            'leggie': ['leg-spin', 'Right-arm leg-spin', 'Left-arm wrist spin'],
            'legspin': ['leg-spin', 'Right-arm leg-spin', 'Left-arm wrist spin'],
            'leg spinner': ['leg-spin', 'Right-arm leg-spin', 'Left-arm wrist spin'],
            'wrist spin': ['leg-spin', 'Right-arm leg-spin', 'Left-arm wrist spin'],
            'wrist spinner': ['leg-spin', 'Right-arm leg-spin', 'Left-arm wrist spin'],
            'left-arm spin': ['Left-arm orthodox', 'Left-arm wrist spin'],
            'left arm spin': ['Left-arm orthodox', 'Left-arm wrist spin'],
            'left-arm orthodox': ['Left-arm orthodox'],
            'left arm orthodox': ['Left-arm orthodox'],
            'sla': ['Left-arm orthodox'],
            'left-arm pace': ['Left-arm pace', 'Left-arm medium'],
            'left arm pace': ['Left-arm pace', 'Left-arm medium'],
            'left-arm quick': ['Left-arm pace'],
            'left arm quick': ['Left-arm pace'],
            'left-arm fast': ['Left-arm pace'],
            'right-arm pace': ['Right-arm pace', 'Right-arm medium'],
            'right arm pace': ['Right-arm pace', 'Right-arm medium'],
        };

        // Simplified bowler type for view-based queries (maps to bowler_type column values in squad views)
        const BOWLER_TYPE_SIMPLE = {
            'spin': 'Spin', 'spinner': 'Spin', 'spinners': 'Spin',
            'off-spin': 'Spin', 'off spin': 'Spin', 'offie': 'Spin', 'offspin': 'Spin', 'off spinner': 'Spin',
            'leg-spin': 'Spin', 'leg spin': 'Spin', 'leggie': 'Spin', 'legspin': 'Spin', 'leg spinner': 'Spin',
            'wrist spin': 'Spin', 'wrist spinner': 'Spin',
            'left-arm spin': 'Spin', 'left arm spin': 'Spin', 'left-arm orthodox': 'Spin', 'left arm orthodox': 'Spin', 'sla': 'Spin',
            'pace': 'Pace', 'fast': 'Pace', 'seam': 'Pace', 'quick': 'Pace',
            'left-arm pace': 'Pace', 'left arm pace': 'Pace', 'left-arm quick': 'Pace', 'left arm quick': 'Pace', 'left-arm fast': 'Pace',
            'right-arm pace': 'Pace', 'right arm pace': 'Pace',
        };

        // ---- 1F: Metric keyword map ----
        const METRIC_MAP = {
            'strike rate': { col: 'strike_rate', dir: 'DESC' },
            'sr': { col: 'strike_rate', dir: 'DESC' },
            'average': { col: 'batting_average', dir: 'DESC', bowling_col: 'bowling_average', bowling_dir: 'ASC' },
            'avg': { col: 'batting_average', dir: 'DESC', bowling_col: 'bowling_average', bowling_dir: 'ASC' },
            'economy': { col: 'economy_rate', dir: 'ASC' },
            'econ': { col: 'economy_rate', dir: 'ASC' },
            'economy rate': { col: 'economy_rate', dir: 'ASC' },
            'boundary %': { col: 'boundary_pct', dir: 'DESC' },
            'boundary pct': { col: 'boundary_pct', dir: 'DESC' },
            'boundaries': { col: 'boundary_pct', dir: 'DESC' },
            'dot ball %': { col: 'dot_ball_pct', dir: 'DESC' },
            'dot ball pct': { col: 'dot_ball_pct', dir: 'DESC' },
            'dot balls': { col: 'dot_ball_pct', dir: 'DESC' },
            'wickets': { col: 'wickets', dir: 'DESC' },
            'runs': { col: 'runs', dir: 'DESC' },
            'sixes': { col: 'sixes', dir: 'DESC' },
            '6s': { col: 'sixes', dir: 'DESC' },
            'fours': { col: 'fours', dir: 'DESC' },
            '4s': { col: 'fours', dir: 'DESC' },
            'fifties': { col: 'fifties', dir: 'DESC' },
            '50s': { col: 'fifties', dir: 'DESC' },
            'hundreds': { col: 'hundreds', dir: 'DESC' },
            '100s': { col: 'hundreds', dir: 'DESC' },
            'centuries': { col: 'hundreds', dir: 'DESC' },
        };

        // ================================================================
        // SECTION 2: HELPER FUNCTIONS (preserved + expanded)
        // ================================================================

        // ---- Resolve a team token to canonical name ----
        function resolveTeamName(token) {
            const lower = token.toLowerCase().trim();
            if (TEAM_ALIASES[lower]) return TEAM_ALIASES[lower];
            for (const [alias, full] of Object.entries(TEAM_ALIASES)) {
                if (alias.includes(lower) || lower.includes(alias)) return full;
            }
            return token;
        }

        // ---- Detect if a token looks like a team abbreviation or name ----
        function isTeamToken(token) {
            const lower = token.toLowerCase().trim();
            return TEAM_ALIASES.hasOwnProperty(lower) ||
                Object.values(TEAM_ALIASES).some(v => v.toLowerCase().includes(lower));
        }

        // ---- Helper: extract a limit number from the query ----
        function extractLimit(query) {
            const match = query.match(/\b(?:top|best|worst|first|last)\s+(\d+)\b/i);
            if (match) return parseInt(match[1]);
            const limitMatch = query.match(/\blimit\s+(\d+)\b/i);
            if (limitMatch) return parseInt(limitMatch[1]);
            return 20;
        }

        // ---- Simple Levenshtein distance for fuzzy matching ----
        function levenshtein(a, b) {
            const m = a.length, n = b.length;
            if (m === 0) return n;
            if (n === 0) return m;
            // Use single-row optimization for memory efficiency
            let prev = Array.from({ length: n + 1 }, (_, i) => i);
            let curr = new Array(n + 1);
            for (let i = 1; i <= m; i++) {
                curr[0] = i;
                for (let j = 1; j <= n; j++) {
                    const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                    curr[j] = Math.min(prev[j] + 1, curr[j - 1] + 1, prev[j - 1] + cost);
                }
                [prev, curr] = [curr, prev];
            }
            return prev[n];
        }

        // ================================================================
        // SECTION 3: STAGE 1 ‚Äî ENTITY EXTRACTION ENGINE
        // ================================================================

        /**
         * extractEntities(query)
         * Priority-ordered extraction pipeline. Each extractor removes matched
         * tokens from the remaining query string so later extractors do not
         * re-match the same text.
         *
         * Returns: { players, teams, phases, venues, seasons, bowlerTypes,
         *            metrics, modifiers, role, remainingTokens }
         */
        function extractEntities(query) {
            const original = query.trim();
            let remaining = original.toLowerCase();

            const entities = {
                players: [],
                teams: [],
                phases: [],
                venues: [],
                seasons: [],
                bowlerTypes: [],
                metrics: [],
                modifiers: {
                    winLoss: null,
                    innings: null,
                    stage: null,
                    limit: extractLimit(remaining),
                    totalContext: null,
                },
                role: null,
                hasVsToken: false,
                remainingTokens: '',
            };

            // -- Helper: remove matched text from remaining --
            function consume(text) {
                const escaped = text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                remaining = remaining.replace(new RegExp('\\b' + escaped + '\\b', 'gi'), ' ').replace(/\s+/g, ' ').trim();
            }

            // -- Helper: try to consume text (returns true if found) --
            function tryConsume(text) {
                const lower = text.toLowerCase();
                if (remaining.includes(lower)) {
                    consume(lower);
                    return true;
                }
                return false;
            }

            // -- Detect "vs" token early (needed for intent classification) --
            if (/\b(?:vs\.?|versus|against|v\.?)\b/i.test(remaining)) {
                entities.hasVsToken = true;
            }

            // -- Detect "wins vs losses" / "split" modifiers BEFORE other extraction --
            if (/\b(?:wins?\s+(?:vs\.?|versus|and|&)\s+loss(?:es)?|win.?loss|split)\b/i.test(remaining)) {
                entities.modifiers.winLoss = 'split';
                remaining = remaining.replace(/\b(?:wins?\s+(?:vs\.?|versus|and|&)\s+loss(?:es)?|win.?loss|split)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            } else if (/\b(?:in\s+wins?|when\s+winning|while\s+winning)\b/i.test(remaining)) {
                entities.modifiers.winLoss = 'wins';
                remaining = remaining.replace(/\b(?:in\s+wins?|when\s+winning|while\s+winning)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            } else if (/\b(?:in\s+loss(?:es)?|when\s+losing|while\s+losing)\b/i.test(remaining)) {
                entities.modifiers.winLoss = 'losses';
                remaining = remaining.replace(/\b(?:in\s+loss(?:es)?|when\s+losing|while\s+losing)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            }

            // -- Detect innings context --
            if (/\b(?:batting\s+first|setting|first\s+innings|1st\s+innings)\b/i.test(remaining)) {
                entities.modifiers.innings = 1;
                remaining = remaining.replace(/\b(?:batting\s+first|setting|first\s+innings|1st\s+innings)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            } else if (/\b(?:chasing|batting\s+second|second\s+innings|2nd\s+innings)\b/i.test(remaining)) {
                entities.modifiers.innings = 2;
                remaining = remaining.replace(/\b(?:chasing|batting\s+second|second\s+innings|2nd\s+innings)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            } else if (/\b(?:defending)\b/i.test(remaining)) {
                entities.modifiers.innings = 2; // bowling in 2nd innings
                remaining = remaining.replace(/\bdefending\b/gi, ' ').replace(/\s+/g, ' ').trim();
            }

            // -- Detect stage context --
            if (/\b(?:playoffs?|knock\s*outs?|knockout)\b/i.test(remaining)) {
                entities.modifiers.stage = 'playoff';
                remaining = remaining.replace(/\b(?:playoffs?|knock\s*outs?|knockout)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            } else if (/\b(?:league\s+stage|group\s+stage|league\s+phase)\b/i.test(remaining)) {
                entities.modifiers.stage = 'league';
                remaining = remaining.replace(/\b(?:league\s+stage|group\s+stage|league\s+phase)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            } else if (/\b(?:finals?|the\s+final)\b/i.test(remaining)) {
                entities.modifiers.stage = 'final';
                remaining = remaining.replace(/\b(?:finals?|the\s+final)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            }

            // -- Detect total context (above 180, etc.) --
            const totalMatch = remaining.match(/\b(?:totals?\s+)?(?:above|over|more\s+than|>=?)\s+(\d{2,3})\b/i);
            if (totalMatch) {
                entities.modifiers.totalContext = { operator: '>=', value: parseInt(totalMatch[1]) };
                remaining = remaining.replace(totalMatch[0], ' ').replace(/\s+/g, ' ').trim();
            }

            // -- Detect role (batting / bowling) --
            if (/\bbowl(?:ing|ers?)?\b/i.test(remaining)) {
                entities.role = 'bowling';
            }
            if (/\bbat(?:ting|ters?|smen|sman)?\b/i.test(remaining) || /\b(run.?scorers?|hitters?|strikers?)\b/i.test(remaining)) {
                entities.role = entities.role === 'bowling' ? 'both' : 'batting';
            }

            // -- STEP 1: Extract seasons (years) BEFORE player names to avoid confusion --
            // Ranges: "2023-2025", "since 2023", "from 2023 to 2025"
            const rangeMatch = remaining.match(/\b(?:since|from|after)\s+(20[12]\d)\b/i);
            if (rangeMatch) {
                entities.seasons.push({ type: 'range', from: rangeMatch[1], to: null });
                remaining = remaining.replace(rangeMatch[0], ' ').replace(/\s+/g, ' ').trim();
            }
            const rangeMatch2 = remaining.match(/\b(20[12]\d)\s*[-‚Äì]\s*(20[12]\d)\b/);
            if (rangeMatch2) {
                entities.seasons.push({ type: 'range', from: rangeMatch2[1], to: rangeMatch2[2] });
                remaining = remaining.replace(rangeMatch2[0], ' ').replace(/\s+/g, ' ').trim();
            }
            // Relative seasons
            if (/\b(?:last\s+season|previous\s+season)\b/i.test(remaining)) {
                entities.seasons.push({ type: 'exact', value: '2025' });
                remaining = remaining.replace(/\b(?:last\s+season|previous\s+season)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            } else if (/\b(?:this\s+(?:season|year)|current\s+season)\b/i.test(remaining)) {
                entities.seasons.push({ type: 'exact', value: '2026' });
                remaining = remaining.replace(/\b(?:this\s+(?:season|year)|current\s+season)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            }
            // Exact years
            const yearMatches = remaining.match(/\b(20[12]\d)\b/g);
            if (yearMatches) {
                yearMatches.forEach(y => {
                    if (!entities.seasons.some(s => s.value === y || s.from === y)) {
                        entities.seasons.push({ type: 'exact', value: y });
                        consume(y);
                    }
                });
            }

            // -- STEP 2: Extract player names (longest match first) --
            // First try multi-word aliases (longest first for greedy match)
            const sortedAliases = Object.keys(PLAYER_ALIASES).sort((a, b) => b.length - a.length);
            for (const alias of sortedAliases) {
                if (entities.players.length >= 2) break; // Max 2 players
                const aliasLower = alias.toLowerCase();
                // Use word boundary matching
                const aliasRegex = new RegExp('\\b' + aliasLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
                if (aliasRegex.test(remaining)) {
                    const fullName = PLAYER_ALIASES[alias];
                    // Avoid duplicates
                    if (!entities.players.some(p => p.name === fullName)) {
                        entities.players.push({ name: fullName, matchedAs: alias, confidence: 0.95 });
                        remaining = remaining.replace(aliasRegex, ' ').replace(/\s+/g, ' ').trim();
                    }
                }
            }

            // -- STEP 3: Extract team names (longest match first) --
            const sortedTeamAliases = Object.keys(TEAM_ALIASES).sort((a, b) => b.length - a.length);
            for (const alias of sortedTeamAliases) {
                if (entities.teams.length >= 2) break;
                const aliasLower = alias.toLowerCase();
                const aliasRegex = new RegExp('\\b' + aliasLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
                if (aliasRegex.test(remaining)) {
                    const canonical = TEAM_ALIASES[alias];
                    if (!entities.teams.some(t => t.canonical === canonical)) {
                        entities.teams.push({ name: alias, canonical: canonical, confidence: 0.95 });
                        remaining = remaining.replace(aliasRegex, ' ').replace(/\s+/g, ' ').trim();
                    }
                }
            }

            // -- STEP 4: Extract phases (longest match first) --
            const sortedPhases = Object.keys(PHASE_MAP).sort((a, b) => b.length - a.length);
            for (const keyword of sortedPhases) {
                const keyRegex = new RegExp('\\b' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
                if (keyRegex.test(remaining)) {
                    const phase = PHASE_MAP[keyword];
                    if (!entities.phases.includes(phase)) {
                        entities.phases.push(phase);
                        remaining = remaining.replace(keyRegex, ' ').replace(/\s+/g, ' ').trim();
                    }
                }
            }

            // -- STEP 5: Extract venues --
            const sortedVenues = Object.keys(VENUE_MAP).sort((a, b) => b.length - a.length);
            for (const keyword of sortedVenues) {
                if (entities.venues.length >= 1) break;
                // Skip venue keywords that are null (city/team conflict)
                if (VENUE_MAP[keyword] === null) continue;
                const keyRegex = new RegExp('\\b' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
                if (keyRegex.test(remaining)) {
                    entities.venues.push({ keyword: keyword, pattern: VENUE_MAP[keyword] });
                    remaining = remaining.replace(keyRegex, ' ').replace(/\s+/g, ' ').trim();
                }
            }

            // -- STEP 6: Extract bowler types (longest match first) --
            const sortedBowlerTypes = Object.keys(BOWLER_TYPE_MAP).sort((a, b) => b.length - a.length);
            for (const keyword of sortedBowlerTypes) {
                if (entities.bowlerTypes.length >= 1) break;
                const keyRegex = new RegExp('\\b' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
                if (keyRegex.test(remaining)) {
                    entities.bowlerTypes.push({
                        keyword: keyword,
                        styles: BOWLER_TYPE_MAP[keyword],
                        simple: BOWLER_TYPE_SIMPLE[keyword] || 'Pace',
                    });
                    remaining = remaining.replace(keyRegex, ' ').replace(/\s+/g, ' ').trim();
                }
            }

            // -- STEP 7: Extract metrics --
            const sortedMetrics = Object.keys(METRIC_MAP).sort((a, b) => b.length - a.length);
            for (const keyword of sortedMetrics) {
                const keyRegex = new RegExp('\\b' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
                if (keyRegex.test(remaining)) {
                    const metric = METRIC_MAP[keyword];
                    if (!entities.metrics.some(m => m.col === metric.col)) {
                        entities.metrics.push({ ...metric, keyword });
                    }
                    // Do NOT consume metric keywords -- they are also useful for role detection
                    break; // Only capture primary metric
                }
            }

            // Strip common noise words from remaining
            remaining = remaining.replace(/\b(show|me|get|find|search|look\s*up|for|of|in|the|how|does|do|has|what|is|are|his|her|their|stats?|record|performance|data|numbers?|info|details|profile|by|with|and|a|an|at|on|to|from)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            // Strip "vs" token from remaining
            remaining = remaining.replace(/\b(?:vs\.?|versus|against|v\.?)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            // Strip limit tokens
            remaining = remaining.replace(/\b(?:top|best|worst|first|last|most|leading|highest|lowest)\s*\d*\b/gi, ' ').replace(/\s+/g, ' ').trim();
            // Strip role tokens
            remaining = remaining.replace(/\b(?:bat(?:ting|ters?|smen|sman)?|bowl(?:ing|ers?)?|all.?rounders?|run.?scorers?|hitters?|strikers?|wicket.?takers?)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            // Strip phase/overs/season noise
            remaining = remaining.replace(/\b(?:overs?|phase|season\s*wise|year\s*wise|per\s*(?:season|year)|by\s*(?:season|year)|each\s*(?:season|year)|every\s*(?:season|year)|yearly|annually|all\s*seasons?|over\s*the\s*years?|ipl|t20|season\s*by\s*season|year\s*by\s*year)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            // Strip pressure/clutch tokens
            remaining = remaining.replace(/\b(?:pressure|clutch|chok(?:e|er|ing)|finisher|closer|rrr|required\s*run\s*rate)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            // Strip contract/auction tokens
            remaining = remaining.replace(/\b(?:most\s*expensive|highest\s*paid|costliest|auction|contracts?|price|retained|rtm|cheap|bargain|affordable)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            // Strip squad/roster tokens
            remaining = remaining.replace(/\b(?:squad|roster|team\s*list|players?|overseas|foreign|international|non.?indian|imports?|uncapped|capped)\b/gi, ' ').replace(/\s+/g, ' ').trim();
            // Strip leftover tokens
            remaining = remaining.replace(/\b(?:who|which|limit|when|where|did|during)\b/gi, ' ').replace(/\s+/g, ' ').trim();

            entities.remainingTokens = remaining;

            // -- Post-processing: if we found no players but remaining has 3+ chars, it might be a player name --
            if (entities.players.length === 0 && remaining.length >= 3 && !isTeamToken(remaining)) {
                // Check if remaining tokens look like a player name (not common cricket words)
                const noiseCheck = /^(run|ball|over|match|team|game|score|win|loss|total|rate|dot|boundary|six|four|wicket|maiden|catch|drop|field)$/i;
                if (!noiseCheck.test(remaining)) {
                    // Fuzzy match against aliases
                    let bestMatch = null;
                    let bestDist = Infinity;
                    for (const [alias, fullName] of Object.entries(PLAYER_ALIASES)) {
                        const dist = levenshtein(remaining.toLowerCase(), alias.toLowerCase());
                        if (dist <= 2 && dist < bestDist) {
                            bestDist = dist;
                            bestMatch = fullName;
                        }
                    }
                    if (bestMatch) {
                        entities.players.push({ name: bestMatch, matchedAs: remaining, confidence: 0.7 });
                        remaining = '';
                    } else {
                        // Use as-is for ILIKE search (unknown player)
                        entities.players.push({ name: remaining, matchedAs: remaining, confidence: 0.5 });
                        remaining = '';
                    }
                }
            }

            entities.remainingTokens = remaining;
            return entities;
        }

        // ================================================================
        // SECTION 4: STAGE 2 ‚Äî INTENT CLASSIFIER
        // ================================================================

        /**
         * classifyIntent(entities, originalQuery)
         * Returns one of: PLAYER_LOOKUP, MATCHUP, LEADERBOARD, TEAM_ANALYSIS,
         * TEAM_COMPARISON, COMPARISON, PRESSURE, SEASON_TREND, CONTRACTS,
         * SQUAD, OVERSEAS, EXPLORATORY
         */
        function classifyIntent(entities, originalQuery) {
            const lower = originalQuery.toLowerCase();

            // Detect season-wise queries
            const isSeasonWise = /\b(year\s*(?:wise|by\s*year)|season\s*(?:wise|by\s*season)|per\s*(?:season|year)|by\s*(?:season|year)|each\s*(?:season|year)|every\s*(?:season|year)|season\s*by\s*season|year\s*by\s*year|yearly|annually|all\s*seasons?|over\s*the\s*years?)\b/i.test(lower);
            if (isSeasonWise) return 'SEASON_TREND';

            // Contract/auction queries
            if (/\b(most expensive|highest paid|costliest|auction|contracts?|price|retained|rtm)\b/i.test(lower)) return 'CONTRACTS';

            // Overseas/foreign queries
            if (/\b(overseas|foreign|international|non.?indian|imports?)\b/i.test(lower)) return 'OVERSEAS';

            // Squad/roster queries
            if (/\b(squad|roster|team\s*list)\b/i.test(lower) || /\bwho\s+(is|are)\s+in\b/i.test(lower)) return 'SQUAD';

            // Pressure/clutch queries
            if (/\b(pressure|clutch|chok(?:e|er|ing)|finisher|closer|rrr|required run rate)\b/i.test(lower)) return 'PRESSURE';

            // Two players = matchup
            if (entities.players.length === 2) return 'MATCHUP';

            // Player vs team
            if (entities.players.length === 1 && entities.teams.length === 1 && entities.hasVsToken) return 'PLAYER_VS_TEAM';

            // Player vs bowler type
            if (entities.players.length === 1 && entities.bowlerTypes.length >= 1) return 'PLAYER_VS_TYPE';

            // Leaderboard tokens
            const hasLeaderboardToken = /\b(top|best|worst|most|highest|leading|lowest)\b/i.test(lower);

            // Two teams = comparison
            if (entities.teams.length === 2) return 'TEAM_COMPARISON';

            // Leaderboard (no specific player)
            if (hasLeaderboardToken && entities.players.length === 0) return 'LEADERBOARD';

            // Single player lookup
            if (entities.players.length === 1) return 'PLAYER_LOOKUP';

            // Single team analysis
            if (entities.teams.length === 1 && entities.players.length === 0) return 'TEAM_ANALYSIS';

            // Win/loss comparison
            if (entities.modifiers.winLoss === 'split') return 'COMPARISON';

            return 'EXPLORATORY';
        }

        // ================================================================
        // SECTION 5: STAGE 3 ‚Äî VIEW COVERAGE MATRIX + VIEW FINDER
        // ================================================================

        /**
         * VIEW_COVERAGE: Maps each relevant view to its supported dimensions and role.
         * Dimensions: 'player', 'phase', 'venue', 'team', 'bowlerType', 'matchup', 'pressure', 'season', 'squad'
         * Role: 'batting', 'bowling', 'matchup', 'pressure', 'team', 'squad', 'reference'
         * Scope: 'default' (recent/standard), 'alltime', 'since2023'
         *
         * The findBestView() function matches required dimensions to find the
         * most specific view that covers all of them.
         */
        const VIEW_COVERAGE = {
            // --- Batting career ---
            'analytics_ipl_batting_career':                 { dims: ['player'], role: 'batting', scope: 'default', playerCol: 'player_name', orderDefault: 'runs DESC' },
            'analytics_ipl_batting_career_alltime':         { dims: ['player'], role: 'batting', scope: 'alltime', playerCol: 'player_name', orderDefault: 'runs DESC' },
            'analytics_ipl_batting_career_since2023':       { dims: ['player'], role: 'batting', scope: 'since2023', playerCol: 'player_name', orderDefault: 'runs DESC' },

            // --- Bowling career ---
            'analytics_ipl_bowling_career':                 { dims: ['player'], role: 'bowling', scope: 'default', playerCol: 'player_name', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowling_career_alltime':         { dims: ['player'], role: 'bowling', scope: 'alltime', playerCol: 'player_name', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowling_career_since2023':       { dims: ['player'], role: 'bowling', scope: 'since2023', playerCol: 'player_name', orderDefault: 'wickets DESC' },

            // --- Batter phase ---
            'analytics_ipl_batter_phase':                   { dims: ['player', 'phase'], role: 'batting', scope: 'default', playerCol: 'player_name', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_phase_alltime':           { dims: ['player', 'phase'], role: 'batting', scope: 'alltime', playerCol: 'player_name', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_phase_since2023':         { dims: ['player', 'phase'], role: 'batting', scope: 'since2023', playerCol: 'player_name', orderDefault: 'runs DESC' },

            // --- Bowler phase ---
            'analytics_ipl_bowler_phase':                   { dims: ['player', 'phase'], role: 'bowling', scope: 'default', playerCol: 'player_name', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_phase_alltime':           { dims: ['player', 'phase'], role: 'bowling', scope: 'alltime', playerCol: 'player_name', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_phase_since2023':         { dims: ['player', 'phase'], role: 'bowling', scope: 'since2023', playerCol: 'player_name', orderDefault: 'wickets DESC' },

            // --- Batter venue ---
            'analytics_ipl_batter_venue':                   { dims: ['player', 'venue'], role: 'batting', scope: 'default', playerCol: 'batter_name', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_venue_alltime':           { dims: ['player', 'venue'], role: 'batting', scope: 'alltime', playerCol: 'batter_name', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_venue_since2023':         { dims: ['player', 'venue'], role: 'batting', scope: 'since2023', playerCol: 'batter_name', orderDefault: 'runs DESC' },

            // --- Bowler venue ---
            'analytics_ipl_bowler_venue':                   { dims: ['player', 'venue'], role: 'bowling', scope: 'default', playerCol: 'bowler_name', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_venue_alltime':           { dims: ['player', 'venue'], role: 'bowling', scope: 'alltime', playerCol: 'bowler_name', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_venue_since2023':         { dims: ['player', 'venue'], role: 'bowling', scope: 'since2023', playerCol: 'bowler_name', orderDefault: 'wickets DESC' },

            // --- Batter venue + phase ---
            'analytics_ipl_batter_venue_phase':             { dims: ['player', 'venue', 'phase'], role: 'batting', scope: 'default', playerCol: 'batter_name', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_venue_phase_alltime':     { dims: ['player', 'venue', 'phase'], role: 'batting', scope: 'alltime', playerCol: 'batter_name', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_venue_phase_since2023':   { dims: ['player', 'venue', 'phase'], role: 'batting', scope: 'since2023', playerCol: 'batter_name', orderDefault: 'runs DESC' },

            // --- Bowler venue + phase ---
            'analytics_ipl_bowler_venue_phase':             { dims: ['player', 'venue', 'phase'], role: 'bowling', scope: 'default', playerCol: 'bowler_name', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_venue_phase_alltime':     { dims: ['player', 'venue', 'phase'], role: 'bowling', scope: 'alltime', playerCol: 'bowler_name', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_venue_phase_since2023':   { dims: ['player', 'venue', 'phase'], role: 'bowling', scope: 'since2023', playerCol: 'bowler_name', orderDefault: 'wickets DESC' },

            // --- Batter vs team ---
            'analytics_ipl_batter_vs_team':                 { dims: ['player', 'team'], role: 'batting', scope: 'default', playerCol: 'batter_name', teamCol: 'opposition', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_vs_team_alltime':         { dims: ['player', 'team'], role: 'batting', scope: 'alltime', playerCol: 'batter_name', teamCol: 'opposition', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_vs_team_since2023':       { dims: ['player', 'team'], role: 'batting', scope: 'since2023', playerCol: 'batter_name', teamCol: 'opposition', orderDefault: 'runs DESC' },

            // --- Batter vs team + phase ---
            'analytics_ipl_batter_vs_team_phase':           { dims: ['player', 'team', 'phase'], role: 'batting', scope: 'default', playerCol: 'batter_name', teamCol: 'opposition', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_vs_team_phase_alltime':   { dims: ['player', 'team', 'phase'], role: 'batting', scope: 'alltime', playerCol: 'batter_name', teamCol: 'opposition', orderDefault: 'runs DESC' },
            'analytics_ipl_batter_vs_team_phase_since2023': { dims: ['player', 'team', 'phase'], role: 'batting', scope: 'since2023', playerCol: 'batter_name', teamCol: 'opposition', orderDefault: 'runs DESC' },

            // --- Bowler vs team ---
            'analytics_ipl_bowler_vs_team':                 { dims: ['player', 'team'], role: 'bowling', scope: 'default', playerCol: 'bowler_name', teamCol: 'opposition', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_vs_team_alltime':         { dims: ['player', 'team'], role: 'bowling', scope: 'alltime', playerCol: 'bowler_name', teamCol: 'opposition', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_vs_team_since2023':       { dims: ['player', 'team'], role: 'bowling', scope: 'since2023', playerCol: 'bowler_name', teamCol: 'opposition', orderDefault: 'wickets DESC' },

            // --- Bowler vs team + phase ---
            'analytics_ipl_bowler_vs_team_phase':           { dims: ['player', 'team', 'phase'], role: 'bowling', scope: 'default', playerCol: 'bowler_name', teamCol: 'opposition', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_vs_team_phase_alltime':   { dims: ['player', 'team', 'phase'], role: 'bowling', scope: 'alltime', playerCol: 'bowler_name', teamCol: 'opposition', orderDefault: 'wickets DESC' },
            'analytics_ipl_bowler_vs_team_phase_since2023': { dims: ['player', 'team', 'phase'], role: 'bowling', scope: 'since2023', playerCol: 'bowler_name', teamCol: 'opposition', orderDefault: 'wickets DESC' },

            // --- Batter vs bowler (matchup) ---
            'analytics_ipl_batter_vs_bowler':               { dims: ['matchup'], role: 'matchup', scope: 'default', playerCol: 'batter_name', bowlerCol: 'bowler_name', orderDefault: 'balls DESC' },
            'analytics_ipl_batter_vs_bowler_alltime':       { dims: ['matchup'], role: 'matchup', scope: 'alltime', playerCol: 'batter_name', bowlerCol: 'bowler_name', orderDefault: 'balls DESC' },
            'analytics_ipl_batter_vs_bowler_since2023':     { dims: ['matchup'], role: 'matchup', scope: 'since2023', playerCol: 'batter_name', bowlerCol: 'bowler_name', orderDefault: 'balls DESC' },

            // --- Batter vs bowler + phase ---
            'analytics_ipl_batter_vs_bowler_phase':         { dims: ['matchup', 'phase'], role: 'matchup', scope: 'default', playerCol: 'batter_name', bowlerCol: 'bowler_name', orderDefault: 'balls DESC' },
            'analytics_ipl_batter_vs_bowler_phase_alltime': { dims: ['matchup', 'phase'], role: 'matchup', scope: 'alltime', playerCol: 'batter_name', bowlerCol: 'bowler_name', orderDefault: 'balls DESC' },
            'analytics_ipl_batter_vs_bowler_phase_since2023':{ dims: ['matchup', 'phase'], role: 'matchup', scope: 'since2023', playerCol: 'batter_name', bowlerCol: 'bowler_name', orderDefault: 'balls DESC' },

            // --- Batter vs bowler type ---
            'analytics_ipl_batter_vs_bowler_type':          { dims: ['player', 'bowlerType'], role: 'batting', scope: 'default', playerCol: 'batter_name', orderDefault: 'balls DESC' },
            'analytics_ipl_batter_vs_bowler_type_alltime':  { dims: ['player', 'bowlerType'], role: 'batting', scope: 'alltime', playerCol: 'batter_name', orderDefault: 'balls DESC' },
            'analytics_ipl_batter_vs_bowler_type_since2023':{ dims: ['player', 'bowlerType'], role: 'batting', scope: 'since2023', playerCol: 'batter_name', orderDefault: 'balls DESC' },

            // --- Batter vs bowler type + phase ---
            'analytics_ipl_batter_vs_bowler_type_phase':    { dims: ['player', 'bowlerType', 'phase'], role: 'batting', scope: 'default', playerCol: 'batter_name', orderDefault: 'balls DESC' },
            'analytics_ipl_batter_vs_bowler_type_phase_alltime': { dims: ['player', 'bowlerType', 'phase'], role: 'batting', scope: 'alltime', playerCol: 'batter_name', orderDefault: 'balls DESC' },
            'analytics_ipl_batter_vs_bowler_type_phase_since2023': { dims: ['player', 'bowlerType', 'phase'], role: 'batting', scope: 'since2023', playerCol: 'batter_name', orderDefault: 'balls DESC' },

            // --- Pressure bands ---
            'analytics_ipl_batter_pressure_bands_since2023': { dims: ['player', 'pressure'], role: 'pressure_batting', scope: 'since2023', playerCol: 'player_name', orderDefault: 'strike_rate DESC' },
            'analytics_ipl_batter_pressure_bands_alltime':   { dims: ['player', 'pressure'], role: 'pressure_batting', scope: 'alltime', playerCol: 'player_name', orderDefault: 'strike_rate DESC' },
            'analytics_ipl_bowler_pressure_bands_since2023': { dims: ['player', 'pressure'], role: 'pressure_bowling', scope: 'since2023', playerCol: 'player_name', orderDefault: 'economy ASC' },
            'analytics_ipl_bowler_pressure_bands_alltime':   { dims: ['player', 'pressure'], role: 'pressure_bowling', scope: 'alltime', playerCol: 'player_name', orderDefault: 'economy ASC' },

            // --- Pressure deltas ---
            'analytics_ipl_pressure_deltas_since2023':       { dims: ['pressure'], role: 'pressure_delta', scope: 'since2023', playerCol: 'player_name', orderDefault: 'pressure_rating DESC' },
            'analytics_ipl_pressure_deltas_alltime':         { dims: ['pressure'], role: 'pressure_delta', scope: 'alltime', playerCol: 'player_name', orderDefault: 'pressure_rating DESC' },

            // --- Pressure sequences ---
            'analytics_ipl_pressure_dot_sequences_since2023': { dims: ['pressure'], role: 'pressure_dot_seq', scope: 'since2023', playerCol: 'bowler_name', orderDefault: 'avg_dot_seq_length DESC' },
            'analytics_ipl_pressure_dot_sequences_alltime':   { dims: ['pressure'], role: 'pressure_dot_seq', scope: 'alltime', playerCol: 'bowler_name', orderDefault: 'avg_dot_seq_length DESC' },
            'analytics_ipl_pressure_boundary_sequences_since2023': { dims: ['pressure'], role: 'pressure_bdry_seq', scope: 'since2023', playerCol: 'batter_name', orderDefault: 'avg_boundary_seq_length DESC' },
            'analytics_ipl_pressure_boundary_sequences_alltime':   { dims: ['pressure'], role: 'pressure_bdry_seq', scope: 'alltime', playerCol: 'batter_name', orderDefault: 'avg_boundary_seq_length DESC' },

            // --- Squad views ---
            'analytics_ipl_squad_batting':                   { dims: ['squad'], role: 'squad_batting', scope: 'default', playerCol: 'player_name', teamCol: 'team_name', orderDefault: 'ipl_runs DESC NULLS LAST' },
            'analytics_ipl_squad_batting_phase':             { dims: ['squad', 'phase'], role: 'squad_batting', scope: 'default', playerCol: 'player_name', teamCol: 'team_name', orderDefault: 'runs DESC NULLS LAST' },
            'analytics_ipl_squad_bowling':                   { dims: ['squad'], role: 'squad_bowling', scope: 'default', playerCol: 'player_name', teamCol: 'team_name', orderDefault: 'player_name' },
            'analytics_ipl_squad_bowling_phase':             { dims: ['squad', 'phase'], role: 'squad_bowling', scope: 'default', playerCol: 'player_name', teamCol: 'team_name', orderDefault: 'economy_rate ASC NULLS LAST' },
        };

        /**
         * findBestView(entities, intent)
         * Determines required dimensions from entities and finds the most specific
         * view that covers all of them.
         * Returns: { viewName, viewMeta } or null if no view matches.
         */
        function findBestView(entities, intent) {
            // Build required dimension set
            const requiredDims = new Set();
            let requiredRole = null; // batting, bowling, matchup
            let preferredScope = 'default';

            // Determine scope from season entities
            if (entities.seasons.length > 0) {
                const s = entities.seasons[0];
                if (s.type === 'range' && s.from && parseInt(s.from) >= 2023) {
                    preferredScope = 'since2023';
                } else if (s.type === 'exact' && parseInt(s.value) >= 2023) {
                    preferredScope = 'since2023';
                } else {
                    preferredScope = 'alltime';
                }
            }

            // Build dimensions
            if (intent === 'MATCHUP') {
                requiredDims.add('matchup');
                requiredRole = 'matchup';
            } else if (entities.players.length >= 1) {
                requiredDims.add('player');
            }

            if (entities.phases.length > 0) requiredDims.add('phase');
            if (entities.venues.length > 0) requiredDims.add('venue');
            if (entities.bowlerTypes.length > 0) requiredDims.add('bowlerType');

            // Team dimension (for player-vs-team, not squad)
            if (entities.teams.length >= 1 && entities.players.length >= 1 && !['SQUAD', 'TEAM_ANALYSIS'].includes(intent)) {
                requiredDims.add('team');
            }

            // Squad dimension
            if (intent === 'TEAM_ANALYSIS' || intent === 'SQUAD') {
                requiredDims.add('squad');
            }

            // Pressure dimension
            if (intent === 'PRESSURE') {
                requiredDims.add('pressure');
            }

            // Determine role
            if (requiredRole === null) {
                if (entities.role === 'bowling') {
                    requiredRole = 'bowling';
                } else if (entities.role === 'batting' || entities.role === null) {
                    requiredRole = 'batting';
                }
            }

            // Disqualifying modifiers: these require dynamic SQL (Phase 2)
            if (entities.modifiers.winLoss || entities.modifiers.innings || entities.modifiers.stage || entities.modifiers.totalContext) {
                return null; // Cannot be satisfied by a view
            }

            // Find matching views
            const candidates = [];
            for (const [viewName, meta] of Object.entries(VIEW_COVERAGE)) {
                // Check scope compatibility
                if (preferredScope === 'since2023' && meta.scope !== 'since2023' && meta.scope !== 'default') continue;
                if (preferredScope === 'alltime' && meta.scope !== 'alltime' && meta.scope !== 'default') continue;
                if (preferredScope === 'default' && meta.scope !== 'default') continue;

                // Check that view dimensions are a superset of required dimensions
                const viewDims = new Set(meta.dims);
                let coversAll = true;
                for (const dim of requiredDims) {
                    if (!viewDims.has(dim)) { coversAll = false; break; }
                }
                if (!coversAll) continue;

                // Check role compatibility
                if (requiredRole === 'batting') {
                    if (!['batting', 'matchup', 'squad_batting', 'pressure_batting', 'pressure_delta', 'pressure_bdry_seq'].includes(meta.role)) continue;
                } else if (requiredRole === 'bowling') {
                    if (!['bowling', 'squad_bowling', 'pressure_bowling', 'pressure_delta', 'pressure_dot_seq'].includes(meta.role)) continue;
                } else if (requiredRole === 'matchup') {
                    if (meta.role !== 'matchup') continue;
                }

                // Score: prefer more specific views (more dimensions = better match)
                // and prefer scope-matched views
                let score = meta.dims.length * 10;
                if (meta.scope === preferredScope) score += 5;
                if (meta.scope === 'default' && preferredScope === 'default') score += 3;

                candidates.push({ viewName, meta, score });
            }

            if (candidates.length === 0) return null;

            // Sort by score descending (most specific first), then by dims length ascending for tie-break
            candidates.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return a.meta.dims.length - b.meta.dims.length; // prefer fewer extra dims
            });

            return { viewName: candidates[0].viewName, viewMeta: candidates[0].meta };
        }

        // ================================================================
        // SECTION 6: STAGE 4 ‚Äî QUERY ROUTER (naturalLanguageToSQL)
        // ================================================================

        /**
         * naturalLanguageToSQL(query)
         * The main NL-to-SQL engine. Uses the 5-stage pipeline:
         * 1. Entity Extraction
         * 2. Intent Classification
         * 3. View Coverage (fast path) or Phase 2 placeholder (dynamic SQL)
         * 4. SQL Generation
         * 5. Validation + Fallback
         *
         * Returns: { sql, type, entity, context } or null
         */
        function naturalLanguageToSQL(query) {
            const q = query.trim();
            if (!q) return null;
            const lower = q.toLowerCase();

            // --- Tier 4 fallback: If query looks like raw SQL, skip NL processing ---
            if (/^\s*(?:SELECT|WITH|INSERT|UPDATE|DELETE|CREATE|DROP|ALTER)\b/i.test(q)) {
                return null; // Let the SQL editor handle it
            }

            // --- Stage 1: Entity Extraction ---
            const entities = extractEntities(q);

            // --- Stage 2: Intent Classification ---
            const intent = classifyIntent(entities, q);

            // --- Helper: build WHERE clauses for view-based queries ---
            function buildViewSQL(viewName, meta, entities, intent) {
                const wheres = [];
                let orderBy = meta.orderDefault || 'player_name';
                const limit = entities.modifiers.limit;

                // Player filter
                if (entities.players.length >= 1 && meta.playerCol) {
                    const playerName = escapeSql(entities.players[0].name);
                    wheres.push(`${meta.playerCol} ILIKE '%${playerName}%'`);
                }

                // Second player (matchup bowler)
                if (entities.players.length >= 2 && meta.bowlerCol) {
                    const bowlerName = escapeSql(entities.players[1].name);
                    wheres.push(`${meta.bowlerCol} ILIKE '%${bowlerName}%'`);
                }

                // Team filter
                if (entities.teams.length >= 1 && meta.teamCol) {
                    const teamName = escapeSql(entities.teams[0].canonical);
                    wheres.push(`${meta.teamCol} ILIKE '%${teamName}%'`);
                }

                // Phase filter
                if (entities.phases.length >= 1) {
                    if (entities.phases.length === 1) {
                        wheres.push(`match_phase = '${escapeSql(entities.phases[0])}'`);
                    } else {
                        const phaseList = entities.phases.map(p => `'${escapeSql(p)}'`).join(', ');
                        wheres.push(`match_phase IN (${phaseList})`);
                    }
                }

                // Venue filter
                if (entities.venues.length >= 1) {
                    const venuePattern = escapeSql(entities.venues[0].pattern);
                    wheres.push(`venue ILIKE '%${venuePattern}%'`);
                }

                // Bowler type filter (for batter_vs_bowler_type views)
                if (entities.bowlerTypes.length >= 1 && meta.dims.includes('bowlerType')) {
                    // These views have a 'bowler_type' column with simple values
                    const btSimple = entities.bowlerTypes[0].simple;
                    if (btSimple) {
                        wheres.push(`bowler_type ILIKE '%${escapeSql(btSimple)}%'`);
                    }
                }

                // Pressure band filter
                if (intent === 'PRESSURE' && meta.dims.includes('pressure')) {
                    wheres.push(`pressure_band IN ('HIGH', 'EXTREME', 'NEAR_IMPOSSIBLE')`);
                }

                // Metric-based ordering
                if (entities.metrics.length > 0) {
                    const m = entities.metrics[0];
                    const isB = entities.role === 'bowling';
                    const col = isB && m.bowling_col ? m.bowling_col : m.col;
                    const dir = isB && m.bowling_dir ? m.bowling_dir : m.dir;
                    orderBy = `${col} ${dir}`;
                }

                const whereClause = wheres.length > 0 ? '\nWHERE ' + wheres.join('\n  AND ') : '';
                const limitClause = (intent === 'PLAYER_LOOKUP' || intent === 'MATCHUP' || intent === 'PLAYER_VS_TEAM' || intent === 'PLAYER_VS_TYPE') ? '' : `\nLIMIT ${limit}`;

                // For leaderboard queries without a specific player, add minimum sample filter
                let minFilter = '';
                if (intent === 'LEADERBOARD' && entities.players.length === 0) {
                    if (meta.role === 'batting' && meta.dims.includes('phase')) {
                        minFilter = wheres.length > 0 ? '\n  AND balls_faced >= 120' : '\nWHERE balls_faced >= 120';
                    } else if (meta.role === 'batting') {
                        minFilter = wheres.length > 0 ? '\n  AND innings >= 10' : '\nWHERE innings >= 10';
                    } else if (meta.role === 'bowling' && meta.dims.includes('phase')) {
                        minFilter = wheres.length > 0 ? '\n  AND balls_bowled >= 120' : '\nWHERE balls_bowled >= 120';
                    } else if (meta.role === 'bowling') {
                        minFilter = wheres.length > 0 ? '\n  AND matches_bowled >= 10' : '\nWHERE matches_bowled >= 10';
                    }
                }

                return `SELECT *\nFROM ${viewName}${whereClause}${minFilter}\nORDER BY ${orderBy}${limitClause};`;
            }

            // ==============================================
            // INTENT-SPECIFIC ROUTING
            // ==============================================

            // --- CONTRACTS ---
            if (intent === 'CONTRACTS') {
                const limit = entities.modifiers.limit;
                const isCheap = /\b(cheap|lowest|bargain|affordable)\b/.test(lower);
                let teamFound = entities.teams.length > 0 ? entities.teams[0].canonical : null;
                if (teamFound) {
                    return {
                        sql: `SELECT player_name, team_name, price_cr, acquisition_type, year_joined\nFROM ipl_2026_contracts\nWHERE team_name ILIKE '%${escapeSql(teamFound)}%'\nORDER BY price_cr ${isCheap ? 'ASC' : 'DESC'};`,
                        type: 'contracts',
                        entity: teamFound
                    };
                }
                return {
                    sql: `SELECT player_name, team_name, price_cr, acquisition_type, year_joined\nFROM ipl_2026_contracts\nORDER BY price_cr ${isCheap ? 'ASC' : 'DESC'}\nLIMIT ${limit};`,
                    type: 'contracts',
                    entity: isCheap ? 'cheapest players' : 'most expensive'
                };
            }

            // --- OVERSEAS ---
            if (intent === 'OVERSEAS') {
                let teamFound = entities.teams.length > 0 ? entities.teams[0].canonical : null;
                const teamClause = teamFound ? `\n  AND team_name ILIKE '%${escapeSql(teamFound)}%'` : '';
                return {
                    sql: `SELECT player_name, team_name, nationality, role, age\nFROM ipl_2026_squads\nWHERE nationality != 'India'${teamClause}\nORDER BY team_name, player_name;`,
                    type: 'overseas',
                    entity: teamFound || 'all teams'
                };
            }

            // --- SQUAD ---
            if (intent === 'SQUAD') {
                let teamFound = entities.teams.length > 0 ? entities.teams[0].canonical : null;
                if (teamFound) {
                    return {
                        sql: `SELECT player_name, role, nationality, age, batting_hand, bowling_type\nFROM ipl_2026_squads\nWHERE team_name ILIKE '%${escapeSql(teamFound)}%'\nORDER BY role, player_name;`,
                        type: 'squad',
                        entity: teamFound
                    };
                }
                // No team specified -- fall through to exploratory
            }

            // --- PRESSURE ---
            if (intent === 'PRESSURE') {
                const isBowling = entities.role === 'bowling' || /\b(closer|economy|dot)\b/.test(lower);
                const limit = entities.modifiers.limit;
                if (/\b(dot.*seq|streak|consecutive)\b/.test(lower)) {
                    const view = isBowling ? 'analytics_ipl_pressure_dot_sequences_since2023' : 'analytics_ipl_pressure_boundary_sequences_since2023';
                    return {
                        sql: `SELECT * FROM ${view}\nWHERE total_${isBowling ? 'dots_in_sequences' : 'boundaries_in_sequences'} >= 3\nORDER BY avg_${isBowling ? 'dot_seq' : 'boundary_seq'}_length DESC\nLIMIT ${limit};`,
                        type: 'pressure_sequences',
                        entity: isBowling ? 'dot sequences' : 'boundary sequences'
                    };
                }
                if (/\b(rating|delta|change)\b/.test(lower)) {
                    return {
                        sql: `SELECT player_name, role, pressure_band, ROUND(sr_delta_pct, 1) AS delta_pct, pressure_rating AS rating\nFROM analytics_ipl_pressure_deltas_since2023\nWHERE pressure_rating IS NOT NULL\nORDER BY sr_delta_pct DESC\nLIMIT ${limit};`,
                        type: 'pressure_ratings',
                        entity: 'pressure ratings'
                    };
                }
                if (isBowling) {
                    return {
                        sql: `SELECT player_name, pressure_band, legal_balls AS balls_bowled, ROUND(economy, 2) AS economy, ROUND(dot_ball_pct, 1) AS dot_pct, ROUND(boundary_conceded_pct, 1) AS bdry_pct, wickets\nFROM analytics_ipl_bowler_pressure_bands_since2023\nWHERE pressure_band IN ('HIGH', 'EXTREME', 'NEAR_IMPOSSIBLE')\n  AND legal_balls >= 15\nORDER BY economy ASC\nLIMIT ${limit};`,
                        type: 'pressure_bowling',
                        entity: 'bowlers under pressure'
                    };
                }
                return {
                    sql: `SELECT player_name, pressure_band, balls_faced, ROUND(strike_rate, 1) AS strike_rate, ROUND(boundary_pct, 1) AS boundary_pct, ROUND(dot_ball_pct, 1) AS dot_pct\nFROM analytics_ipl_batter_pressure_bands_since2023\nWHERE pressure_band IN ('HIGH', 'EXTREME', 'NEAR_IMPOSSIBLE')\n  AND balls_faced >= 15\nORDER BY strike_rate DESC\nLIMIT ${limit};`,
                    type: 'pressure_batting',
                    entity: 'batters under pressure'
                };
            }

            // --- SEASON_TREND ---
            if (intent === 'SEASON_TREND') {
                let playerName = entities.players.length > 0 ? entities.players[0].name : entities.remainingTokens;
                if (!playerName || playerName.length < 2) return null;
                playerName = escapeSql(playerName);
                const isBowling = entities.role === 'bowling';
                if (isBowling) {
                    return {
                        sql: `WITH ipl AS (\n  SELECT dm.match_id, dm.season\n  FROM dim_match dm\n  JOIN dim_tournament dt ON dm.tournament_id = dt.tournament_id\n  WHERE dt.tournament_name = 'Indian Premier League'\n)\nSELECT dp.current_name AS player_name, ipl.season,\n  count(DISTINCT fb.match_id) AS matches,\n  round(sum(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) / 6.0, 1) AS overs,\n  sum(fb.total_runs) AS runs_conceded,\n  sum(CASE WHEN fb.is_wicket AND fb.wicket_type NOT IN ('run out','retired hurt','retired out') THEN 1 ELSE 0 END) AS wickets,\n  round(sum(fb.total_runs) * 6.0 / nullif(sum(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS economy,\n  round(sum(fb.total_runs) * 1.0 / nullif(sum(CASE WHEN fb.is_wicket AND fb.wicket_type NOT IN ('run out','retired hurt','retired out') THEN 1 ELSE 0 END), 0), 2) AS average\nFROM fact_ball fb\nJOIN dim_player dp ON fb.bowler_id = dp.player_id\nJOIN ipl ON fb.match_id = ipl.match_id\nWHERE dp.current_name ILIKE '%${playerName}%'\nGROUP BY dp.current_name, ipl.season\nORDER BY ipl.season;`,
                        type: 'player_season',
                        entity: playerName,
                        context: 'bowling'
                    };
                }
                return {
                    sql: `WITH ipl AS (\n  SELECT dm.match_id, dm.season\n  FROM dim_match dm\n  JOIN dim_tournament dt ON dm.tournament_id = dt.tournament_id\n  WHERE dt.tournament_name = 'Indian Premier League'\n)\nSELECT dp.current_name AS player_name, ipl.season,\n  count(DISTINCT fb.match_id) AS innings,\n  sum(fb.batter_runs) AS runs,\n  sum(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END) AS balls,\n  round(sum(fb.batter_runs) * 100.0 / nullif(sum(CASE WHEN fb.is_legal_ball THEN 1 ELSE 0 END), 0), 2) AS strike_rate,\n  round(sum(fb.batter_runs) * 1.0 / nullif(sum(CASE WHEN fb.is_wicket AND fb.player_out_id = fb.batter_id THEN 1 ELSE 0 END), 0), 2) AS average,\n  sum(CASE WHEN fb.batter_runs = 4 THEN 1 ELSE 0 END) AS fours,\n  sum(CASE WHEN fb.batter_runs = 6 THEN 1 ELSE 0 END) AS sixes\nFROM fact_ball fb\nJOIN dim_player dp ON fb.batter_id = dp.player_id\nJOIN ipl ON fb.match_id = ipl.match_id\nWHERE dp.current_name ILIKE '%${playerName}%'\nGROUP BY dp.current_name, ipl.season\nORDER BY ipl.season;`,
                    type: 'player_season',
                    entity: playerName,
                    context: 'batting'
                };
            }

            // --- TEAM_ANALYSIS ---
            if (intent === 'TEAM_ANALYSIS' && entities.teams.length >= 1) {
                const teamName = entities.teams[0].canonical;
                const isBowling = entities.role === 'bowling';

                // Team + phase
                if (entities.phases.length > 0) {
                    const view = isBowling ? 'analytics_ipl_squad_bowling_phase' : 'analytics_ipl_squad_batting_phase';
                    const phaseFilter = entities.phases.length === 1
                        ? `\n  AND match_phase = '${escapeSql(entities.phases[0])}'`
                        : `\n  AND match_phase IN (${entities.phases.map(p => `'${escapeSql(p)}'`).join(', ')})`;
                    return {
                        sql: `SELECT * FROM ${view}\nWHERE team_name ILIKE '%${escapeSql(teamName)}%'${phaseFilter}\nORDER BY ${isBowling ? 'economy_rate ASC NULLS LAST' : 'runs DESC NULLS LAST'};`,
                        type: 'team_analysis',
                        entity: teamName,
                        context: isBowling ? 'bowling' : 'batting'
                    };
                }

                // Team batting/bowling (no phase)
                if (entities.role === 'bowling' || entities.role === 'batting') {
                    const view = isBowling ? 'analytics_ipl_squad_bowling' : 'analytics_ipl_squad_batting';
                    return {
                        sql: `SELECT * FROM ${view}\nWHERE team_name ILIKE '%${escapeSql(teamName)}%'\nORDER BY ${isBowling ? 'player_name' : 'ipl_runs DESC NULLS LAST'};`,
                        type: 'team_analysis',
                        entity: teamName,
                        context: isBowling ? 'bowling' : 'batting'
                    };
                }

                // Default: show squad
                return {
                    sql: `SELECT player_name, role, nationality, age, batting_hand, bowling_type\nFROM ipl_2026_squads\nWHERE team_name ILIKE '%${escapeSql(teamName)}%'\nORDER BY role, player_name;`,
                    type: 'squad',
                    entity: teamName
                };
            }

            // --- MATCHUP (player vs player) ---
            if (intent === 'MATCHUP' && entities.players.length >= 2) {
                const batter = escapeSql(entities.players[0].name);
                const bowler = escapeSql(entities.players[1].name);

                // Check for phase
                if (entities.phases.length > 0) {
                    const scope = entities.seasons.length > 0 && entities.seasons[0].from && parseInt(entities.seasons[0].from) >= 2023 ? '_since2023' : '';
                    const viewName = `analytics_ipl_batter_vs_bowler_phase${scope}`;
                    const phaseFilter = `\n  AND match_phase = '${escapeSql(entities.phases[0])}'`;
                    return {
                        sql: `SELECT *\nFROM ${viewName}\nWHERE batter_name ILIKE '%${batter}%'\n  AND bowler_name ILIKE '%${bowler}%'${phaseFilter}\nORDER BY balls DESC;`,
                        type: 'matchup',
                        entity: entities.players[0].name,
                        context: entities.players[1].name
                    };
                }

                return {
                    sql: `SELECT *\nFROM analytics_ipl_batter_vs_bowler\nWHERE batter_name ILIKE '%${batter}%'\n  AND bowler_name ILIKE '%${bowler}%'\nORDER BY balls DESC;`,
                    type: 'matchup',
                    entity: entities.players[0].name,
                    context: entities.players[1].name
                };
            }

            // --- PLAYER_VS_TEAM ---
            if (intent === 'PLAYER_VS_TEAM' && entities.players.length >= 1 && entities.teams.length >= 1) {
                const playerName = escapeSql(entities.players[0].name);
                const teamName = escapeSql(entities.teams[0].canonical);
                const isBowling = entities.role === 'bowling';

                if (entities.phases.length > 0) {
                    const viewName = isBowling ? 'analytics_ipl_bowler_vs_team_phase' : 'analytics_ipl_batter_vs_team_phase';
                    const pCol = isBowling ? 'bowler_name' : 'batter_name';
                    const phaseFilter = `\n  AND match_phase = '${escapeSql(entities.phases[0])}'`;
                    return {
                        sql: `SELECT *\nFROM ${viewName}\nWHERE ${pCol} ILIKE '%${playerName}%'\n  AND opposition ILIKE '%${teamName}%'${phaseFilter}\nORDER BY ${isBowling ? 'wickets DESC' : 'runs DESC'};`,
                        type: 'player_vs_team',
                        entity: entities.players[0].name,
                        context: entities.teams[0].canonical
                    };
                }

                const viewName = isBowling ? 'analytics_ipl_bowler_vs_team' : 'analytics_ipl_batter_vs_team';
                const pCol = isBowling ? 'bowler_name' : 'batter_name';
                return {
                    sql: `SELECT *\nFROM ${viewName}\nWHERE ${pCol} ILIKE '%${playerName}%'\n  AND opposition ILIKE '%${teamName}%'\nORDER BY ${isBowling ? 'wickets DESC' : 'runs DESC'};`,
                    type: 'player_vs_team',
                    entity: entities.players[0].name,
                    context: entities.teams[0].canonical
                };
            }

            // --- PLAYER_VS_TYPE ---
            if (intent === 'PLAYER_VS_TYPE' && entities.players.length >= 1) {
                const playerName = escapeSql(entities.players[0].name);

                if (entities.phases.length > 0) {
                    return {
                        sql: `SELECT *\nFROM analytics_ipl_batter_vs_bowler_type_phase\nWHERE batter_name ILIKE '%${playerName}%'\n  AND match_phase = '${escapeSql(entities.phases[0])}'\nORDER BY balls DESC;`,
                        type: 'player_vs_type',
                        entity: entities.players[0].name,
                        context: entities.bowlerTypes[0].keyword
                    };
                }

                return {
                    sql: `SELECT *\nFROM analytics_ipl_batter_vs_bowler_type\nWHERE batter_name ILIKE '%${playerName}%'\nORDER BY balls DESC;`,
                    type: 'player_vs_type',
                    entity: entities.players[0].name,
                    context: entities.bowlerTypes[0].keyword
                };
            }

            // --- LEADERBOARD ---
            if (intent === 'LEADERBOARD') {
                const limit = entities.modifiers.limit;
                const isBowling = entities.role === 'bowling' || /\b(bowl(?:ers?|ing)?|wicket.?takers?|wickets?|economy|econ|dot.?ball)\b/.test(lower);

                // Phase leaderboard
                if (entities.phases.length > 0) {
                    if (isBowling) {
                        let orderBy = 'wickets DESC';
                        if (entities.metrics.length > 0) {
                            const m = entities.metrics[0];
                            orderBy = `${m.bowling_col || m.col} ${m.bowling_dir || m.dir}`;
                        } else if (/economy|econ/.test(lower)) {
                            orderBy = 'economy_rate ASC';
                        } else if (/dot.?ball/.test(lower)) {
                            orderBy = 'dot_ball_pct DESC';
                        }
                        const phaseFilter = `match_phase = '${escapeSql(entities.phases[0])}'`;
                        return {
                            sql: `SELECT player_name, match_phase, matches, balls_bowled, overs, runs_conceded, wickets, economy_rate, dot_ball_pct\nFROM analytics_ipl_bowler_phase\nWHERE ${phaseFilter}\n  AND balls_bowled >= 120\nORDER BY ${orderBy}\nLIMIT ${limit};`,
                            type: 'phase_leaderboard',
                            entity: entities.phases[0] + ' bowlers',
                            context: 'bowling'
                        };
                    } else {
                        let orderBy = 'strike_rate DESC';
                        if (entities.metrics.length > 0) {
                            const m = entities.metrics[0];
                            orderBy = `${m.col} ${m.dir}`;
                        } else if (/average|avg/.test(lower)) {
                            orderBy = 'batting_average DESC';
                        } else if (/boundary/.test(lower)) {
                            orderBy = 'boundary_pct DESC';
                        }
                        const phaseFilter = `match_phase = '${escapeSql(entities.phases[0])}'`;
                        return {
                            sql: `SELECT player_name, match_phase, innings, runs, balls_faced, strike_rate, batting_average, boundary_pct\nFROM analytics_ipl_batter_phase\nWHERE ${phaseFilter}\n  AND balls_faced >= 120\nORDER BY ${orderBy}\nLIMIT ${limit};`,
                            type: 'phase_leaderboard',
                            entity: entities.phases[0] + ' batters',
                            context: 'batting'
                        };
                    }
                }

                // Career leaderboard
                if (isBowling) {
                    let orderBy = 'wickets DESC';
                    if (/economy|econ\b/.test(lower)) orderBy = 'economy_rate ASC';
                    else if (/dot.?ball/.test(lower)) orderBy = 'dot_ball_pct DESC';
                    else if (/\baverage\b/.test(lower)) orderBy = 'bowling_average ASC';
                    else if (/strike.?rate|sr\b/.test(lower)) orderBy = 'bowling_strike_rate ASC';
                    const minFilter = /economy|econ|dot.?ball|average|strike.?rate|sr/.test(lower) ? '\n  AND balls_bowled >= 500' : '';
                    return {
                        sql: `SELECT player_name, primary_role, matches_bowled, overs_bowled, wickets, economy_rate, bowling_average, bowling_strike_rate, dot_ball_pct, best_wickets, best_runs\nFROM analytics_ipl_bowling_career\nWHERE matches_bowled >= 10${minFilter}\nORDER BY ${orderBy}\nLIMIT ${limit};`,
                        type: 'leaderboard',
                        entity: 'bowlers',
                        context: orderBy.split(' ')[0]
                    };
                }

                // Batting leaderboard
                let orderBy = 'runs DESC';
                if (/strike.?rate|sr\b/.test(lower)) orderBy = 'strike_rate DESC';
                else if (/\baverage\b/.test(lower)) orderBy = 'batting_average DESC';
                else if (/\b(centuries|hundreds|100s)\b/.test(lower)) orderBy = 'hundreds DESC';
                else if (/\b(fifties|50s)\b/.test(lower)) orderBy = 'fifties DESC';
                else if (/\bsixes\b/.test(lower)) orderBy = 'sixes DESC';
                else if (/\bfours\b/.test(lower)) orderBy = 'fours DESC';
                else if (/\b(boundaries)\b/.test(lower)) orderBy = 'boundary_pct DESC';
                const minFilter = /strike.?rate|sr|average/.test(lower) ? '\n  AND balls_faced >= 500' : '';
                return {
                    sql: `SELECT player_name, primary_role, innings, runs, balls_faced, strike_rate, batting_average, boundary_pct, fifties, hundreds, sixes\nFROM analytics_ipl_batting_career\nWHERE innings >= 10${minFilter}\nORDER BY ${orderBy}\nLIMIT ${limit};`,
                    type: 'leaderboard',
                    entity: 'batters',
                    context: orderBy.split(' ')[0]
                };
            }

            // --- PLAYER_LOOKUP (single player, possibly with dimensions) ---
            if (intent === 'PLAYER_LOOKUP' && entities.players.length >= 1) {
                const playerName = entities.players[0].name;

                // Check for context modifiers that require dynamic SQL (Phase 2)
                if (entities.modifiers.winLoss || entities.modifiers.innings || entities.modifiers.stage || entities.modifiers.totalContext) {
                    // Phase 2 placeholder: show helpful message
                    const modDesc = [];
                    if (entities.modifiers.winLoss) modDesc.push(`win/loss: ${entities.modifiers.winLoss}`);
                    if (entities.modifiers.innings) modDesc.push(`innings: ${entities.modifiers.innings}`);
                    if (entities.modifiers.stage) modDesc.push(`stage: ${entities.modifiers.stage}`);
                    if (entities.modifiers.totalContext) modDesc.push(`total: ${entities.modifiers.totalContext.operator}${entities.modifiers.totalContext.value}`);

                    // For now, return the closest view-based query with a comment about the missing filters
                    const bestView = findBestView({
                        ...entities,
                        modifiers: { ...entities.modifiers, winLoss: null, innings: null, stage: null, totalContext: null }
                    }, intent);

                    if (bestView) {
                        const sql = buildViewSQL(bestView.viewName, bestView.viewMeta, entities, intent);
                        return {
                            sql: `-- NOTE: Dynamic filters (${modDesc.join(', ')}) require Phase 2 dynamic SQL.\n-- Showing closest available view-based results.\n${sql}`,
                            type: 'player_lookup',
                            entity: playerName,
                            context: modDesc.join(', ')
                        };
                    }
                }

                // Try view-based routing
                const bestView = findBestView(entities, intent);
                if (bestView) {
                    const sql = buildViewSQL(bestView.viewName, bestView.viewMeta, entities, intent);
                    // Determine type from view
                    let type = 'player_lookup';
                    if (bestView.viewMeta.dims.includes('venue')) type = 'player_venue';
                    if (bestView.viewMeta.dims.includes('phase')) type = 'phase';
                    if (bestView.viewMeta.role === 'bowling') type = 'player_bowling';
                    return {
                        sql,
                        type,
                        entity: playerName,
                        context: entities.phases[0] || entities.venues[0]?.pattern || null
                    };
                }

                // Fallback: direct career lookup
                const isBowling = entities.role === 'bowling';
                if (isBowling) {
                    return {
                        sql: `SELECT player_name, primary_role, matches_bowled, overs_bowled, wickets, economy_rate, bowling_average, bowling_strike_rate, dot_ball_pct\nFROM analytics_ipl_bowling_career\nWHERE player_name ILIKE '%${escapeSql(playerName)}%';`,
                        type: 'player_bowling',
                        entity: playerName
                    };
                }
                return {
                    sql: `SELECT player_name, primary_role, innings, runs, balls_faced, strike_rate, batting_average, boundary_pct, fifties, hundreds, sixes\nFROM analytics_ipl_batting_career\nWHERE player_name ILIKE '%${escapeSql(playerName)}%';`,
                    type: 'player_lookup',
                    entity: playerName
                };
            }

            // --- TEAM_COMPARISON ---
            if (intent === 'TEAM_COMPARISON' && entities.teams.length >= 2) {
                // Phase 2 placeholder for now
                const t1 = entities.teams[0].canonical;
                const t2 = entities.teams[1].canonical;
                const isBowling = entities.role === 'bowling';
                const view = isBowling ? 'analytics_ipl_squad_bowling' : 'analytics_ipl_squad_batting';
                const orderCol = isBowling ? 'player_name' : 'ipl_runs DESC NULLS LAST';
                return {
                    sql: `-- Team comparison: ${t1} vs ${t2}\nSELECT * FROM ${view}\nWHERE team_name ILIKE '%${escapeSql(t1)}%'\n   OR team_name ILIKE '%${escapeSql(t2)}%'\nORDER BY team_name, ${orderCol};`,
                    type: 'team_comparison',
                    entity: t1,
                    context: t2
                };
            }

            // --- EXPLORATORY / FALLBACK ---
            // Last resort: if we have any remaining text, try it as a player name
            if (entities.remainingTokens.length >= 2) {
                const guess = entities.remainingTokens;
                if (isTeamToken(guess)) {
                    const teamName = resolveTeamName(guess);
                    if (entities.role === 'bowling') {
                        return {
                            sql: `SELECT * FROM analytics_ipl_squad_bowling\nWHERE team_name ILIKE '%${escapeSql(teamName)}%'\nORDER BY player_name;`,
                            type: 'team_analysis',
                            entity: teamName,
                            context: 'bowling'
                        };
                    }
                    if (entities.role === 'batting') {
                        return {
                            sql: `SELECT * FROM analytics_ipl_squad_batting\nWHERE team_name ILIKE '%${escapeSql(teamName)}%'\nORDER BY ipl_runs DESC NULLS LAST;`,
                            type: 'team_analysis',
                            entity: teamName,
                            context: 'batting'
                        };
                    }
                    return {
                        sql: `SELECT player_name, role, nationality, age, batting_hand, bowling_type\nFROM ipl_2026_squads\nWHERE team_name ILIKE '%${escapeSql(teamName)}%'\nORDER BY role, player_name;`,
                        type: 'squad',
                        entity: teamName
                    };
                }

                // Try as player name
                const isBowling = entities.role === 'bowling';
                if (isBowling) {
                    return {
                        sql: `SELECT player_name, primary_role, matches_bowled, overs_bowled, wickets, economy_rate, bowling_average, bowling_strike_rate, dot_ball_pct\nFROM analytics_ipl_bowling_career\nWHERE player_name ILIKE '%${escapeSql(guess)}%';`,
                        type: 'player_bowling',
                        entity: guess
                    };
                }
                return {
                    sql: `SELECT player_name, primary_role, innings, runs, balls_faced, strike_rate, batting_average, boundary_pct, fifties, hundreds, sixes\nFROM analytics_ipl_batting_career\nWHERE player_name ILIKE '%${escapeSql(guess)}%';`,
                    type: 'player_lookup',
                    entity: guess
                };
            }

            return null;
        }

        // Make it globally accessible
        window.naturalLanguageToSQL = naturalLanguageToSQL;
        // Also expose entity extraction and intent for debugging / Phase 2
        window._nlExtractEntities = extractEntities;
        window._nlClassifyIntent = classifyIntent;
        window._nlFindBestView = findBestView;

        /* ==================== "THE FIRST TAKE" INSIGHT GENERATOR (TKT-177) ==================== */
        let lastNLQueryType = null;
        let lastNLEntity = null;
        let lastNLContext = null;

        function generateFirstTakeInsight(columns, rows, queryType, entity, context) {
            if (!rows || rows.length === 0) {
                return `<p style="font-size:13px;color:var(--text-secondary);line-height:1.6;">
                    No results to analyse here. That is unusual \u2014 let us check if the query or spelling needs adjusting.
                    Try a broader search or check the schema browser for available views.
                </p>`;
            }

            const firstRow = rows[0];
            const totalRows = rows.length;

            function fmt(n) {
                if (n === null || n === undefined) return 'N/A';
                if (typeof n === 'number') return n % 1 === 0 ? n.toLocaleString() : n.toFixed(2);
                return String(n);
            }

            function colAvg(colName) {
                const vals = rows.map(r => r[colName]).filter(v => v !== null && v !== undefined && typeof v === 'number');
                if (vals.length === 0) return null;
                return vals.reduce((a, b) => a + b, 0) / vals.length;
            }

            function pctAboveAvg(val, avg) {
                if (!avg || avg === 0) return null;
                return (((val - avg) / avg) * 100).toFixed(1);
            }

            let insight = '';

            switch (queryType) {
                case 'leaderboard': {
                    const name = firstRow.player_name || firstRow.batter_name || 'The leader';
                    if (context === 'runs' || context === 'wickets') {
                        const statVal = firstRow[context] || firstRow.runs || firstRow.wickets;
                        const avg = colAvg(context) || colAvg('runs') || colAvg('wickets');
                        const pct = pctAboveAvg(statVal, avg);
                        insight = `Right, let us talk about this leaderboard. <strong>${escapeHtml(name)}</strong> sits at the top with <strong>${fmt(statVal)} ${context}</strong>.`;
                        if (pct && parseFloat(pct) > 0) {
                            insight += ` That is <strong>${pct}%</strong> above the group average in this sample.`;
                        }
                        insight += ` When you are scouting, this is your benchmark \u2014 everyone else is chasing this standard.`;
                        if (totalRows >= 3) {
                            const third = rows[2];
                            insight += ` Keep an eye on <strong>${escapeHtml(third.player_name || third.batter_name || 'the third name')}</strong> in third \u2014 that is often where the real value sits in squad building.`;
                        }
                    } else {
                        const keyStat = context || 'strike_rate';
                        const val = firstRow[keyStat];
                        insight = `Looking at this data, <strong>${escapeHtml(name)}</strong> leads with a ${keyStat.replace(/_/g, ' ')} of <strong>${fmt(val)}</strong>.`;
                        insight += ` This is a ${totalRows}-deep leaderboard \u2014 important to look beyond the headline number and consider sample size before drawing conclusions.`;
                    }
                    break;
                }
                case 'player_lookup':
                case 'player_bowling': {
                    const name = firstRow.player_name || firstRow.batter_name || entity;
                    if (firstRow.innings !== undefined) {
                        insight = `Here is the career dossier on <strong>${escapeHtml(name)}</strong>: <strong>${fmt(firstRow.innings)}</strong> innings`;
                        if (firstRow.runs !== undefined) insight += `, <strong>${fmt(firstRow.runs)}</strong> runs`;
                        if (firstRow.batting_average !== undefined) insight += ` at an average of <strong>${fmt(firstRow.batting_average)}</strong>`;
                        if (firstRow.strike_rate !== undefined) insight += ` and a strike rate of <strong>${fmt(firstRow.strike_rate)}</strong>`;
                        insight += '.';
                        if (firstRow.strike_rate && firstRow.strike_rate > 140) {
                            insight += ` That strike rate is in the impact zone \u2014 this is someone who shifts momentum.`;
                        } else if (firstRow.batting_average && firstRow.batting_average > 35) {
                            insight += ` Averaging above 35 in T20 cricket \u2014 that is rare consistency under pressure.`;
                        }
                    } else if (firstRow.wickets !== undefined) {
                        insight = `The bowling profile for <strong>${escapeHtml(name)}</strong>: <strong>${fmt(firstRow.wickets)}</strong> wickets`;
                        if (firstRow.economy_rate !== undefined) insight += ` at an economy of <strong>${fmt(firstRow.economy_rate)}</strong>`;
                        if (firstRow.bowling_average !== undefined) insight += `, average <strong>${fmt(firstRow.bowling_average)}</strong>`;
                        if (firstRow.bowling_strike_rate !== undefined) insight += `, strike rate <strong>${fmt(firstRow.bowling_strike_rate)}</strong>`;
                        insight += '.';
                        if (firstRow.economy_rate && firstRow.economy_rate < 7.5) {
                            insight += ` An economy under 7.5 in T20s is elite \u2014 this bowler controls scoring pressure.`;
                        }
                    } else {
                        insight = `Data loaded for <strong>${escapeHtml(name)}</strong>. ${totalRows} record${totalRows > 1 ? 's' : ''} found.`;
                    }
                    break;
                }
                case 'squad': {
                    const teamName = entity || 'This squad';
                    const overseas = rows.filter(r => r.nationality && r.nationality !== 'India').length;
                    const indian = totalRows - overseas;
                    insight = `<strong>${escapeHtml(teamName)}</strong> has <strong>${totalRows}</strong> players in the squad`;
                    insight += ` \u2014 <strong>${overseas}</strong> overseas slots used.`;
                    if (overseas > 0) {
                        const overseasNames = rows.filter(r => r.nationality && r.nationality !== 'India').slice(0, 4).map(r => r.player_name);
                        insight += ` Key overseas contingent: ${overseasNames.map(n => '<strong>' + escapeHtml(n) + '</strong>').join(', ')}.`;
                    }
                    insight += ` That is ${indian} Indian players forming the core \u2014 crucial for building the middle overs structure.`;
                    break;
                }
                case 'team_analysis': {
                    const teamName = entity || 'This team';
                    const side = context || 'batting';
                    insight = `<strong>${escapeHtml(teamName)}</strong> ${side} analysis across <strong>${totalRows}</strong> squad members.`;
                    if (side === 'batting' && firstRow.ipl_runs !== undefined) {
                        const topScorer = rows.reduce((a, b) => ((b.ipl_runs || 0) > (a.ipl_runs || 0) ? b : a), rows[0]);
                        insight += ` The anchor is <strong>${escapeHtml(topScorer.player_name)}</strong> with <strong>${fmt(topScorer.ipl_runs)}</strong> IPL runs.`;
                        const uncapped = rows.filter(r => !r.ipl_innings || r.ipl_innings === 0).length;
                        if (uncapped > 0) insight += ` ${uncapped} player${uncapped > 1 ? 's are' : ' is'} uncapped at IPL level \u2014 development opportunities there.`;
                    }
                    break;
                }
                case 'contracts': {
                    const topPlayer = firstRow.player_name || 'Top pick';
                    insight = `Looking at the money \u2014 <strong>${escapeHtml(topPlayer)}</strong> at <strong>${fmt(firstRow.price_cr)} Cr</strong>`;
                    if (firstRow.team_name) insight += ` for ${escapeHtml(firstRow.team_name)}`;
                    insight += '.';
                    if (totalRows >= 5) {
                        const totalSpend = rows.slice(0, Math.min(totalRows, limit)).reduce((s, r) => s + (r.price_cr || 0), 0);
                        insight += ` Top ${Math.min(totalRows, limit)} contracts total <strong>${fmt(totalSpend)} Cr</strong>.`;
                    }
                    insight += ` Always compare contract value against actual output \u2014 that is where you find market inefficiencies.`;
                    break;
                }
                case 'player_vs_team': {
                    const name = firstRow.player_name || entity;
                    insight = `<strong>${escapeHtml(name)}</strong> vs <strong>${escapeHtml(context || 'opposition')}</strong>: `;
                    if (firstRow.runs !== undefined) insight += `<strong>${fmt(firstRow.runs)}</strong> runs`;
                    if (firstRow.balls_faced !== undefined) insight += ` off <strong>${fmt(firstRow.balls_faced)}</strong> balls`;
                    if (firstRow.strike_rate !== undefined) insight += ` (SR: <strong>${fmt(firstRow.strike_rate)}</strong>)`;
                    insight += '. ';
                    insight += `Matchup data like this is gold in pre-tournament preparation \u2014 it tells you where to target or protect.`;
                    break;
                }
                case 'matchup': {
                    const batter = firstRow.batter_name || entity;
                    const bowler = firstRow.bowler_name || context;
                    insight = `Head-to-head: <strong>${escapeHtml(batter)}</strong> vs <strong>${escapeHtml(bowler)}</strong> \u2014 `;
                    if (firstRow.balls !== undefined) insight += `<strong>${fmt(firstRow.balls)}</strong> balls faced, `;
                    if (firstRow.runs !== undefined) insight += `<strong>${fmt(firstRow.runs)}</strong> runs, `;
                    if (firstRow.dismissals !== undefined) insight += `<strong>${fmt(firstRow.dismissals)}</strong> dismissals`;
                    if (firstRow.strike_rate !== undefined) insight += ` (SR: <strong>${fmt(firstRow.strike_rate)}</strong>)`;
                    insight += '. ';
                    if (firstRow.balls && firstRow.balls < 12) {
                        insight += `Small sample though \u2014 need at least 12 deliveries to read anything meaningful into this.`;
                    } else {
                        insight += `This is actionable intelligence for field placement and bowling changes.`;
                    }
                    break;
                }
                case 'player_vs_type': {
                    const name = firstRow.batter_name || entity;
                    insight = `<strong>${escapeHtml(name)}</strong> breakdown by bowler type:`;
                    for (const row of rows.slice(0, 4)) {
                        if (row.bowler_type) {
                            insight += ` vs ${escapeHtml(row.bowler_type)}: SR <strong>${fmt(row.strike_rate)}</strong> (${fmt(row.balls)} balls);`;
                        }
                    }
                    insight += ` This split is essential for planning bowling rotations \u2014 expose the weakness, protect against the strength.`;
                    break;
                }
                case 'phase_leaderboard':
                case 'phase': {
                    const phase = context || entity || 'this phase';
                    const name = firstRow.player_name || 'The leader';
                    insight = `Phase breakdown for <strong>${escapeHtml(String(phase))}</strong>: <strong>${escapeHtml(name)}</strong> leads.`;
                    if (firstRow.strike_rate !== undefined) insight += ` Strike rate: <strong>${fmt(firstRow.strike_rate)}</strong>.`;
                    if (firstRow.economy_rate !== undefined) insight += ` Economy: <strong>${fmt(firstRow.economy_rate)}</strong>.`;
                    if (firstRow.wickets !== undefined) insight += ` Wickets: <strong>${fmt(firstRow.wickets)}</strong>.`;
                    insight += ` Phase-specific data separates genuine match-winners from flat-track performers. Context is everything in T20 cricket.`;
                    break;
                }
                case 'overseas': {
                    insight = `<strong>${totalRows}</strong> overseas players across ${escapeHtml(entity || 'the squads')}.`;
                    const nationalities = {};
                    rows.forEach(r => { if (r.nationality) nationalities[r.nationality] = (nationalities[r.nationality] || 0) + 1; });
                    const topNations = Object.entries(nationalities).sort((a, b) => b[1] - a[1]).slice(0, 3);
                    if (topNations.length > 0) {
                        insight += ` Top nationalities: ${topNations.map(([n, c]) => `<strong>${escapeHtml(n)}</strong> (${c})`).join(', ')}.`;
                    }
                    insight += ` The overseas composition defines a squad's ceiling \u2014 you need the right balance of impact and reliability.`;
                    break;
                }
                case 'player_season': {
                    const name = firstRow.player_name || escapeHtml(entity);
                    const seasons = rows.map(r => r.season).filter(Boolean);
                    insight = `<strong>${escapeHtml(name)}</strong> across <strong>${seasons.length}</strong> IPL season${seasons.length > 1 ? 's' : ''} (${seasons[0]}\u2013${seasons[seasons.length - 1]}).`;
                    if (context === 'batting' && firstRow.runs !== undefined) {
                        const bestSeason = rows.reduce((best, r) => (r.runs || 0) > (best.runs || 0) ? r : best, rows[0]);
                        const totalRuns = rows.reduce((sum, r) => sum + (r.runs || 0), 0);
                        insight += ` Career total: <strong>${totalRuns.toLocaleString()}</strong> runs. Peak season: <strong>${bestSeason.season}</strong> with <strong>${(bestSeason.runs || 0).toLocaleString()}</strong> runs at SR ${fmt(bestSeason.strike_rate)}.`;
                    } else if (context === 'bowling' && firstRow.wickets !== undefined) {
                        const bestSeason = rows.reduce((best, r) => (r.wickets || 0) > (best.wickets || 0) ? r : best, rows[0]);
                        const totalWickets = rows.reduce((sum, r) => sum + (r.wickets || 0), 0);
                        insight += ` Career total: <strong>${totalWickets}</strong> wickets. Peak season: <strong>${bestSeason.season}</strong> with <strong>${bestSeason.wickets}</strong> wickets at econ ${fmt(bestSeason.economy)}.`;
                    }
                    insight += ` Year-by-year tape shows you the arc \u2014 who is peaking and who is fading.`;
                    break;
                }
                case 'player_venue': {
                    const name = firstRow.batter_name || firstRow.bowler_name || escapeHtml(entity);
                    const venue = firstRow.venue || escapeHtml(context);
                    if (firstRow.runs !== undefined) {
                        insight = `<strong>${escapeHtml(name)}</strong> at <strong>${escapeHtml(venue)}</strong>: <strong>${firstRow.runs}</strong> runs in <strong>${firstRow.innings}</strong> innings, SR ${fmt(firstRow.strike_rate)}, avg ${fmt(firstRow.average)}.`;
                        if (firstRow.sixes) insight += ` Hit <strong>${firstRow.sixes}</strong> sixes here.`;
                    } else if (firstRow.wickets !== undefined) {
                        insight = `<strong>${escapeHtml(name)}</strong> at <strong>${escapeHtml(venue)}</strong>: <strong>${firstRow.wickets}</strong> wickets in <strong>${firstRow.matches}</strong> matches, economy ${fmt(firstRow.economy)}.`;
                    }
                    insight += ` Ground conditions matter \u2014 the best scouts always check the venue tape first.`;
                    break;
                }
                default: {
                    insight = `${totalRows} row${totalRows > 1 ? 's' : ''} returned. `;
                    if (firstRow.player_name) {
                        insight += `First entry: <strong>${escapeHtml(firstRow.player_name)}</strong>. `;
                    }
                    insight += `Dig into the data \u2014 the details often tell a different story than the headlines.`;
                }
            }

            return `<p style="font-size:13px;color:var(--text-secondary);line-height:1.6;">${insight}</p>`;
        }

        // ---- Update the insight card after query execution ----
        function updateFirstTakeInsight(columns, rows) {
            const insightSection = document.getElementById('andy-flower-insights');
            if (!insightSection) return;

            const insightHTML = generateFirstTakeInsight(
                columns, rows,
                lastNLQueryType, lastNLEntity, lastNLContext
            );

            insightSection.innerHTML = `
                <div class="insight-card">
                    <div class="insight-card-header">
                        <span class="icon">\u{1F3CF}</span>
                        <h4>The First Take</h4>
                        <span class="badge">Cricket Context</span>
                    </div>
                    <p class="insight-subtitle" style="font-size: 13px; font-style: italic; color: var(--text-secondary); margin-bottom: 8px;">
                        "Stephen A. wished he had this data before going on air"
                    </p>
                    ${insightHTML}
                </div>`;
        }

        /* ==================== WIRE NL SEARCH BAR (TKT-177) ==================== */
        const nlInput = document.getElementById('nl-search-input');

        function handleNLSearch() {
            const query = nlInput.value.trim();
            if (!query) return;

            const result = naturalLanguageToSQL(query);
            if (result) {
                lastNLQueryType = result.type;
                lastNLEntity = result.entity || null;
                lastNLContext = result.context || null;

                setEditorSQL(result.sql);
                document.getElementById('sql-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Auto-execute after a brief delay to let user see the SQL
                setTimeout(() => {
                    executeQueryWithInsights();
                }, 300);
            } else {
                // No pattern matched - show helpful hint
                const insightSection = document.getElementById('andy-flower-insights');
                if (insightSection) {
                    insightSection.innerHTML = `
                        <div class="insight-card" style="border-color: rgba(255, 159, 10, 0.3); background: linear-gradient(135deg, rgba(255, 159, 10, 0.08) 0%, rgba(255, 69, 58, 0.06) 100%);">
                            <div class="insight-card-header">
                                <span class="icon">\u{1F3CF}</span>
                                <h4>The First Take</h4>
                                <span class="badge" style="background: rgba(255, 159, 10, 0.15); color: var(--accent-orange);">Try These</span>
                            </div>
                            <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.8; margin-bottom: 8px;">
                                I could not quite parse that one. Here are some things I understand:
                            </p>
                            <ul style="font-size: 12px; color: var(--text-secondary); line-height: 2; list-style: none; padding: 0; font-family: 'JetBrains Mono', monospace;">
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='Kohli stats';handleNLSearch();">\u{1F4A1} <strong>"Kohli stats"</strong> \u2014 Player career lookup</li>
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='Kohli year wise';handleNLSearch();">\u{1F4A1} <strong>"Kohli year wise"</strong> \u2014 Season-by-season breakdown</li>
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='Kohli at Chinnaswamy';handleNLSearch();">\u{1F4A1} <strong>"Kohli at Chinnaswamy"</strong> \u2014 Venue splits</li>
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='top 10 batsmen';handleNLSearch();">\u{1F4A1} <strong>"top 10 batsmen"</strong> \u2014 Batting leaderboard</li>
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='Kohli vs MI';handleNLSearch();">\u{1F4A1} <strong>"Kohli vs MI"</strong> \u2014 Player vs team</li>
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='best death bowlers';handleNLSearch();">\u{1F4A1} <strong>"best death bowlers"</strong> \u2014 Phase specialists</li>
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='CSK squad';handleNLSearch();">\u{1F4A1} <strong>"CSK squad"</strong> \u2014 Team roster</li>
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='most expensive players';handleNLSearch();">\u{1F4A1} <strong>"most expensive players"</strong> \u2014 IPL 2026 contracts</li>
                                <li style="cursor:pointer;" onclick="document.getElementById('nl-search-input').value='clutch batters';handleNLSearch();">\u{1F4A1} <strong>"clutch batters"</strong> \u2014 Pressure performance</li>
                            </ul>
                        </div>`;
                }
            }
        }

        window.handleNLSearch = handleNLSearch;

        nlInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleNLSearch();
            }
        });

        // ---- Patch executeQuery to generate insights after results ----
        const _originalExecuteQuery = executeQuery;

        async function executeQueryWithInsights() {
            await _originalExecuteQuery();
            if (currentResultRows && currentResultRows.length > 0) {
                updateFirstTakeInsight(currentResultColumns, currentResultRows);
            }
        }

        window.executeQuery = executeQueryWithInsights;
        document.getElementById('run-button').removeEventListener('click', _originalExecuteQuery);
        document.getElementById('run-button').addEventListener('click', executeQueryWithInsights);

        // Update NL search bar placeholder
        nlInput.placeholder = "Ask: 'top batsmen', 'Kohli stats', 'CSK squad', 'best death bowlers', 'Kohli vs MI'...";

        /* ==================== START INITIALIZATION ==================== */
        /* Import DuckDB with a 15-second timeout so a hung CDN never blocks the page */
        function importWithTimeout(url, ms) {
            return Promise.race([
                import(url),
                new Promise((_, reject) => setTimeout(() => reject(new Error('CDN import timed out after ' + ms + 'ms')), ms))
            ]);
        }

        async function loadAndInitDuckDB() {
            try {
                duckdb = await importWithTimeout('https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.29.0/+esm', 15000);
                console.log('DuckDB-WASM loaded successfully');
                await initDuckDB();
            } catch (err) {
                console.error('DuckDB-WASM failed to load:', err);
                const overlayEl = document.getElementById('loading-overlay');
                const progressTextEl = document.getElementById('loading-progress-text');
                if (progressTextEl) progressTextEl.textContent = 'Analytics engine failed to load: ' + err.message;
                const btn = document.createElement('button');
                btn.textContent = 'Dismiss & Browse Page';
                btn.style.cssText = 'margin-top:16px;padding:10px 24px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:13px;font-weight:600;';
                btn.onclick = () => overlayEl.classList.add('hidden');
                overlayEl.querySelector('.loading-steps').insertAdjacentElement('afterend', btn);
            }
        }

        // Signal to safety timeout that module evaluation completed successfully
        window._filmRoomReady = true;

        // Kick off DuckDB load (non-blocking ‚Äî page is already rendered)
        loadAndInitDuckDB();
    </script>

    <!-- Navigation Guide Button -->
    <button type="button" class="nav-guide-btn" onclick="toggleNavGuide()" title="Quick Navigation Guide" style="
        position: fixed; bottom: 48px; right: 20px; width: 52px; height: 52px;
        border-radius: 50%; background: var(--bg-secondary); border: 1px solid var(--border);
        color: var(--text-secondary); font-size: 22px; cursor: pointer; z-index: 90;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 16px var(--shadow); transition: all 0.2s ease;
    ">‚ùì</button>

    <!-- Navigation Guide Modal -->
    <div class="nav-guide-overlay" id="nav-guide-overlay" onclick="closeNavGuide(event)" style="
        display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
        z-index: 150; align-items: center; justify-content: center;
    ">
        <div class="nav-guide-modal" onclick="event.stopPropagation()" style="
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 16px; padding: 28px 24px; max-width: 420px; width: 90%;
            max-height: 80vh; overflow-y: auto; position: relative;
        ">
            <button type="button" class="nav-guide-close" onclick="toggleNavGuide()" style="
                position: absolute; top: 12px; right: 12px; background: none; border: none;
                color: var(--text-tertiary); font-size: 18px; cursor: pointer; padding: 4px 8px;
            ">&#10005;</button>
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 18px; font-weight: 800;">üèè The Playbook Rundown</h3>
                <p style="font-size: 13px; color: var(--text-secondary);">Your pre-game briefing from the coaching staff</p>
            </div>
            <a href="index.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;">üè†</span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">Home ‚Äî "The Main Event"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">The Lab homepage. Your IPL 2026 analytics command center.</p>
                </div>
            </a>
            <a href="teams.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;">üèè</span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">Team Breakdowns ‚Äî "The Dugout"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">Andy Flower's domain. Predicted XIs, depth charts, full rosters.</p>
                </div>
            </a>
            <a href="artifacts.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;">üìä</span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">Artifacts ‚Äî "The Trophy Cabinet"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">All 10 franchise stat packs. Stephen Curry approved ‚Äî clean data.</p>
                </div>
            </a>
            <a href="analysis.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;">üî¨</span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">Analysis ‚Äî "Studying Film"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">Tom Brady's film room. Matchups, clusters, phase breakdowns.</p>
                </div>
            </a>
            <a href="research.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;">üìö</span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">Research ‚Äî "Pep's Tactical Notebook"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">Methodology docs. The science behind the grades.</p>
                </div>
            </a>
            <a href="research-desk.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; background: rgba(10,132,255,0.08); border: 1px solid rgba(10,132,255,0.15);">
                <span style="font-size: 24px;">üé¨</span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">The Film Room ‚Äî "Breaking Down Tape"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">üìç You Are Here. Pull up the tape on any player, team, or matchup. The full scouting database, coach-style.</p>
                </div>
            </a>
            <a href="about.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;">üåπ</span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">About ‚Äî "The Origin Story"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">The story, the vision, the Founder. How Cricket Playbook came to be.</p>
                </div>
            </a>
            <a href="../../mission_control/dashboard/index.html" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; text-decoration: none; color: inherit; transition: background 0.2s;">
                <span style="font-size: 24px;">üì°</span>
                <div>
                    <h4 style="font-size: 14px; font-weight: 600;">The Boardroom ‚Äî "Front Office Moves"</h4>
                    <p style="font-size: 12px; color: var(--text-secondary);">Florentino's war room. Tickets, sprints, agent roster.</p>
                </div>
            </a>
        </div>
    </div>

    <script>
        function toggleNavGuide() {
            const overlay = document.getElementById('nav-guide-overlay');
            const isVisible = overlay.style.display === 'flex';
            overlay.style.display = isVisible ? 'none' : 'flex';
        }
        function closeNavGuide(e) {
            if (e.target === e.currentTarget) toggleNavGuide();
        }

        /* Schema sidebar mobile toggle */
        function toggleSchemaSidebar() {
            const sidebar = document.getElementById('schema-browser');
            const overlay = document.getElementById('schema-overlay');
            const isOpen = sidebar.classList.contains('open');
            if (isOpen) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('active');
            }
        }
    </script>
</body>
</html>
