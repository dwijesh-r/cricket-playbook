# ML Health Check Pipeline
# ========================
# Automated monitoring for Cricket Playbook ML models
#
# Author: Ime Udoka (MLOps Lead)
# Ticket: TKT-073
#
# Triggers:
#   - Weekly schedule (Monday 9 AM UTC)
#   - Push to ML-related files
#   - Manual dispatch (for ad-hoc checks)
#   - After model retraining workflows

name: ML Health Check

on:
  # Weekly scheduled check - Monday 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'

  # Trigger on ML-related file changes
  push:
    branches: [main]
    paths:
      - 'scripts/ml_ops/**'
      - 'scripts/analysis/player_clustering*.py'
      - 'ml_ops/**'
      - 'outputs/tags/**'

  # Manual trigger for ad-hoc checks
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose output'
        required: false
        default: 'true'
        type: boolean
      export_metrics:
        description: 'Export metrics to artifacts'
        required: false
        default: 'true'
        type: boolean

  # Trigger after other workflows complete
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

jobs:
  ml-health-check:
    runs-on: ubuntu-latest
    # Only run on workflow_run if it was successful
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Create required directories
        run: |
          mkdir -p outputs/tags
          mkdir -p outputs/monitoring/health_reports
          mkdir -p ml_ops

      - name: Check for player tags
        id: check-tags
        run: |
          if [ -f "outputs/tags/player_tags.json" ]; then
            echo "tags_exist=true" >> $GITHUB_OUTPUT
          else
            echo "tags_exist=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Player tags not found - creating minimal test data"
          fi

      - name: Create minimal test data (if needed)
        if: steps.check-tags.outputs.tags_exist == 'false'
        run: |
          cat > outputs/tags/player_tags.json << 'EOF'
          {
            "batters": [
              {"player_id": "test_1", "player_name": "Test Batter", "cluster": 0}
            ],
            "bowlers": [
              {"player_id": "test_2", "player_name": "Test Bowler", "cluster": 0}
            ],
            "metadata": {
              "generated_at": "2026-02-07T00:00:00",
              "is_test_data": true
            }
          }
          EOF

      - name: Run ML Health Check
        id: health-check
        run: |
          # Determine flags
          VERBOSE_FLAG=""
          EXPORT_FLAG=""

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ inputs.verbose }}" == "true" ]; then
              VERBOSE_FLAG="--verbose"
            fi
            if [ "${{ inputs.export_metrics }}" == "true" ]; then
              EXPORT_FLAG="--export"
            fi
          else
            # Default: verbose and export for scheduled/push runs
            VERBOSE_FLAG="--verbose"
            EXPORT_FLAG="--export"
          fi

          echo "Running: python scripts/ml_ops/run_health_check.py $VERBOSE_FLAG $EXPORT_FLAG --json"

          # Run health check and capture output
          set +e
          python scripts/ml_ops/run_health_check.py $VERBOSE_FLAG $EXPORT_FLAG --json > health_report.json 2>&1
          EXIT_CODE=$?
          set -e

          # Parse status from output
          cat health_report.json

          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          # Set status based on exit code
          if [ $EXIT_CODE -eq 0 ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "status_emoji=ðŸŸ¢" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 1 ]; then
            echo "status=degraded" >> $GITHUB_OUTPUT
            echo "status_emoji=ðŸŸ¡" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "status=critical" >> $GITHUB_OUTPUT
            echo "status_emoji=ðŸ”´" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "status_emoji=âŒ" >> $GITHUB_OUTPUT
          fi

      - name: Upload health report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ml-health-report-${{ github.run_id }}
          path: |
            health_report.json
            outputs/monitoring/
          retention-days: 30

      - name: Create job summary
        if: always()
        run: |
          echo "## ${{ steps.health-check.outputs.status_emoji }} ML Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.health-check.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Health Report" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat health_report.json >> $GITHUB_STEP_SUMMARY || echo "Report not available" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Fail on critical status
        if: steps.health-check.outputs.exit_code == '2'
        run: |
          echo "ðŸ”´ CRITICAL: ML health check detected critical issues!"
          echo "Review the health report artifact for details."
          exit 1

      - name: Warn on degraded status
        if: steps.health-check.outputs.exit_code == '1'
        run: |
          echo "ðŸŸ¡ WARNING: ML health check detected potential issues."
          echo "Review the health report artifact for details."
          # Don't fail the build, but log warning
